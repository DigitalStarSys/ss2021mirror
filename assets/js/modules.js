Class((function Antimatter(_num,_config,_renderer=World.RENDERER){Inherit(this,AntimatterFBO);var _geometry,_this=this,_drawLimit=_num,_size=function findSize(){return _config.pot?Math.pow(2,Math.ceil(Math.log(Math.sqrt(_num))/Math.log(2))):Math.ceil(Math.sqrt(_num))}();async function createBuffer(){let{geometry:geometry,vertices:vertices,attribs:attribs,usedDepth:usedDepth}=await AntimatterUtil.createBufferArray(_size,_num,_config);_this.vertices=_this.cloneVertices?vertices.clone():vertices,(_geometry=geometry.clone(!0)).drawRange.end=_drawLimit,_this.vertices.geometry=_geometry,_this.attribs=_this.random=attribs,_this.textureUsedDepth=usedDepth,_this.init(_geometry,_renderer,_size)}defer(createBuffer),this.createFloatArray=function(components=3){return new Float32Array(_size*_size*components)},this.createFloatArrayAsync=async function(components=3,freshCopy){let{array:array}=await AntimatterUtil.createFloatArray(_size*_size*components,freshCopy);return array},this.ready=function(callback){return _this.wait(_this,"vertices")},this.useShader=function(vs,fs,params){"object"==typeof fs&&(params=fs,fs=null),this.vertexShader=vs,this.fragmentShader=fs||vs,this.uniforms=params},this.createMesh=this.getMesh=function(){let shader=_this.createShader(_this.fragmentShader||"AntimatterBasicFrag");return _this.mesh=new Points(_geometry,shader),_this.mesh.frustumCulled=!1,_this.shader=shader,_this.geometry=_geometry,_this.mesh},this.createShader=function(fs){let uniforms=_this.uniforms||{},obj={tPos:{type:"t",value:_this.vertices.texture,ignoreUIL:!0},tPrevPos:{type:"t",value:_this.vertices.texture,ignoreUIL:!0}};for(let key in uniforms)obj[key]=uniforms[key];let shader=new Shader(_this.vertexShader||"AntimatterPosition",fs,obj),vs=shader.vertexShader;if(vs&&!vs.includes("uniform sampler2D tPos")){let split=vs.split("__ACTIVE_THEORY_LIGHTS__"),defined="uniform sampler2D tPos;";shader.vertexShader=split[0]+"\n"+defined+"\n__ACTIVE_THEORY_LIGHTS__\n"+split[1]}return shader},this.getLookupArray=function(){return new Float32Array(_this.vertices.geometry.attributes.position.array)},this.getRandomArray=function(){return _geometry.attributes.random.array},this.overrideShader=function(original){let shader=original.clone();original.copyUniformsTo(shader),shader.uniforms.tPos={type:"t",value:_this.vertices.texture,ignoreUIL:!0},shader.uniforms.tPrevPos={type:"t",value:_this.vertices.texture,ignoreUIL:!0},_this.shader=shader,_this.mesh.shader=shader},this.upload=async function(needsMesh){_this.preventRender=!0,_geometry.distributeBufferData=!0,await _this.ready(),await _this.vertices.uploadAsync(),await defer(),await _this.random.uploadAsync(),await defer(),_this.mesh&&needsMesh&&(_this.mesh.upload(),await _geometry.uploadBuffersAsync());for(let key in _this.shader.uniforms){let uniform=_this.shader.uniforms[key];uniform.value&&(uniform.value.uploadAsync?await uniform.value.uploadAsync():uniform.value.upload&&(uniform.value.upload(),await defer()))}await _this.wait(100);for(let i=0;i<_this.passes.length;i++)await _this.passes[i].upload();_this.preventRender=!1},this.uploadSync=async function(needsMesh){await _this.ready(),_this.customClass&&_this.customClass.loaded&&await _this.customClass.loaded(),_this.mesh&&needsMesh&&_this.mesh.upload();for(let i=0;i<4;i++)_this.update()},this.get("particleCount",(_=>_num)),this.get("textureSize",(_=>_size)),this.get("powerOf2",(_=>Math.pow(2,Math.ceil(Math.log(Math.sqrt(_num))/Math.log(2)))))})),Class((function AntimatterAttribute(_data,_components){Inherit(this,Component);var _this=this,_size=Math.sqrt(_data.length/(_components||3));this.size=_size,this.count=_size*_size,this.buffer=_data,this.texture=new DataTexture(_data,_size,_size,4==_components?Texture.RGBAFormat:Texture.RGBFormat,Texture.FLOAT),this.set("needsUpdate",(function(){_this.texture&&(_this.texture.needsUpdate=!0)})),this.bufferData=function(data,components){_this.buffer=data,components!=_components?(_this.texture.destroy(),_this.texture=new DataTexture(data,_size,_size,4==components?Texture.RGBAFormat:Texture.RGBFormat,Texture.FLOAT)):(_this.texture.data=data,_this.texture.needsUpdate=!0),_components=components,_data=data},this.upload=function(){_this.texture.upload()},this.uploadAsync=function(){return _this.texture.distributeTextureData=!0,_this.texture.upload(),_this.texture.uploadAsync()},this.clone=function(){return new AntimatterAttribute(_data,_components)},this.onDestroy=function(){_this.texture&&_this.texture.destroy&&_this.texture.destroy()}})),Class((function AntimatterFBO(){var _this,_gpuGeom,_renderer,_size,_prevRT,_scene,_mesh,_camera,_copy,_geometry;Inherit(this,Component);var _output={type:"t",value:null,ignoreUIL:!0},_prevOutput={type:"t",value:null,ignoreUIL:!0};function copy(input,output){World.RENDERER.blit(input,output)||(_copy.visible=!0,_mesh.visible=!1,_copy.shader.uniforms.tMap.value=input,_renderer.renderSingle(_copy,_camera,output),_copy.visible=!1,_mesh.visible=!0)}this.passes=[],this.init=function(geometry,renderer,size){_this=this,_gpuGeom=geometry.attributes.position.array,_renderer=renderer,_size=size,function initPasses(){_camera=World.CAMERA,_geometry=World.QUAD,_scene=new Scene,(_mesh=new Mesh(_geometry,null)).frustumCulled=!1,_mesh.noMatrices=!0,_mesh.transient=!0,_scene.add(_mesh);let copyShader=AntimatterFBO.getCopyShader();(_copy=new Mesh(_geometry,copyShader)).noMatrices=!0,_scene.add(_copy),_copy.visible=!1}()},this.getGPUGeom=function(){return _gpuGeom},this.addPass=function(pass,index){_this=this,pass.init||pass.initialize(_size),"number"!=typeof index?_this.passes.push(pass):_this.passes.splice(index,0,pass)},this.findPass=function(name){_this=this;for(var i=0;i<_this.passes.length;i++){var pass=_this.passes[i];if(pass.name==name)return pass}},this.removePass=function(pass){_this=this,"number"==typeof pass?_this.passes.splice(pass):_this.passes.remove(pass)},this.update=function(){if((_this=this).mesh&&!_this.preventRender){var output=_output.value||_this.vertices.texture;_this.storeVelocity&&(_prevRT?(copy(_output.value,_prevRT),_prevOutput.value=_prevRT):(_prevOutput.value=output,(_prevRT=_this.passes[0].getRT(0).clone()).upload()));for(var i=0;i<_this.passes.length;i++){var pass=_this.passes[i],needsInit=!pass.init,firstRender=!pass.first;needsInit&&pass.initialize(_size),pass.first=!0,_mesh.shader=pass.shader,_mesh.shader.uniforms.tInput.value=firstRender?_this.vertices.texture:pass.output,pass.ready||(_mesh.shader.uniforms.tInput.value=_this.vertices.texture);var rt=firstRender?pass.getRT(0):pass.getWrite();output=pass.output;_renderer.renderSingle(_scene.children[0],_camera,rt),copy(rt,output),pass.swap()}output&&(_output.value=output,_this.mesh.shader.uniforms.tPos.value=_output.value,_this.mesh.shader.uniforms.tPrevPos.value=_prevOutput.value)}},this.onDestroy=function(){_this.vertices&&_this.vertices.destroy&&_this.vertices.destroy(),_this.attribs&&_this.attribs.destroy&&_this.attribs.destroy(),_this.passes.forEach((function(pass){pass.first=!1,_this.persistPasses||pass&&pass.destroy&&pass.destroy()})),_this.mesh.destroy()},this.getOutput=function(){return _output},this.getPrevOutput=function(){return _prevOutput}}),(function(){var _shader;AntimatterFBO.getCopyShader=function(){return _shader||((_shader=new Shader("ScreenQuad")).addUniforms({tMap:{type:"t",value:null}}),_shader._attachmentData={format:Texture.RGBAFormat,type:Texture.FLOAT,attachments:1}),_shader}})),Class((function AntimatterPass(_shader,_uni,_clone){var _this=this;this.UILPrefix="am_"+_shader;const _uniforms={tInput:{type:"t",value:null,ignoreUIL:!0},fSize:{type:"f",value:64,ignoreUIL:!0}};var _rts=[],_read=0,_write=0;function prepareShader(code,type){if("vs"==type)return code;let header=["uniform sampler2D tInput;","uniform float fSize;","varying vec2 vUv;",Shaders.getShader("antimatter.glsl")].join("\n"),mainAt=code.indexOf("void main()"),before=code.slice(0,mainAt),after=code.slice(mainAt);return code=before+header+after,_this.onCreateShader&&(code=_this.onCreateShader(code)),code}function initRT(size){var type="ios"==Device.system.os?Texture.HALF_FLOAT:Texture.FLOAT,parameters={minFilter:Texture.NEAREST,magFilter:Texture.NEAREST,format:Texture.RGBAFormat,type:type},rt=new RenderTarget(size,size,parameters);return rt.texture.generateMipmaps=!1,rt}this.uniforms=_uniforms,this.output=initRT(64),this.name=_shader,this.id=Utils.timestamp(),this.ready=!1,function(){if(_uni)for(var key in _uni.unique&&(_this.UILPrefix+="_"+_uni.unique.replace("/","_"),delete _uni.unique),_uni.customCompile&&(_this.customCompile=_uni.customCompile||"",delete _uni.customCompile),_uni)_uniforms[key]=_uni[key]}(),this.addInput=function(name,attribute){var uniform="object"!=typeof attribute||attribute.height||"string"!=typeof attribute.type?attribute instanceof AntimatterAttribute?{type:"t",value:attribute.texture,ignoreUIL:!0}:attribute instanceof AntimatterPass?{type:"t",value:attribute.output,ignoreUIL:!0}:{type:"t",value:attribute,ignoreUIL:!0}:attribute;let lookup=UILStorage.parse(_this.UILPrefix+name);lookup&&(uniform.value=lookup.value);let uniforms=_shader&&_shader.uniforms?_shader.uniforms:_uniforms;return uniforms[name]=uniform,uniform.ignoreUIL=!0,uniforms[name]},this.addUniforms=function(object){let uniforms=_shader&&_shader.uniforms?_shader.uniforms:_uniforms;for(let key in object){let uniform=object[key],lookup=UILStorage.parse(_this.UILPrefix+key);if(lookup){if(Array.isArray(lookup.value))switch(lookup.value.length){case 2:lookup.value=(new Vector2).fromArray(lookup.value);break;case 3:lookup.value=(new Vector3).fromArray(lookup.value);break;case 4:lookup.value=(new Vector4).fromArray(lookup.value)}uniform.value=lookup.value}uniforms[key]=uniform}},this.getRT=function(index){return _rts[index]},this.getRead=function(){return _rts[_read]},this.getWrite=function(){return _rts[_write]},this.setRead=function(index){_read=index},this.setWrite=function(index){_write=index},this.swap=function(){++_write>2&&(_write=0,_this.ready=!0),++_read>2&&(_this.onInit&&(_this.onInit(),_this.onInit=null),_read=0)},this.initialize=function(size){if(!_this.init){_this.init=!0;for(var i=0;i<3;i++)_rts.push(initRT(size));_this.output.setSize(size,size),_shader instanceof Shader||((_shader=new Shader("AntimatterPass",_shader,{customCompile:_this.customCompile}))._attachmentData={format:Texture.RGBAFormat,type:Texture.FLOAT,attachments:1},_shader.preCompile=prepareShader,_shader.addUniforms(_uniforms),_this.uniforms=_shader.uniforms,_shader.UILPrefix=_this.UILPrefix,_shader.id=Utils.timestamp()),_this.shader=_shader,_shader.uniforms.fSize.value=size}},this.setUniform=function(key,value){_uniforms[key]||(_uniforms[key]={value:value}),_uniforms[key].value=value,_shader&&_shader.uniforms&&(_shader.uniforms[key].value=value)},this.getUniform=function(key){return _shader&&_shader.uniforms?_shader.uniforms[key].value:null},this.tween=function(key,value,time,ease,delay,callback,update){return tween(_shader.uniforms[key],{value:value},time,ease,delay,callback,update)},this.clone=function(){return new AntimatterPass(_shader,_uni)},this.destroy=function(){_rts.forEach((function(rt){rt&&rt.destroy&&rt.destroy()}))},this.upload=async function(){_shader.upload(),await defer();for(let i=0;i<_rts.length;i++)_rts[i].upload(),await defer();for(let key in _shader.uniforms){let uniform=_shader.uniforms[key];uniform.value&&(uniform.value.uploadAsync?await uniform.value.uploadAsync():uniform.value.upload&&(uniform.value.upload(),await defer()))}}})),Class((function AntimatterSpawn(_proton,_group,_input){Inherit(this,Component);const _this=this;var _life,_pass,_velocity,_color,_index=-1,_total=_proton.particleCount,_releasedA=[],_releasedB=[],_temp0=[],_temp1=[],_temp2=[],_vec=new Vector3;function loop(){let count=_releasedA.length;for(let i=count-1;i>-1;i--){let index=_releasedA[i];_life.buffer[4*index+0]=0}_releasedA.length=0,count&&(_life.needsUpdate=!0);let hold=_releasedA;_releasedA=_releasedB,_releasedB=hold}!async function(){await async function initPass(){let[lifeBuffer,velocityBuffer]=await Promise.all([_proton.antimatter.createFloatArrayAsync(4,!0),_proton.antimatter.createFloatArrayAsync(3,!0)]);_life=_this.initClass(AntimatterAttribute,lifeBuffer,4),_velocity=_this.initClass(AntimatterAttribute,velocityBuffer,3),_pass=_this.initClass(AntimatterPass,"AntimatterSpawn",{unique:_input.prefix,uMaxCount:_proton.behavior.uniforms.uMaxCount,tAttribs:_proton.behavior.uniforms.tAttribs,tLife:{value:_life,ignoreUIL:!0},uSetup:{value:1,ignoreUIL:!0},decay:{value:1},HZ:{value:Render.HZ_MULTIPLIER,ignoreUIL:!0},decayRandom:{value:new Vector2(1,1)}}),ShaderUIL.add(_pass,_group).setLabel("Life Shader"),_pass.onInit=_=>{_pass.setUniform("uSetup",0),_this.canEmit=!0},_proton.behavior.addInput("tSpawn",_pass),_proton.behavior.addInput("tVelocity",_velocity),_proton.shader.addUniforms({tLife:{value:_pass.output}}),_proton.antimatter.addPass(_pass,0),_this.lifeOutput=_pass.output}(),_this.startRender(loop)}(),this.emit=function(position,velocity,color){if(!_this.canEmit)return;if(velocity&&position.length!=velocity.length)throw"Position and velocity need to be the same length";if(color&&position.length!=color.length)throw"Position and color need to be the same length";let count=position.length/3;for(let i=0;i<count;i++){let index=++_index;_index>=_total&&(_index=-1),_life.buffer[4*index+0]=1,_life.buffer[4*index+1]=position[3*i+0],_life.buffer[4*index+2]=position[3*i+1],_life.buffer[4*index+3]=position[3*i+2],velocity&&(_velocity.buffer[3*index+0]=velocity[3*i+0],_velocity.buffer[3*index+1]=velocity[3*i+1],_velocity.buffer[3*index+2]=velocity[3*i+2]),color&&_color&&(_color.buffer[3*index+0]=color[3*i+0],_color.buffer[3*index+1]=color[3*i+1],_color.buffer[3*index+2]=color[3*i+2]),_releasedB.push(index)}_life.needsUpdate=!0,velocity&&(_velocity.needsUpdate=!0),color&&_color&&(_color.needsUpdate=!0)},this.release=function(pos,count=1,radius=0,velocity,color){if(!_this.canEmit)return;let positions=_temp0,velocities=velocity?_temp1:null,colors=color?_temp2:null,radX=Array.isArray(radius)?radius[0]:radius,radY=Array.isArray(radius)?radius[1]:radius,radZ=Array.isArray(radius)?radius[2]:radius;for(let i=0;i<count;i++)pos.spherical?(_vec.set(Math.random(-1,1,4),Math.random(-1,1,4),Math.random(-1,1,4)).normalize().multiplyScalar(radX),positions[3*i+0]=pos.x+_vec.x,positions[3*i+1]=pos.y+_vec.y,positions[3*i+2]=pos.z+_vec.z):(positions[3*i+0]=pos.x+Math.random(-1,1,4)*radX,positions[3*i+1]=pos.y+Math.random(-1,1,4)*radY,positions[3*i+2]=pos.z+Math.random(-1,1,4)*radZ),velocities&&(velocities[3*i+0]=velocity.x,velocities[3*i+1]=velocity.y,velocities[3*i+2]=velocity.z),colors&&(colors[3*i+0]=color.r,colors[3*i+1]=color.g,colors[3*i+2]=color.b);_this.emit(positions,velocities,colors),_temp0.length=0,_temp1.length=0,_temp2.length=0},this.upload=async function(){await(_life?.uploadAsync()),await(_velocity?.uploadAsync())},this.useColor=async function(shader){let colorBuffer=await _proton.antimatter.createFloatArrayAsync(3,!0);_color=_this.initClass(AntimatterAttribute,colorBuffer,3),shader||(shader=_proton.shader),shader.addUniforms({tColor:{value:_color}}),_proton.behavior.addInput("tColor",_color)},this.applyToShader=function(shader){shader.uniforms.tLife=_proton.shader.uniforms.tLife,_velocity&&(shader.uniforms.tVelocity={value:_velocity}),_color&&(shader.uniforms.tColor={value:_color})},this.ready=function(){return this.wait("canEmit")},this.get("total",(_=>_total)),this.get("index",(_=>_index)),this.set("index",(i=>_index=i))})),Class((function AntimatterUtil(){Inherit(this,Component);var _thread,_this=this,_promises={};function createBufferArrayAntimatter(e,id){let size=e.size,num=e.num,position=new Float32Array(size*size*3);if(window.NativeUtils)NativeUtils.fillBufferUV(position,num,size);else for(let i=0;i<num;i++)position[3*i+0]=i%size/size,position[3*i+1]=Math.floor(i/size)/size,position[3*i+2]=i;let{w:w,h:h,d:d}=e.dimensions,usedDepth=num/(size*size),grid=0==w[0]&&0==w[1]&&0==h[0]&&0==h[1];var vertices=new Float32Array(size*size*4);if(window.NativeUtils)grid?NativeUtils.fillBufferGrid(vertices,num,size,usedDepth):NativeUtils.fillBufferRange(vertices,num,w[0],w[1],h[0],h[1],d[0],d[1]);else for(let i=0;i<num;i++)grid?(vertices[4*i+0]=Math.range(i%size,0,size,-1,1),vertices[4*i+1]=Math.range(i/size,size*usedDepth*usedDepth,0,-1,1)):(vertices[4*i+0]=Math.random(w[0],w[1],10),vertices[4*i+1]=Math.random(h[0],h[1],10),vertices[4*i+2]=Math.random(d[0],d[1],10)),vertices[4*i+3]=1;var attribs=new Float32Array(size*size*4);if(window.NativeUtils)NativeUtils.fillBufferRandom(attribs,attribs.length);else for(let i=0;i<num;i++)attribs[4*i+0]=Math.random(0,1,10),attribs[4*i+1]=Math.random(0,1,10),attribs[4*i+2]=Math.random(0,1,10),attribs[4*i+3]=Math.random(0,1,10);resolve({geometry:position,vertices:vertices,attribs:attribs,usedDepth:usedDepth},id,[position.buffer,vertices.buffer,attribs.buffer])}function createFloatArrayAntimatter({size:size},id){let array=new Float32Array(size);resolve({array:array},id,[array.buffer])}this.cache=!0,this.createBufferArray=function(size,num,config={}){let key;if(_thread||function initThread(){_thread=!0,Thread.upload(createBufferArrayAntimatter),Thread.upload(createFloatArrayAntimatter)}(),_this.cache&&(key=`buffer_${JSON.stringify(config)}_${size}_${num}`,_promises[key]))return _promises[key];let promise=Promise.create();return key&&(_promises[key]=promise),Thread.shared().createBufferArrayAntimatter({size:size,num:num,dimensions:config}).then((data=>{data.attribs=new AntimatterAttribute(data.attribs,4),data.vertices=new AntimatterAttribute(data.vertices,4);let geometry=data.geometry;data.geometry=new Geometry,data.geometry.addAttribute("position",new GeometryAttribute(geometry,3)),data.geometry.addAttribute("random",new GeometryAttribute(data.attribs.buffer,4)),promise.resolve(data)})),promise},this.createFloatArray=function(size,freshCopy){if(freshCopy||!_this.cache)return Thread.shared().createFloatArrayAntimatter({size:size});if(_promises["float_size"+size])return _promises["float_size"+size];return _promises["float_size"+size]=Thread.shared().createFloatArrayAntimatter({size:size})}}),"static"),Class((function Audio3D(_options){Inherit(this,Component);const _this=this;var _bindingLabel;const _config=require("Audio3DConfig");function onVisibility(e){_this.context&&GlobalAudio3D.blurs&&(_this.context.visibilityMuted="focus"!==e.type)}!function initContext(){_options||(_options={}),GlobalAudio3D.native?(window._al&&(_this.context=_this.initClass(Audio3DALBuffer)),window.AVFSound&&(_this.context=_this.initClass(Audio3DNBuffer,"AVF")),window.MPAudio&&(_options.stream?_this.context=_this.initClass(Audio3DNBuffer,"MP"):_this.context=_this.initClass(Audio3DNBuffer,"GVR"))):_options.fallback||GlobalAudio3D.fallback?_this.context=_this.initClass(Audio3DFallback):_options.positional&&GlobalAudio3D.resonanceAudio?_this.context=_this.initClass(Audio3DResonanceAudio):_options.simpleBuffer&&"ie"!==Device.system.browser?_this.context=_this.initClass(Audio3DWASimpleBuffer):!0!==_options.stream&&"ie"!==Device.system.browser?_this.context=_this.initClass(Audio3DWABuffer):_this.context=_this.initClass(Audio3DWAStream)}(),function initInterface(){for(let command of _config.commands)_this[command]=_this.context[command];for(let setter of _config.setters)_this.set(setter,(e=>{_this.context&&(_this.context[setter]=e)}));for(let getter of _config.getters)_this.get(getter,(_=>{if(_this.context)return _this.context[getter]}))}(),function addHandlers(){_this.events.sub(_this.context,Events.END,(e=>_this.events.fire(Events.END,e))),_this.events.sub(_this.context,Events.LOADED,(e=>_this.events.fire(Events.LOADED,e))),_this.events.sub(Events.VISIBILITY,onVisibility)}(),function initOptions(){if(_options){for(let option in _options)_config.setters.includes(option)&&(_this.context[option]=_options[option]);_options.label&&(_bindingLabel=GlobalAudio3D.getLabelState(_options.label).bind("mute",(async bool=>{if(!_this.context)return _bindingLabel.destroy();_this.context.muted=bool})))}}(),this.tween=function(){return tween(_this,...arguments)},this.clone=function(){return new Audio3D(_options)},this.onDestroy=function(){_this.context.unload(),_bindingLabel?.destroy?.()}})),Class((function Audio3DLayer(...args){Inherit(this,Component);const _this=this;var _group,_input,_mesh,_audio3D,_config,_key,_autoplay,_volume={value:0};async function fadeIn(){await _this.wait("init"),_this._invisible||_this.delayedCall((()=>{if(_audio3D.play(),0!=_config.getNumber("fadeInTime")){_volume.value=0,_audio3D.volume=0,tween(_volume,{value:_config.getNumber("volume")},_config.getNumber("fadeInTime"),"easeOutExpo").onUpdate((()=>{_audio3D.volume=_volume.value}))}}),_config.getNumber("delay"))}async function fadeOut(){if(await _this.wait("init"),0!=_config.getNumber("fadeOutTime")){_volume.value=_config.getNumber("volume"),tween(_volume,{value:0},_config.getNumber("fadeOutTime"),"easeOutExpo",0,(()=>{_audio3D.context&&_audio3D.context.stream&&Audio3DWA.getActiveStreamCount(_audio3D.context.stream)>1||_audio3D.pause()})).onUpdate((()=>{_audio3D.volume=_volume.value}))}else{if(_audio3D.context&&_audio3D.context.stream&&Audio3DWA.getActiveStreamCount(_audio3D.context.stream)>1)return;_audio3D.pause()}}!function parseArgs(){args.forEach((arg=>{switch(Utils.getConstructorName(arg)){case"InputUILConfig":_input=arg;break;case"UILFolder":_group=arg;break;case"Mesh":_mesh=arg,_this.parent=_mesh,_mesh.audioCount?_mesh.audioCount++:_mesh.audioCount=1,_mesh.findSound||(_mesh.findSound=async function(key){if(Array.isArray(_mesh.scriptClass))for(let scriptClass of _mesh.scriptClass)if(await scriptClass.key==key)return scriptClass})}})),_this.visible=_input.get("visible")}(),function initConfig(){let config=InputUIL.create(_input.prefix+"audio3dLayer"+(_mesh?_mesh.audioCount:""),_group);config.add("path").add("key").add("label").addToggle("autoplay",!1).addToggle("loop",!1).addToggle("stream",!1).addToggle("positional",!1).addNumber("volume",1).addNumber("fadeInTime",0).addNumber("fadeOutTime",0).addNumber("delay",0).setLabel("Audio"),config.addButton("preview",{label:"Preview",actions:[{title:"Play",callback:fadeIn},{title:"Stop",callback:fadeOut}]}),_config=config}(),async function initAudio(){GlobalAudio3D.initialized||await GlobalAudio3D.interacted,_key=_config.get("key"),_autoplay=_config.get("autoplay");let path=_config.get("path");path&&(_audio3D=_this.initClass(Audio3D,{src:path,autoplay:!1,volume:_config.getNumber("volume"),loop:_config.get("loop"),stream:_config.get("stream"),positional:_config.get("positional"),label:_config.get("label")}),_mesh&&_config.get("positional")&&_mesh.add(_audio3D.group),_this.flag("init",!0))}(),_this.startRender((()=>{})),this.get("audio",(()=>_audio3D)),this.play=function(){fadeIn()},this.stop=function(){fadeOut()},this.get("key",(async()=>(await _this.wait("init"),_key))),this.onVisible=async function(){await _this.wait("init"),_audio3D&&_autoplay&&fadeIn()},this.onInvisible=async function(){await _this.wait("init"),_audio3D&&fadeOut()}})),Class((function GlobalAudio3D(){Inherit(this,Component);const _this=this;var _volume=1,_muted=!1,_blurs=!0,_playbackRate=1,_poolSize=3,_interacted=Promise.create(),_labelStates={};function initInteraction(e){e&&e.preventDefault&&e.preventDefault(),document.removeEventListener(Device.mobile?"touchend":"mouseup",initInteraction,{passive:!1}),Audio3DWA.createPool(_poolSize),Audio3DWA.purge(),_this.initialized=!0,_this.events.fire(Events.READY),_interacted.resolve()}this.native=!1,this.TRANSPARENT=0,this.ACOUSTIC_CEILING_TILES=1,this.BRICK_BARE=2,this.BRICK_PAINTED=3,this.CONCRETE_BLOCK_COARSE=4,this.CONCRETE_BLOCK_PAINTED=5,this.CURTAIN_HEAVY=6,this.FIBER_GLASS_INSULATION=7,this.GLASS_THICK=8,this.GLASS_THIN=9,this.GRASS=10,this.LINOLEUM_ON_CONCRETE=11,this.MARBLE=12,this.METAL=13,this.PARQUET_ON_CONCRETE=14,this.PLASTER_ROUGH=15,this.PLASTER_SMOOTH=16,this.PLYWOOD_PANEL=17,this.POLISHED_CONCRETE_OR_TILE=18,this.SHEET_ROCK=19,this.WATER_OR_ICE_SURFACE=20,this.WOOD_CEILING=21,this.WOOD_PANEL=22,this.LOW=0,this.MED=1,this.HIGH=2,this.RESONANCE_AUDIO="resonance_audio",this.quality=this.HIGH,async function(){await defer(),window.AURA&&function initNative(){_this.native=!0,!window._al||Audio3DAL.init();_this.initialized=!0,_interacted.resolve()}(),function initDebug(){Hydra.LOCAL&&Utils.query("audioDebug")&&(AudioNode.prototype.connect=(func=AudioNode.prototype.connect,function(){var target=arguments[0];return(this.outputs||(this.outputs=[])).push(arguments[0]),(target.inputs||(target.inputs=[])).push(this),func.apply(this,arguments)}));var func}()}(),this.set("volume",(v=>{_volume=v,_this.events.fire(Events.UPDATE,{volume:_volume})})),this.get("volume",(_=>_volume)),this.set("muted",(v=>{_muted=v,_this.events.fire(Events.UPDATE,{muted:_muted})})),this.get("muted",(_=>_muted)),this.set("blurs",(v=>{_blurs=v,_this.events.fire(Events.UPDATE,{blurs:_blurs})})),this.get("blurs",(_=>_blurs)),this.set("playbackRate",(v=>{_playbackRate=v,_this.events.fire(Events.UPDATE,{playbackRate:_playbackRate})})),this.get("playbackRate",(_=>_playbackRate)),this.get("pool",(_=>_poolSize)),this.set("pool",(n=>{_poolSize=n})),this.get("interacted",(_=>_interacted)),this.get("fallback",(_=>"ie"===Device.system.browser&&Device.system.browserVersion<=11)),this.setup=function(type="default"){Utils.query("muted")&&Hydra.LOCAL&&(_muted=!0),document.addEventListener(Device.mobile?"touchend":"mouseup",initInteraction,{passive:!1}),"resonance_audio"!=type||_this.native||(_this.resonanceAudio=!0,AssetLoader.loadAssets(["assets/js/lib/_resonance/resonance-audio.min.js"]))},this.ready=function(){return _this.wait(_this,"initialized")},this.enableRoom=function(bool){window.GVRAudio&&GVRAudio.enableRoom(bool)},this.setRoomProperties=function(x,y,z,wall,ceiling,floor){window.GVRAudio&&GVRAudio.setRoomProperties(x,y,z,wall,ceiling,floor)},this.setRoomReverbAdjustments=function(gain,time,brightness){window.GVRAudio&&GVRAudio.setRoomReverbAdjustments(gain,time,brightness)},this.muteLabel=function(label){_this.getLabelState(label).set("mute",!0)},this.unmuteLabel=function(label){_this.getLabelState(label).set("mute",!1)},this.getLabelState=function(label){return _labelStates[label]||(_labelStates[label]=AppState.createLocal()),_labelStates[label]}}),"static"),Module((function Audio3DConfig(){this.exports={getters:["playbackRate","loop","autoplay","volume","rolloff","preload","visibilityMuted","selfDestruct","src","frequency","group","duration","currentTime","activity","playing","filter","panner","delay","progress","reverb"],setters:["playbackRate","loop","autoplay","volume","rolloff","preload","visibilityMuted","selfDestruct","src"],commands:["play","pause","stop","seek","load","unload","convolve"]}})),Module((function Audio3DSilence(){this.exports="data:audio/mpeg;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAADAAAGhgBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVWqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr///////////////////////////////////////////8AAAA5TEFNRTMuOThyAc0AAAAAAAAAABSAJAiqQgAAgAAABobxtI73AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQxAACFEII9ACZ/sJZwWEoEb8w/////N//////JcxjHjf+7/v/H2PzCCFAiDtGeyBCIx7bJJ1mmEEMy6g8mm2c8nrGABB4h2Mkmn//4z/73u773R5qHHu/j/w7Kxkzh5lWRWdsifCkNAnY9Zc1HvDAhjhSHdFkHFzLmabt/AQxSg2wwzLhHIJOBnAWwVY4zrhIYhhc2kvhYDfQ4hDi2Gmh5KyFn8EcGIrHAngNgIwVIEMf5bzbAiTRoAD///8z/KVhkkWEle6IX+d/z4fvH3BShK1e5kmjkCMoxVmXhd4ROlTKo3iipasvTilY21q19ta30/v/0/idPX1v8PNxJL6ramnOVsdvMv2akO0iSYIzdJFirtzWXCZicS9vHqvSKyqm5XJBdqBwPxyfJdykhWTZ0G0ZyTZGpLKxsNwwoRhsx3tZfhwmeOBVISm3impAC/IT/8hP/EKEM1KMdVdVKM2rHV4x7HVXZvbVVKN/qq8CiV9VL9jjH/6l6qf7MBCjZmOqsAibjcP+qqqv0oxqpa/NVW286hPo1nz2L/h8+jXt//uSxCmDU2IK/ECN98KKtE5IYzNoCfbw+u9i5r8PoadUMFPKqWL4LK3T/LCraMSHGkW4bpLXR/E6LlHOVQxmslKVJ8IULktMN06N0FKCpHCoYsjC4F+Z0NVqdNFoGSTjSiyjzLdnZ2fNqTi2eHKONONKLMPMKLONKLMPQRJGlFxZRoKcJFAYEeIFiRQkUWUeYfef//Ko04soswso40UJAgMw8wosososy0EalnZyjQUGBRQGIFggOWUacWUeYmuadrZziQKKEgQsQLAhQkUJAgMQDghltLO1onp0cpkNInSFMqlYeSEJ5AHsqFdOwy1DA2sRmRJKxdKRfLhfLw5BzUxBTUUzLjk4LjJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVUxBTUUzLjk4LjJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/7ksRRA8AAAaQAAAAgAAA0gAAABFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU="})),Class((function Audio3DBase(){Inherit(this,Object3D);const _this=this;var _quaternion,_euler,_position=new Vector3;this.audioPosition=function(){return _position=_this.group._parent?_this.group.getWorldPosition():Audio3DWA.getCamera().getWorldPosition()},this.audioPositionInverse=function(){return _position=_this.audioPosition(),_this.group._parent&&_position.applyMatrix4(Audio3DWA.getCamera().matrixWorldInverse),_position},this.audioOrientationInverse=function(){return _quaternion||(_quaternion=new Quaternion,_euler=new Euler),_this.group.parent?(_this.group.getWorldQuaternion(_quaternion),_euler.setFromQuaternion(_quaternion)):_euler.set(0,0,0),_euler},this.listenerPosition=function(){return _this.group._parent&&(_position=Audio3DWA.getCamera().getWorldPosition()),_position}})),Class((function Audio3DAL(){Inherit(this,Component);const _this=this;var _cam,_vec,_map={},_orientation=[];function loop(){_vec&&_cam&&(_vec.set(0,0,-1).applyQuaternion(_cam.quaternion),_orientation[0]=_vec.x,_orientation[1]=_vec.y,_orientation[2]=_vec.z,_orientation[3]=_cam.up.x,_orientation[4]=_cam.up.y,_orientation[5]=_cam.up.z,_al.Listener3f(_al.AL_POSITION,_cam.position.x,_cam.position.y,_cam.position.z),_al.Listener3f(_al.AL_VELOCITY,0,0,0),_al.Listenerfv(_al.AL_ORIENTATION,_orientation))}function getLengthInSec(buffer){let size=_al.GetBufferi(buffer,_al.AL_SIZE),bits=_al.GetBufferi(buffer,_al.AL_BITS);return size/_al.GetBufferi(buffer,_al.AL_CHANNELS)/(bits/8)/_al.GetBufferi(buffer,_al.AL_FREQUENCY)}this.init=function(){},this.audioContext=function(){_vec=new Vector3,_cam=World.CAMERA,_this.startRender(loop)},this.loadBuffer=async function(url){if(_map[url]){let obj=_map[url];return obj.count++,obj}let buffer=await _al.convertToBuffer(url);return _map[url]={buffer:buffer,length:getLengthInSec(buffer),count:1},_map[url]},this.deleteBuffer=function(url){let obj=_map[url];obj&&(obj.count--,obj.count<=0&&delete _map[url])}}),"static"),Class((function Audio3DALBuffer(){Inherit(this,Audio3DBase);const _this=this;var _source,_length,_filter,_convolver,_delay,_reverb,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(t,dt){if(_source){if((_currentTime+=dt/1e3)>=_length)return void(_options.loop?_this.seek(0):(_this.events.fire(Events.END),_this.stop(),_options.selfDestruct&&_this.parent.destroy()));let pos=_this.audioPosition();_al.Source3f(_source,_al.AL_POSITION,pos.x,pos.y,pos.z)}}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}Audio3DAL.audioContext(),function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_filter||(_filter=_this.initClass(Audio3DALFilter)),_delay||(_delay=_this.initClass(Audio3DALDelay)),_convolver||(_convolver=_this.initClass(Audio3DALConvolver)),_reverb||(_reverb=_this.initClass(Audio3DALReverb))}(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update)}(),this.set("src",(src=>{_this.stop(),_settings.src=src,defer((_=>{if(_options.autoplay)return _this.play();_this.volume=_options.volume}))})),this.get("src",(_=>_settings.src)),this.get("selfDestruct",(_=>_options.selfDestruct)),this.set("selfDestruct",(d=>{_options.selfDestruct=d})),this.set("volume",(v=>(_options.volume=v,void 0!==_source&&_al.Sourcef(_source,_al.AL_GAIN,v),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,void 0!==_source&&_al.Sourcei(_source,_al.AL_LOOPING,l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("frequency",(_=>[])),this.get("activity",(_=>0)),this.get("playing",(_=>_settings.playing)),this.set("rolloff",(r=>{_options.rolloff=r})),this.get("rolloff",(_=>_options.rolloff)),this.get("loaded",(_=>_settings.loaded)),this.get("currentTime",(_=>_currentTime)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("duration",(_=>_length||0)),this.get("progress",(_=>_this.currentTime/_this.duration)),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted&&(_options.muteState=_options.muted),!1===muted&&1!=_options.muteState&&(_options.muted=muted,_this.volume=_this.volume),!1===muted&&delete _options.muteState})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.set("playbackRate",(v=>{_options.playbackRate=v,void 0!==_source&&_al.Sourcef(_source,_al.AL_PITCH,v)})),this.get("playbackRate",(_=>_options.playbackRate)),this.get("filter",(_=>_filter)),this.get("delay",(_=>_delay)),this.get("reverb",(_=>_reverb)),this.play=async function(){_settings.autoplay=!0,_settings.src&&(_settings.loadingPlay=!0,_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),_settings.playing=!0,_this.volume=_options.volume,_this.playbackRate=_options.playbackRate,_this.startRender(loop),_al.SourcePlay(_source),_al.Sourcei(_source,_al.AL_SEC_OFFSET,_currentTime),_reverb&&(_reverb.source=_source),_convolver&&(_convolver.source=_source),_filter&&(_filter.source=_source),_delay&&(_delay.source=_source)))},this.pause=function(){_settings.autoplay=!1,_settings.src&&_settings.loaded&&_settings.playing&&(_settings.loadingPlay=!1,_settings.playing=!1,void 0!==_source&&_al.SourcePause(_source),_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.loaded&&(_currentTime=0,void 0!==_source&&_al.SourceStop(_source),_settings.playing=!1,_this.stopRender(loop))},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_currentTime=Math.min(_length,Math.max(0,time)),_this.stop(),wasPlaying&&_this.play()}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await async function createBuffer(){_al.Listener3f(_al.AL_POSITION,0,0,0),_al.Listener3f(_al.AL_VELOCITY,0,0,0),_source=_al.GenSources(1)[0];let{buffer:buffer,length:length}=await Audio3DAL.loadBuffer(_settings.src);_al.Sourcei(_source,_al.AL_BUFFER,buffer),_length=length}(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),_al.DeleteSources([_source]),Audio3DAL.deleteBuffer(_settings.src))},this.convolve=async function(src){return _convolver||(_convolver=_this.initClass(Audio3DALConvolver)),_source&&(_convolver.source=_source),_convolver.src=src,_convolver}})),Class((function Audio3DALParam(_config={}){Inherit(this,Component);const _this=this,PROPS=["automationRate","defaultValue","maxValue","minValue","value"];!function initGetters(){for(let prop of PROPS)_this.get(prop,(_=>_this["_"+prop]))}(),function initSetters(){for(let prop of PROPS)_this.set(prop,(value=>{if(_this["_"+prop]===value)return;_this["_"+prop]=value;let e={};e[prop]=value,_this.events.fire(Events.UPDATE,e)}))}(),function initDefaults(){for(let prop in _config)PROPS.includes(prop)&&(_this[prop]=_config[prop])}(),this.update=function(){let obj={};for(let prop of PROPS)obj[prop]=_this[prop];_this.events.fire(Events.UPDATE,obj)}})),Class((function Audio3DALConvolver(){Inherit(this,Component);this.get("numberOfInputs",(_=>1)),this.get("numberOfOutputs",(_=>1)),this.get("channelCount",(_=>2)),this.get("channelCountMode",(_=>"max")),this.get("channelInterpretation",(_=>"speakers"))})),Class((function Audio3DALDelay(){Inherit(this,Component);const _this=this;var _source;function onDelayTimeUpdate(e){}!function initDelayTime(){_this.delayTime=_this.initClass(Audio3DALParam,{automationRate:"a-rate",defaultValue:0,maxValue:1,minValue:0,value:0})}(),function addHandlers(){_this.events.sub(_this.delayTime,Events.UPDATE,onDelayTimeUpdate)}(),this.get("numberOfInputs",(_=>1)),this.get("numberOfOutputs",(_=>1)),this.get("channelCount",(_=>2)),this.get("channelCountMode",(_=>"max")),this.get("channelInterpretation",(_=>"speakers")),this.set("source",(source=>{_source=source})),this.get("source",(_=>_source))})),Class((function Audio3DALFilter(){Inherit(this,Component);const _this=this;var _type,_source,_filter;const ENABLED=_al.EFXEnabled();function onUpdate(){!function initFilter(){_filter||(_filter=_al.GenFilters(1)[0])}(),function applyType(){let t;t=_al.AL_FILTER_LOWPASS;t&&_al.Filteri(_filter,_al.AL_FILTER_TYPE,t)}(),function applyFrequency(){let type,v=_this.frequency.value,value=1;value=Math.range(v,_this.frequency.minValue,_this.frequency.maxValue,0,1,!0),type=_al.AL_LOWPASS_GAINHF;type&&_al.Filterf(_filter,type,value)}(),function applyGain(){let type,value=Math.range(_this.gain.value,_this.gain.minValue,_this.gain.maxValue,0,1,!0);type=_al.AL_LOWPASS_GAIN;type&&_al.Filterf(_filter,type,value)}(),function applyFilter(){_source&&ENABLED&&_al.Sourcei(_source,_al.AL_DIRECT_FILTER,_filter)}()}!function initDetune(){_this.detune=_this.initClass(Audio3DALParam,{automationRate:"a-rate",defaultValue:0,maxValue:Math.pow(2,128),minValue:-Math.pow(2,128),value:0})}(),function initFrequency(){_this.frequency=_this.initClass(Audio3DALParam,{automationRate:"a-rate",defaultValue:350,maxValue:24e3,minValue:0,value:350})}(),function initGain(){_this.gain=_this.initClass(Audio3DALParam,{automationRate:"a-rate",defaultValue:0,maxValue:Math.pow(2,128),minValue:-Math.pow(2,128),value:0})}(),function addHandlers(){_this.events.sub(_this.detune,Events.UPDATE,onUpdate),_this.events.sub(_this.frequency,Events.UPDATE,onUpdate),_this.events.sub(_this.gain,Events.UPDATE,onUpdate)}(),this.set("type",(type=>{_type=type,onUpdate()})),this.get("type",(_=>_type)),this.get("numberOfInputs",(_=>1)),this.get("numberOfOutputs",(_=>1)),this.get("channelCount",(_=>2)),this.get("channelCountMode",(_=>"max")),this.get("channelInterpretation",(_=>"speakers")),this.set("source",(source=>{_source=source;for(let prop of["detune","frequency","gain"])_this[prop].update()})),this.get("source",(_=>_source)),this.onDestroy=function(){_filter&&_al.DeleteFilters([_filter])}})),Class((function Audio3DALReverb(){Inherit(this,Component);const _this=this,MAP=[{prop:"density",al:"AL_REVERB_DENSITY",update:"Effectf",value:1,min:0,max:1},{prop:"diffusion",al:"AL_REVERB_DIFFUSION",update:"Effectf",value:1,min:0,max:1},{prop:"gain",al:"AL_REVERB_GAIN",update:"Effectf",value:.83,min:0,max:1},{prop:"gainHF",al:"AL_REVERB_GAINHF",update:"Effectf",value:.83,min:.1,max:2},{prop:"decayTime",al:"AL_REVERB_DECAY_TIME",update:"Effectf",value:1.49,min:.1,max:20},{prop:"decayHF",al:"AL_REVERB_DECAY_HFRATIO",update:"Effectf",value:.83,min:.1,max:2},{prop:"reflectionsGain",al:"AL_REVERB_REFLECTIONS_GAIN",update:"Effectf",value:.05,min:0,max:3.16},{prop:"reflectionsDelay",al:"AL_REVERB_REFLECTIONS_DELAY",update:"Effectf",value:.007,min:0,max:.3},{prop:"lateGain",al:"AL_REVERB_LATE_REVERB_GAIN",update:"Effectf",value:1.26,min:0,max:10},{prop:"lateDelay",al:"AL_REVERB_LATE_REVERB_DELAY",update:"Effectf",value:.011,min:0,max:.1},{prop:"airAbsorptionGainHF",al:"AL_REVERB_AIR_ABSORPTION_GAINHF",update:"Effectf",value:.994,min:.892,max:1},{prop:"roomRolloff",al:"AL_REVERB_ROOM_ROLLOFF_FACTOR",update:"Effectf",value:0,min:0,max:10}];var _slot,_effect,_source,_enabled=_al.EFXEnabled&&_al.EFXEnabled();function onUpdate(){!function initEffect(){_enabled&&(_slot||(_slot=_al.GenAuxiliaryEffectSlots(1)[0]),_effect||(_effect=_al.GenEffects(1)[0]),_al.Effecti(_effect,_al.AL_EFFECT_TYPE,_al.AL_EFFECT_REVERB))}(),function applyProps(){if(!_enabled)return;for(let item of MAP){let i=_this[item.prop],v=Math.clamp(i.value,i.minValue,i.maxValue);_al[item.update](_effect,_al[item.al],v)}}(),function applyEffect(){if(!_enabled)return;_al.AuxiliaryEffectSloti(_slot,_al.AL_EFFECTSLOT_EFFECT,_effect),_source&&_al.Source3i(_source,_al.AL_AUXILIARY_SEND_FILTER,_slot,0,_al.AL_FILTER_NULL)}()}!function initProps(){for(let item of MAP)_this[item.prop]=_this.initClass(Audio3DALParam,{value:item.value,maxValue:item.max,minValue:item.min})}(),function addHandlers(){for(let item of MAP)_this.events.sub(_this[item.prop],Events.UPDATE,onUpdate)}(),this.set("source",(source=>{_source=source,onUpdate()})),this.get("source",(_=>_source)),this.onDestroy=function(){_effect&&_al.DeleteEffects([_effect]),_slot&&_al.AuxiliaryEffectSlots([_slot])}})),Class((function Audio3DFallback(){Inherit(this,Audio3DBase);const _this=this;var _stream,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){initOptions(),(_settings.autoplay||_options.autoplay)&&_this.play()}initOptions(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready)}(),this.set("src",(src=>{_this.unload(),function destroyStream(){_stream&&_stream.element&&GlobalAudio3D.ready&&(Audio3DWA.unloadStream(_settings.src),_stream=null)}(),_settings.src=src})),this.get("src",(_=>_settings.src)),this.set("volume",(v=>(v=Math.clamp(v,0,1),_options.volume=v,_stream&&_stream.element&&(_stream.element.volume=_options.muted||_options.globalMuted?0:v*_options.globalVolume),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,_stream&&(_stream.element.loop=l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("frequency",(_=>0)),this.get("activity",(_=>0)),this.get("playing",(_=>_settings.playing)),this.set("rolloff",(r=>{})),this.get("rolloff",(_=>0)),this.get("loaded",(_=>!0)),this.get("duration",(_=>_stream?_stream.element.duration:0)),this.get("currentTime",(_=>_stream?_stream.element.currentTime:0)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("progress",(_=>_this.currentTime/_this.duration)),this.set("playbackRate",(v=>{_options.playbackRate=v,_stream&&_stream.element&&(_stream.element.playbackRate=v*_options.globalPlaybackRate)})),this.get("playbackRate",(_=>_options.playbackRate)),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted&&(_options.muteState=_options.muted),!1===muted&&1!=_options.muteState&&(_options.muted=muted,_this.volume=_this.volume),!1===muted&&delete _options.muteState})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.play=function(){if(_settings.autoplay=!0,_settings.src&&GlobalAudio3D.ready&&(function createStream(){!_stream&&GlobalAudio3D.ready&&((_stream=Audio3DWA.loadStream(_settings.src)).element.onended=_=>{_this.unload(),_this.events.fire(Events.END)},_this.loop=_this.loop,_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,(_options.autoplay||_settings.autoplay)&&_this.play())}(),!0!==_settings.playing&&(_settings.playing=!0,_this.volume=_options.volume,_stream))){_stream.element.playbackRate=_options.playbackRate,_stream.element.play();try{_stream.element.currentTime=_currentTime}catch(e){}}},this.pause=function(){if(_settings.autoplay=!1,_stream&&GlobalAudio3D.ready&&_settings.src&&_settings.playing){try{_currentTime=_stream.element.currentTime}catch(e){}_stream.element.pause(),_settings.playing=!1}},this.stop=function(){if(_settings.autoplay=!1,_settings.src&&GlobalAudio3D.ready&&(_currentTime=0,_settings.playing=!1,_stream&&_stream.element&&_stream.element.stop)){_stream.element.stop();try{_stream.element.currentTime=0}catch(e){}}},this.seek=function(time){if(_settings.src&&(_currentTime=time,_stream&&_stream.element))try{_stream.element.currentTime=time}catch(e){}},this.load=function(){return!0},this.unload=function(){_settings.autoplay=!1,_stream&&GlobalAudio3D.ready&&_settings.src&&_this.stop()},this.convolve=function(src){}})),Class((function Audio3DN(){Inherit(this,Component);const _this=this;var _init;function loop(){window.GVRAudio&&(GVRAudio.setHeadPos(World.CAMERA.position.x,World.CAMERA.position.y,World.CAMERA.position.z),GVRAudio.setHeadRotation(World.CAMERA.quaternion.x,World.CAMERA.quaternion.y,World.CAMERA.quaternion.z,World.CAMERA.quaternion.w))}this.audioContext=function(){window.GVRAudio&&!_init&&(GVRAudio.initEngine(GlobalAudio3D.quality),_init=!0,_this.startRender(loop))}}),"static"),Class((function Audio3DNBuffer(_backingType){Inherit(this,Audio3DBase);const _this=this;var _backing,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(){let pos,orientation;switch(_backingType){case"AVF":pos=_this.audioPositionInverse(),orientation=_this.audioOrientationInverse();break;case"GVR":pos=_this.audioPosition()}pos&&_backing&&(_backing.setPos(pos.x,pos.y,pos.z),orientation&&_backing.setOrientation(orientation.x,orientation.y,orientation.z,0,1,0))}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}Audio3DN.audioContext(),function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update)}(),this.set("src",(src=>{_this.stop(),_settings.src=src,defer((_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_options.volume}))})),this.get("src",(_=>_settings.src)),this.get("selfDestruct",(_=>_options.selfDestruct)),this.set("selfDestruct",(d=>{_options.selfDestruct=d})),this.set("volume",(v=>(_options.volume=v,_backing&&_backing.volume(v),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,_backing&&_backing.loop(l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("frequency",(_=>[])),this.get("activity",(_=>0)),this.get("playing",(_=>_settings.playing)),this.set("rolloff",(r=>{_options.rolloff=r})),this.get("rolloff",(_=>_options.rolloff)),this.get("loaded",(_=>_settings.loaded)),this.get("currentTime",(_=>_currentTime)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("duration",(_=>0)),this.get("progress",(_=>_this.currentTime/_this.duration)),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted&&(_options.muteState=_options.muted),!1===muted&&1!=_options.muteState&&(_options.muted=muted,_this.volume=_this.volume),!1===muted&&delete _options.muteState})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.set("playbackRate",(v=>{_options.playbackRate=v,_backing&&_backing.setRate(v)})),this.get("playbackRate",(_=>_options.playbackRate)),this.play=async function(){_settings.autoplay=!0,_settings.src&&(_settings.loadingPlay=!0,_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),_settings.playing=!0,_this.volume=_options.volume,_this.playbackRate=_options.playbackRate,_this.startRender(loop),_backing.seek(_currentTime),_backing.play(_options.loop)))},this.pause=function(){_settings.autoplay=!1,_settings.src&&_settings.loaded&&_settings.playing&&(_currentTime=_currentTime,_settings.loadingPlay=!1,_settings.playing=!1,_backing&&_backing.pause(),_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.loaded&&(_currentTime=0,_backing&&_backing.stop(),_settings.playing=!1,_this.stopRender(loop))},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_currentTime=time,_backing&&(_backing.seek(_currentTime),wasPlaying&&_backing.play())}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await function createBuffer(){let promise=Promise.create(),url=_settings.src;switch(url.includes("http")||(url=AURA.rootPath+url),_backingType){case"AVF":_backing=AVFSound.create(url);break;case"MP":_backing=new MPAudio(url);break;case"GVR":_backing=new GVRAudio(url)}return _backing.onComplete=_=>{_this.events.fire(Events.END),_options.selfDestruct&&_this.parent.destroy()},_backing.onUpdate=t=>{_currentTime=t},_backing.onReady=promise.resolve,promise}(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),_backing.destroy())},this.convolve=async function(src){}})),Class((function Audio3DResonance(){Inherit(this,Component);require("Audio3DSilence");var _context,_resonance,_orientation,_cam,_streams={};function loop(){(_cam=Audio3DWA.getCamera())&&_context&&_context.listener&&(_orientation.set(0,0,-1).applyQuaternion(_cam.quaternion),_resonance.setListenerOrientation(_orientation.x,_orientation.y,_orientation.z,_cam.up.x,_cam.up.y,_cam.up.z),_resonance.setListenerPosition(_cam.position.x,_cam.position.y,_cam.position.z))}this.createAudioInput=async function(url){let isElement="string"!=typeof url,element=null;if(isElement&&(element=url,url=element.src?element.src:element.srcObject?element.srcObject.id:""),!_streams[url]){let stream={};isElement?(stream.element=element,element.setAttribute("muted",!0),element.muted=!0):(stream.element=await Audio3DWA.getElement(),stream.element.crossOrigin="anonymous",stream.element.src=url);let audioElementSource=_context.createMediaElementSource(stream.element),source=_resonance.createSource();audioElementSource.connect(source.input),stream.source=source,_streams[url]=stream}return _streams[url]},this.resonance=async function(refresh){return window.ResonanceAudio||await AssetLoader.waitForLib("ResonanceAudio"),await GlobalAudio3D.ready(),_context&&!refresh||(_context&&(_context.close(),_context=null),_orientation=new Vector3,(_context=new(window.AudioContext||window.webkitAudioContext)).dest=_context.createMediaStreamDestination(),(_resonance=new ResonanceAudio(_context)).output.connect(_context.destination),Render.start(loop)),_resonance},this.setRoomProperties=function(dimensions,materials){_resonance.setRoomProperties(dimensions,materials)}}),"static"),Class((function Audio3DResonanceAudio(){Inherit(this,Audio3DBase);const _this=this;var _stream,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(){let pos;pos=_this.audioPosition(),pos&&_stream&&_stream.source.setPosition(pos.x,pos.y,pos.z)}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}!async function(){await Audio3DResonance.resonance(),function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update)}()}(),this.set("src",(src=>{_this.stop(),_settings.src=src,defer((_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_options.volume,_stream&&(_stream.element.volume=_this.volume)}))})),this.get("src",(_=>_settings.src)),this.get("selfDestruct",(_=>_options.selfDestruct)),this.set("selfDestruct",(d=>{_options.selfDestruct=d})),this.set("volume",(v=>(_options.volume=v,_stream&&(_stream.element.volume=v),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,_stream&&(_stream.element.loop=l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("frequency",(_=>[])),this.get("activity",(_=>0)),this.get("playing",(_=>_settings.playing)),this.set("rolloff",(r=>{_options.rolloff=r})),this.get("rolloff",(_=>_options.rolloff)),this.get("loaded",(_=>_settings.loaded)),this.get("currentTime",(_=>_currentTime)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("duration",(_=>_stream?_stream.element.duration:0)),this.get("progress",(_=>_this.currentTime/_this.duration)),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted&&(_options.muteState=_options.muted),!1===muted&&1!=_options.muteState&&(_options.muted=muted,_this.volume=_this.volume),!1===muted&&delete _options.muteState})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.set("playbackRate",(v=>{_options.playbackRate=v})),this.get("playbackRate",(_=>_options.playbackRate)),this.play=async function(){_settings.autoplay=!0,_settings.src&&(_settings.loadingPlay=!0,_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),_settings.playing=!0,_this.volume=_options.volume,_this.playbackRate=_options.playbackRate,_this.startRender(loop),_stream.element.currentTime=_currentTime,_stream.element.play()))},this.pause=function(){_settings.autoplay=!1,_settings.src&&_settings.loaded&&_settings.playing&&(_currentTime=_currentTime,_settings.loadingPlay=!1,_settings.playing=!1,_stream&&_stream.element.pause(),_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.loaded&&(_currentTime=0,_stream&&(_stream.element.pause(),_stream.element.currentTime=0),_settings.playing=!1,_this.stopRender(loop))},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_currentTime=time,_stream&&(_stream.element.seek(_currentTime),wasPlaying&&_stream.element.play())}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await async function createBuffer(){let promise=Promise.create(),url=_settings.src;return(_stream=await Audio3DResonance.createAudioInput(url)).element.onended=_=>{_this.unload(),_this.events.fire(Events.END)},_this.loop=_this.loop,_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_stream.element.currentTime=_currentTime,_stream.element.volume=_this.volume,_stream.element.onloadeddata=promise.resolve,(_options.autoplay||_settings.autoplay)&&_this.play(),promise}(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&_this.stop()}})),Class((function Audio3DWA(){Inherit(this,Component);const _this=this,_silence=require("Audio3DSilence");var _context,_orientation,_cam,_pool,_streams={},_buffers={};function loop(){(_cam=_this.getCamera())&&_cam.getWorldQuaternion&&_context&&_context.listener&&(_orientation.set(0,0,-1).applyQuaternion(_cam.getWorldQuaternion()),_context.listener.forwardX?(_context.listener.forwardX.setValueAtTime(_orientation.x,_context.currentTime),_context.listener.forwardY.setValueAtTime(_orientation.y,_context.currentTime),_context.listener.forwardZ.setValueAtTime(_orientation.z,_context.currentTime),_context.listener.upX.setValueAtTime(_cam.up.x,_context.currentTime),_context.listener.upY.setValueAtTime(_cam.up.y,_context.currentTime),_context.listener.upZ.setValueAtTime(_cam.up.z,_context.currentTime)):(_context.listener.setOrientation&&_context.listener.setOrientation(_orientation.x,_orientation.y,_orientation.z,_cam.up.x,_cam.up.y,_cam.up.z),_context.listener.setPosition&&_context.listener.setPosition(_cam.position.x,_cam.position.y,_cam.position.z),_context.listener.setVelocity&&_context.listener.setVelocity(0,0,0)))}function createAudioElement(){let audio;return GlobalAudio3D.fallback?(audio=document.createElement("audio"),document.body.appendChild(audio),audio.source=document.createElement("source"),audio.appendChild(audio.source),audio.setAttribute("controls","controls"),audio.source.setAttribute("src",""),audio.source.setAttribute("type","audio/mp3"),audio.src="",audio.play()):(audio=new Audio,audio.src=_silence,audio.play().catch((e=>{}))),audio}this.createPool=function(n=10){_pool=_this.initClass(ObjectPool,createAudioElement,n),_this.flag("init",!0)},this.audioContext=function(refresh){return _context&&!refresh||(_context&&(_context.close(),_context=null),_orientation=new Vector3,(_context=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48e3})).dest=_context.createMediaStreamDestination(),Render.start(loop)),_context},this.unloadBuffer=function(url){_buffers[url]&&delete _buffers[url]},this.loadBuffer=async function(url){if(!_buffers[url]){_buffers[url]={loaded:Promise.create(),data:null};var response=await fetch(url),buffer=await response.arrayBuffer();_this.audioContext().decodeAudioData(buffer,(data=>{_buffers[url].data=data,_buffers[url].loaded.resolve()}))}return await _buffers[url].loaded,_buffers[url].data},this.unloadStream=function(url){_streams[url]&&(_streams[url].stream.element.src=_silence,_streams[url].stream.element.load(),_streams[url].count--,_pool.put(_streams[url].stream.element),0==_streams[url].count&&defer((_=>{delete _streams[url]})))},this.loadStream=function(url){let isElement="string"!=typeof url&&void 0!==url,element=null;if(isElement&&(element=url,url=element.src?element.src:element.srcObject?element.srcObject.id:""),!_streams[url]){let stream={};_streams[url]={stream:null,count:0},isElement?(stream.element=element,element.setAttribute("muted",!0),element.muted=!0):(stream.element=_this.getElement(),stream.element.crossOrigin="anonymous",stream.element.src=url),GlobalAudio3D.fallback?stream.element.setAttribute("src",url):(stream.element.mediaSrc?stream.source=stream.element.mediaSrc:stream.element.srcObject?(stream.source=_this.audioContext().createMediaStreamSource(stream.element.srcObject),(new Audio).srcObject=element.srcObject):stream.source=_this.audioContext().createMediaElementSource(stream.element),stream.element.mediaSrc=stream.source),isElement||stream.element.load(),_streams[url].stream=stream}return _streams[url].count++,_streams[url].stream},this.getActiveStreamCount=function(stream){for(let key in _streams)if(_streams[key].stream==stream)return _streams[key].count;return-1},this.purge=function(){for(let stream in _streams)_this.unloadStream(stream);for(let buffer in _buffers)_this.unloadBuffer(buffer)},this.getElement=function(){return _pool||_this.createPool(),_pool.get()},this.useCamera=function(camera){_this.CAMERA=camera},this.getCamera=function(){return _this.CAMERA||(_this.CAMERA=World.CAMERA),_this.CAMERA}}),"static"),Class((function Audio3DWABuffer(){Inherit(this,Audio3DBase);const _this=this;var _context,_buffer,_stream,_gain,_panner,_analyser,_filter,_delay,_convolver,_position,_frequency,_convolution,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(){_context&&(_position=_context.listener.forwardX?_this.audioPosition().sub(_this.listenerPosition()):_this.audioPosition(),_panner.setPosition(_position.x,_position.y,_position.z))}async function initContext(){await GlobalAudio3D.ready(),_context=Audio3DWA.audioContext(),_gain=_context.createGain?_context.createGain():_context.createGainNode(),_panner=_context.createPanner(),(_filter=_context.createBiquadFilter()).type="lowshelf",_filter.frequency.value=0,_filter.gain.value=1,_analyser=_context.createAnalyser(),(_delay=_context.createDelay(10)).delayTime.value=0,_analyser.fftSize=32,_frequency=new Uint8Array(_analyser.frequencyBinCount),_analyser.connect(_context.destination),_delay.connect(_analyser),_filter.connect(_delay),_convolver?(_convolver.connect(_filter),_gain.connect(_convolver)):_gain.connect(_filter),_panner.connect(_gain)}function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function destroyBuffer(){if(_buffer&&_stream){_settings.loaded=!1;try{_stream.disconnect(_panner),_convolver?(_convolver.disconnect(_filter),_gain.disconnect(_convolver)):_gain.disconnect(_filter),_analyser.disconnect(_context.destination),_buffer.stop(),_buffer=null,Audio3DWA.unloadBuffer(_settings.src)}catch(e){}}}async function createStream(){_stream||((_stream=_context.createBufferSource()).buffer=_buffer.buffer,_stream.loop=_options.loop,_stream.playbackRate=_options.playbackRate,_stream.onended=_=>{_this&&_this.stop&&(_this.stop(),_this.events.fire(Events.END),_options.selfDestruct&&_this.parent.destroy())},_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_stream.connect(_panner),_stream.start(0,_currentTime))}function destroyStream(){if(_stream)try{_stream.disconnect(_panner),_stream.stop(),_stream=null}catch(e){}}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){destroyBuffer(),destroyStream(),_context=null,_gain=null,_panner=null,_analyser=null,_delay=null,_frequency=null,_filter=null,initContext(),initOptions(),_convolution&&_this.convolve(_convolution),(_options.autoplay||_settings.autoplay)&&_this.play()}!async function(){await initContext(),initOptions(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready)}()}(),this.set("src",(src=>{_this.stop(),_settings.src=src,defer((_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_options.volume}))})),this.get("src",(_=>_settings.src)),this.get("selfDestruct",(_=>_options.selfDestruct)),this.set("selfDestruct",(d=>{_options.selfDestruct=d})),this.set("volume",(v=>(_options.volume=v,_gain&&(_gain.gain.value=_options.muted||_options.globalMuted?0:v*_options.globalVolume),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,_stream&&(_stream.loop=l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("frequency",(_=>_analyser?(_analyser.getByteFrequencyData(_frequency),_frequency):[])),this.get("activity",(_=>_analyser?(_analyser.getByteFrequencyData(_frequency),Math.clamp(_frequency.slice(3,13).reduce(((n1,n2)=>n1+n2),0)/2560,0,1)):0)),this.get("playing",(_=>_settings.playing)),this.set("rolloff",(r=>{_options.rolloff=r,_panner&&(_panner.rolloffFactor=r)})),this.get("rolloff",(_=>_options.rolloff)),this.get("loaded",(_=>_settings.loaded)),this.get("currentTime",(_=>_context&&_buffer?_context.currentTime%_buffer.buffer.duration:0)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted&&(_options.muteState=_options.muted),!1===muted&&1!=_options.muteState&&(_options.muted=muted,_this.volume=_this.volume),!1===muted&&delete _options.muteState})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.set("playbackRate",(v=>{_options.playbackRate=v,_stream&&(_stream.playbackRate.value=v*_options.globalPlaybackRate)})),this.get("playbackRate",(_=>_options.playbackRate)),this.get("filter",(_=>_filter)),this.get("delay",(_=>_delay)),this.get("panner",(_=>_panner)),this.get("duration",(_=>_buffer?_buffer.buffer.duration:0)),this.get("progress",(_=>_this.currentTime/_this.duration)),this.play=async function(){_settings.autoplay=!0,_settings.src&&GlobalAudio3D.ready&&(_settings.loadingPlay=!0,_stream||_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),await createStream(),_settings.playing=!0,_this.volume=_options.volume,_this.startRender(loop)))},this.pause=function(){_settings.autoplay=!1,_stream&&GlobalAudio3D.ready&&_settings.src&&_settings.loaded&&_settings.playing&&(_currentTime=_context.currentTime,destroyStream(),_settings.loadingPlay=!1,_settings.playing=!1,_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.src&&GlobalAudio3D.ready&&_settings.loaded&&(_currentTime=0,destroyStream(),_settings.loading=!1,_settings.loaded=!1,_settings.loadingPlay=!1,_settings.playing=!1,_this.stopRender(loop))},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_this.stop(),_currentTime=time,wasPlaying&&_this.play()}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await async function createBuffer(){await GlobalAudio3D.ready(),(_buffer=_context.createBufferSource()).buffer=await Audio3DWA.loadBuffer(_settings.src),_settings.loaded=!0}(),await createStream(),_options.autoplay||_settings.loadingPlay||destroyStream(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),destroyBuffer())},this.convolve=async function(src){if(_convolution=src,!GlobalAudio3D.ready)return;if(!1===src)return void(_convolver&&(_convolver.disconnect(),_gain.disconnect(),_gain.connect(_filter),_convolver=null));let buffer=await Audio3DWA.loadBuffer(src);_convolver||(_convolver=_context.createConvolver(),_gain.disconnect(),_convolver.connect(_filter),_gain.connect(_convolver)),_convolver.buffer=buffer}})),Class((function Audio3DWASimpleBuffer(){Inherit(this,Audio3DBase);const _this=this;var _context,_buffer,_stream,_gain,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function initContext(){GlobalAudio3D.ready&&(_context=Audio3DWA.audioContext(),(_gain=_context.createGain?_context.createGain():_context.createGainNode()).connect(_context.destination))}function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function destroyBuffer(){_buffer&&_stream&&(_settings.loaded=!1,_stream.disconnect(_gain),_gain.disconnect(_context.destination),_buffer.stop(),_buffer=null,Audio3DWA.unloadBuffer(_settings.src))}async function createStream(){!_stream&&GlobalAudio3D.ready&&((_stream=_context.createBufferSource()).buffer=_buffer.buffer,_stream.loop=_options.loop,_stream.playbackRate=_options.playbackRate,_stream.onended=_=>{_this.stop(),_this.events.fire(Events.END),_options.selfDestruct&&_this.parent.destroy()},_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_stream.connect(_gain),_stream.start(0,_currentTime))}function destroyStream(){_stream&&(_stream.disconnect(_gain),_stream.stop(),_stream=null)}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){destroyBuffer(),destroyStream(),_context=null,_gain=null,initContext(),initOptions(),(_options.autoplay||_settings.autoplay)&&_this.play()}initContext(),initOptions(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready)}(),this.set("src",(src=>{_this.stop(),_settings.src=src,defer((_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_options.volume}))})),this.get("src",(_=>_settings.src)),this.get("selfDestruct",(_=>_options.selfDestruct)),this.set("selfDestruct",(d=>{_options.selfDestruct=d})),this.set("volume",(v=>(_options.volume=v,_gain&&(_gain.gain.value=_options.muted||_options.globalMuted?0:v*_options.globalVolume),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,_stream&&(_stream.loop=l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("playing",(_=>_settings.playing)),this.get("loaded",(_=>_settings.loaded)),this.get("currentTime",(_=>_context&&_buffer?_context.currentTime%_buffer.buffer.duration:0)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted&&(_options.muteState=_options.muted),!1===muted&&1!=_options.muteState&&(_options.muted=muted,_this.volume=_this.volume),!1===muted&&delete _options.muteState})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.set("playbackRate",(v=>{_options.playbackRate=v,_stream&&(_stream.playbackRate.value=v*_options.globalPlaybackRate)})),this.get("playbackRate",(_=>_options.playbackRate)),this.get("duration",(_=>_buffer?_buffer.buffer.duration:0)),this.get("progress",(_=>_this.currentTime/_this.duration)),this.play=async function(){_settings.autoplay=!0,_settings.src&&GlobalAudio3D.ready&&(_settings.loadingPlay=!0,_stream||_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),await createStream(),_settings.playing=!0,_this.volume=_options.volume))},this.pause=function(){_settings.autoplay=!1,_stream&&GlobalAudio3D.ready&&_settings.src&&_settings.loaded&&_settings.playing&&(_currentTime=_context.currentTime,destroyStream(),_settings.loadingPlay=!1,_settings.playing=!1)},this.stop=function(){_settings.autoplay=!1,_settings.src&&GlobalAudio3D.ready&&_settings.loaded&&(_currentTime=0,destroyStream(),_settings.loading=!1,_settings.loaded=!1,_settings.loadingPlay=!1,_settings.playing=!1)},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_this.stop(),_currentTime=time,wasPlaying&&_this.play()}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await async function createBuffer(){GlobalAudio3D.ready&&((_buffer=_context.createBufferSource()).buffer=await Audio3DWA.loadBuffer(_settings.src),_settings.loaded=!0)}(),await createStream(),_options.autoplay||_settings.loadingPlay||destroyStream(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),destroyBuffer())},this.convolve=async function(src){}})),Class((function Audio3DWAStream(){Inherit(this,Audio3DBase);const _this=this;var _context,_stream,_gain,_panner,_analyser,_filter,_delay,_convolver,_position,_frequency,_convolution,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(){_context&&(_position=_context.listener.forwardX?_this.audioPosition().sub(_this.listenerPosition()):_this.audioPosition(),_panner.setPosition(_position.x,_position.y,_position.z))}function initContext(){_context=Audio3DWA.audioContext(),_gain=_context.createGain?_context.createGain():_context.createGainNode(),_panner=_context.createPanner(),(_analyser=_context.createAnalyser()).fftSize=32,_frequency=new Uint8Array(_analyser.frequencyBinCount),(_filter=_context.createBiquadFilter()).type="lowshelf",_filter.frequency.value=0,_filter.gain.value=1,(_delay=_context.createDelay(10)).delayTime.value=0}function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function createStream(){_stream||((_stream=Audio3DWA.loadStream(_settings.src)).element.onended=_=>{_this.unload(),_this.events.fire(Events.END)},_this.loop=_this.loop,_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_stream.source.connect(_panner),_panner.connect(_gain),_convolver?(_gain.connect(_convolver),_convolver.connect(_filter)):_gain.connect(_filter),_filter.connect(_delay),_delay.connect(_analyser),_analyser.connect(_context.destination),_stream.element.currentTime=_currentTime,(_options.autoplay||_settings.autoplay)&&_this.play())}function destroyStream(){_stream&&(_stream.source.disconnect(_panner),_stream=null)}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){destroyStream(),_context=null,_gain=null,_panner=null,_analyser=null,_delay=null,_filter=null,_frequency=null,initContext(),initOptions(),_convolution&&_this.convolve(_convolution),(_settings.autoplay||_options.autoplay)&&_this.play()}initOptions(),initContext(),createStream(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready)}(),this.set("src",(src=>{if(destroyStream(),_settings.src=src,_options.autoplay)return _this.play();_options.preload&&_this.load()})),this.get("src",(_=>_settings.src)),this.set("volume",(v=>(v=Math.clamp(v,0,1),_options.volume=v,_gain&&(_gain.gain.value=_options.muted||_options.globalMuted?0:v*_options.globalVolume),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,_stream&&(_stream.element.loop=l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("frequency",(_=>(_analyser&&_analyser.getByteFrequencyData(_frequency),_frequency))),this.get("activity",(_=>_analyser?(_analyser.getByteFrequencyData(_frequency),Math.clamp(_frequency.slice(3,13).reduce(((n1,n2)=>n1+n2),0)/2560,0,1)):0)),this.get("playing",(_=>_settings.playing)),this.set("rolloff",(r=>{_options.rolloff=r,_panner&&(_panner.rolloffFactor=r)})),this.get("rolloff",(_=>_options.rolloff)),this.get("loaded",(_=>!0)),this.get("duration",(_=>_stream?_stream.element.duration:0)),this.get("currentTime",(_=>_stream?_stream.element.currentTime:0)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("progress",(_=>_this.currentTime/_this.duration)),this.set("playbackRate",(v=>{_options.playbackRate=v,_stream&&_stream.element&&(_stream.element.playbackRate=v*_options.globalPlaybackRate)})),this.get("playbackRate",(_=>_options.playbackRate)),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted&&(_options.muteState=_options.muted),!1===muted&&1!=_options.muteState&&(_options.muted=muted,_this.volume=_this.volume),!1===muted&&delete _options.muteState})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.get("filter",(_=>_filter)),this.get("delay",(_=>_delay)),this.get("panner",(_=>_panner)),this.play=function(){_settings.autoplay=!0,_settings.src&&(createStream(),_stream&&!0!==_settings.playing&&(_settings.playing=!0,_this.volume=_this.volume,_this.startRender(loop),_stream.element.playbackRate=_options.playbackRate?_options.playbackRate:1,_stream.element.play().catch((e=>{}))))},this.pause=function(){_settings.autoplay=!1,_stream&&_settings.src&&_settings.playing&&(_currentTime=_stream.element.currentTime,_stream.element.pause(),_settings.playing=!1,_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.src&&(_currentTime=0,_settings.playing=!1,_this.stopRender(loop),_stream&&_stream.element&&_stream.element.stop&&(_stream.element.stop(),_stream.element.currentTime=0))},this.seek=function(time){_settings.src&&(_currentTime=time,_stream&&(_stream.element.currentTime=time))},this.load=function(){_settings.src&&(_settings.playing||(createStream(),_stream.element.load()))},this.unload=function(){_settings.autoplay=!1,_settings.src&&(_this.stop&&_this.stop(),destroyStream(),Audio3DWA.unloadStream(_settings.src))},this.convolve=async function(src){if(_convolution=src,!1===src)return void(_convolver&&(_convolver.disconnect(),_gain.disconnect(),_gain.connect(_analyser),_convolver=null));let buffer=await Audio3DWA.loadBuffer(src);_convolver||(_convolver=_context.createConvolver(),_gain.disconnect(),_convolver.connect(_analyser),_gain.connect(_convolver)),_convolver.buffer=buffer},this.get("stream",(_=>_stream))}));class CubicPoly{constructor(x0,x1,t0,t1){this.init(x0,x1,t0,t1)}init(x0,x1,t0,t1){this.c0=x0,this.c1=t0,this.c2=-3*x0+3*x1-2*t0-t1,this.c3=2*x0-2*x1+t0+t1}initCatmullRom(x0,x1,x2,x3,tension){this.init(x1,x2,tension*(x2-x0),tension*(x3-x1))}initNonuniformCatmullRom(x0,x1,x2,x3,dt0,dt1,dt2){let t1=(x1-x0)/dt0-(x2-x0)/(dt0+dt1)+(x2-x1)/dt1,t2=(x2-x1)/dt1-(x3-x1)/(dt1+dt2)+(x3-x2)/dt2;t1*=dt1,t2*=dt1,this.init(x1,x2,t1,t2)}calc(t){let t2=t*t,t3=t2*t;return this.c0+this.c1*t+this.c2*t2+this.c3*t3}}Class((function Curve(_input,_type){Inherit(this,Component);const _this=this;var _curve;function initCurve(input){switch(_type){case"line":_curve=new CurvePath;for(let i=0;i<input.length-1;i+=1){let newCurve=new LineCurve(input[i],input[i+1]);_curve.add(newCurve)}break;default:case"catmull":_curve=new CatmullRomCurve(input)}}this.root=new Group,Array.isArray(_input)&&Array.isArray(_input[0])?function initFromArray(){let points=[];for(let i=0;i<_input.length;i++)points.push((new Vector3).fromArray(_input[i]));_this.points=points,initCurve(points)}():Array.isArray(_input)&&_input[0]instanceof Vector3?function initFromVecArray(){_this.points=_input,initCurve(_input)}():Array.isArray(_input)&&"number"==typeof _input[0]?function initFromFlatArray(){let points=[];for(let i=0;i<_input.length;i+=3)points.push(new Vector3(_input[i+0],_input[i+1],_input[i+2]));_this.points=points,initCurve(points)}():function initFromObj(obj){if("string"==typeof obj){let name=obj;if(!(obj=Assets.JSON[obj]))throw`No curve ${name} found`;obj.curves=obj.curves[0]}else obj.curves=Array.isArray(obj.curves[0])?obj.curves[0]:obj.curves;for(var data=obj.curves,points=[],j=0;j<data.length;j+=3)points.push(new Vector3(data[j+0],data[j+1],data[j+2]));initCurve(points)}(_input),this.debug=function(){let points=_curve.getPoints(50),geometry=(new Geometry).setFromPoints(points),shader=Utils3D.getTestShader(4095),curveObject=new Line(geometry,shader);return _this.root.add(curveObject),_this.root},this.getPointAt=function(t){t=Math.max(0,Math.min(1,t)),window.THREAD||this.root.updateMatrixWorld();let pos=_curve.getPointAt(t);return window.THREAD||pos.applyMatrix4(this.root.matrixWorld),pos},this.getPoint=function(t){t=Math.max(0,Math.min(1,t)),window.THREAD||this.root.updateMatrixWorld();let pos=_curve.getPoint(t);return window.THREAD||pos.applyMatrix4(this.root.matrixWorld),pos},this.getTangent=function(t){t=Math.max(0,Math.min(1,t)),window.THREAD||this.root.updateMatrixWorld();let pos=_curve.getTangent(t);return window.THREAD||pos.applyMatrix4(this.root.matrixWorld),pos},this.applyDataTexture=function(shader,subdivisions){if(!_this.dataTexture){let size=(num=>{var values=[2,4,8,16,32,64,128,256,512,1024,2048,4096];for(let i=0;i<values.length;i++){var p2=values[i];if(p2*p2>=num)return p2}})(subdivisions),total=size*size,buffer=new Float32Array(3*total);for(let i=0;i<total;i++){let percent=i/(total-1),pos=_this.getPoint(percent);buffer[3*i+0]=pos.x,buffer[3*i+1]=pos.y,buffer[3*i+2]=pos.z}_this.dataTexture=new DataTexture(buffer,size,size,Texture.RGBFormat,Texture.FLOAT)}shader.addUniforms({tCurve:{value:_this.dataTexture},uCurveSize:{value:_this.dataTexture.width}})},this.onDestroy=function(){_this.dataTexture&&_this.dataTexture.destroy()},this.set("closed",(v=>{_curve.closed=v})),this.get("curve",(_=>_curve))}),(_=>{Curve.parseFile=async function(data){"string"==typeof data&&(data=await get(Assets.getPath(data)));let curves=[];return data.curves.forEach((array=>{curves.push(new Curve({curves:[array]}))})),curves},Curve.loadOnThread=function(thread){thread._curveLoaded||(thread._curveLoaded=!0,thread.importES6Class("CubicPoly"),thread.importES6Class("Curve3D"),thread.importES6Class("CurvePath"),thread.importES6Class("CatmullRomCurve"),thread.importES6Class("LineCurve"),thread.importClass(Curve))}}));class Curve3D{constructor(){this.arcLengthDivisions=200}getPointAt(u){let t=this.getUtoTmapping(u);return this.getPoint(t)}getPoints(divisions=5){let points=[];for(let d=0;d<=divisions;d++)points.push(this.getPoint(d/divisions));return points}getSpacedPoints(divisions=5){let points=[];for(let d=0;d<=divisions;d++)points.push(this.getPointAt(d/divisions));return points}getLength(){let lengths=this.getLengths();return lengths[lengths.length-1]}getLengths(divisions=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===divisions+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;let current,p,cache=[],last=this.getPoint(0),sum=0;for(cache.push(0),p=1;p<=divisions;p++)current=this.getPoint(p/divisions),sum+=current.distanceTo(last),cache.push(sum),last=current;return this.cacheArcLengths=cache,cache}updateArtLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(u,distance){let targetArcLength,arcLengths=this.getLengths(),i=0,il=arcLengths.length;targetArcLength=distance||u*arcLengths[il-1];let comparison,low=0,high=il-1;for(;low<=high;)if(i=Math.floor(low+(high-low)/2),comparison=arcLengths[i]-targetArcLength,comparison<0)low=i+1;else{if(!(comparison>0)){high=i;break}high=i-1}if(i=high,arcLengths[i]===targetArcLength)return i/(il-1);let lengthBefore=arcLengths[i];return(i+(targetArcLength-lengthBefore)/(arcLengths[i+1]-lengthBefore))/(il-1)}getTangent(t){let t1=t-1e-4,t2=t+1e-4;t1<0&&(t1=0),t2>1&&(t2=1);let pt1=this.getPoint(t1);return this.getPoint(t2).clone().sub(pt1).normalize()}getTangentAt(u){let t=this.getUtoTmapping(u);return this.getTangent(t)}computeFrenetFrames(segments,closed){let i,u,theta,normal=new Vector3,tangents=[],normals=[],binormals=[],vec=new Vector3,mat=new Matrix4;for(i=0;i<=segments;i++)u=i/segments,tangents[i]=this.getTangentAt(u),tangents[i].normalize();normals[0]=new Vector3,binormals[0]=new Vector3;let min=Number.MAX_VALUE,tx=Math.abs(tangents[0].x),ty=Math.abs(tangents[0].y),tz=Math.abs(tangents[0].z);for(tx<=min&&(min=tx,normal.set(1,0,0)),ty<=min&&(min=ty,normal.set(0,1,0)),tz<=min&&normal.set(0,0,1),vec.crossVectors(tangents[0],normal).normalize(),normals[0].crossVectors(tangents[0],vec),binormals[0].crossVectors(tangents[0],normals[0]),i=1;i<=segments;i++)normals[i]=normals[i-1].clone(),binormals[i]=binormals[i-1].clone(),vec.crossVectors(tangents[i-1],tangents[i]),vec.length()>Number.EPSILON&&(vec.normalize(),theta=Math.acos(Math.clamp(tangents[i-1].dot(tangents[i]),-1,1)),normals[i].applyMatrix4(mat.makeRotationAxis(vec,theta))),binormals[i].crossVectors(tangents[i],normals[i]);if(!0===closed)for(theta=Math.acos(Math.clamp(normals[0].dot(normals[segments]),-1,1)),theta/=segments,tangents[0].dot(vec.crossVectors(normals[0],normals[segments]))>0&&(theta=-theta),i=1;i<=segments;i++)normals[i].applyMatrix4(mat.makeRotationAxis(tangents[i],theta*i)),binormals[i].crossVectors(tangents[i],normals[i]);return{tangents:tangents,normals:normals,binormals:binormals}}}Class((function CurveLayer(_input,_group){Inherit(this,Object3D);const _this=this;var _config,_curve,_debug;function getJSONPath(){let path=_config.get("json");return path.includes("assets/geometry")||(path="assets/geometry/"+path),path.includes(".json")||(path+=".json"),path}!async function(){(_config=InputUIL.create(_input.prefix+"curve",_group)).setLabel("Curve"),_config.add("json"),_config.addToggle("debug"),_config.get("json")&&await async function initCurve(path){let data=_this.data=await get(Assets.getPath(path));_curve=_this.initClass(Curve,data),Global.PLAYGROUND&&((_debug=_curve.debug()).visible=_config.get("debug"),_this.add(_debug))}(getJSONPath()),_config.onUpdate=_=>{_debug&&(_debug.visible=Global.PLAYGROUND&&_config.get("debug"))},_this.flag("loaded",!0)}(),this.getData=async function(){return _config.get("json")||console.warn("No json path set on CurveLayer :: Promise won't resolve"),await _this.wait("data"),_this.data},this.getJSONPath=function(){return _config.get("json")||console.warn("No json path set on CurveLayer"),getJSONPath()},this.getCurve=async function(){return await _this.wait("loaded"),_curve}}));class CubicBezierCurve extends Curve3D{constructor(v0,v1,v2,v3){super(),this.type="CubicBezierCurve",this.v0=v0||new Vector3,this.v1=v1||new Vector3,this.v2=v2||new Vector3,this.v3=v3||new Vector3}getLength(){const tmp=this.tmp;let length=0;return this.points.forEach(((p,i)=>{0!==i&&(tmp.subVectors(p,this.points[i-1]),length+=tmp.length())})),length}getPoint(t,optionalTarget){var point=optionalTarget||new Vector3,v0=this.v0,v1=this.v1,v2=this.v2,v3=this.v3;return point.set(this.cubicBezier(t,v0.x,v1.x,v2.x,v3.x),this.cubicBezier(t,v0.y,v1.y,v2.y,v3.y),this.cubicBezier(t,v0.z,v1.z,v2.z,v3.z)),point}copy(source){return this.copy.call(this,source),this.v0.copy(source.v0),this.v1.copy(source.v1),this.v2.copy(source.v2),this.v3.copy(source.v3),this}cubicBezierP0(t,p){var k=1-t;return k*k*k*p}cubicBezierP1(t,p){var k=1-t;return 3*k*k*t*p}cubicBezierP2(t,p){return 3*(1-t)*t*t*p}cubicBezierP3(t,p){return t*t*t*p}cubicBezier(t,p0,p1,p2,p3){return this.cubicBezierP0(t,p0)+this.cubicBezierP1(t,p1)+this.cubicBezierP2(t,p2)+this.cubicBezierP3(t,p3)}}class CatmullRomCurve extends Curve3D{constructor(points=[]){if(super(),this.tmp=new Vector3,this.px=new CubicPoly,this.py=new CubicPoly,this.pz=new CubicPoly,points.length<2)throw"CatmullRomCurve: Points array needs at least two entries.";this.points=points,this.closed=!1}getLength(){const tmp=this.tmp;let length=0;return this.points.forEach(((p,i)=>{0!==i&&(tmp.subVectors(p,this.points[i-1]),length+=tmp.length())})),length}getPoint(t,target){let p0,p1,p2,p3,tmp=this.tmp,px=this.px,py=this.py,pz=this.pz,points=this.points,l=points.length,point=(l-(this.closed?0:1))*t,intPoint=Math.floor(point),weight=point-intPoint;if(this.closed?intPoint+=intPoint>0?0:(Math.floor(Math.abs(intPoint)/points.length)+1)*points.length:0===weight&&intPoint===l-1&&(intPoint=l-2,weight=1),this.closed||intPoint>0?p0=points[(intPoint-1)%l]:(tmp.subVectors(points[0],points[1]).add(points[0]),p0=tmp),p1=points[intPoint%l],p2=points[(intPoint+1)%l],this.closed||intPoint+2<l?p3=points[(intPoint+2)%l]:(tmp.subVectors(points[l-1],points[l-2]).add(points[l-1]),p3=tmp),void 0===this.type||"centripetal"===this.type||"chordal"===this.type){let pow="chordal"===this.type?.5:.25,dt0=Math.pow(p0.distanceToSquared(p1),pow),dt1=Math.pow(p1.distanceToSquared(p2),pow),dt2=Math.pow(p2.distanceToSquared(p3),pow);dt1<1e-4&&(dt1=1),dt0<1e-4&&(dt0=dt1),dt2<1e-4&&(dt2=dt1),px.initNonuniformCatmullRom(p0.x,p1.x,p2.x,p3.x,dt0,dt1,dt2),py.initNonuniformCatmullRom(p0.y,p1.y,p2.y,p3.y,dt0,dt1,dt2),pz.initNonuniformCatmullRom(p0.z,p1.z,p2.z,p3.z,dt0,dt1,dt2)}else if("catmullrom"===this.type){let tension=void 0!==this.tension?this.tension:.5;px.initCatmullRom(p0.x,p1.x,p2.x,p3.x,tension),py.initCatmullRom(p0.y,p1.y,p2.y,p3.y,tension),pz.initCatmullRom(p0.z,p1.z,p2.z,p3.z,tension)}if(!target)return new Vector3(px.calc(weight),py.calc(weight),pz.calc(weight));target.set(px.calc(weight),py.calc(weight),pz.calc(weight))}}Class((function BaseCamera(_input,_group){Inherit(this,Object3D);const _this=this;var _type="perspective";function resize(){switch(_type){case"perspective":_this.camera.aspect=Stage.width/Stage.height,_this.camera.updateProjectionMatrix();break;case"orthographic":if(_this.width||_this.height)_this.camera.setViewport(_this.width,_this.height);else{let m=900/Stage.height/100;_this.camera.setViewport(Stage.width*m,Stage.height*m)}}}this.camera=new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3),this.group.add(this.camera),this.startRender((_=>{_this.group.updateMatrixWorld(!0)})),this.onResize((_=>{_this.overrideResize||resize()})),_input&&(_this.prefix=_input.prefix,CameraUIL.add(_this,_group).setLabel("Camera")),this.playgroundLock=function(camera=Camera.instance()){if(!Global.PLAYGROUND)return;Utils.getConstructorName(_this.parent).includes(Global.PLAYGROUND.split("/")[0])&&RenderManager.type==RenderManager.NORMAL&&camera.lock(_this.camera)},this.lock=function(camera=Camera.instance()){if("orthographic"==_type)return console.error("You can't lock an orthographic camera to the main camera. Use an FXScene .setCamera");RenderManager.type==RenderManager.NORMAL&&camera.lock(_this.camera)},this.transition=function(time,ease,delay,camera=Camera.instance()){"object"==typeof delay&&(camera=delay,delay=0);let p=Promise.create();return camera.transition(_this.camera,time,ease,delay||0),_this.delayedCall((_=>p.resolve()),time+(delay||0)),p},this.manualTransition=function(camera=Camera.instance()){return camera.manualTransition(_this.camera)},this.setFOV=function(fov){fov!=this.camera.fov&&(this.camera.fov=fov,this.camera.updateProjectionMatrix())},this.getFOV=function(){return this.camera.fov},this.useOrthographic=function(w,h){"orthographic"!==_type&&(isNaN(w)||(this.width=w),isNaN(h)||(this.height=h),this.camera&&this.group.remove(this.camera),this.camera=new OrthographicCamera,this.group.add(this.camera),this.camera.position.z=1,_type="orthographic",resize())},this.usePerspective=function(){"perspective"!==_type&&(this.camera&&this.group.remove(this.camera),this.camera=new PerspectiveCamera,this.group.add(this.camera),_type="perspective",resize())},this.useCurve=function(curve){return _this.camera.curve=curve,this}})),Class((function Camera(_worldCamera){Inherit(this,Component);const _this=this;var _debug,_prevCamera,_lockCamera,_curve,_manual,_calc=new Vector3,_target=new Group,_anim={weight:0,weight2:0},_center=new Vector3,_cameraTarget=new Group,_cameraTarget2=new Group;function manualLoop(){_anim.weight2=_manual.value}function loop(){_debug&&(_debug.visible=!_debug.position.equals(_center));let change=(_anim.weight2-_anim.weight)*_this.lerp;if(_manual&&(change=Math.max(change,0)),_anim.weight+=change,_prevCamera){if(_prevCamera.updateMatrixWorld(),_lockCamera.updateMatrixWorld(),_curve){let pos=_curve.getPoint(_anim.weight);pos.lerp(_prevCamera.getWorldPosition(),Math.range(_anim.weight,0,.1,1,0,!0),!1),pos.lerp(_lockCamera.getWorldPosition(),Math.range(_anim.weight,.6,1,0,1,!0),!1),_curve.lerpPos||(_curve.lerpPos=(new Vector3).copy(_prevCamera.getWorldPosition()),_curve.lerpBlend={value:0});let lerp=Math.mix(_curve.lerp||.02,1,_curve.lerpBlend.value);_curve.lerpPos.lerp(pos,lerp,!1),0==_curve.lerpBlend.value&&_calc.subVectors(_worldCamera.position,_lockCamera.getWorldPosition()).length()<.01&&(_curve.lerpBlend.value=.001,tween(_curve.lerpBlend,{value:1},1e3,"linear"),_this.onCurveComplete&&_this.onCurveComplete()),_target.position.copy(_curve.lerpPos)}else _target.position.copy(_prevCamera.getWorldPosition()).lerp(_lockCamera.getWorldPosition(),_anim.weight,!1);_target.quaternion.copy(_prevCamera.getWorldQuaternion()).slerp(_lockCamera.getWorldQuaternion(),_anim.weight,!1),_worldCamera.fov!=_lockCamera.fov&&(_worldCamera.fov+=(_lockCamera.fov-_worldCamera.fov)*_anim.weight,_worldCamera.updateProjectionMatrix()),_cameraTarget.position.lerp(_target.position,_this.lerp2,!1),_cameraTarget.quaternion.slerp(_target.quaternion,_this.lerp2,!1)}else _lockCamera&&(_lockCamera.updateMatrixWorld(),Utils3D.decompose(_lockCamera,_cameraTarget),_worldCamera.fov!=_lockCamera.fov&&(_worldCamera.fov=_lockCamera.fov,_worldCamera.updateProjectionMatrix()));_cameraTarget2.position.lerp(_cameraTarget.position,_this.finalLerp,!1),_cameraTarget2.quaternion.slerp(_cameraTarget.quaternion,_this.finalLerp,!1),_worldCamera.position.lerp(_cameraTarget2.position,_this.finalLerp,!1),_worldCamera.quaternion.slerp(_cameraTarget2.quaternion,_this.finalLerp,!1),_worldCamera.updateMatrixWorld(),_debug&&(_debug.position.copy(_worldCamera.position),_debug.quaternion.copy(_worldCamera.quaternion)),RenderManager.fire(_this)}this.lerp=1,this.lerp2=1,this.worldCamera=_worldCamera,this.finalLerp=1,this.multiTween=!0,RenderManager.type==RenderManager.NORMAL&&(Utils.query("orbit")||Utils.query("wasd")?async function initDebug(){(_debug=new Mesh(new BoxGeometry(.25,.25,.5,1,1,5),new Shader("DebugCamera",{uColor:{value:new Color,transparent:!0,depthTest:!1}}))).renderOrder=9999,World.SCENE.add(_debug),_worldCamera=new PerspectiveCamera;let p=Global.PLAYGROUND||"m";p+=Utils.query("wasd")?"wasd":"orbit";let pos=Storage.get("debugCameraPos_"+p)||World.CAMERA.position.toArray();World.CAMERA.position.fromArray(pos),World.CAMERA.position.debug=!0,Global.DEBUG_CAMERA_POS=pos;let store=_=>Storage.set("debugCameraPos_"+p,World.CAMERA.position.toArray());await defer(),World.CONTROLS&&(World.CONTROLS.onChange=store)}():World.CONTROLS&&(World.CONTROLS.enabled=!1),_this.startRender(loop,RenderManager.AFTER_LOOPS)),this.lock=function(camera){_lockCamera=camera,_worldCamera.fov=_lockCamera.fov,_worldCamera.updateProjectionMatrix(),_prevCamera=null,loop()},this.transition=function(camera,duration=1e3,ease="easeInOutCubic"){return _curve&&(_curve.lerpPos=_curve.lerpBlend=null),camera.curve&&((_curve=camera.curve).lerpPos=camera.lerpPos),_prevCamera===camera?(duration*=.5*Math.smoothStep(.5,1,_anim.weight)+.5,_anim.weight=1-_anim.weight):_anim.weight=0,_this.stopRender(manualLoop),_anim.weight2=_anim.weight,_prevCamera=_lockCamera,_lockCamera=camera,tween(_anim,{weight2:1},duration,ease)},this.manualTransition=function(camera){return this.transition(camera).stop(),_manual={value:0},_this.startRender(manualLoop),_manual},this.setPrevCamera=function(camera){_prevCamera=camera.camera||camera},this.get("worldCamera",(_=>_worldCamera)),this.get("lockCamera",(_=>_lockCamera)),this.set("debugScale",(s=>{_debug&&_debug.scale.setScalar(s)})),this.createLocal=function(camera){return camera||(camera=World.CAMERA.clone(),_this.onResize((_=>{camera.aspect=Stage.width/Stage.height,camera.updateProjectionMatrix()}))),new Camera(camera.camera||camera)}}),"singleton"),Class((function GazeCamera(_input,_group){Inherit(this,BaseCamera);const _this=this;var _strength={v:1},_move=new Vector3,_position=new Vector3,_wobble=new Vector3,_rotation=0,_wobbleAngle=Math.radians(Math.rand(0,360)),_innerGroup=new Group;function loop(){if(Device.system.xr.vr)_move.x=_this.position.x,_move.y=0;else if(_this.useAccelerometer&&Mobile.Accelerometer&&Mobile.Accelerometer.connected)_move.x=_this.position.x+Math.range(Mobile.Accelerometer.x,-2,2,-1,1,!0)*_strength.v*_this.moveXY.x*_this.strength,_move.y=0;else{_move.x=_this.position.x+Math.range(Mouse.x,0,Stage.width,-1,1,!0)*_strength.v*_this.moveXY.x*_this.strength,_move.y=_this.position.y+Math.range(Mouse.y,0,Stage.height,-1,1,!0)*_strength.v*_this.moveXY.y*_this.strength;let rotateStrength=Math.range(Math.abs(Mouse.delta.x)/Stage.width,0,.02,0,1,!0);_rotation=Math.lerp(Math.radians(_this.deltaRotate)*rotateStrength*Math.sign(Mouse.delta.x),_rotation,.02*_this.deltaLerp*_strength.v),_this.group.rotation.z=Math.lerp(_rotation,_this.group.rotation.z,.07*_this.deltaLerp)}if(_move.z=_this.position.z,_position.lerp(_move,_this.lerpSpeed2),_this.camera.position.lerp(_position,_this.lerpSpeed),_this.camera.lookAt(_this.lookAt),_this.wobbleStrength>0){let t=Render.TIME;_wobble.x=Math.cos(_wobbleAngle+t*(75e-5*_this.wobbleSpeed))*(_wobbleAngle+200*Math.sin(t*(95e-5*_this.wobbleSpeed))),_wobble.y=Math.sin(Math.asin(Math.cos(_wobbleAngle+t*(85e-5*_this.wobbleSpeed))))*(150*Math.sin(_wobbleAngle+t*(75e-5*_this.wobbleSpeed))),_wobble.x*=2*Math.sin(_wobbleAngle+t*(75e-5*_this.wobbleSpeed)),_wobble.y*=1.75*Math.cos(_wobbleAngle+t*(65e-5*_this.wobbleSpeed)),_wobble.x*=1.1*Math.cos(_wobbleAngle+t*(75e-5*_this.wobbleSpeed)),_wobble.y*=1.15*Math.sin(_wobbleAngle+t*(25e-5*_this.wobbleSpeed)),_wobble.z=Math.sin(_wobbleAngle+.0025*_wobble.x)*(100*_this.wobbleZ),_wobble.multiplyScalar(.001*_this.wobbleStrength*_strength.v),_innerGroup.position.lerp(_wobble,.07)}}this.strength=1,this.moveXY=new Vector2(4,4),this.position=new function Position(){Inherit(this,Component);var _x=0,_y=0,_z=0;this.get("x",(_=>_x)),this.get("y",(_=>_y)),this.get("z",(_=>_z)),this.set("x",(x=>{_x=x})),this.set("y",(y=>{_y=y})),this.set("z",(z=>{_z=z,_move.z=_z,_this.camera.position.copy(_move),_position.copy(_move)})),this.set=function(x,y,z,noCopy){_x=x,_y=y,_z=z,_move.z=z,noCopy||_this.camera.position.copy(_move),_position.copy(_move)},this.toArray=function(){return[_x,_y,_z]},this.fromArray=function(array){_x=array[0],_y=array[1],_z=array[2],_move.set(_x,_y,_z),_this.camera.position.copy(_move),_position.copy(_move)},this.copy=function(vec){_x=vec.x,_y=vec.y,_z=vec.z,_move.set(_x,_y,_z),_this.camera.position.copy(_move),_position.copy(_move)}},this.lerpSpeed=.05,this.lerpSpeed2=1,this.lookAt=new Vector3(0,0,0),this.deltaRotate=0,this.deltaLerp=1,this.wobbleSpeed=1,this.wobbleStrength=0,this.wobbleZ=1,_input&&(_this.prefix=_input.prefix,CameraUIL.add(_this,_group).setLabel("Camera")),_this.startRender(loop),_innerGroup.add(_this.camera),_this.group.add(_innerGroup),this.orbit=function(time=1e3,ease="easeInOutSine"){return tween(_strength,{v:1},time,ease)},this.still=function(time=300,ease="easeInOutSine"){return tween(_strength,{v:0},time,ease)}}));class Base3D{constructor(){this.position=new Vector3D,this.rotation=new Euler,this.quaternion=new Quaternion,this.scale=new Vector3D(1,1,1),this._parent=null,this.up=new Vector3(0,1,0),this.isObject3D=!0,this.children=[],this.childrenLength=0,this.modelViewMatrix=new Matrix4,this.normalMatrix=new Matrix3,this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=!0,this.matrixWorldNeedsUpdate=!1,this.matrixDirty=!0,this.visible=!0,this.castShadow=!1,this.frustumCulled=!0,this._renderOrder=0,this.worldPos=new Vector3,this.worldQuat=new Quaternion;const _this=this;this.quaternion.onChange((_=>{_this.matrixDirty=!0,_this.rotation.setFromQuaternion(_this.quaternion,void 0,!1)})),this.rotation.onChange((_=>{_this.matrixDirty=!0,_this.quaternion.setFromEuler(_this.rotation,!1)})),this.scale.onChange((_=>{_this.matrixDirty=!0})),this.position.onChange((_=>{_this.matrixDirty=!0}))}get renderOrder(){return this._renderOrder}set renderOrder(value){this._renderOrder=value;let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent;for(let i=0;i<this.children.length;i++)this.children[i].renderOrder+=value}applyMatrix(matrix){return this.matrix.multiplyMatrices(matrix,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale),this}applyQuaternion(q){return this.quaternion.premultiply(q),this}setRotationFromAxisAngle(axis,angle){this.quaternion.setFromAxisAngle(axis,angle)}setRotationFromMatrix(m){this.quaternion.setFromRotationMatrix(m)}setRotationFromQuaternion(q){this.quaternion.copy(q)}localToWorld(v){return v.applyMatrix4(this.matrixWorld)}worldToLocal(v){let m1=this.M1||new Matrix4;return this.M1=m1,v.applyMatrix4(m1.getInverse(this.matrixWorld))}lookAt(x,y,z){let m1=this.M1||new Matrix4;this.M1=m1;let v=this.V1||new Vector3;this.V1=v,x.isVector3?v.copy(x):v.set(x,y,z),this.isCamera?m1.lookAt(this.position,v,this.up):m1.lookAt(v,this.position,this.up),this.quaternion.setFromRotationMatrix(m1)}add(object){if(arguments.length>1){for(let i=0;i<arguments.length;i++)this.add(arguments[i]);return this}if(object===this)return this;if(object&&object.isObject3D?(null!==object._parent&&object._parent.remove(object),object._parent=this,this.children.push(object),this.childrenLength=this.children.length):console.error("Object is not instance of Object3D",object),this.isScene)this.displayNeedsUpdate=!0;else{let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent}return this}remove(object){if(arguments.length>1){for(let i=0;i<arguments.length;i++)this.remove(arguments[i]);return this}if(this.isScene)this.displayNeedsUpdate=!0;else{let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent}this.children.remove(object),this.childrenLength=this.children.length}getWorldPosition(target){let v=this.V1||new Vector3;return this.V1=v,target||(target=v),this.updateMatrixWorld(),target.setFromMatrixPosition(this.matrixWorld)}getWorldScale(target){let v=this.V1S||new Vector3;this.V1S=v;let v2=this.V12||new Vector3;this.V2=v2;let q=this.Q1||new Quaternion;return this.Q1=q,target||(target=v2),this.updateMatrixWorld(),this.matrixWorld.decompose(v,q,target),target}getWorldQuaternion(target){let v=this.V1Q||new Vector3;this.V1Q=v;let q=this.Q1||new Quaternion;return this.Q1=q,target||(target=q),this.updateMatrixWorld(),this.matrixWorld.decompose(v,target,v),target}traverse(callback){callback(this);let children=this.children;for(let i=0;i<children.length;i++)children[i].traverse(callback)}updateMatrix(){!1!==this.matrixAutoUpdate&&(this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0)}updateMatrixWorld(force){if(!1===this.matrixAutoUpdate)return;if(!force&&!this.determineVisible())return;(this.determineDirty()||force)&&!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==force||(null===this._parent||this.determineNoTransform()?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this._parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1);for(let i=this.childrenLength-1;i>-1;i--)this.children[i].updateMatrixWorld(force);this.matrixDirty=!1}clone(recursive){(new this.constructor).copy(this,recursive)}copy(source,recursive){if(this.name=source.name,this.up.copy(source.up),this.position.copy(source.position),this.quaternion.copy(source.quaternion),this.scale.copy(source.scale),this.matrix.copy(source.matrix),this.matrixWorld.copy(source.matrixWorld),this.matrixAutoUpdate=source.matrixAutoUpdate,this.matrixWorldNeedsUpdate=source.matrixWorldNeedsUpdate,this.visible=source.visible,this.castShadow=source.castShadow,this.receiveShadow=source.receiveShadow,this.frustumCulled=source.frustumCulled,this.renderOrder=source.renderOrder,!0===recursive)for(let i=0;i<source.children.length;i++){let child=source.children[i];this.add(child.clone())}return this}render(){}determineVisible(){if(!this.visible)return!1;let p=this._parent;for(;p;){if(!p.visible)return!1;p=p._parent}return!0}determineDirty(){let p=this._parent;for(;p;){if(p.matrixDirty)return!0;p=p._parent}return this.matrixDirty}determineNoTransform(){return this._parent?this._parent.determineNoTransform()&&this.matrix.isIdentity():this.matrix.isIdentity()}translateX(distance){this.xAxis||(this.xAxis=new Vector3(1,0,0)),this.translateOnAxis(this.xAxis,distance)}translateY(distance){this.yAxis||(this.yAxis=new Vector3(0,1,0)),this.translateOnAxis(this.yAxis,distance)}translateZ(distance){this.zAxis||(this.zAxis=new Vector3(0,0,1)),this.translateOnAxis(this.zAxis,distance)}translateOnAxis(axis,distance){let v=this.V1||new Vector3;return this.V1=v,v.copy(axis).applyQuaternion(this.quaternion),this.position.add(v.multiplyScalar(distance)),this}upload(){this.shader&&(this.shader.upload(this,this.geometry),this.shader.shadow&&this.shader.shadow.upload(this,this.geometry)),this.geometry&&this.geometry.upload(this,this.shader)}destroy(){this.geometry&&this.geometry.destroy&&this.geometry.destroy(this),this.shader&&this.shader.destroy&&this.shader.destroy(this),this.hitDestroy&&this.hitDestroy(),this._gl&&this._gl.ubo&&this._gl.ubo.destroy(),this._gl&&this._gl.vao&&this._gl.vao.destroy(),this._gl&&(this._gl=null),this._parent&&this._parent.remove(this),this.parent&&this.parent.__destroyChild&&this.parent.__destroyChild(this.__id)}}Class((function Renderer(_params={}){Inherit(this,Component);const _this=this;var _canvas,_gl,_width,_height,_anisotropy,_clearColor,_projScreenMatrix,_frustum,_ubo,_dpr=1,_resolution=new Vector2,_m0=new Matrix4,_m1=new Matrix4,_time={value:0},_stencilActive=!1;function initCameraUBO(camera){camera._ubo=new UBO(0,_gl),camera._ubo.push({value:camera.projectionMatrix}),camera._ubo.push({value:camera.matrixWorldInverse}),camera._ubo.push({value:camera.worldPos}),camera._ubo.push({value:camera.worldQuat}),camera._ubo.push({value:_resolution}),camera._ubo.push(_time),camera._ubo.push(Render.timeScaleUniform),camera._ubo.upload()}function projectObject(object,camera,scene){if(void 0!==object.shader){let visible=object.determineVisible()&&object.shader.visible&&!object.shader.neverRender;visible&&(object.modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix)),(scene.displayNeedsUpdate||object.shader.transparent&&!scene.disableAutoSort&&visible)&&object.getWorldPosition(object.worldPos),scene.displayNeedsUpdate&&scene.toRender[object.shader.transparent?1:0].push(object)}if(!0===object.visible||scene.displayNeedsUpdate)for(let i=object.childrenLength-1;i>-1;i--)projectObject(object.children[i],camera,scene)}function attachSceneUniforms(object,scene,camera){if(Shader.renderer.appendUniform(object.shader,"normalMatrix",object.normalMatrix),Shader.renderer.appendUniform(object.shader,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader,"modelViewMatrix",object.modelViewMatrix),_ubo?camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader,"projectionMatrix",camera.projectionMatrix),Shader.renderer.appendUniform(object.shader,"viewMatrix",camera.matrixWorldInverse),Shader.renderer.appendUniform(object.shader,"cameraPosition",camera.worldPos),Shader.renderer.appendUniform(object.shader,"cameraQuaternion",camera.worldQuat),Shader.renderer.appendUniform(object.shader,"resolution",_resolution),Shader.renderer.appendUniform(object.shader,"time",_time.value),Shader.renderer.appendUniform(object.shader,"timeScale",Render.timeScaleUniform.value)),_this.shadows&&object.shader.receiveShadow&&!_this.overridePreventShadows){let lights=Lighting.getShadowLights();object._gl||(object._gl={}),object._gl.shadowData||(object._gl.shadowData={combined:new Float32Array(16*lights.length)});for(let i=0;i<lights.length;i++){let light=lights[i];_m1.multiplyMatrices(light.shadow.camera.matrixWorldInverse,object.matrixWorld),_m0.multiplyMatrices(light.shadow.camera.projectionMatrix,_m1),_m0.toArray(object._gl.shadowData.combined,16*i)}scene._shadowData&&scene._shadowData.count&&(object.shader.uniforms.shadowMap.value=scene._shadowData[_this.overridePreventShadows?"emptyMaps":"maps"],Shader.renderer.appendUniform(object.shader,"shadowMatrix",object._gl.shadowData.combined,"matrix"),Shader.renderer.appendUniform(object.shader,"shadowLightPos",scene._shadowData.pos,"vec3"),Shader.renderer.appendUniform(object.shader,"shadowSize",scene._shadowData.size,"float"))}}function attachShadowUniforms(object,scene,light){light._mvm||(light._mvm=new Matrix4),light._nm||(light._nm=new Matrix3),light._mvm.multiplyMatrices(light.shadow.camera.matrixWorldInverse,object.matrixWorld),light._nm.getNormalMatrix(object.modelViewMatrix),Shader.renderer.appendUniform(object.shader.shadow,"normalMatrix",light._nm),Shader.renderer.appendUniform(object.shader.shadow,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader.shadow,"modelViewMatrix",light._mvm),_ubo?light.shadow.camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader.shadow,"projectionMatrix",light.shadow.camera.projectionMatrix),Shader.renderer.appendUniform(object.shader.shadow,"viewMatrix",light.shadow.camera.matrixWorldInverse))}function loop(t,dt){_time.value+=.001*dt}function render(scene,camera,rt){rt&&rt.width?(_resolution.set(rt.width,rt.height),RenderTarget.renderer.bind(rt)):(Renderer.overrideViewport||(_gl.viewport(0,0,_width*_dpr,_height*_dpr),_resolution.set(_canvas.width,_canvas.height)),_this.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))),camera.parent||camera.updateMatrixWorld(),camera.getWorldPosition(camera.worldPos),camera.getWorldQuaternion(camera.worldQuat),_frustum.setFromCamera(camera),_ubo&&(camera._ubo?camera._ubo.update():initCameraUBO(camera));for(let l=0;l<2;l++){let len=scene.toRender[l].length;for(let i=0;i<len;i++){let object=scene.toRender[l][i];object.onBeforeRender&&object.onBeforeRender(),object.determineVisible()&&object.shader.visible&&!object.shader.neverRender&&(!1!==object.frustumCulled&&!0!==_frustum.intersectsObject(object)||(object.shader.draw(object,object.geometry),attachSceneUniforms(object,scene,camera),object.geometry.draw(object,object.shader)))}}rt&&rt.width&&RenderTarget.renderer.unbind(rt)}this.autoClear=!0,this.shadows=Renderer.SHADOWS_MED,Renderer.instance=_this,Renderer.CLEAR=[0,0,0,1],function initContext(){let contextAttributes={antialias:void 0!==_params.antialias&&_params.antialias,powerPreference:_params.powerPreference,preserveDrawingBuffer:_params.preserveDrawingBuffer,xrCompatible:_params.xrCompatible,alpha:void 0!==_params.alpha&&_params.alpha,stencil:_params.stencil};if(_this.stencil=!!_params.stencil,_canvas=_params.canvas||document.createElement("canvas"),_params.gl?(_gl=_params.gl,_this.type=Device.graphics.webgl.version.includes(["webgl 2","webgl2"])?Renderer.WEBGL2:Renderer.WEBGL1):Device.graphics.webgl?["webgl2","webgl","experimental-webgl"].forEach((name=>{_gl||"webgl2"==name&&_params.forceWebGL1||(_gl=_canvas.getContext(name,contextAttributes),_this.type=_gl&&"webgl2"==name?Renderer.WEBGL2:Renderer.WEBGL1)})):(_gl=new NoGLPolyfill,_this.type=Renderer.WEBGL2),!_gl)throw"Error! Could not create WebGL context";_this.domElement=_canvas,_canvas.style.background="black",Renderer.type=_this.type,Renderer.context=_this.context=_gl}(),function setExtensions(){_this.extensions={},_this.type!=Renderer.WEBGL2?(_this.extensions.VAO=_gl.getExtension("OES_vertex_array_object"),_this.extensions.instancedArrays=_gl.getExtension("ANGLE_instanced_arrays"),_this.extensions.standardDerivatives=_gl.getExtension("OES_standard_derivatives"),_this.extensions.depthTextures=_gl.getExtension("WEBGL_depth_texture"),_this.extensions.drawBuffers=_gl.getExtension("WEBGL_draw_buffers"),_this.extensions.halfFloat=_gl.getExtension("OES_texture_half_float"),_this.extensions.float=_gl.getExtension("OES_texture_float"),_this.extensions.colorBufferFloat=_gl.getExtension("WEBGL_color_buffer_float")):_this.extensions.colorBufferFloat=_gl.getExtension("EXT_color_buffer_float"),_this.extensions.filterFloat=_gl.getExtension("OES_texture_float_linear"),_this.extensions.anisotropy=_gl.getExtension("EXT_texture_filter_anisotropic")||_gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),_this.extensions.astc=_gl.getExtension("WEBGL_compressed_texture_astc"),_this.extensions.atc=_gl.getExtension("WEBGL_compressed_texture_atc"),_this.extensions.etc=_gl.getExtension("WEBGL_compressed_texture_etc"),_this.extensions.etc1=_gl.getExtension("WEBGL_compressed_texture_etc1"),_this.extensions.pvrtc=_gl.getExtension("WEBGL_compressed_texture_pvrtc")||_gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),_this.extensions.s3tc=_gl.getExtension("WEBGL_compressed_texture_s3tc")||_gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),_this.extensions.s3tc_srgb=_gl.getExtension("WEBGL_compressed_texture_s3tc_srgb"),Renderer.extensions=_this.extensions}(),function initRenderers(){Geometry.renderer=new GeometryRendererWebGL(_gl),Texture.renderer=new TextureRendererWebGL(_gl),Shader.renderer=new ShaderRendererWebGL(_gl),RenderTarget.renderer=new FBORendererWebGL(_gl)}(),function initMath(){_projScreenMatrix=new Matrix4,new Vector3,_frustum=new Frustum}(),function initUBO(){_this.type==Renderer.WEBGL2&&(_ubo=!0),Renderer.UBO=_ubo}(),_this.startRender(loop),this.render=function(scene,camera,rt,forceToScreen){scene.displayNeedsUpdate&&(scene.toRender[0].length=0,scene.toRender[1].length=0),scene.updateMatrixWorld(),projectObject(scene,camera,scene),(scene.displayNeedsUpdate||scene.opaqueSortOrder==Scene.FRONT_TO_BACK)&&function sortOpaque(array,sortOrder,camera){for(let i=array.length-1;i>-1;i--){let obj=array[i];obj.shader._gl||obj.shader.upload()}if(sortOrder==Scene.FRONT_TO_BACK){for(let i=array.length-1;i>-1;i--){let obj=array[i];obj.__sortVec||(obj.__sortVec=new Vector3),obj.__sortVec.setFromMatrixPosition(camera.modelViewMatrix)}array.sort(((a,b)=>b.__sortVec.z-a.__sortVec.z))}else array.sort(((a,b)=>{if(a.renderOrder!==b.renderOrder)return a.renderOrder-b.renderOrder;let aid=a.shader._gl._id,bid=b.shader._gl._id;return aid!==bid?aid-bid:a.id-b.id}))}(scene.toRender[0],scene.opaqueSortOrder,camera),(scene.displayNeedsUpdate||scene.toRender[1].length&&!scene.disableAutoSort)&&function sortTransparent(array){RenderStats.update("SortTransparent",array.length),array.sort(((a,b)=>a.renderOrder!==b.renderOrder?a.renderOrder-b.renderOrder:a.worldPos.z!==b.worldPos.z?a.worldPos.z-b.worldPos.z:a.id-b.id))}(scene.toRender[1]),_this.shadows&&!_this.overridePreventShadows&&!_this.pauseShadowRendering&&scene.hasShadowLight&&function renderShadows(scene,camera){let render=light=>{RenderTarget.renderer.bind(light.shadow.rt),RenderStats.update("ShadowLights"),light.shadow.camera.updateMatrixWorld(),camera.getWorldPosition(camera.worldPos),_frustum.setFromCamera(camera),_ubo&&(light.shadow.camera._ubo?light.shadow.camera._ubo.update():initCameraUBO(light.shadow.camera));for(let l=0;l<2;l++)for(let i=0;i<scene.toRender[l].length;i++){let object=scene.toRender[l][i];!0===object.castShadow&&object.determineVisible()&&object.shader.visible&&!object.shader.neverRender&&(!1!==object.frustumCulled&&!0!==_frustum.intersectsObject(object)||(object.shader.shadow||Lighting.initShadowShader(object),object.shader.shadow.draw(object,object.geometry),attachShadowUniforms(object,0,light),object.geometry.draw(object,object.shader),_ubo&&light.shadow.camera._ubo.unbind(),RenderStats.update("ShadowMesh")))}RenderTarget.renderer.unbind(light.shadow.rt)},lights=Lighting.getShadowLights();scene._shadowData||(scene._shadowData={maps:[],emptyMaps:[],size:new Float32Array(lights.length),pos:new Float32Array(3*lights.length),count:lights.length}),scene._shadowData.count!=lights.length&&(scene._shadowData.size=new Float32Array(lights.length),scene._shadowData.pos=new Float32Array(3*lights.length),scene._shadowData.count=lights.length);for(let i=0;i<lights.length;i++){let light=lights[i];light.prepareRender(),scene._shadowData.maps[i]=light.shadow.rt.depth,scene._shadowData.emptyMaps[i]=Utils3D.getEmptyTexture(),scene._shadowData.size[i]=light.shadow.size,light.position.toArray(scene._shadowData.pos,3*i)}for(let i=0;i<lights.length;i++){let light=lights[i];!light.shadow.frozen&&light.determineVisible()&&render(light)}}(scene,camera),rt&&!rt.vrRT||!_this.vrRenderingPath||forceToScreen?rt||!_this.arRenderingPath||forceToScreen?render(scene,camera,rt):_this.arRenderingPath(render,scene,camera):_this.vrRenderingPath(scene,camera,_projScreenMatrix,_frustum,attachSceneUniforms,rt),scene.displayNeedsUpdate=!1,Shader.renderer.resetState()},this.renderSingle=function(object,camera,rt){rt?(_resolution.set(rt.width,rt.height),RenderTarget.renderer.bind(rt)):(Renderer.overrideViewport||(_gl.viewport(0,0,_width*_dpr,_height*_dpr),_resolution.set(_canvas.width,_canvas.height)),_this.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))),camera.getWorldPosition(camera.worldPos),object.modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix),object.getWorldPosition(object.worldPos),_ubo&&(camera._ubo||initCameraUBO(camera)),object.shader.draw(object,object.geometry),object.noMatrices||(Shader.renderer.appendUniform(object.shader,"normalMatrix",object.normalMatrix),Shader.renderer.appendUniform(object.shader,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader,"modelViewMatrix",object.modelViewMatrix)),_ubo?camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader,"projectionMatrix",camera.projectionMatrix),Shader.renderer.appendUniform(object.shader,"viewMatrix",camera.matrixWorldInverse),Shader.renderer.appendUniform(object.shader,"cameraPosition",camera.worldPos),Shader.renderer.appendUniform(object.shader,"cameraQuaternion",camera.worldQuat),Shader.renderer.appendUniform(object.shader,"resolution",_resolution),Shader.renderer.appendUniform(object.shader,"time",_time.value),Shader.renderer.appendUniform(object.shader,"timeScale",Render.timeScaleUniform.value)),object.geometry.draw(object,object.shader),_ubo&&camera._ubo.unbind(),rt&&RenderTarget.renderer.unbind(rt),Shader.renderer.resetState()},this.setClearColor=function(color,alpha=1){_clearColor=new Color(color),Renderer.CLEAR=[_clearColor.r,_clearColor.g,_clearColor.b,alpha]},this.setClearAlpha=function(alpha){Renderer.CLEAR[3]=alpha},this.getClearColor=function(){return _clearColor||(_clearColor=new Color(0,0,0)),_clearColor},this.getClearAlpha=function(){return Renderer.CLEAR[3]},this.setPixelRatio=function(dpr){_dpr=dpr,this.setSize(_width,_height)},this.setSize=function(width,height){_width=width,_height=height,_canvas.width=width*_dpr,_canvas.height=height*_dpr,_canvas.style.width=width+"px",_canvas.style.height=height+"px",_resolution.set(_canvas.width,_canvas.height)},this.getMaxAnisotropy=function(){return Device.graphics.webgl&&_this.extensions.anisotropy?(_anisotropy||(_anisotropy=_gl.getParameter(_this.extensions.anisotropy.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),_anisotropy):0},this.readPixels=function(rt,x=0,y=0,width,height){width||(width=rt?rt.width:1),height||(height=rt?rt.height:1),width=Math.round(width),height=Math.round(height);let w=Math.round(width-x),h=Math.round(height-y),array=new Uint8Array(w*h*4);return _gl.bindFramebuffer(_gl.FRAMEBUFFER,rt?rt._gl:null),_gl.readPixels(x,y,width,height,_gl.RGBA,_gl.UNSIGNED_BYTE,array),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),array},this.blit=function(input,output){return _this.type==Renderer.WEBGL2&&(input._gl||input.upload(),output._gl||output.upload(),_gl.bindFramebuffer(_gl.READ_FRAMEBUFFER,input._gl),_gl.bindFramebuffer(_gl.DRAW_FRAMEBUFFER,output._gl),_gl.blitFramebuffer(0,0,input.width,input.height,0,0,output.width,output.height,_gl.COLOR_BUFFER_BIT,_gl.NEAREST),_gl.bindFramebuffer(_gl.READ_FRAMEBUFFER,null),_gl.bindFramebuffer(_gl.DRAW_FRAMEBUFFER,null),!0)},this.setupStencilMask=function(ref=1){_stencilActive||(_gl.enable(_gl.STENCIL_TEST),_gl.clear(_gl.STENCIL_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT)),_stencilActive=!0,_gl.stencilFunc(_gl.ALWAYS,ref,255),_gl.stencilOp(_gl.KEEP,_gl.KEEP,_gl.REPLACE),_gl.stencilMask(255),_gl.colorMask(!1,!1,!1,!1),_gl.disable(_gl.DEPTH_TEST)},this.setupStencilDraw=function(mode,ref=1){_gl.colorMask(!0,!0,!0,!0),_gl.enable(_gl.DEPTH_TEST),_gl.stencilFunc("inside"==mode?_gl.EQUAL:_gl.NOTEQUAL,ref,255),_gl.stencilOp(_gl.KEEP,_gl.KEEP,_gl.KEEP)},this.clearStencil=function(){_gl.disable(_gl.STENCIL_TEST),_stencilActive=!1},this.clearDepth=function(rt){rt&&!rt._gl&&rt.upload(),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),_gl.clear(_gl.DEPTH_BUFFER_BIT),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)},this.clearColor=function(rt){rt&&!rt._gl&&rt.upload(),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),_gl.clear(_gl.COLOR_BUFFER_BIT),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)},this.get("resolution",(_=>_resolution)),this.get("time",(_=>_time)),this.get("canvas",(_=>_canvas))}),(_=>{Renderer.WEBGL1="webgl1",Renderer.WEBGL2="webgl2",Renderer.STATIC_SHADOWS="static_shadows",Renderer.SHADOWS_LOW="shadows_low",Renderer.SHADOWS_MED="shadows_med",Renderer.SHADOWS_HIGH="shadows_high",Renderer.ID=0}));class CameraBase3D extends Base3D{constructor(){super(),this.matrixWorldInverse=new Matrix4,this.projectionMatrix=new Matrix4,this.isCamera=!0}copy(source,recursive){return Base3D.prototype.copy.call(this,source,recursive),this.matrixWorldInverse.copy(source.matrixWorldInverse),this.projectionMatrix.copy(source.projectionMatrix),this}updateMatrixWorld(force){Base3D.prototype.updateMatrixWorld.call(this,force),this.matrixWorldInverse.getInverse(this.matrixWorld)}clone(){return(new this.constructor).copy(this)}}class CubeCamera extends Base3D{constructor(near=.1,far=1e3,cubeResolution=512){super();this.px=new PerspectiveCamera(90,1,near,far),this.px.up.set(0,-1,0),this.px.lookAt(new Vector3(1,0,0)),this.add(this.px),this.nx=new PerspectiveCamera(90,1,near,far),this.nx.up.set(0,-1,0),this.nx.lookAt(new Vector3(-1,0,0)),this.add(this.nx),this.py=new PerspectiveCamera(90,1,near,far),this.py.up.set(0,0,1),this.py.lookAt(new Vector3(0,1,0)),this.add(this.py),this.ny=new PerspectiveCamera(90,1,near,far),this.ny.up.set(0,0,-1),this.ny.lookAt(new Vector3(0,-1,0)),this.add(this.ny),this.pz=new PerspectiveCamera(90,1,near,far),this.pz.up.set(0,-1,0),this.pz.lookAt(new Vector3(0,0,1)),this.add(this.pz),this.nz=new PerspectiveCamera(90,1,near,far),this.nz.up.set(0,-1,0),this.nz.lookAt(new Vector3(0,0,-1)),this.add(this.nz),this.rt=new CubeRenderTarget(cubeResolution,cubeResolution)}render(scene=World.SCENE,renderer=World.RENDERER){let rt=this.rt;this.updateMatrixWorld(!0),this.beforeRender&&this.beforeRender(this.px),rt.activeFace=0,renderer.render(scene,this.px,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.nx),rt.activeFace=1,renderer.render(scene,this.nx,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.py),rt.activeFace=2,renderer.render(scene,this.py,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.ny),rt.activeFace=3,renderer.render(scene,this.ny,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.pz),rt.activeFace=4,renderer.render(scene,this.pz,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.nz),rt.activeFace=5,renderer.render(scene,this.nz,rt),this.afterRender&&this.afterRender(rt)}}class OrthographicCamera extends CameraBase3D{constructor(left,right,top,bottom,near,far){super(),this.isOrthographicCamera=!0,this.zoom=1,this.left=left,this.right=right,this.top=top,this.bottom=bottom,this.near=void 0!==near?near:.1,this.far=void 0!==far?far:2e3,this.position.z=1,this.updateProjectionMatrix()}clone(){return(new OrthographicCamera).copy(this)}copy(source,recursive){return CameraBase3D.prototype.copy.call(this,source,recursive),this.left=source.left,this.right=source.right,this.top=source.top,this.bottom=source.bottom,this.near=source.near,this.far=source.far,this.zoom=source.zoom,this.view=null===source.view?null:Object.assign({},source.view),this}updateProjectionMatrix(){let dx=(this.right-this.left)/(2*this.zoom),dy=(this.top-this.bottom)/(2*this.zoom),cx=(this.right+this.left)/2,cy=(this.top+this.bottom)/2,left=cx-dx,right=cx+dx,top=cy+dy,bottom=cy-dy;this.projectionMatrix.makeOrthographic(left,right,top,bottom,this.near,this.far)}setViewport(width,height){this.left=width/-2,this.right=width/2,this.top=height/2,this.bottom=height/-2,this.updateProjectionMatrix()}}class PerspectiveCamera extends CameraBase3D{constructor(fov,aspect,near,far){super(),this.type="PerspectiveCamera",this.fov=fov||50,this.zoom=1,this.near=near||.1,this.far=far||2e3,this.focus=10,this.aspect=aspect||1,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}clone(){return(new PerspectiveCamera).copy(this)}copy(source,recursive){return CameraBase3D.prototype.copy.call(this,source,recursive),this.fov=source.fov,this.zoom=source.zoom,this.near=source.near,this.far=source.far,this.focus=source.focus,this.aspect=source.aspect,this.filmGauge=source.filmGauge,this.filmOffset=source.filmOffset,this}setFocalLength(focalLength){let vExtentSlope=.5*this.getFilmHeight()/focalLength;this.fov=Math.degrees(2*Math.atan(vExtentSlope)),this.updateProjectionMatrix()}getFocalLength(){let vExtentSlope=Math.tan(Math.radians(.5*this.fov));return.5*this.getFilmHeight()/vExtentSlope}getEffectiveFOV(){return Math.degrees(2*Math.atan(Math.tan(Math.radians(.5*this.fov))/this.zoom))}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}updateProjectionMatrix(){let near=this.near,top=near*Math.tan(Math.radians(.5*this.fov))/this.zoom,height=2*top,width=this.aspect*height,left=-.5*width,skew=(this.view,this.filmOffset);0!==skew&&(left+=near*skew/this.getFilmWidth()),this.projectionMatrix.makePerspective(left,left+width,top,top-height,near,this.far)}}class Geometry{constructor(){this.attributes=Geometry.createAttributes(this),this.drawRange={start:0,end:0},this.boundingBox=null,this.boundingSphere=null,this.index=null,this.maxInstancedCount=void 0,this.keepAlive=!1,this.id=Utils.timestamp()}draw(mesh,shader){Geometry.renderer.draw(this,mesh,shader)}upload(mesh,shader){Geometry.renderer.upload(this,mesh,shader)}destroy(mesh){this.keepAlive||Geometry.renderer.destroy(this,mesh)}addAttribute(name,attribute){attribute.meshPerAttribute>=1&&(this.isInstanced=!0,this.maxInstancedCount=attribute.count),this.attributes[name]=attribute}setIndex(attribute){this.index=attribute.array||attribute}toNonIndexed(){let geometry2=new Geometry,indices=this.index,attributes=this.attributes;for(let name in attributes){let attribute=attributes[name],array=attribute.array,itemSize=attribute.itemSize,array2=new array.constructor(indices.length*itemSize),index=0,index2=0;for(let i=0,l=indices.length;i<l;i++){index=indices[i]*itemSize;for(let j=0;j<itemSize;j++)array2[index2++]=array[index++]}geometry2.addAttribute(name,new GeometryAttribute(array2,itemSize))}return geometry2}normalizeNormals(){let vector=this._V1||new Vector3;this._V1=vector;let x,y,z,normals=this.attributes.normal;for(let i=0,il=normals.count;i<il;i++)x=3*i+0,y=3*i+1,z=3*i+2,vector.x=normals.array[x],vector.y=normals.array[y],vector.z=normals.array[z],vector.normalize(),normals.array[x]=vector.x,normals.array[y]=vector.y,normals.array[z]=vector.z}computeFaceNormals(){let cb=new Vector3,ab=new Vector3;for(let f=0,fl=this.faces.length;f<fl;f++){let face=this.faces[f],vA=this.vertices[face.a],vB=this.vertices[face.b],vC=this.vertices[face.c];cb.subVectors(vC,vB),ab.subVectors(vA,vB),cb.cross(ab),cb.normalize(),face.normal.copy(cb)}}computeVertexNormals(){let index=this.index,attributes=this.attributes,groups=this.groups;if(attributes.position){let positions=attributes.position.array;if(void 0===attributes.normal)this.addAttribute("normal",new BufferAttribute(new Float32Array(positions.length),3));else{let array=attributes.normal.array;for(let i=0,il=array.length;i<il;i++)array[i]=0}let vA,vB,vC,normals=attributes.normal.array,pA=new Vector3,pB=new Vector3,pC=new Vector3,cb=new Vector3,ab=new Vector3;if(index){let indices=index.array;0===groups.length&&this.addGroup(0,indices.length);for(let j=0,jl=groups.length;j<jl;++j){let group=groups[j],start=group.start;for(let i=start,il=start+group.count;i<il;i+=3)vA=3*indices[i+0],vB=3*indices[i+1],vC=3*indices[i+2],pA.fromArray(positions,vA),pB.fromArray(positions,vB),pC.fromArray(positions,vC),cb.subVectors(pC,pB),ab.subVectors(pA,pB),cb.cross(ab),normals[vA]+=cb.x,normals[vA+1]+=cb.y,normals[vA+2]+=cb.z,normals[vB]+=cb.x,normals[vB+1]+=cb.y,normals[vB+2]+=cb.z,normals[vC]+=cb.x,normals[vC+1]+=cb.y,normals[vC+2]+=cb.z}}else for(let i=0,il=positions.length;i<il;i+=9)pA.fromArray(positions,i),pB.fromArray(positions,i+3),pC.fromArray(positions,i+6),cb.subVectors(pC,pB),ab.subVectors(pA,pB),cb.cross(ab),normals[i]=cb.x,normals[i+1]=cb.y,normals[i+2]=cb.z,normals[i+3]=cb.x,normals[i+4]=cb.y,normals[i+5]=cb.z,normals[i+6]=cb.x,normals[i+7]=cb.y,normals[i+8]=cb.z;this.normalizeNormals(),attributes.normal.needsUpdate=!0}}computeBoundingBox(){this.boundingBox||(this.boundingBox=new Box3);let position=this.attributes.position;position?this.boundingBox.setFromBufferAttribute(position):this.boundingBox.makeEmpty()}computeBoundingSphere(){let box=new Box3,vector=new Vector3;this.boundingSphere||(this.boundingSphere=new Sphere);let position=this.attributes.position;if(position){let center=this.boundingSphere.center;box.setFromBufferAttribute(position),box.getCenter(center);let maxRadiusSq=0;for(let i=0,il=position.count;i<il;i++)vector.x=position.array[3*i+0],vector.y=position.array[3*i+1],vector.z=position.array[3*i+2],maxRadiusSq=Math.max(maxRadiusSq,center.distanceToSquared(vector));this.boundingSphere.radius=Math.sqrt(maxRadiusSq),isNaN(this.boundingSphere.radius)&&console.error("Bounding Sphere came up NaN, broken position buffer.",this)}}merge(geometry){let Float32ArrayConcat=(first,second)=>{let firstLength=first.length,result=new Float32Array(firstLength+second.length);return result.set(first),result.set(second,firstLength),result},attributes=this.attributes;if(this.index){let indices=geometry.index,offset=attributes.position.count;for(let i=0,il=indices.length;i<il;i++)indices[i]=offset+indices[i];this.index=((first,second)=>{let firstLength=first.length,result=new Uint16Array(firstLength+second.length);return result.set(first),result.set(second,firstLength),result})(this.index,indices)}for(let key in attributes)void 0!==geometry.attributes[key]&&(attributes[key].array=Float32ArrayConcat(attributes[key].array,geometry.attributes[key].array),attributes[key].count=attributes[key].array.length/attributes[key].itemSize);return this}clone(noCopy){return(new Geometry).copy(this,noCopy)}copy(source,noCopy){this.index=null,this.boundingBox=null,this.boundingSphere=null,this.index=source.index;let attributes=source.attributes;for(let name in attributes)this.addAttribute(name,attributes[name].clone(noCopy));let boundingBox=source.boundingBox;boundingBox&&boundingBox.clone&&(this.boundingBox=boundingBox.clone());let boundingSphere=source.boundingSphere;return boundingSphere&&boundingSphere.clone&&(this.boundingSphere=boundingSphere.clone()),this}center(){let offset=new Vector3;return this.computeBoundingBox(),this.boundingBox.getCenter(offset).negate(),this.applyMatrix((new Matrix4).makeTranslation(offset.x,offset.y,offset.z)),this}applyMatrix(matrix){let position=this.attributes.position;position&&(matrix.applyToBufferAttribute(position),position.needsUpdate=!0);let normal=this.attributes.normal;if(normal){(new Matrix3).getNormalMatrix(matrix).applyToBufferAttribute(normal),normal.needsUpdate=!0}return this.boundingBox&&this.computeBoundingBox(),this.boundingSphere&&this.computeBoundingSphere(),this}scale(x,y,z){this.applyMatrix((new Matrix4).makeScale(x,y,z))}setFromPoints(points){let position=[];for(let i=0,l=points.length;i<l;i++){let point=points[i];position.push(point.x,point.y,point.z||0)}return this.addAttribute("position",new GeometryAttribute(new Float32Array(position),3)),this}instanceFrom(geom){geom.index&&(geom=geom.toNonIndexed());for(let key in geom.attributes)this.addAttribute(key,geom.attributes[key]);return this}uploadBuffersAsync(){return Geometry.renderer.uploadBuffersAsync(this)}toJSON(){let geom=this.index?this.toNonIndexed():this;return JSON.stringify({position:Array.from(geom.attributes.position.array).map((val=>parseFloat(val.toFixed(3)))),uv:Array.from(geom.attributes.uv.array).map((val=>parseFloat(val.toFixed(3))))})}}class GeometryAttribute{constructor(_array,_itemSize,_meshPerAttribute){this.array=_array,this.itemSize=_itemSize,this.count=void 0!==_array?_array.length/_itemSize:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.meshPerAttribute=_meshPerAttribute}setArray(array){let newCount=void 0!==array?array.length/this.itemSize:0;newCount!=this.count&&(this.needsNewBuffer=!0),this.array=array,this.count=newCount,this.needsUpdate=!0}clone(noCopy){return noCopy?this:new GeometryAttribute(new Float32Array(this.array),this.itemSize,this.meshPerAttribute)}getX(index){return this.array[index*this.itemSize]}setX(index,x){return this.array[index*this.itemSize]=x,this}getY(index){return this.array[index*this.itemSize+1]}setY(index,y){return this.array[index*this.itemSize+1]=y,this}getZ(index){return this.array[index*this.itemSize+2]}setZ(index,z){return this.array[index*this.itemSize+2]=z,this}getW(index){return this.array[index*this.itemSize+3]}setW(index,w){return this.array[index*this.itemSize+3]=w,this}setXY(index,x,y){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this}setXYZ(index,x,y,z){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this.array[index+2]=z,this}setXYZW(index,x,y,z,w){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this.array[index+2]=z,this.array[index+3]=w,this}}class InterleavedBuffer{constructor(array,stride){this.array=array,this.stride=stride,this.count=array?array.length/stride:0,this.isInterleaved=!0,this.needsUpdate=!1,this.dynamic=!1,this.updateRange={offset:0,count:-1}}}class InterleavedGeometryAttribute{constructor(interleavedBuffer,itemSize,offset){this.data=interleavedBuffer,this.itemSize=itemSize,this.offset=offset,this.isInterleaved=!0}}class Group extends Base3D{constructor(){super(),this.isGroup=!0}}class BaseLight extends Base3D{constructor(color=16777215,intensity=1,distance=9999){super(),this.color=new Color(color),this.data=new Vector4,this.data2=new Vector4,this.data3=new Vector4,this.properties=new Vector4(intensity,distance,0,0)}destroy(){this.shadow&&(Lighting.removeFromShadowGroup(this),this.shadow.destroy())}prepareRender(){this.shadow.camera.position.copy(this.position),this.shadow.camera.lookAt(this.shadow.target)}set castShadow(bool){(this.shadow||bool)&&(this.shadow||(this.shadow=new Shadow(this)),this.shadow.enabled=bool,this.silentShadow||(bool?Lighting.addToShadowGroup(this):Lighting.removeFromShadowGroup(this)))}set intensity(v){this.properties.x=v}get intensity(){return this.properties.x}set distance(v){this.properties.y=v}get distance(){return this.properties.y}set bounce(v){this.properties.z=v}get bounce(){return this.properties.z}}class Line extends Base3D{constructor(geometry,shader){super(),this.geometry=geometry,this.shader=shader,this.isLine=!0,this.id=Renderer.ID++}clone(){return new Line(this.geometry,this.shader).copy(this)}}class Mesh extends Base3D{constructor(geometry,shader){super(),this._geometry=geometry,this._shader=shader&&shader.shader?shader.shader:shader,this.isMesh=!0,this.id=Utils.timestamp(),shader&&(this._shader.mesh=this)}clone(){return new Mesh(this._geometry,this.shader).copy(this)}set geometry(g){Geometry.renderer.resetMeshGeom(this),this._geometry=g}get geometry(){return this._geometry}set shader(shader){this._shader=shader&&shader.shader?shader.shader:shader}get shader(){return this._shader}isInsideOf(mesh){return this.box3||(this.box3=new Box3),this.box3.setFromObject(this),mesh.isMeshInside(this)}isMeshInside(mesh){return this.box3||(this.box3=new Box3),this.box3.setFromObject(this),mesh.box3.intersectsBox(this.box3)}}class Points extends Base3D{constructor(geometry,shader){super(),this._geometry=geometry,this.shader=shader,this.isPoints=!0,this.id=Renderer.ID++,shader&&(this.shader.mesh=this)}clone(){return new Points(this._geometry,this.shader).copy(this)}set geometry(g){Geometry.renderer.resetMeshGeom(this),this._geometry=g}get geometry(){return this._geometry}}class Scene extends Base3D{constructor(){super(),this.autoUpdate=!0,this.toRender=[[],[]],this._displayNeedsUpdate=!0,this.isScene=!0,this.changes=[]}set displayNeedsUpdate(v){!0===v&&this.changes.forEach((cb=>cb())),this._displayNeedsUpdate=v}get displayNeedsUpdate(){return this._displayNeedsUpdate}bindSceneChange(cb){this.changes.push(cb)}}Class((function FBORendererWebGL(_gl){const WEBGL2=Renderer.type==Renderer.WEBGL2,{getFormat:getFormat,getProperty:getProperty,getType:getType,getFloatParams:getFloatParams}=require("GLTypes");function prepareTexture(texture){texture._gl=_gl.createTexture(),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),texture.needsUpdate=!1}function texImageDB(rt,texture){if(texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),getType(texture),null);_gl.bindTexture(_gl.TEXTURE_2D,null)}this.upload=function(rt){if(!rt._gl){if(rt.cube)return function uploadCube(rt){rt._gl=_gl.createFramebuffer(),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl);let texture=rt.texture;texture._gl=_gl.createTexture(),texture.cube=!0,texture.needsUpdate=!1,_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl);for(let i=0;i<6;i++)_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),_gl.UNSIGNED_BYTE,null);_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),rt._depthBuffer=_gl.createRenderbuffer(),_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_COMPONENT16,rt.width,rt.height),_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,rt._depthBuffer),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}(rt);if(rt._gl=_gl.createFramebuffer(),rt.depth||rt.disableDepth||(rt._depthBuffer=_gl.createRenderbuffer(),_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),_gl.renderbufferStorage(_gl.RENDERBUFFER,rt.stencil?_gl.DEPTH_STENCIL:_gl.DEPTH_COMPONENT16,rt.width,rt.height)),RenderCount.add(`fbo_${rt.width}x${rt.height}`,rt),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.multi)if(WEBGL2){let colorAttachments=[];for(let i=0;i<rt.attachments.length;i++){let key="COLOR_ATTACHMENT"+i,texture=rt.attachments[i];colorAttachments.push(_gl[key]),prepareTexture(texture),texImageDB(rt,texture),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl[key],_gl.TEXTURE_2D,texture._gl,0)}_gl.drawBuffers(colorAttachments)}else{let ext=Renderer.extensions.drawBuffers,colorAttachments=[];for(let i=0;i<rt.attachments.length;i++){let key="COLOR_ATTACHMENT"+i+"_WEBGL",texture=rt.attachments[i];colorAttachments.push(ext[key]),prepareTexture(texture),texImageDB(rt,texture),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,ext[key],_gl.TEXTURE_2D,texture._gl,0)}ext.drawBuffersWEBGL(colorAttachments)}else{if(prepareTexture(rt.texture),rt.texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(rt.texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(rt.texture),rt.width,rt.height,0,getFormat(rt.texture),getType(rt.texture),null);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,_gl.TEXTURE_2D,rt.texture._gl,0)}if(rt.depth){prepareTexture(rt.depth);let iformat=WEBGL2?_gl.DEPTH_COMPONENT24:_gl.DEPTH_COMPONENT;_gl.texImage2D(_gl.TEXTURE_2D,0,iformat,rt.width,rt.height,0,_gl.DEPTH_COMPONENT,_gl.UNSIGNED_INT,null),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,rt.stencil?_gl.DEPTH_STENCIL_ATTACHMENT:_gl.DEPTH_ATTACHMENT,_gl.TEXTURE_2D,rt.depth._gl,0)}else rt.disableDepth||_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,rt.stencil?_gl.DEPTH_STENCIL_ATTACHMENT:_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,rt._depthBuffer);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}},this.bind=function(rt){rt._gl||this.upload(rt),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.cube&&_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,_gl.TEXTURE_CUBE_MAP_POSITIVE_X+rt.activeFace,rt.texture._gl,0),rt.scissor&&(_gl.enable(_gl.SCISSOR_TEST),_gl.scissor(rt.scissor.x,rt.scissor.y,rt.scissor.width,rt.scissor.height)),_gl.viewport(rt.viewport.x,rt.viewport.y,rt.width,rt.height),Renderer.instance.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))},this.unbind=function(rt){rt.scissor&&_gl.disable(_gl.SCISSOR_TEST),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)},this.resize=function(rt){if(rt.texture._gl&&rt._gl){if(_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.multi)for(let i=0;i<rt.attachments.length;i++){let texture=rt.attachments[i];if(_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(rt.texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),getType(texture),null)}else if(_gl.bindTexture(_gl.TEXTURE_2D,rt.texture._gl),rt.texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(rt.texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(rt.texture),rt.width,rt.height,0,getFormat(rt.texture),getType(rt.texture),null);if(rt.depth){_gl.bindTexture(_gl.TEXTURE_2D,rt.depth._gl);let iformat=WEBGL2?_gl.DEPTH_COMPONENT24:_gl.DEPTH_COMPONENT;_gl.texImage2D(_gl.TEXTURE_2D,0,iformat,rt.width,rt.height,0,_gl.DEPTH_COMPONENT,_gl.UNSIGNED_INT,null),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,rt.stencil?_gl.DEPTH_STENCIL_ATTACHMENT:_gl.DEPTH_ATTACHMENT,_gl.TEXTURE_2D,rt.depth._gl,0)}else rt.disableDepth||(_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),_gl.renderbufferStorage(_gl.RENDERBUFFER,rt.stencil?_gl.DEPTH_STENCIL:_gl.DEPTH_COMPONENT16,rt.width,rt.height));_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}},this.destroy=function(rt){_gl.deleteFramebuffer(rt._gl),rt._depthBuffer&&_gl.deleteRenderbuffer(rt._depthBuffer),Texture.renderer.destroy(rt.texture),RenderCount.remove(`fbo_${rt.width}x${rt.height}`),rt.multi&&rt.attachments.forEach((t=>Texture.renderer.destroy(t))),rt._gl=null}})),Class((function GeometryRendererWebGL(_gl){var _cache={};const WEBGL2=Renderer.type==Renderer.WEBGL2;function updateBuffer(attrib){if(!attrib._gl)return;attrib.needsUpdate=!1,_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),RenderStats.update("BufferUpdates");let array=attrib.array,updateRange=attrib.updateRange;if(-1===updateRange.count)attrib.needsNewBuffer?(_gl.bufferData(_gl.ARRAY_BUFFER,attrib.array,_gl.DYNAMIC_DRAW),attrib.needsNewBuffer=!1):_gl.bufferSubData(_gl.ARRAY_BUFFER,0,array);else if(Array.isArray(updateRange)){for(let i=updateRange.length-1;i>-1;i--){let{offset:offset,count:count}=updateRange[i];_gl.bufferSubData(_gl.ARRAY_BUFFER,offset*array.BYTES_PER_ELEMENT,array.subarray(offset,offset+count))}updateRange.length=0}else _gl.bufferSubData(_gl.ARRAY_BUFFER,updateRange.offset*array.BYTES_PER_ELEMENT,array.subarray(updateRange.offset,updateRange.offset+updateRange.count));_gl.bindBuffer(_gl.ARRAY_BUFFER,null)}this.draw=function(geom,mesh,shader){geom._gl&&!geom.needsUpdate&&mesh._gl&&mesh._gl.geomInit||this.upload(geom,mesh,shader),RenderStats.active&&RenderStats.update("DrawCalls",1,shader.vsName+"|"+shader.fsName,mesh);for(let i=geom._attributeKeys.length-1;i>-1;i--){let key=geom._attributeKeys[i],attrib=geom._attributeValues[i];mesh._gl.program!=shader._gl.program?(mesh._gl[key]=_gl.getAttribLocation(shader._gl.program,key),mesh._gl.program=shader._gl.program):void 0===mesh._gl[key]&&(mesh._gl[key]=_gl.getAttribLocation(shader._gl.program,key)),-1!==mesh._gl[key]&&(attrib.isInterleaved&&attrib.data.needsUpdate?updateBuffer(attrib.data):(attrib.needsUpdate||attrib.dynamic)&&updateBuffer(attrib))}if(geom.indexNeedsUpdate){if(_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),geom.indexUpdateRange){let updateRange=geom.indexUpdateRange;_gl.bufferSubData(_gl.ELEMENT_ARRAY_BUFFER,updateRange.offset*geom.index.BYTES_PER_ELEMENT,geom.index.subarray(updateRange.offset,updateRange.offset+updateRange.count))}else _gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,geom.index,_gl.STATIC_DRAW);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,null),geom.indexNeedsUpdate=!1}mesh._gl.vao.bind();let mode=mesh._gl.mode;mode||(mesh._gl.mode=mode=function getMode(mesh,shader){return mesh.isPoints?_gl.POINTS:mesh.isLine?_gl.LINE_STRIP:shader.wireframe?_gl.LINES:_gl.TRIANGLES}(mesh,shader));let drawStart=geom.drawRange.start||0,drawEnd=geom.drawRange.end||geom.attributes.position.count;if(geom.isInstanced){let maxInstancedCount=mesh.maxInstancedCount?Math.min(mesh.maxInstancedCount,geom.maxInstancedCount):geom.maxInstancedCount;WEBGL2?geom.index?_gl.drawElementsInstanced(mode,geom.index.length,_gl.UNSIGNED_SHORT,0,maxInstancedCount):_gl.drawArraysInstanced(mode,drawStart,drawEnd,maxInstancedCount):geom.index?Renderer.extensions.instancedArrays.drawElementsInstancedANGLE(mode,geom.index.length,_gl.UNSIGNED_SHORT,0,maxInstancedCount):Renderer.extensions.instancedArrays.drawArraysInstancedANGLE(mode,drawStart,drawEnd,maxInstancedCount)}else geom.index?_gl.drawElements(mode,geom.index.length,_gl.UNSIGNED_SHORT,0):_gl.drawArrays(mode,drawStart,drawEnd);mesh._gl.vao.unbind()},this.upload=function(geom,mesh,shader,hotload){if(!mesh)return;geom._gl||(geom._gl={id:Utils.timestamp()}),mesh._gl||(mesh._gl={}),mesh._gl.geomInit=!0,geom.uploaded=!0;const KEY=`${geom._gl.id}_${shader._gl._id}`;let cached=_cache[KEY];if(cached&&!hotload)return cached.count++,mesh._gl.vao=cached.vao,void(mesh._gl.lookup=KEY);RenderCount.add("geometry"),mesh._gl.vao&&mesh._gl.vao.destroy(),mesh._gl.vao=new VAO(_gl),geom.distributeBufferData||RenderCount.add("geom_upload",geom);for(let i=geom._attributeKeys.length-1;i>-1;i--){let key=geom._attributeKeys[i],attrib=geom._attributeValues[i],location=mesh._gl[key]||_gl.getAttribLocation(shader._gl.program,key);if(mesh._gl[key]=location,attrib._gl)continue;attrib._gl={};let{array:array,dynamic:dynamic}=attrib;attrib.isInterleaved&&(attrib.data._gl||(attrib.data._gl=attrib._gl),attrib._gl=attrib.data._gl,array=attrib.data.array,dynamic=attrib.data.dynamic),attrib._gl.buffer||(attrib._gl.buffer=_gl.createBuffer(),attrib._gl.bufferUploaded=!geom.distributeBufferData,_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),_gl.bufferData(_gl.ARRAY_BUFFER,geom.distributeBufferData?array.length*array.BYTES_PER_ELEMENT:array,dynamic?_gl.DYNAMIC_DRAW:_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ARRAY_BUFFER,null)),attrib.needsUpdate=!1}geom.index&&(geom._gl.index||(geom._gl.index=_gl.createBuffer(),_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,geom.index,_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,null))),mesh._gl.vao.bind();for(let i=geom._attributeKeys.length-1;i>-1;i--){let key=geom._attributeKeys[i],attrib=geom._attributeValues[i],location=mesh._gl[key];if(-1==location)continue;let stride=0,offset=0;if(attrib.isInterleaved){let bytes=attrib.data.array.BYTES_PER_ELEMENT;stride=attrib.data.stride*bytes,offset=attrib.offset*bytes}_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),_gl.vertexAttribPointer(location,attrib.itemSize,_gl.FLOAT,!1,stride,offset),_gl.enableVertexAttribArray(location),geom.isInstanced&&(WEBGL2?_gl.vertexAttribDivisor(location,attrib.meshPerAttribute):Renderer.extensions.instancedArrays.vertexAttribDivisorANGLE(location,attrib.meshPerAttribute))}geom.index&&_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),mesh._gl.vao.unbind(),_cache[KEY]={count:1,vao:mesh._gl.vao}},this.destroy=function(geom,mesh){for(let i=geom._attributeKeys.length-1;i>-1;i--){geom._attributeKeys[i];let attrib=geom._attributeValues[i];attrib._gl&&(_gl.deleteBuffer(attrib._gl.buffer),attrib._gl=null)}if(mesh&&mesh._gl&&mesh._gl.vao){let cache=_cache[mesh._gl.lookup];cache?(cache.count--,0==cache.count&&(cache.vao.destroy(),delete _cache[mesh._gl.lookup])):mesh._gl.vao.destroy(),delete mesh._gl.vao}delete geom._gl},this.resetMeshGeom=function(mesh){mesh._gl&&(mesh._gl.geomInit=!1)},this.uploadBuffersAsync=async function(geom){if(geom._gl&&geom._gl.uploadedAsync)return;let upload=attrib=>{let array=attrib.array,buffer=attrib._gl.buffer,promise=Promise.create(),amt=4,match=!1;for(;!match;)amt--,array.length%amt==0&&(match=!0);let chunk=array.length/amt,i=0,worker=new Render.Worker((function uploadBuffersAsync(){let offset=i*chunk,subarray=array.subarray(offset,offset+chunk);if(!attrib._gl)return worker.stop(),promise.resolve();subarray.length&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,buffer),_gl.bufferSubData(_gl.ARRAY_BUFFER,offset*array.BYTES_PER_ELEMENT,subarray),_gl.bindBuffer(_gl.ARRAY_BUFFER,null)),++i==amt&&(promise.resolve(),worker.stop())}));return promise},uploaded=!1;for(let i=geom._attributeKeys.length-1;i>-1;i--){geom._attributeKeys[i];let attrib=geom._attributeValues[i];if(!attrib._gl){geom.distributeBufferData=!0;let{array:array,dynamic:dynamic}=attrib;attrib._gl={},attrib.isInterleaved&&(attrib.data._gl||(attrib.data._gl=attrib._gl),attrib._gl=attrib.data._gl,array=attrib.data.array,dynamic=attrib.data.dynamic),attrib._gl.buffer||(attrib._gl.buffer=_gl.createBuffer(),attrib._gl.bufferUploaded=!geom.distributeBufferData,attrib.array.length&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),_gl.bufferData(_gl.ARRAY_BUFFER,array.length*array.BYTES_PER_ELEMENT,dynamic?_gl.DYNAMIC_DRAW:_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ARRAY_BUFFER,null))),attrib.needsUpdate=!1,geom.needsUpdate=!0}attrib._gl.bufferUploaded||(attrib._gl.bufferUploaded=!0,uploaded=!0,await upload(attrib),attrib.needsUpdate=!1)}geom._gl.uploadedAsync=!0,uploaded&&RenderCount.add("geom_uploadAsync",geom)}})),Class((function ShaderRendererWebGL(_gl){var _pool={},_programID=0,_cached={},_uboCache={};const WEBGL2=Renderer.type==Renderer.WEBGL2,GLOBAL_UNIFORMS=["normalMatrix","modelMatrix","modelViewMatrix","projectionMatrix","viewMatrix","cameraPosition","cameraQuaternion","resolution","time","shadowMatrix","shadowLightPos","shadowSize"];function toTypedArray(uni){uni.value;return uni._gl||(uni._gl={}),uni._gl.array&&uni._gl.array.length==uni.value.length?uni._gl.array.set(uni.value):uni._gl.array=new Float32Array(uni.value),uni._gl.array}function createShader(str,type){let shader=_gl.createShader(type);if(_gl.shaderSource(shader,str),_gl.compileShader(shader),Hydra.LOCAL&&!_gl.getShaderParameter(shader,_gl.COMPILE_STATUS)){let error=_gl.getShaderInfoLog(shader);_gl.deleteShader(shader);let split=str.split("\n"),errorString="";split.forEach(((line,index)=>{index=function(){switch(index.toString().length){case 1:return"00"+index;case 2:return"0"+index}return index}(),errorString+=`${index}: ${line}\n`})),console.warn(error,errorString)}return shader}function createProgram(shader){let vsCode=shader.onBeforeCompile(shader.vertexShader,"vs"),fsCode=shader.onBeforeCompile(shader.fragmentShader,"fs");RenderCount.add("shader",shader);let vs=createShader(vsCode,_gl.VERTEX_SHADER),fs=createShader(fsCode,_gl.FRAGMENT_SHADER);Hydra.LOCAL&&window.GLSLLinter&&GLSLLinter.lint(shader,vsCode,fsCode);let program=_gl.createProgram();return _gl.attachShader(program,vs),_gl.attachShader(program,fs),_gl.linkProgram(program),Hydra.LOCAL&&(_gl.getProgramParameter(program,_gl.LINK_STATUS)||(console.warn(`Shader: ${shader.vsName} | ${shader.vsName}`),console.warn(vsCode),console.warn(fsCode),console.error(`Could not compile WebGL program. ${shader.vsName} ${shader.fsName} \n\n`+_gl.getProgramInfoLog(program)))),_gl.deleteShader(vs),_gl.deleteShader(fs),program}function setupShaders(shader){for(let i=shader._uniformKeys.length-1;i>-1;i--){let key=shader._uniformKeys[i],uniform=shader._uniformValues[i];if(void 0===shader._gl[key]&&uniform)if(uniform.ubo)if(WEBGL2){if(_uboCache[shader.UILPrefix]&&!shader.ubo&&(shader.ubo=_uboCache[shader.UILPrefix]),_uboCache[shader.UILPrefix]){shader._gl[key]="U";continue}shader.ubo||(shader.ubo=new UBO(1,_gl)),shader.ubo.push(uniform),shader._gl[key]="U"}else shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key);else WEBGL2&&uniform.lightUBO?(shader._gl[key]="U",shader.uboLight=!0):shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key)}shader.ubo&&!_uboCache[shader.UILPrefix]&&(_uboCache[shader.UILPrefix]=shader.ubo),shader._gl.setupGlobals||(shader._gl.setupGlobals=!0,GLOBAL_UNIFORMS.forEach((key=>{shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key)}))),shader.uboLight&&_gl.getUniformBlockIndex(shader._gl.program,"lights"),WEBGL2&&_gl.getUniformBlockIndex(shader._gl.program,"global")}function uniformTextureArray(uni,uLoc,shader){let array=shader._gl.texArray||[];array.length=0,shader._gl.texArray=array;for(let i=0;i<uni.value.length;i++){array.push(shader._gl.texIndex);let texture=uni.value[i];!1===texture.loaded&&(texture=Utils3D.getEmptyTexture()),(void 0===texture._gl||texture.needsReupload)&&Texture.renderer.upload(texture),_gl.activeTexture(_gl["TEXTURE"+shader._gl.texIndex++]),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl)}_gl.uniform1iv(uLoc,array)}this.upload=function(shader){if(!shader._gl){shader._gl={};let key=`${shader.vsName}_${shader.fsName}_${shader.customCompile}`,cached=_pool[key];cached?(shader._gl.program=cached.program,shader._gl._id=cached.id,cached.count++,Hydra.LOCAL&&_pool[key].references.push(shader)):(shader._gl.program=createProgram(shader),shader._gl._id=_programID++,_pool[key]={count:1,program:shader._gl.program,id:shader._gl._id},Hydra.LOCAL&&(_pool[key].references=[shader]))}setupShaders(shader),shader.ubo&&shader.ubo.upload(),shader.vertexShader=shader.fragmentShader=""},this.findCachedProgram=function(shader){let key=`${shader.vsName}_${shader.fsName}_${shader.customCompile}`,cached=_pool[key];return!!cached&&(shader._gl={},shader._gl.program=cached.program,shader._gl._id=cached.id,_uboCache[shader.UILPrefix]&&(shader.ubo=shader.UILPrefix),cached.count++,!0)},this.draw=function(shader){void 0===shader._gl&&this.upload(shader),shader._gl.texIndex=0,shader._gl.program!=_cached.program&&(_gl.useProgram(shader._gl.program),_cached.program=shader._gl.program),shader.ubo&&shader.ubo.bind(shader._gl.program,"ubo"),shader.uboLight&&Lighting.bindUBO(shader._gl.program);for(let i=shader._uniformKeys.length-1;i>-1;i--){let key=shader._uniformKeys[i],uni=shader._uniformValues[i];if(!uni)continue;let uLoc=shader._gl[key];if(void 0===uLoc&&(setupShaders(shader),uLoc=shader._gl[key]),null!==uLoc&&-1!==uLoc&&"U"!==uLoc){if(null===uni.value&&(uni.value=Utils3D.getEmptyTexture()),Hydra.LOCAL&&void 0===uni.value)throw`Uniform ${key} value is undefined. | ${shader.vsName} ${shader.fsName}`;switch(uni.type||(uni.type="string"==typeof(uniform=uni).type?uniform.type:null===uniform.value||uniform.value instanceof Texture||uniform.value.texture||uniform.value.rt&&uniform.value.rt.texture?"t":uniform.value instanceof Vector2?"v2":uniform.value instanceof Vector3||uniform.value instanceof Vector3D?"v3":uniform.value instanceof Vector4?"v4":uniform.value instanceof Matrix4?"m4":uniform.value instanceof Matrix3?"m3":uniform.value instanceof Color?"c":uniform.value instanceof Quaternion?"q":Array.isArray(uniform.value)&&uniform.value[0]instanceof Texture?"tv":"f"),uni.type){case"f":_gl.uniform1f(uLoc,uni.value);break;case"i":_gl.uniform1i(uLoc,Math.floor(uni.value));break;case"b":_gl.uniform1i(uLoc,uni.value);break;case"v2":_gl.uniform2f(uLoc,uni.value.x,uni.value.y);break;case"v3":_gl.uniform3f(uLoc,uni.value.x,uni.value.y,uni.value.z);break;case"c":_gl.uniform3f(uLoc,uni.value.r,uni.value.g,uni.value.b);break;case"q":case"v4":_gl.uniform4f(uLoc,uni.value.x,uni.value.y,uni.value.z,uni.value.w);break;case"v3v":_gl.uniform3fv(uLoc,toTypedArray(uni));break;case"v4v":_gl.uniform4fv(uLoc,toTypedArray(uni));break;case"v2v":_gl.uniform2fv(uLoc,toTypedArray(uni));break;case"fv":_gl.uniform1fv(uLoc,toTypedArray(uni));break;case"m4":_gl.uniformMatrix4fv(uLoc,!1,uni.value.elements);break;case"m3":_gl.uniformMatrix3fv(uLoc,!1,uni.value.elements);break;case"tv":uniformTextureArray(uni,uLoc,shader);break;case"t":let texture=uni.value;texture.isTexture||(uni.value.rt&&(texture=uni.value.rt.overrideTexture||uni.value.rt.texture),uni.value.texture&&(texture=uni.value.texture)),!1===texture.loaded&&(texture=Utils3D.getEmptyTexture());let texIndex=shader._gl.texIndex++;uni.value.vrRT&&(shader._gl.vrRT=!0,uni.value._glTexIndex=texIndex),Texture.renderer.draw(texture,uLoc,key,texIndex)}}}var uniform;if(shader.polygonOffset){let key=shader.polygonOffsetFactor+"_"+shader.polygonOffsetUnits;_cached.polygonOffset!=key&&(_gl.enable(_gl.POLYGON_OFFSET_FILL),_gl.polygonOffset(shader.polygonOffsetFactor,shader.polygonOffsetUnits)),_cached.polygonOffset=key}else _cached.polygonOffset&&_gl.disable(_gl.POLYGON_OFFSET_FILL),_cached.polygonOffset=!1;if(shader.transparent?(_cached.transparent||_gl.enable(_gl.BLEND),_cached.transparent=!0):(_cached.transparent&&_gl.disable(_gl.BLEND),_cached.transparent=!1),_cached.blending!=shader.blending){switch(shader.blending){case Shader.ADDITIVE_BLENDING:_gl.blendEquation(_gl.FUNC_ADD),_gl.blendFunc(_gl.SRC_ALPHA,_gl.ONE);break;case Shader.PREMULTIPLIED_ALPHA_BLENDING:_gl.blendEquation(_gl.FUNC_ADD),_gl.blendFunc(_gl.ONE,_gl.ONE_MINUS_SRC_ALPHA);break;case Shader.ADDITIVE_COLOR_ALPHA:_gl.blendEquation(_gl.FUNC_ADD),_gl.blendFunc(_gl.ONE,_gl.ONE);break;default:_gl.blendEquationSeparate(_gl.FUNC_ADD,_gl.FUNC_ADD),_gl.blendFuncSeparate(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA,_gl.ONE,_gl.ONE_MINUS_SRC_ALPHA)}_cached.blending=shader.blending}switch(shader.depthTest?(_cached.depthTest||_gl.enable(_gl.DEPTH_TEST),_cached.depthTest=!0):(_cached.depthTest&&_gl.disable(_gl.DEPTH_TEST),_cached.depthTest=!1),shader.side){case Shader.BACK_SIDE:_cached.side!=Shader.BACK_SIDE&&(_gl.enable(_gl.CULL_FACE),_gl.cullFace(_gl.FRONT),_cached.side=Shader.BACK_SIDE);break;case Shader.DOUBLE_SIDE:_cached.side!=Shader.DOUBLE_SIDE&&(_gl.disable(_gl.CULL_FACE),_cached.side=Shader.DOUBLE_SIDE);break;default:_cached.side!=Shader.FRONT_SIDE&&(_gl.enable(_gl.CULL_FACE),_gl.cullFace(_gl.BACK),_cached.side=Shader.FRONT_SIDE)}if(_cached.depthMask!=shader.depthWrite&&(_gl.depthMask(!!shader.depthWrite),_cached.depthMask=shader.depthWrite),shader.colorMask&&shader.colorMask.push)_gl.colorMask(shader.colorMask[0]||!1,shader.colorMask[1]||!1,shader.colorMask[2]||!1,shader.colorMask[3]||!1);else switch(shader.colorMask){case Shader.COLOR_MASK_NONE:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!0,!0,!0,!0),_cached.colorMask=shader.colorMask);break;case Shader.COLOR_MASK_RGB:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!1,!1,!1,!0),_cached.colorMask=shader.colorMask);break;case Shader.COLOR_MASK_RGBA:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!1,!1,!1,!1),_cached.colorMask=shader.colorMask)}if(shader.customState)for(let i=0;i<shader.customState.length;i++){let obj=shader.customState[i];_gl[obj.fn].apply(_gl,obj.params)}},this.destroy=function(shader){delete shader._gl,shader.ubo&&shader.ubo.destroy()},this.appendUniform=function(shader,key,value,hint){let loc=shader._gl[key];if(void 0===loc&&(loc=loc=_gl.getUniformLocation(shader._gl.program,key)),null!==loc)if(value.isMatrix4)_gl.uniformMatrix4fv(loc,!1,value.elements);else if(value.isMatrix3)_gl.uniformMatrix3fv(loc,!1,value.elements);else if(value.isVector4)_gl.uniform4f(loc,value.x,value.y,value.z,value.w);else if(value.isQuaternion)_gl.uniform4f(loc,value.x,value.y,value.z,value.w);else if(value.isVector3)_gl.uniform3f(loc,value.x,value.y,value.z);else if(value.isVector2)_gl.uniform2f(loc,value.x,value.y);else if(value instanceof Float32Array)switch(hint){case"matrix":_gl.uniformMatrix4fv(loc,!1,value);break;case"float":_gl.uniform1fv(loc,value);break;case"vec3":_gl.uniform3fv(loc,value)}else if(Array.isArray(value)){let array=shader._gl.texArray||[];array.length=0,shader._gl.texArray=array;for(let i=0;i<value.length;i++)array.push(shader._gl.texIndex),_gl.activeTexture(_gl["TEXTURE"+shader._gl.texIndex++]),_gl.bindTexture(_gl.TEXTURE_2D,value[i]._gl);_gl.uniform1iv(loc,array)}else _gl.uniform1f(loc,value)},this.resetState=function(){_cached.depthMask||(_gl.depthMask(!0),_cached.depthMask=!0),_cached.depthTest||_gl.enable(_gl.DEPTH_TEST),_cached.depthTest=!0,_cached.colorMask!=Shader.COLOR_MASK_NONE&&(_gl.colorMask(!0,!0,!0,!0),_cached.colorMask=Shader.COLOR_MASK_NONE),_cached.program=null},this.clearState=function(){_cached={}},this.hotReload=function(file){file=file.split(".")[0].trim();for(let key in _pool)if(key.includes(file)&&!key.includes("|instance")){let obj=_pool[key],rootShader=obj.references[0];rootShader.restoreFS=rootShader.restoreVS=null,rootShader.resetProgram(),rootShader._gl={},rootShader._gl.program=createProgram(rootShader),rootShader._gl._id=_programID++,setupShaders(rootShader),obj.program=rootShader._gl.program,obj.id=rootShader._gl._id;for(let i=1;i<obj.references.length;i++)obj.references[i]._gl=rootShader._gl}},this.hotReloadClearProgram=function(id){for(let key in _pool)key.includes(id)&&delete _pool[key]}})),Class((function TextureRendererWebGL(_gl){const _this=this;var _state={};const DATA=new Uint8Array([0,0,0,0]),{getFormat:getFormat,getProperty:getProperty,getType:getType,getFloatParams:getFloatParams}=require("GLTypes");function setTextureParams(texture,textureType=_gl.TEXTURE_2D){let format=getFormat(texture);textureType!=_gl.TEXTURE_2D||texture.compressed||_gl.texImage2D(textureType,0,format,1,1,0,format,_gl.UNSIGNED_BYTE,DATA),_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(textureType,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(textureType,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),texture.data||texture.format!=Texture.RGBAFormat?1==_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):!1===texture.premultiplyAlpha?(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),_state.premultiply=!0),texture.anisotropy>1&&_gl.texParameterf(_gl.TEXTURE_2D,Renderer.extensions.anisotropy.TEXTURE_MAX_ANISOTROPY_EXT,texture.anisotropy)}this.draw=function(texture,loc,key,id){if((void 0===texture._gl||texture.needsReupload)&&this.upload(texture),_gl.activeTexture(_gl["TEXTURE"+id]),texture.cube)_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl);else{let texType=texture.EXT_OES?_gl.TEXTURE_EXTERNAL_OES:_gl.TEXTURE_2D;_gl.bindTexture(texType,texture._gl)}_gl.uniform1i(loc,id),(texture.dynamic||texture.needsUpdate)&&function updateDynamic(texture){if(texture.isDataTexture){if(!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1),!texture.glFormat){let{format:format,type:type}=getFloatParams(texture);texture.glFormat=format,texture.glType=type}_gl.texSubImage2D(_gl.TEXTURE_2D,0,0,0,texture.width,texture.height,texture.glFormat,texture.glType,texture.data)}else _state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0),texture.format==Texture.RGBAFormat?!1===texture.premultiplyAlpha?(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),_state.premultiply=!0):_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1),texture.glFormat||(texture.glFormat=getFormat(texture)),_gl.texImage2D(_gl.TEXTURE_2D,0,texture.glFormat,texture.glFormat,getType(texture),texture.image)}(texture),texture.needsUpdate=!1},this.upload=function(texture){if(texture._gl&&!texture.needsReupload&&!texture.needsUpdate)return;let format=getFormat(texture);if(RenderCount.add("texture"),texture.distributeTextureData||RenderCount.add("tex_upload",texture),texture.cube){if(6!=texture.cube.length)throw"Cube texture requires 6 images";return function uploadCube(texture){void 0===texture._gl&&(texture._gl=_gl.createTexture(),_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl),_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0),setTextureParams(texture,_gl.TEXTURE_CUBE_MAP));let format=getFormat(texture);for(let i=0;i<6;i++)_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,format,format,getType(texture),texture.cube[i]);_gl.generateMipmap(_gl.TEXTURE_CUBE_MAP),texture.needsUpdate=texture.needsReupload=!1,texture.onUpdate&&texture.onUpdate()}(texture)}let texType=texture.EXT_OES?_gl.TEXTURE_EXTERNAL_OES:_gl.TEXTURE_2D;if(void 0===texture._gl?(texture._gl=_gl.createTexture(),_gl.bindTexture(texType,texture._gl),setTextureParams(texture,texType)):_gl.bindTexture(texType,texture._gl),texture.isDataTexture||texture.type&&texture.type.includes("float")){!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_gl.pixelStorei(_gl.UNPACK_ALIGNMENT,1);let{internalformat:internalformat,format:format,type:type}=getFloatParams(texture);if("ie"===Device.system.browser)try{_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,texture.width,texture.height,0,format,type,texture.distributeTextureData?null:texture.data)}catch(e){console.log(e)}else _gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,texture.width,texture.height,0,format,type,texture.distributeTextureData?null:texture.data)}else if(_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0),texture.image&&texture.compressed){let data=texture.image.compressedData;for(let i=0;i<data.length;i++){let size=texture.image.sizes[i];_gl.compressedTexImage2D(_gl.TEXTURE_2D,i,texture.image.gliFormat,size,size,0,data[i])}data.length=0}else if(texture.image&&!(texture.image instanceof HTMLVideoElement))try{_gl.texImage2D(_gl.TEXTURE_2D,0,format,format,getType(texture),texture.image)}catch(e){console.log("error loading texture",e,texture.image)}(texture.image||texture.data)&&texture.generateMipmaps&&!texture.compressed&&_gl.generateMipmap(_gl.TEXTURE_2D),texture.needsUpdate=texture.needsReupload=!1,texture.onUpdate&&texture.onUpdate()},this.uploadAsync=function(texture){let{format:format,type:type}=getFloatParams(texture);if(texture._uploadAsyncPromise)return texture._uploadAsyncPromise;texture._uploadAsyncPromise=Promise.create(),RenderCount.add("tex_uploadAsync",texture),texture._gl||(texture.distributeTextureData=!0,_this.upload(texture));let pixelsPerChunk=texture.height/4,dataPerChunk=texture.data.length/4,i=0,worker=new Render.Worker((function workerUploadAsync(){let pixelOffset=pixelsPerChunk*i,dataOffset=dataPerChunk*i,subarray=texture.data.subarray(dataOffset,dataOffset+dataPerChunk);!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),_gl.texSubImage2D(_gl.TEXTURE_2D,0,0,pixelOffset,texture.width,pixelsPerChunk,format,type,subarray),_gl.bindTexture(_gl.TEXTURE_2D,null),4==++i&&(worker.stop(),texture._uploadAsyncPromise.resolve())}));return texture._uploadAsyncPromise},this.destroy=function(texture){texture._gl&&(_gl.deleteTexture(texture._gl),RenderCount.remove("texture"),RenderCount.add("tex_destroy",texture)),delete texture._gl}}));class RenderTarget{constructor(width,height,options={}){this.width=width,this.height=height,this.viewport=new Vector2(0,0),void 0===options.minFilter&&(options.minFilter=Texture.LINEAR),this.stencil="boolean"==typeof options.stencil&&options.stencil,this.texture=new Texture(null),this.texture.generateMipmaps=options.generateMipmaps,this.texture.width=width,this.texture.height=height,this.texture.minFilter=options.minFilter||Texture.LINEAR,this.texture.magFilter=options.magFilter||Texture.LINEAR,this.texture.wrapS=options.wrapS||Texture.CLAMP_TO_EDGE,this.texture.wrapT=options.wrapT||Texture.CLAMP_TO_EDGE,this.texture.format=options.format||Texture.RGBFormat,options.type&&(this.texture.type=options.type),this.isRT=!0}setSize(width,height){this.width=width,this.height=height,this.texture.width=width,this.texture.height=height,this.viewport.set(0,0),RenderTarget.renderer.resize(this)}clone(){return(new RenderTarget).copy(this)}copy(source){return this.width=source.width,this.height=source.height,this.viewport.copy(source.viewport),this.texture=source.texture.clone(),this}createDepthTexture(){return this.depth=new Texture(null),this.depth.generateMipmaps=!1,this.depth.minFilter=Texture.NEAREST,this.depth.magFilter=Texture.NEAREST,this.depth.wrapS=Texture.CLAMP_TO_EDGE,this.depth.wrapT=Texture.CLAMP_TO_EDGE,this.depth}destroy(){RenderTarget.renderer.destroy(this)}upload(){this._gl||RenderTarget.renderer.upload(this)}}class MultiRenderTarget extends RenderTarget{constructor(width,height,options={}){super(width,height,options),this.multi=!0,this.attachments=[this.texture]}}class CubeRenderTarget extends RenderTarget{constructor(width,height,options={}){super(width,height,options),this.activeFace=0,this.cube=!0}}Class((function Shader(_vertexShader,_fragmentShader,_params,_onBeforeBuild,_postfix){const _this=this;this.uniforms=Shader.createUniforms(this),this.side=Shader.FRONT_SIDE,this.blending=Shader.NORMAL_BLENDING,this.colorMask=Shader.COLOR_MASK_NONE,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=1,this.depthTest=!0,this.depthWrite=!0,this.wireframe=!1,this.transparent=!1,this.visible=!0,this.persists=!1,this.precision="high",this.customCompile="","string"!=typeof _fragmentShader&&(_params=_fragmentShader,_fragmentShader=_vertexShader),_params=_params||{},_this.vsParam=_vertexShader,_this.fsParam=_fragmentShader,_this.params=_params,_this.vsName=_vertexShader,_this.fsName=(_fragmentShader||_vertexShader)+(_postfix||""),_params.vsName&&(_this.vsName=_params.vsName,delete _params.vsName),_params.precision&&(_this.precision=_params.precision),_params.receiveShadow&&(_this.receiveLight=!0,World.RENDERER.shadows&&(_this.precision="high"));let vs=_vertexShader,fs=_fragmentShader;_params.uilFrom&&(vs=_params.uilFrom,fs=_params.uilFrom,delete _params.uilFrom),_this.UILPrefix=_params.UILPrefix||`${vs}/${fs}/${_params.unique?_params.unique+"/":""}`,Shader.parseParams(_params,_this),Shader.renderer.findCachedProgram(_this)||(_this.vertexShader=Shader.process(Shaders.getShader(_vertexShader+".vs"),"vs",_this,_onBeforeBuild),_this.fragmentShader=Shader.process(Shaders.getShader(_fragmentShader+".fs"),"fs",_this,_onBeforeBuild))}),(_=>{Shader.FRONT_SIDE="shader_front_side",Shader.BACK_SIDE="shader_back_side",Shader.DOUBLE_SIDE="shader_double_side",Shader.ADDITIVE_BLENDING="shader_additive_blending",Shader.NORMAL_BLENDING="shader_normal_blending",Shader.PREMULTIPLIED_ALPHA_BLENDING="shader_premultiplied_alpha_blending",Shader.ADDITIVE_COLOR_ALPHA="shader_additive_color_alpha",Shader.CUSTOM_DEPTH="shader_custom_depth",Shader.COLOR_MASK_RGB="shader_colormask_rgb",Shader.COLOR_MASK_RGBA="shader_colormask_rgba",Shader.COLOR_MASK_NONE="shader_colormask_none",Shader.parseParams=function(_params,_this){for(let key in _params)if("receiveShadow"==key)_this.receiveShadow=_params[key];else if("receiveLight"==key)_this.receiveLight=_params[key];else if(_params[key]&&void 0!==_params[key].value)window.UILStorage&&UILStorage.hasData()?(_this.uniforms[key]=UILStorage.parse(_this.UILPrefix+key,_params[key].value)||_params[key],_params[key].ubo&&(_this.uniforms[key].ubo=!0)):_this.uniforms[key]=_params[key];else{if("unique"==key)continue;_this[key]=_params[key]}},Shader.process=function(code,type,_this,_onBeforeBuild){const WEBGL2=Renderer.type==Renderer.WEBGL2;if(!code)throw"No shader found! "+_this.vsName+" | "+_this.fsName;const externalOES=code.includes("samplerExternalOES")&&window.AURA&&"android"==Device.system.os,standardDeriv=!WEBGL2&&code.includes(["fwidth","dFdx"]),drawBuffers=!WEBGL2&&code.includes(["gl_FragData","#drawbuffer"])&&window.World&&World.NUKE.useDrawBuffers;return header="vs"==type?["#version 300 es",externalOES?"#extension GL_OES_EGL_image_external_essl3 : require":"",`precision ${_this.precision}p float;`,`precision ${_this.precision}p int;`,"attribute vec2 uv;","attribute vec3 position;","attribute vec3 normal;","uniform mat3 normalMatrix;","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform global {","mat4 projectionMatrix;","mat4 viewMatrix;","vec3 cameraPosition;","vec4 cameraQuaternion;","vec2 resolution;","float time;","float timeScale;","};"].join("\n"):["#version 300 es",externalOES?"#extension GL_OES_EGL_image_external_essl3 : require":"",standardDeriv?"#extension GL_OES_standard_derivatives : enable":"",drawBuffers?"#extension GL_EXT_draw_buffers : require":"",`precision ${_this.precision}p float;`,`precision ${_this.precision}p int;`,"uniform mat3 normalMatrix;","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform global {","mat4 projectionMatrix;","mat4 viewMatrix;","vec3 cameraPosition;","vec4 cameraQuaternion;","vec2 resolution;","float time;","float timeScale;","};","out vec4 FragColor;"].join("\n"),header+="\n__ACTIVE_THEORY_LIGHTS__\n\n",window.AURA&&(header+="#define AURA\n"),_onBeforeBuild&&(code=_onBeforeBuild(code,type)),code=header+code};const prototype=Shader.prototype;var _emptyShadowMap;prototype.copyUniformsTo=function(shader,linked){for(let key in this.uniforms)void 0!==this.uniforms[key]&&(shader.uniforms[key]=linked?this.uniforms[key]:{type:this.uniforms[key].type,value:this.uniforms[key].value})},prototype.addUniforms=function(uniforms){uniforms.UILPrefix&&(this.UILPrefix=uniforms.UILPrefix,delete uniforms.UILPrefix);for(let key in uniforms)this.hotReloading&&this.uniforms[key]||(this.uniforms[key]=uniforms[key])},prototype.draw=function(mesh,geom){this.receiveLight&&!this.__lighting&&Lighting.getLighting(this),Shader.renderer.draw(this,mesh,geom)},prototype.upload=function(mesh,geom){Shader.renderer.upload(this,mesh,geom),this.receiveShadow&&!this.shadow&&Lighting.initShadowShader(this,mesh)},prototype.destroy=function(){this.persists||(Shader.renderer.destroy(this),this.shadow&&this.shadow.destroy()),this.receiveLight&&Lighting.destroyShader(this)},prototype.onBeforeCompile=function(code,type){const WEBGL2=Renderer.type==Renderer.WEBGL2;"}"!=(code=code.trim())[code.length-1]&&(code+="\n}");let p=this.mesh,scene=World.SCENE;for(;p;)p instanceof Scene&&(scene=p),p=p._parent;scene.nuke&&scene.nuke.onBeforeShaderCompile&&scene.nuke.onBeforeShaderCompile(this.mesh),this.receiveShadow&&(this.receiveLight=!0);let varyings=[],uniforms=[];(code=code.split("\n")).forEach(((line,index)=>{"fs"==type&&line.includes("#drawbuffer")&&(line.includes("#drawbuffer Color")?code[index]=line.replace("#drawbuffer Color",""):code[index]=""),line.includes("varying")&&varyings.push(line.trim()),line.includes("uniform")&&uniforms.push(line.trim())})),code=code.join("\n");const process=function(array){let replace,counts=[];array.forEach((value=>{let count=0;array.forEach((v2=>{value==v2&&count++})),count>1&&(replace||(replace=[]),replace.includes(value)||(replace.push(value),counts.push(count)))})),replace&&replace.forEach(((value,i)=>{let count=counts[i];for(let j=0;j<count-1;j++){let index=code.lastIndexOf(value);code=code.substring(0,index)+code.substring(index+value.length)}}))};process(varyings),process(uniforms),"fs"==type&&(WEBGL2?code.includes("gl_FragColor")&&(code=code.replace(/gl_FragColor/g,"FragColor")):code.includes("#applyShadow")&&(code=code.replace("#applyShadow",""))),code=code.replace("__ACTIVE_THEORY_LIGHTS__",function getLightingCode(_this){if(!_this.receiveLight||_this.isShadow)return"";let numLights=Lighting.getLighting(_this).position.length/4;return 0==numLights?Lighting.getShadowUniforms(_this):["#define NUM_LIGHTS "+numLights,"uniform lights {",`vec4 lightPos[${numLights}];`,`vec4 lightColor[${numLights}];`,`vec4 lightData[${numLights}];`,`vec4 lightData2[${numLights}];`,`vec4 lightData3[${numLights}];`,`vec4 lightProperties[${numLights}];`,"};"].join("\n")+Lighting.getShadowUniforms(_this)}(this)),"fs"==type&&code.includes("SHADOW_MAPS")&&(code=require("GLSLOptimizer")(code.replace("SHADOW_COUNT",Lighting.getShadowCount(this)))),this.preCompile&&(code=this.preCompile(code,type));let converter=require("ShaderCode");return code=WEBGL2?converter.convertWebGL2(code,type):converter.convertWebGL1(code)},prototype.set=function(key,value,ref){let _this=ref||this;return _this.uniforms[key]?(void 0!==value&&(TweenManager.clearTween(_this.uniforms[key]),_this.uniforms[key].value=value,_this.ubo&&(_this.ubo.needsUpdate=!0)),_this.uniforms[key].value):console.warn(`No key ${key} found on shader`,_this)},prototype.get=function(key,ref){let _this=ref||this;return _this.uniforms[key]&&_this.uniforms[key].value},prototype.tween=function(key,value,time,ease,delay,callback,update,scaledTime){return"number"==typeof value?tween(this.uniforms[key],{value:value},time,ease,delay,callback,update,null,scaledTime):tween(this.uniforms[key].value,value,time,ease,delay,callback,update,null,scaledTime)},prototype.clone=function(noShadows,postfix){const _this=this;noShadows&&(_this.params.receiveShadow=!1);let shader=new Shader(_this.vsParam,_this.fsParam,_this.params,null,postfix);for(let key in _this)key.includes(["vsName","fsName","uniforms","_uniform","_gl"])||"function"==typeof _this[key]||(shader[key]=_this[key]);for(let key in _this.uniforms)shader.uniforms[key]={type:_this.uniforms[key].type,value:_this.uniforms[key].value};return shader},prototype.resetProgram=function(){this.destroy(),this.vertexShader=this.restoreVS||Shader.process(Shaders.getShader(this.vsName+".vs"),"vs",this),this.fragmentShader=this.restoreFS||Shader.process(Shaders.getShader(this.fsName+".fs"),"fs",this)},Object.defineProperty(prototype,"receiveShadow",{set:function(v){this._receiveShadow=v,v&&(_emptyShadowMap||(_emptyShadowMap=[Utils3D.getEmptyTexture()]),this.uniforms.shadowMap={value:_emptyShadowMap})},get:function(){return this._receiveShadow}})})),Shader.createUniforms=function(shader){let uniforms={},handler={set(target,property,value){target[property]=value,shader._uniformKeys.length=0,shader._uniformValues.length=0;for(let key in uniforms)shader._uniformKeys.push(key),shader._uniformValues.push(uniforms[key]);return!0}};return shader._uniformValues=[],shader._uniformKeys=[],new Proxy(uniforms,handler)};class Texture{constructor(img){this.magFilter=Texture.LINEAR,this.minFilter=Texture.LINEAR_MIPMAP,this.format=Texture.RGBAFormat,this.wrapS=this.wrapT=Texture.CLAMP_TO_EDGE,this._image=img,this.needsUpdate=!0,this.generateMipmaps=!0,this.anisotropy=1,this.type=Texture.UNSIGNED_BYTE,this.isTexture=!0,img&&img.onCreateTexture&&img.onCreateTexture(this)}set image(img){this._image=img,img&&img.onCreateTexture&&img.onCreateTexture(this)}get image(){return this._image}upload(){this._gl||Texture.renderer.upload(this)}destroy(){Texture.renderer.destroy(this),this._image=null}clone(){let texture=new Texture(this.img);return texture.format=this.format,texture.type=this.type,texture.anisotropy=this.anisotropy,texture.wrapS=this.wrapS,texture.wrapT=this.wrapT,texture.generateMipmaps=this.generateMipmaps,texture.minFilter=this.minFilter,texture.magFilter=this.magFilter,texture}}class DataTexture extends Texture{constructor(data,width,height,format,type){super(),format&&(this.format=format),this.width=width,this.height=height,this.data=data,this.minFilter=this.magFilter=Texture.NEAREST,this.generateMipmaps=!1,this.type=type||Texture.FLOAT,this.isDataTexture=!0}uploadAsync(){return Texture.renderer.uploadAsync(this)}}Texture.NEAREST="texture_nearest",Texture.CLAMP_TO_EDGE="texture_clamp",Texture.REPEAT="texture_repeat",Texture.MIRROR_REPEAT="texture_mirror_repeat",Texture.LINEAR="texture_linear",Texture.LINEAR_MIPMAP="texture_linear_mip",Texture.LINEAR_MIPMAP_NEAREST="texture_linear_mip_nearest",Texture.NEAREST_MIPMAP="texture_nearest_mip",Texture.RGBFormat="texture_rgbFormat",Texture.RGBAFormat="texture_rgbaFormat",Texture.UNSIGNED_BYTE="texture_unsigned_byte",Texture.DEPTH="texture_depth",Texture.FLOAT="texture_float",Texture.HALF_FLOAT="texture_half_float",Module((function GLSLOptimizer(){this.exports=function(code){return function unrollLoops(string){return string.replace(/#pragma unroll_loop[\s]+?for \(int i \= (\d+)\; i < (\d+)\; i\+\+\) \{([\s\S]+?)(?=\})\}/g,(function replace(match,start,end,snippet){let unroll="";for(let i=parseInt(start);i<parseInt(end);i++)unroll+=snippet.replace(/\[i\]/g,"["+i+"]");return unroll}))}(code)}})),Module((function GLTypes(){function getType(texture){let _gl=Renderer.context;switch(texture.type){case Texture.FLOAT:return _gl.FLOAT;case Texture.HALF_FLOAT:return Renderer.type==Renderer.WEBGL2?_gl.HALF_FLOAT:Renderer.extensions.halfFloat.HALF_FLOAT_OES;default:return _gl.UNSIGNED_BYTE}}this.exports={getFormat:function getFormat(texture){let _gl=Renderer.context;return texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB},getProperty:function getProperty(property){let _gl=Renderer.context;switch(property){case Texture.NEAREST:return _gl.NEAREST;case Texture.LINEAR:return _gl.LINEAR;case Texture.LINEAR_MIPMAP:return _gl.LINEAR_MIPMAP_LINEAR;case Texture.NEAREST_MIPMAP:return _gl.NEAREST_MIPMAP_LINEAR;case Texture.LINEAR_MIPMAP_NEAREST:return _gl.LINEAR_MIPMAP_NEAREST;case Texture.CLAMP_TO_EDGE:return _gl.CLAMP_TO_EDGE;case Texture.REPEAT:return _gl.REPEAT;case Texture.MIRROR_REPEAT:return _gl.MIRRORED_REPEAT}},getType:getType,getFloatParams:function getFloatParams(texture){let _gl=Renderer.context;return{internalformat:function(){if(Renderer.type==Renderer.WEBGL2){switch(texture.type){case Texture.HALF_FLOAT:return texture.format==Texture.RGBAFormat?_gl.RGBA16F:_gl.RGB16F;case Texture.FLOAT:return texture.format==Texture.RGBAFormat?_gl.RGBA32F:_gl.RGB32F}return texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB}return texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB}(),format:texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB,type:getType(texture)}}}})),Module((function ShaderCode(){function removeUBO(code,name){let uniforms=code.split(`uniform ${name} {`)[1];uniforms=uniforms.split("};")[0],uniforms=uniforms.split("\n"),uniforms.forEach((u=>{(u=u.trim()).length&&(code=code.replace(u,"uniform "+u))}));let split=code.split(`uniform ${name} {`);return split[1]=split[1].replace("};",""),code=(code=split.join("")).replace(`uniform ${name} {`,"")}this.exports={convertWebGL1:function convertWebGL1(code){return(code=(code=(code=code.replace("#version 300 es","")).replace(/texture\(/g,"texture2D(")).replace("out vec4 FragColor;","")).includes("samplerExternalOES")&&(code=code.replace("samplerExternalOES","sampler2D")),code.includes("uniform global {")&&(code=removeUBO(code,"global")),code.includes("uniform ubo {")&&(code=removeUBO(code,"ubo")),code.includes("uniform lights {")&&(code=removeUBO(code,"lights")),code},convertWebGL2:function convertWebGL2(code,type){return code=code.replace(/texture2D/g,"texture"),!(code="vs"==type?(code=code.replace(/attribute/g,"in")).replace(/varying/g,"out"):(code=code.replace(/varying/g,"in")).replace(/textureCube/g,"texture")).includes("samplerExternalOES")||"android"==Device.system.os&&window.AURA||(code=code.replace("samplerExternalOES","sampler2D")),Renderer.UBO?(code.includes("uniform global {")&&(code=code.replace("uniform global","layout(std140) uniform global")),code.includes("uniform ubo {")&&(code=code.replace("uniform ubo","layout(std140) uniform ubo")),Lighting.UBO?code.includes("uniform lights {")&&(code=code.replace("uniform lights","layout(std140) uniform lights")):code.includes("uniform lights {")&&(code=removeUBO(code,"lights"))):(code.includes("uniform global {")&&(code=removeUBO(code,"global")),code.includes("uniform ubo {")&&(code=removeUBO(code,"ubo")),code.includes("uniform lights {")&&(code=removeUBO(code,"lights"))),code}}}));class UBO{constructor(location,gl=Renderer.context){this.gl=gl,this.arrays=[];for(let i=0;i<30;i++)this.arrays.push([]);this.arrayIndex=0,this.objects=[],this.location=location,this.data=null,this.lastUpdate=0}_getSize(uniform){let obj=uniform.value;return Array.isArray(obj)?uniform.components?obj.length/uniform.components*16:16*obj.length:obj instanceof Vector2?8:obj instanceof Vector3||obj instanceof Vector4||obj instanceof Color?16:obj instanceof Matrix4?64:obj instanceof Matrix3?48:obj instanceof Quaternion?16:4}_getValues(uniform){let obj=uniform.value;return Array.isArray(obj)?obj:obj instanceof Vector2?this._array(obj.x,obj.y):obj instanceof Vector3?this._array(obj.x,obj.y,obj.z):obj instanceof Matrix4||obj instanceof Matrix3?obj.elements:obj instanceof Color?this._array(obj.r,obj.g,obj.b):obj instanceof Quaternion?this._array(obj.x,obj.y,obj.z,obj.w):this._array(obj)}_array(){this.arrayIndex++>=this.arrays.length-1&&(this.arrayIndex=0);let array=this.arrays[this.arrayIndex];return array.length=0,array.push.apply(array,arguments),array}clear(){for(let i=0;i<this.arrays.length;i++)this.arrays[i].length=0}calculate(){let len=this.objects.length,chunk=16,tsize=0,offset=0,size=0;for(let i=0;i<len;i++){let obj=this.objects[i];size=this._getSize(obj),tsize=chunk-size,tsize<0&&chunk<16?(offset+=chunk,i>0&&(this.objects[i-1].chunkLen+=chunk),chunk=16):tsize<0&&16==chunk||(0==tsize?chunk=16:chunk-=size),obj.offset=offset/4,obj.chunkLen=size/4,obj.dataLen=size/4,offset+=size}return offset%16!=0&&(this.objects[this.objects.length-1].chunkLen+=chunk/4,offset+=chunk),offset/4}compileData(){let i,array=this._array(),len=this.calculate();for(i=0;i<len;i++)array[i]=0;for(i=0;i<this.objects.length;i++){let obj=this.objects[i],values=this._getValues(obj);for(let j=0;j<values.length;j++)array[obj.offset+j]=values[j]}return array}upload(){if(this.data)return;let gl=Renderer.context,array=this.compileData();array.length&&(this.data=new Float32Array(array),this.buffer=gl.createBuffer(),gl.bindBuffer(gl.UNIFORM_BUFFER,this.buffer),gl.bufferData(gl.UNIFORM_BUFFER,this.data,gl.DYNAMIC_DRAW),gl.bindBuffer(gl.UNIFORM_BUFFER,null),gl.bindBufferBase(gl.UNIFORM_BUFFER,this.location,this.buffer))}bind(program,name){this.data||this.upload(),this.needsUpdate&&this.update();let location,gl=Renderer.context;location=program==this.lastProgram&&name==this.lastName&&void 0!==this.lastLocation?this.lastLocation:gl.getUniformBlockIndex(program,name),location>99999||-1==location||(gl.uniformBlockBinding(program,location,this.location),gl.bindBufferBase(gl.UNIFORM_BUFFER,this.location,this.buffer),this.lastProgram=program,this.lastName=name,this.lastLocation=location)}update(){if(this.data||this.upload(),!this.data)return;let gl=Renderer.context,array=this.compileData();array.length!=this.data.length&&(this.data=new Float32Array(array),this.upload()),this.data.set(array),gl.bindBuffer(gl.UNIFORM_BUFFER,this.buffer),gl.bufferSubData(gl.UNIFORM_BUFFER,0,this.data),gl.bindBuffer(gl.UNIFORM_BUFFER,null),this.needsUpdate=!1}unbind(){}push(){if(this.data)throw"Can't modify UBO after initial upload!";for(let i=0;i<arguments.length;i++)this.objects.push(arguments[i])}destroy(){this.gl.deleteBuffer(this.buffer)}}class VAO{constructor(gl){this.gl=gl,this.WEBGL2=Renderer.type==Renderer.WEBGL2,this.WEBGL2?this.vao=gl.createVertexArray():this.vao=Renderer.extensions.VAO.createVertexArrayOES()}bind(){const gl=this.gl;this.WEBGL2?gl.bindVertexArray(this.vao):Renderer.extensions.VAO.bindVertexArrayOES(this.vao)}unbind(){const gl=this.gl;this.WEBGL2?gl.bindVertexArray(null):Renderer.extensions.VAO.bindVertexArrayOES(null)}destroy(){const gl=this.gl;this.WEBGL2?gl.deleteVertexArray(this.vao):Renderer.extensions.VAO.deleteVertexArrayOES(this.vao),this.vao=null}}class BoxGeometry extends Geometry{constructor(width=1,height=1,depth=1,widthSegments=1,heightSegments=1,depthSegments=1){super(),widthSegments=Math.floor(widthSegments),heightSegments=Math.floor(heightSegments),depthSegments=Math.floor(depthSegments);let indices=[],vertices=[],normals=[],uvs=[],numberOfVertices=0;function buildPlane(u,v,w,udir,vdir,width,height,depth,gridX,gridY,materialIndex){let ix,iy,segmentWidth=width/gridX,segmentHeight=height/gridY,widthHalf=width/2,heightHalf=height/2,depthHalf=depth/2,gridX1=gridX+1,gridY1=gridY+1,vertexCounter=0,vector=new Vector3;for(iy=0;iy<gridY1;iy++){let y=iy*segmentHeight-heightHalf;for(ix=0;ix<gridX1;ix++){let x=ix*segmentWidth-widthHalf;vector[u]=x*udir,vector[v]=y*vdir,vector[w]=depthHalf,vertices.push(vector.x,vector.y,vector.z),vector[u]=0,vector[v]=0,vector[w]=depth>0?1:-1,normals.push(vector.x,vector.y,vector.z),uvs.push(ix/gridX),uvs.push(1-iy/gridY),vertexCounter+=1}}for(iy=0;iy<gridY;iy++)for(ix=0;ix<gridX;ix++){let a=numberOfVertices+ix+gridX1*iy,b=numberOfVertices+ix+gridX1*(iy+1),c=numberOfVertices+(ix+1)+gridX1*(iy+1),d=numberOfVertices+(ix+1)+gridX1*iy;indices.push(a,b,d),indices.push(b,c,d)}numberOfVertices+=vertexCounter}buildPlane("z","y","x",-1,-1,depth,height,width,depthSegments,heightSegments,0),buildPlane("z","y","x",1,-1,depth,height,-width,depthSegments,heightSegments,1),buildPlane("x","z","y",1,1,width,depth,height,widthSegments,depthSegments,2),buildPlane("x","z","y",1,-1,width,depth,-height,widthSegments,depthSegments,3),buildPlane("x","y","z",1,-1,width,height,depth,widthSegments,heightSegments,4),buildPlane("x","y","z",-1,-1,width,height,-depth,widthSegments,heightSegments,5),this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class CircleGeometry extends Geometry{constructor(radius=1,segments=8,thetaStart=0,thetaLength=2*Math.PI){super();var i,s,indices=[],vertices=[],normals=[],uvs=[],vertex=new Vector3,uv=new Vector2;for(vertices.push(0,0,0),normals.push(0,0,1),uvs.push(.5,.5),s=0,i=3;s<=segments;s++,i+=3){var segment=thetaStart+s/segments*thetaLength;vertex.x=radius*Math.cos(segment),vertex.y=radius*Math.sin(segment),vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,0,1),uv.x=(vertices[i]/radius+1)/2,uv.y=(vertices[i+1]/radius+1)/2,uvs.push(uv.x,uv.y)}for(i=1;i<=segments;i++)indices.push(i,i+1,0);this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class CylinderGeometry extends Geometry{constructor(radiusTop=1,radiusBottom=1,height=1,radialSegments=8,heightSegments=1,openEnded=!1,thetaStart=0,thetaLength=2*Math.PI,planarMapping=!1){super(),radialSegments=Math.floor(radialSegments),heightSegments=Math.floor(heightSegments);let indices=[],vertices=[],normals=[],uvs=[],index=0,indexArray=[],halfHeight=height/2;function generateCap(top){let x,centerIndexStart,centerIndexEnd,uv=new Vector2,vertex=new Vector3,radius=!0===top?radiusTop:radiusBottom,sign=!0===top?1:-1,signV=planarMapping?1:sign;for(centerIndexStart=index,x=1;x<=radialSegments;x++)vertices.push(0,halfHeight*sign,0),normals.push(0,sign,0),uvs.push(.5,.5),index++;for(centerIndexEnd=index,x=0;x<=radialSegments;x++){let theta=x/radialSegments*thetaLength+thetaStart,cosTheta=Math.cos(theta),sinTheta=Math.sin(theta);vertex.x=radius*sinTheta,vertex.y=halfHeight*sign,vertex.z=radius*cosTheta,vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,sign,0),uv.x=.5*cosTheta+.5,uv.y=.5*sinTheta*signV+.5,uvs.push(uv.x,uv.y),index++}for(x=0;x<radialSegments;x++){let c=centerIndexStart+x,i=centerIndexEnd+x;!0===top?indices.push(i,i+1,c):indices.push(i+1,i,c)}}!function generateTorso(){let x,y,uv=new Vector2,normal=new Vector3,vertex=new Vector3,slope=(radiusBottom-radiusTop)/height;for(y=0;y<=heightSegments;y++){let indexRow=[],v=y/heightSegments,radius=v*(radiusBottom-radiusTop)+radiusTop;for(x=0;x<=radialSegments;x++){let u=x/radialSegments,theta=u*thetaLength+thetaStart,sinTheta=Math.sin(theta),cosTheta=Math.cos(theta);vertex.x=radius*sinTheta,vertex.y=-v*height+halfHeight,vertex.z=radius*cosTheta,vertices.push(vertex.x,vertex.y,vertex.z),normal.set(sinTheta,slope,cosTheta).normalize(),normals.push(normal.x,normal.y,normal.z),planarMapping?(uv.x=.5*cosTheta+.5,uv.y=.5*sinTheta+.5,uvs.push(uv.x,uv.y)):uvs.push(u,1-v),indexRow.push(index++)}indexArray.push(indexRow)}for(x=0;x<radialSegments;x++)for(y=0;y<heightSegments;y++){let a=indexArray[y][x],b=indexArray[y+1][x],c=indexArray[y+1][x+1],d=indexArray[y][x+1];indices.push(a,b,d),indices.push(b,c,d)}}(),!1===openEnded&&(radiusTop>0&&generateCap(!0),radiusBottom>0&&generateCap(!1)),this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class ConeGeometry extends CylinderGeometry{constructor(radius,height,radialSegments,heightSegments,openEnded,thetaStart,thetaLength){super(0,radius,height,radialSegments,heightSegments,openEnded,thetaStart,thetaLength)}}class PlaneGeometry extends Geometry{constructor(width=1,height=1,widthSegments=1,heightSegments=1){super();let ix,iy,width_half=width/2,height_half=height/2,gridX=Math.floor(widthSegments)||1,gridY=Math.floor(heightSegments)||1,gridX1=gridX+1,gridY1=gridY+1,segment_width=width/gridX,segment_height=height/gridY,indices=[],vertices=[],normals=[],uvs=[];for(iy=0;iy<gridY1;iy++){let y=iy*segment_height-height_half;for(ix=0;ix<gridX1;ix++){let x=ix*segment_width-width_half;vertices.push(x,-y,0),normals.push(0,0,1),uvs.push(ix/gridX),uvs.push(1-iy/gridY)}}for(iy=0;iy<gridY;iy++)for(ix=0;ix<gridX;ix++){let a=ix+gridX1*iy,b=ix+gridX1*(iy+1),c=ix+1+gridX1*(iy+1),d=ix+1+gridX1*iy;indices.push(a,b,d),indices.push(b,c,d)}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class PolyhedronGeometry extends Geometry{constructor(vertices,indices=[],radius=1,detail=0){super();let vertexBuffer=[],uvBuffer=[];function subdivideFace(a,b,c,detail){var i,j,cols=Math.pow(2,detail),v=[];for(i=0;i<=cols;i++){v[i]=[];var aj=a.clone().lerp(c,i/cols),bj=b.clone().lerp(c,i/cols),rows=cols-i;for(j=0;j<=rows;j++)v[i][j]=0===j&&i===cols?aj:aj.clone().lerp(bj,j/rows)}for(i=0;i<cols;i++)for(j=0;j<2*(cols-i)-1;j++){var k=Math.floor(j/2);j%2==0?(pushVertex(v[i][k+1]),pushVertex(v[i+1][k]),pushVertex(v[i][k])):(pushVertex(v[i][k+1]),pushVertex(v[i+1][k+1]),pushVertex(v[i+1][k]))}}function pushVertex(vertex){vertexBuffer.push(vertex.x,vertex.y,vertex.z)}function getVertexByIndex(index,vertex){let stride=3*index;vertex.x=vertices[stride+0],vertex.y=vertices[stride+1],vertex.z=vertices[stride+2]}function correctUV(uv,stride,vector,azimuth){azimuth<0&&1===uv.x&&(uvBuffer[stride]=uv.x-1),0===vector.x&&0===vector.z&&(uvBuffer[stride]=azimuth/2/Math.PI+.5)}function azimuth(vector){return Math.atan2(vector.z,-vector.x)}!function subdivide(detail){let a=new Vector3,b=new Vector3,c=new Vector3;for(let i=0;i<indices.length;i+=3)getVertexByIndex(indices[i+0],a),getVertexByIndex(indices[i+1],b),getVertexByIndex(indices[i+2],c),subdivideFace(a,b,c,detail)}(detail),function appplyRadius(radius){for(var vertex=new Vector3,i=0;i<vertexBuffer.length;i+=3)vertex.x=vertexBuffer[i+0],vertex.y=vertexBuffer[i+1],vertex.z=vertexBuffer[i+2],vertex.normalize().multiplyScalar(radius),vertexBuffer[i+0]=vertex.x,vertexBuffer[i+1]=vertex.y,vertexBuffer[i+2]=vertex.z}(radius),function generateUVs(){let vertex=new Vector3;for(let i=0;i<vertexBuffer.length;i+=3){vertex.x=vertexBuffer[i+0],vertex.y=vertexBuffer[i+1],vertex.z=vertexBuffer[i+2];let u=azimuth(vertex)/2/Math.PI+.5,v=(vector=vertex,Math.atan2(-vector.y,Math.sqrt(vector.x*vector.x+vector.z*vector.z))/Math.PI+.5);uvBuffer.push(u,1-v)}var vector;(function correctUVs(){let a=new Vector3,b=new Vector3,c=new Vector3,centroid=new Vector3,uvA=new Vector2,uvB=new Vector2,uvC=new Vector2;for(let i=0,j=0;i<vertexBuffer.length;i+=9,j+=6){a.set(vertexBuffer[i+0],vertexBuffer[i+1],vertexBuffer[i+2]),b.set(vertexBuffer[i+3],vertexBuffer[i+4],vertexBuffer[i+5]),c.set(vertexBuffer[i+6],vertexBuffer[i+7],vertexBuffer[i+8]),uvA.set(uvBuffer[j+0],uvBuffer[j+1]),uvB.set(uvBuffer[j+2],uvBuffer[j+3]),uvC.set(uvBuffer[j+4],uvBuffer[j+5]),centroid.copy(a).add(b).add(c).divideScalar(3);let azi=azimuth(centroid);correctUV(uvA,j+0,a,azi),correctUV(uvB,j+2,b,azi),correctUV(uvC,j+4,c,azi)}})(),function correctSeam(){for(let i=0;i<uvBuffer.length;i+=6){let x0=uvBuffer[i+0],x1=uvBuffer[i+2],x2=uvBuffer[i+4],max=Math.max(x0,x1,x2),min=Math.min(x0,x1,x2);max>.9&&min<.1&&(x0<.2&&(uvBuffer[i+0]+=1),x1<.2&&(uvBuffer[i+2]+=1),x2<.2&&(uvBuffer[i+4]+=1))}}()}(),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertexBuffer),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(vertexBuffer.slice()),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvBuffer),2)),0===detail?this.computeVertexNormals():this.normalizeNormals()}}class IcosahedronGeometry extends PolyhedronGeometry{constructor(radius,detail){let t=(1+Math.sqrt(5))/2;super([-1,t,0,1,t,0,-1,-t,0,1,-t,0,0,-1,t,0,1,t,0,-1,-t,0,1,-t,t,0,-1,t,0,1,-t,0,-1,-t,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],radius,detail)}}class RingGeometry extends Geometry{constructor(innerRadius=.5,outerRadius=1,thetaSegments=8,phiSegments=1,thetaStart=0,thetaLength=2*Math.PI){super();var segment,j,i,indices=[],vertices=[],normals=[],uvs=[],radius=innerRadius,radiusStep=(outerRadius-innerRadius)/phiSegments,vertex=new Vector3,uv=new Vector2;for(j=0;j<=phiSegments;j++){for(i=0;i<=thetaSegments;i++)segment=thetaStart+i/thetaSegments*thetaLength,vertex.x=radius*Math.cos(segment),vertex.y=radius*Math.sin(segment),vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,0,1),uv.x=(vertex.x/outerRadius+1)/2,uv.y=(vertex.y/outerRadius+1)/2,uvs.push(uv.x,uv.y);radius+=radiusStep}for(j=0;j<phiSegments;j++){var thetaSegmentLevel=j*(thetaSegments+1);for(i=0;i<thetaSegments;i++){var a=segment=i+thetaSegmentLevel,b=segment+thetaSegments+1,c=segment+thetaSegments+2,d=segment+1;indices.push(a,b,d),indices.push(b,c,d)}}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class SphereGeometry extends Geometry{constructor(radius=1,widthSegments=8,heightSegments=6,phiStart=0,phiLength=2*Math.PI,thetaStart=0,thetaLength=Math.PI){super(),widthSegments=Math.max(3,Math.floor(widthSegments)),heightSegments=Math.max(2,Math.floor(heightSegments));let ix,iy,thetaEnd=thetaStart+thetaLength,index=0,grid=[],vertex=new Vector3,normal=new Vector3,indices=[],vertices=[],normals=[],uvs=[];for(iy=0;iy<=heightSegments;iy++){let verticesRow=[],v=iy/heightSegments;for(ix=0;ix<=widthSegments;ix++){let u=ix/widthSegments;vertex.x=-radius*Math.cos(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),vertex.y=radius*Math.cos(thetaStart+v*thetaLength),vertex.z=radius*Math.sin(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),vertices.push(vertex.x,vertex.y,vertex.z),normal.set(vertex.x,vertex.y,vertex.z).normalize(),normals.push(normal.x,normal.y,normal.z),uvs.push(u,1-v),verticesRow.push(index++)}grid.push(verticesRow)}for(iy=0;iy<heightSegments;iy++)for(ix=0;ix<widthSegments;ix++){let a=grid[iy][ix+1],b=grid[iy][ix],c=grid[iy+1][ix],d=grid[iy+1][ix+1];(0!==iy||thetaStart>0)&&indices.push(a,b,d),(iy!==heightSegments-1||thetaEnd<Math.PI)&&indices.push(b,c,d)}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class TorusKnotGeometry extends Geometry{constructor(radius=1,tube=.4,tubularSegments=64,radialSegments=8,p=2,q=3){super();let i,j,indices=[],vertices=[],normals=[],uvs=[],vertex=new Vector3,normal=new Vector3,P1=new Vector3,P2=new Vector3,B=new Vector3,T=new Vector3,N=new Vector3;for(i=0;i<=tubularSegments;++i){let u=i/tubularSegments*p*Math.PI*2;for(calculatePositionOnCurve(u,p,q,radius,P1),calculatePositionOnCurve(u+.01,p,q,radius,P2),T.subVectors(P2,P1),N.addVectors(P2,P1),B.crossVectors(T,N),N.crossVectors(B,T),B.normalize(),N.normalize(),j=0;j<=radialSegments;++j){let v=j/radialSegments*Math.PI*2,cx=-tube*Math.cos(v),cy=tube*Math.sin(v);vertex.x=P1.x+(cx*N.x+cy*B.x),vertex.y=P1.y+(cx*N.y+cy*B.y),vertex.z=P1.z+(cx*N.z+cy*B.z),vertices.push(vertex.x,vertex.y,vertex.z),normal.subVectors(vertex,P1).normalize(),normals.push(normal.x,normal.y,normal.z),uvs.push(i/tubularSegments),uvs.push(j/radialSegments)}}for(j=1;j<=tubularSegments;j++)for(i=1;i<=radialSegments;i++){let a=(radialSegments+1)*(j-1)+(i-1),b=(radialSegments+1)*j+(i-1),c=(radialSegments+1)*j+i,d=(radialSegments+1)*(j-1)+i;indices.push(a,b,d),indices.push(b,c,d)}function calculatePositionOnCurve(u,p,q,radius,position){let cu=Math.cos(u),su=Math.sin(u),quOverP=q/p*u,cs=Math.cos(quOverP);position.x=radius*(2+cs)*.5*cu,position.y=radius*(2+cs)*su*.5,position.z=radius*Math.sin(quOverP)*.5}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}Class((function Interaction3D(_camera){Inherit(this,Component);const _this=this;let _hover,_click;var _lastOnUpdate,_v3=new Vector3,_input={},_cacheHits=[],_enabled=!0;_this.ID=Utils.timestamp(),_camera=_camera||World.CAMERA;var _ray=_this.initClass(Raycaster,_camera),_meshes=[],_test=[],_event={};const PROHIBITED_ELEMENTS=["hit","prevent_interaction3d"];function checkIfProhibited(element){let el=element;for(;el;){if(el.classList)for(let i=0;i<PROHIBITED_ELEMENTS.length;i++)if(el.classList.contains(PROHIBITED_ELEMENTS[i]))return!0;el=el.parentNode}return!1}function parseMeshes(meshes){Array.isArray(meshes)||(meshes=[meshes]);let output=[];return meshes.forEach((function checkMesh(obj){obj.hitArea&&(obj=function initHitMesh(obj){obj.hitMesh||(obj.hitMesh=new Mesh(obj.hitArea),obj.add(obj.hitMesh));return(obj=obj.hitMesh).isHitMesh=!0,obj.testVisibility=!1,obj.visible=!1,obj}(obj));"boolean"==typeof obj.isHitMesh?(obj.mouseEnabled=function(visible){visible?~_meshes.indexOf(obj)||_meshes.push(obj):_meshes.remove(obj)},output.push(obj)):output.push(obj);obj.children.length&&obj.children.forEach(checkMesh)})),output}function testObjects(){_test.length=0;for(let i=_meshes.length-1;i>-1;i--){let obj=_meshes[i];obj.determineVisible()&&_test.push(obj)}return _test}function start(e){if("2d"==_input.type){let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));if(element&&checkIfProhibited(element)||GLUI.HIT)return}if(!_enabled)return;let hit=move(e);"3d"==_input.type&&_this.events.fire(Interaction3D.EXTERNAL_PRESS),hit?(_click=hit.object,_click.time=Render.TIME):_click=null}function moveHand(e){if(!_enabled)return;_cacheHits.length=0;for(let i=0;i<_input.obj.length;i++){let obj=_input.obj[i];_v3.set(0,0,-1).applyQuaternion(obj.quaternion);let hit=_ray.checkFromValues(testObjects(),obj.position,_v3)[0];hit&&_cacheHits.push(hit)}_cacheHits.sort(((a,b)=>a.distance-b.distance));let hit=_cacheHits[0];if(hit&&hit.object==_lastOnUpdate||(_lastOnUpdate&&_lastOnUpdate.onMissUpdate&&_lastOnUpdate.onMissUpdate(),_lastOnUpdate=null),hit){let mesh=hit.object;if(mesh.onHitUpdate)return hit.usingFinger=!0,_lastOnUpdate=mesh,mesh.onHitUpdate(hit),!1;!mesh._debounceFingerClick||Render.TIME-mesh._debounceFingerClick>1e3?hit.distance<.01?(_click=mesh,triggerClick(mesh,hit),mesh._debounceFingerClick=Render.TIME):_hover||(_hover=mesh,triggerHover("over",mesh,hit)):_hover&&(triggerHover("out",_hover),_hover=null)}else _hover&&(triggerHover("out",_hover),_hover=null)}function move(e){if("2d"==_input.type){let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));if(element&&checkIfProhibited(element))return}if(!_enabled)return void Interaction3D.requestCursor("auto",_this);let hit;if("2d"==_input.type?hit=_ray.checkHit(testObjects(),_input.position,_input.rect||Stage)[0]:(_input.obj.hideBeam(),_v3.set(0,0,-1).applyQuaternion(_input.obj.group.getWorldQuaternion()),hit=_ray.checkFromValues(testObjects(),_input.obj.group.getWorldPosition(),_v3)[0]),hit&&hit.object==_lastOnUpdate||(_lastOnUpdate&&_lastOnUpdate.onMissUpdate&&_lastOnUpdate.onMissUpdate(),_lastOnUpdate=null),hit){_this.intersecting=!0;let mesh=hit.object;if("3d"==_input.type){if(mesh.onHitUpdate&&hit.distance>5)return!1;_input.obj.showBeam(),_input.obj.setHitPosition&&_input.obj.setHitPosition(hit)}return mesh.onHitUpdate?(mesh.onHitUpdate(hit),_lastOnUpdate=mesh,!1):(_hover!==mesh?(_hover&&triggerHover("out",_hover,hit),_hover=mesh,triggerHover("over",_hover,hit),_hover.__clickCallback?Interaction3D.requestCursor("pointer",_this):Interaction3D.requestCursor("auto",_this)):function triggerMove(mesh,hit){_event.action="move",_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.MOVE,_event,!0),mesh["__moveCallback"+_this.ID]&&mesh["__moveCallback"+_this.ID](_event)}(_hover,hit),hit)}return _this.intersecting=!1,end(),_input.obj&&_input.obj.setHitPosition&&_input.obj.setHitPosition(!1),!1}function end(){_hover&&(triggerHover("out",_hover,null),_hover=null,Interaction3D.requestCursor(_this.cursor,_this))}function click(e){if("3d"==_input.type&&_this.events.fire(Interaction3D.EXTERNAL_RELEASE),!_this.enabled)return;if(!_click)return;let hit,element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));if(!element||!checkIfProhibited(element)){if("2d"==_input.type){if(GLUI.HIT)return;hit=_ray.checkHit(testObjects(),_input.position,_input.rect)[0]}else _v3.set(0,0,-1).applyQuaternion(_input.obj.group.getWorldQuaternion()),hit=_ray.checkFromValues(testObjects(),_input.obj.group.getWorldPosition(),_v3)[0];hit&&hit.object===_click&&triggerClick(_click,hit),_click=null}}function triggerHover(action,mesh,hit){_event.action=action,_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.HOVER,_event,!0),_hover.__hoverCallback&&_hover.__hoverCallback(_event)}function triggerClick(mesh,hit){_event.action="click",_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.CLICK,_event,!0),_click.__clickCallback&&_click.__clickCallback(_event)}function vrInputButton(e){"trigger"==e.label&&(e.pressed?start(e):click(e))}this.cursor="auto",_ray.testVisibility=!0,this.set("camera",(c=>{_ray.camera=c})),this.add=function(meshes,hover,click,move,seo){let seoRoot;Array.isArray(meshes)||(meshes=parseMeshes(meshes)),move&&"function"!=typeof move&&(seo=move,move=null),seo&&seo.root&&(seoRoot=seo.root,seo=seo.seo),meshes.forEach(((mesh,i)=>{if(seo)try{mesh._divFocus=_=>hover({action:"over",seo:!0,mesh:mesh}),mesh._divBlur=_=>hover({action:"out",seo:!0,mesh:mesh}),mesh._divSelect=_=>click({action:"click",seo:!0,mesh:mesh});let{url:url,label:label,...options}=Array.isArray(seo)?seo[i]:seo;GLSEO.objectNode(mesh,seoRoot),mesh.seo.aLink(url,label,options)}catch(e){Hydra.LOCAL&&console.warn("Could not add SEO to Interaction3D meshes",e)}mesh.hitDestroy=_=>_meshes.remove(mesh),hover&&(mesh.__hoverCallback=hover),click&&(mesh.__clickCallback=click),move&&(mesh["__moveCallback"+_this.ID]=move),_meshes.push(mesh)}))},this.remove=function(meshes){Array.isArray(meshes)||(meshes=parseMeshes(meshes)),meshes.forEach((mesh=>{mesh===_hover&&(_hover=null,Interaction3D.requestCursor(_this.cursor,_this)),mesh.seo&&mesh.seo.unlink();for(let i=_meshes.length-1;i>=0;i--)mesh===_meshes[i]&&_meshes.splice(i,1)}))},this.set("testVisibility",(v=>_ray.testVisibility=v)),this.set("input",(obj=>{_input&&_input.obj&&(_input.obj.isVrController&&_this.events.unsub(_input.obj,VRInput.BUTTON,vrInputButton),_input.obj.setHitPosition&&_input.obj.setHitPosition(!1)),(_input={}).obj=obj,_input.position=obj.group?obj.group.position:obj,_input.quaternion=obj.group?obj.group.quaternion:null,_input.type="number"==typeof _input.position.z||Array.isArray(obj)?"3d":"2d",_input.rect=obj.rect,"3d"==_input.type?(new Vector3,new Vector3):(new Vector2,new Vector2),obj==Mouse?function addHandlers(){_this.events.sub(Mouse.input,Interaction.START,start),Device.mobile&&_this.events.sub(Mouse.input,Interaction.END,end),_this.events.sub(Mouse.input,Interaction.MOVE,move),_this.events.sub(Mouse.input,Interaction.CLICK,click)}():(!function removeHandlers(){_this.events.unsub(Mouse.input,Interaction.START,start),Device.mobile&&_this.events.unsub(Mouse.input,Interaction.END,end),_this.events.unsub(Mouse.input,Interaction.MOVE,move),_this.events.unsub(Mouse.input,Interaction.CLICK,click)}(),Array.isArray(obj)?(_this.startRender(moveHand),_this.stopRender(move)):(_this.events.sub(obj,VRInput.BUTTON,vrInputButton),_this.startRender(move),_this.stopRender(moveHand)))})),this.get("input",(_=>_input)),this.get("enabled",(_=>_enabled)),this.set("enabled",(v=>{(_enabled=v)||(_hover&&triggerHover("out",_hover,null),_hover=null)}))}),(()=>{Interaction3D.HOVER="interaction3d_hover",Interaction3D.CLICK="interaction3d_click",Interaction3D.MOVE="interaction3d_move",Interaction3D.EXTERNAL_PRESS="interaction3d_ext_press",Interaction3D.EXTERNAL_RELEASE="interaction3d_ext_release";var _cursorObj,_map=new Map,_input=Mouse;Interaction3D.find=function(camera){if(camera=camera.camera||camera,!_map.has(camera)){let interaction=new Interaction3D(camera);interaction.input=_input,_map.set(camera,interaction)}return _map.get(camera)},Interaction3D.useInput=function(obj){if(_input!=obj){for(let[camera,interaction]of _map)interaction.input=obj;_input=obj}},Interaction3D.requestCursor=function(cursor,obj){"pointer"==cursor&&(_cursorObj=obj,Stage.cursor(cursor)),"auto"==cursor&&_cursorObj==obj&&(Stage.cursor(cursor),_cursorObj=null)}})),Class((function Lighting(){Inherit(this,Component);const _this=this;var _activeScene,_scenes={};function loop(){if(decomposeLights(_activeScene.lights),_this.UBO){let shader=_activeScene.shaders.start();shader&&(updateArrays(shader),_activeScene.ubo.created?_activeScene.ubo.update():createUBO(shader.uniforms))}else{let shader=_activeScene.shaders.start();for(;shader;)updateArrays(shader),shader=_activeScene.shaders.next()}}function createUBO(uniforms){_activeScene.ubo.created=!0,_activeScene.ubo.push(uniforms.lightPos),_activeScene.ubo.push(uniforms.lightColor),_activeScene.ubo.push(uniforms.lightData),_activeScene.ubo.push(uniforms.lightData2),_activeScene.ubo.push(uniforms.lightData3),_activeScene.ubo.push(uniforms.lightProperties),_activeScene.ubo.upload()}function decomposeLights(lights){for(let i=lights.length-1;i>-1;i--){let light=lights[i];light._decomposedTime&&Render.TIME-light._decomposedTime<8||(light._decomposedTime=Render.TIME,light._parent||light.updateMatrixWorld(),light._world||(light._world=new Vector3),light.lockToLocal?light._world.copy(light.position):light.getWorldPosition(light._world))}}function updateArrays(shader){let lighting=shader.__lighting;lighting.position.length=0,lighting.color.length=0,lighting.data.length=0,lighting.data2.length=0,lighting.data3.length=0,lighting.properties.length=0;for(let i=0;i<_activeScene.lights.length;i++){let light=_activeScene.lights[i];light._world||decomposeLights(_activeScene.lights),lighting.position.push(light._world.x,light._world.y,light._world.z,0),lighting.color.push(light.color.r,light.color.g,light.color.b,0),lighting.data.push(light.data.x,light.data.y,light.data.z,light.data.w),lighting.data2.push(light.data2.x,light.data2.y,light.data2.z,light.data2.w),lighting.data3.push(light.data3.x,light.data3.y,light.data3.z,light.data3.w),lighting.properties.push(light.properties.x,light.properties.y,light.properties.z,light.properties.w)}}function findParentScene(obj3d){if(!obj3d)return _activeScene;if(obj3d._lightingData)return obj3d._lightingData;let scene,p=obj3d._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent;return scene||(scene=_activeScene),scene}this.fallbackAreaToPoint=!1,this.scenes=_scenes,async function(){await Hydra.ready(),_this.createScene("default"),_this.useScene("default")}(),this.createScene=function(name,scene){if(_scenes[name])return this;let obj={lights:[],renderShadows:[],ubo:new(window.Metal?MetalUBO:UBO)(2),shaders:new LinkedList,name:name};return scene&&(scene._lightingData=obj),_scenes[name]=obj,this},this.useScene=function(name){if(!(_activeScene=_scenes[name]))throw`Scene ${name} not found`;return loop(),this},this.destroyScene=function(name){delete _scenes[name]},this.push=this.add=function(light){_this.UBO=Renderer.UBO&&!(window.AURA||RenderManager.type==RenderManager.WEBVR),window.Metal&&(_this.UBO=!0);let scene=findParentScene(light);scene.lights.push(light),light.isAreaLight&&(scene.hasAreaLight=!0),_this.startedLoop||(_this.startedLoop=!0,RenderManager.type==RenderManager.WEBVR?_this.startRender(loop,World.NUKE):Render.onDrawFrame(loop))},this.remove=function(light){_activeScene.lights.remove(light)},this.getLighting=function(shader,force){if(shader.__lighting&&!force)return shader.__lighting;let scene=findParentScene(shader.mesh);scene.shaders.push(shader),window.AreaLightUtil&&scene.hasAreaLight&&AreaLightUtil.append(shader);let lighting=shader.__lighting={position:[],color:[],data:[],data2:[],data3:[],properties:[]},lightUBO=_this.UBO;return shader.uniforms.lightPos={type:"v4v",value:lighting.position,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightColor={type:"v4v",value:lighting.color,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData={type:"v4v",value:lighting.data,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData2={type:"v4v",value:lighting.data2,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData3={type:"v4v",value:lighting.data3,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightProperties={type:"v4v",value:lighting.properties,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},updateArrays(shader),_this.UBO&&!_activeScene.ubo.created&&createUBO(shader.uniforms),shader.__lighting},this.destroyShader=function(shader){findParentScene(shader.mesh);_activeScene.shaders.remove(shader)},this.sort=function(callback){_activeScene.lights.sort(callback)},this.addToShadowGroup=function(light){findParentScene(light).renderShadows.push(light)},this.removeFromShadowGroup=function(light){findParentScene(light);_activeScene.renderShadows.remove(light)},this.getShadowLights=function(){return _activeScene.renderShadows},this.getShadowCount=function(){return _activeScene.renderShadows.length},this.initShadowShader=function(object,mesh){let scene,shader=object.shader||object;if(shader.mesh){let p=shader.mesh._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent}if(scene||(scene=_activeScene),!World.RENDERER.shadows||0==scene.renderShadows.length)return"";shader._gl||shader.upload();let vsName=shader.vsName,fsName="ShadowDepth";shader.customShadowShader&&(fsName=shader.customShadowShader),shader.shadow=new Shader(vsName,fsName,{receiveLight:shader.receiveLight,UILPrefix:shader.UILPrefix,precision:"high"}),shader.vertexShader&&(shader.shadow.vertexShader=shader.vertexShader),shader.restoreVS&&(shader.shadow.vertexShader=shader.restoreVS),shader.customCompile&&(shader.shadow.customCompile=shader.customCompile+"_shadow"),shader.shadow.lights=shader.lights,shader.shadow.isShadow=!0,shader.copyUniformsTo(shader.shadow,!0),shader.shadow.upload()},this.getShadowUniforms=function(shader){let scene;if(shader.mesh){let p=shader.mesh._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent}return scene||(scene=_activeScene),World.RENDERER.shadows&&0!=scene.renderShadows.length?["\n#define SHADOW_MAPS "+scene.renderShadows.length,World.RENDERER.shadows==Renderer.SHADOWS_LOW?"#define SHADOWS_LOW":"",World.RENDERER.shadows==Renderer.SHADOWS_MED?"#define SHADOWS_MED":"",World.RENDERER.shadows==Renderer.SHADOWS_HIGH?"#define SHADOWS_HIGH":"",`uniform sampler2D shadowMap[${scene.renderShadows.length}];`,`uniform mat4 shadowMatrix[${scene.renderShadows.length}];`,`uniform vec3 shadowLightPos[${scene.renderShadows.length}];`,`uniform float shadowSize[${scene.renderShadows.length}];`].join("\n"):""},this.bindUBO=function(shader){_activeScene.ubo.created&&_activeScene.ubo.bind(shader,"lights")},this.fallbackAreaToPointTest=function(){return _this.fallbackAreaToPoint},this.get("activeScene",(_=>_activeScene))}),"static");class Shadow{constructor(light){this.light=light,this.camera=new PerspectiveCamera(60,1,.1,50),this.target=new Vector3,this.rt=new RenderTarget(1024,1024),this.rt.createDepthTexture(),this.enabled=!0,this._size=1024,this._fov=60,this._far=50,this._near=.1,light.add(this.camera)}destroy(){this.rt.destroy()}set fov(value){this._fov=value,this.camera.fov=value,this.camera.updateProjectionMatrix(),-1==value&&(this.camera=new OrthographicCamera(-5,5,5,-5,.1,50))}get fov(){return this._fov}set area(value){this._area=value,this.camera.left=-value,this.camera.right=value,this.camera.top=value,this.camera.bottom=-value,this.camera.updateProjectionMatrix()}get area(){return this._area}set far(value){this._far=value,this.camera.far=value,this.camera.updateProjectionMatrix()}get far(){return this._far}set near(value){this._near=value,this.camera.near=value,this.camera.updateProjectionMatrix()}get near(){return this._near}set size(value){this._size=value,this.rt.setSize(value,value)}get size(){return this._size}}class Box2{constructor(min,max){this.min=void 0!==min?min:new Vector2(1/0,1/0),this.max=void 0!==max?max:new Vector2(-1/0,-1/0)}set(min,max){return this.min.copy(min),this.max.copy(max),this}setFromPoints(points){this.makeEmpty();for(let i=0,il=points.length;i<il;i++)this.expandByPoint(points[i]);return this}setFromCenterAndSize(center,size){let v1=this.V1||new Vector2;this.V1=v1;let halfSize=v1.copy(size).multiplyScalar(.5);return this.min.copy(center).sub(halfSize),this.max.copy(center).add(halfSize),this}clone(){return(new Box2).copy(this)}copy(box){return this.min.copy(box.min),this.max.copy(box.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(target){return this.isEmpty()?target.set(0,0):target.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(target){return this.isEmpty()?target.set(0,0):target.subVectors(this.max,this.min)}expandByPoint(point){return this.min.min(point),this.max.max(point),this}expandByVector(vector){return this.min.sub(vector),this.max.add(vector),this}expandByScalar(scalar){return this.min.addScalar(-scalar),this.max.addScalar(scalar),this}containsPoint(point){return!(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y)}containsBox(box){return this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y}getParameter(point,target){return target.set((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(box){return!(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y)}clampPoint(point,target){return target.copy(point).clamp(this.min,this.max)}distanceToPoint(point){let v1=this.V1||new Vector2;return this.V1=v1,v1.copy(point).clamp(this.min,this.max).sub(point).length()}intersect(box){return this.min.max(box.min),this.max.min(box.max),this}union(box){return this.min.min(box.min),this.max.max(box.max),this}translate(offset){return this.min.add(offset),this.max.add(offset),this}equals(box){return box.min.equals(this.min)&&box.max.equals(this.max)}}class Box3{constructor(min,max){this.min=void 0!==min?min:new Vector3(1/0,1/0,1/0),this.max=void 0!==max?max:new Vector3(-1/0,-1/0,-1/0)}set(min,max){return this.min.copy(min),this.max.copy(max),this}setFromArray(array){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=array.length;i<l;i+=3){let x=array[i],y=array[i+1],z=array[i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}setFromBufferAttribute(attribute){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=attribute.count;i<l;i++){let x=attribute.array[3*i+0],y=attribute.array[3*i+1],z=attribute.array[3*i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}setFromPoints(points){this.makeEmpty();for(let i=0,il=points.length;i<il;i++)this.expandByPoint(points[i]);return this}setFromCenterAndSize(center,size){let v1=this.V1||new Vector3;this.V1=v1;let halfSize=v1.copy(size).multiplyScalar(.5);return this.min.copy(center).sub(halfSize),this.max.copy(center).add(halfSize),this}setFromObject(object){return this.makeEmpty(),this.expandByObject(object)}clone(){return(new Box3).copy(this)}copy(box){return this.min.copy(box.min),this.max.copy(box.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(target){return this.isEmpty()?target.set(0,0,0):target.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(target){return this.isEmpty()?target.set(0,0,0):target.subVectors(this.max,this.min)}expandByPoint(point){return this.min.min(point),this.max.max(point),this}expandByVector(vector){return this.min.sub(vector),this.max.add(vector),this}expandByScalar(scalar){return this.min.addScalar(-scalar),this.max.addScalar(scalar),this}expandByObject(object,local){let scope,i,l,v1=this.V1||new Vector3;return this.V1=v1,scope=this,object.updateMatrixWorld(!0),object.traverse((node=>{let geometry=node.geometry;if(!geometry)return;let attribute=geometry.attributes.position;if(void 0!==attribute)for(i=0,l=attribute.count;i<l;i++)v1.fromBufferAttribute(attribute,i).applyMatrix4(local?node.matrix:node.matrixWorld),scope.expandByPoint(v1)})),this}containsPoint(point){return!(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y||point.z<this.min.z||point.z>this.max.z)}containsBox(box){return this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y&&this.min.z<=box.min.z&&box.max.z<=this.max.z}getParameter(point,target){return target.set((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y),(point.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(box){return!(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y||box.max.z<this.min.z||box.min.z>this.max.z)}intersectsSphere(sphere){let closestPoint=this.V1||new Vector3;return this.V1=closestPoint,this.clampPoint(sphere.center,closestPoint),closestPoint.distanceToSquared(sphere.center)<=sphere.radius*sphere.radius}intersectsPlane(plane){let min,max;return plane.normal.x>0?(min=plane.normal.x*this.min.x,max=plane.normal.x*this.max.x):(min=plane.normal.x*this.max.x,max=plane.normal.x*this.min.x),plane.normal.y>0?(min+=plane.normal.y*this.min.y,max+=plane.normal.y*this.max.y):(min+=plane.normal.y*this.max.y,max+=plane.normal.y*this.min.y),plane.normal.z>0?(min+=plane.normal.z*this.min.z,max+=plane.normal.z*this.max.z):(min+=plane.normal.z*this.max.z,max+=plane.normal.z*this.min.z),min<=plane.constant&&max>=plane.constant}intersectsTriangle(triangle){let v0=this.V0||new Vector3;this.V0=v0;let v1=this.V1||new Vector3;this.V1=v1;let v2=this.V2||new Vector3;this.V2=v2;let f0=this.F0||new Vector3;this.F0=f0;let f1=this.F1||new Vector3;this.F1=f1;let f2=this.F2||new Vector3;this.F2=f2;let testAxis=this.V3||new Vector3;this.V3=testAxis;let center=this.V4||new Vector3;this.V4=center;let extents=this.V5||new Vector3;this.V5=extents;let triangleNormal=this.V6||new Vector3;function satForAxes(axes){let i,j;for(i=0,j=axes.length-3;i<=j;i+=3){testAxis.fromArray(axes,i);let r=extents.x*Math.abs(testAxis.x)+extents.y*Math.abs(testAxis.y)+extents.z*Math.abs(testAxis.z),p0=v0.dot(testAxis),p1=v1.dot(testAxis),p2=v2.dot(testAxis);if(Math.max(-Math.max(p0,p1,p2),Math.min(p0,p1,p2))>r)return!1}return!0}if(this.V6=triangleNormal,this.isEmpty())return!1;this.getCenter(center),extents.subVectors(this.max,center),v0.subVectors(triangle.a,center),v1.subVectors(triangle.b,center),v2.subVectors(triangle.c,center),f0.subVectors(v1,v0),f1.subVectors(v2,v1),f2.subVectors(v0,v2);let axes=[0,-f0.z,f0.y,0,-f1.z,f1.y,0,-f2.z,f2.y,f0.z,0,-f0.x,f1.z,0,-f1.x,f2.z,0,-f2.x,-f0.y,f0.x,0,-f1.y,f1.x,0,-f2.y,f2.x,0];return!!satForAxes(axes)&&(axes=[1,0,0,0,1,0,0,0,1],!!satForAxes(axes)&&(triangleNormal.crossVectors(f0,f1),axes=[triangleNormal.x,triangleNormal.y,triangleNormal.z],satForAxes(axes)))}clampPoint(point,target){return target.copy(point).clamp(this.min,this.max)}distanceToPoint(point){let v1=this.V1||new Vector3;return this.V1=v1,v1.copy(point).clamp(this.min,this.max).sub(point).length()}getBoundingSphere(target=new Sphere){let v1=this.V1||new Vector3;return this.V1=v1,this.getCenter(target.center),target.radius=.5*this.getSize(v1).length(),target}intersect(box){return this.min.max(box.min),this.max.min(box.max),this.isEmpty()&&this.makeEmpty(),this}union(box){return this.min.min(box.min),this.max.max(box.max),this}applyMatrix4(matrix){if(this.isEmpty())return this;let m=matrix.elements,xax=m[0]*this.min.x,xay=m[1]*this.min.x,xaz=m[2]*this.min.x,xbx=m[0]*this.max.x,xby=m[1]*this.max.x,xbz=m[2]*this.max.x,yax=m[4]*this.min.y,yay=m[5]*this.min.y,yaz=m[6]*this.min.y,ybx=m[4]*this.max.y,yby=m[5]*this.max.y,ybz=m[6]*this.max.y,zax=m[8]*this.min.z,zay=m[9]*this.min.z,zaz=m[10]*this.min.z,zbx=m[8]*this.max.z,zby=m[9]*this.max.z,zbz=m[10]*this.max.z;return this.min.x=Math.min(xax,xbx)+Math.min(yax,ybx)+Math.min(zax,zbx)+m[12],this.min.y=Math.min(xay,xby)+Math.min(yay,yby)+Math.min(zay,zby)+m[13],this.min.z=Math.min(xaz,xbz)+Math.min(yaz,ybz)+Math.min(zaz,zbz)+m[14],this.max.x=Math.max(xax,xbx)+Math.max(yax,ybx)+Math.max(zax,zbx)+m[12],this.max.y=Math.max(xay,xby)+Math.max(yay,yby)+Math.max(zay,zby)+m[13],this.max.z=Math.max(xaz,xbz)+Math.max(yaz,ybz)+Math.max(zaz,zbz)+m[14],this}translate(offset){return this.min.add(offset),this.max.add(offset),this}equals(box){return box.min.equals(this.min)&&box.max.equals(this.max)}setFromBufferAttribute(attribute){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=attribute.count;i<l;i++){let x=attribute.array[3*i+0],y=attribute.array[3*i+1],z=attribute.array[3*i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}}class Color{constructor(r,g,b){return null==r&&null==g&&null==b?this.setRGB(1,1,1):void 0===g&&void 0===b?this.set(r):void this.setRGB(r,g,b)}set(value){return value&&value instanceof Color?this.copy(value):"number"==typeof value?this.setHex(value):"string"==typeof value&&this.setStyle(value),this}setScalar(scalar){return this.r=scalar,this.g=scalar,this.b=scalar,this}setHex(hex){return hex=Math.floor(hex),this.r=(hex>>16&255)/255,this.g=(hex>>8&255)/255,this.b=(255&hex)/255,this}setStyle(string){return this.setHex(Number(string.replace("#","0x")))}setRGB(r,g,b){return this.r=r,this.g=g,this.b=b,this}setHSL(h,s,l){function hue2rgb(p,q,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?p+6*(q-p)*t:t<.5?q:t<2/3?p+6*(q-p)*(2/3-t):p}if(h=Math.euclideanModulo(h,1),s=Math.clamp(s,0,1),l=Math.clamp(l,0,1),0===s)this.r=this.g=this.b=l;else{let p=l<=.5?l*(1+s):l+s-l*s,q=2*l-p;this.r=hue2rgb(q,p,h+1/3),this.g=hue2rgb(q,p,h),this.b=hue2rgb(q,p,h-1/3)}return this}clone(){return new Color(this.r,this.g,this.b)}copy(color){return this.r=color.r,this.g=color.g,this.b=color.b,this}copyGammaToLinear(color,gammaFactor){return void 0===gammaFactor&&(gammaFactor=2),this.r=Math.pow(color.r,gammaFactor),this.g=Math.pow(color.g,gammaFactor),this.b=Math.pow(color.b,gammaFactor),this}copyLinearToGamma(color,gammaFactor){void 0===gammaFactor&&(gammaFactor=2);let safeInverse=gammaFactor>0?1/gammaFactor:1;return this.r=Math.pow(color.r,safeInverse),this.g=Math.pow(color.g,safeInverse),this.b=Math.pow(color.b,safeInverse),this}convertGammaToLinear(gammaFactor){return this.copyGammaToLinear(this,gammaFactor),this}convertLinearToGamma(gammaFactor){return this.copyLinearToGamma(this,gammaFactor),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return"#"+("000000"+this.getHex().toString(16)).slice(-6)}getHSL(){let target=this.target||{};this.target=target;let hue,saturation,r=this.r,g=this.g,b=this.b,max=Math.max(r,g,b),min=Math.min(r,g,b),lightness=(min+max)/2;if(min===max)hue=0,saturation=0;else{let delta=max-min;switch(saturation=lightness<=.5?delta/(max+min):delta/(2-max-min),max){case r:hue=(g-b)/delta+(g<b?6:0);break;case g:hue=(b-r)/delta+2;break;case b:hue=(r-g)/delta+4}hue/=6}return target.h=hue,target.s=saturation,target.l=lightness,target}tween(color,time,ease,delay){const _this=this;_this.tweenObj||(_this.tweenObj={v:0}),_this.tweenObj.v=0;let clone=this.clone();return TweenManager.tween(_this.tweenObj,{v:1},time,ease,delay).onUpdate((_=>{_this.copy(clone).lerp(color,_this.tweenObj.v)}))}offsetHSL(h,s,l){let hsl=this.getHSL();return hsl.h+=h,hsl.s+=s,hsl.l+=l,this.setHSL(hsl.h,hsl.s,hsl.l),this}add(color){return this.r+=color.r,this.g+=color.g,this.b+=color.b,this}addColors(color1,color2){return this.r=color1.r+color2.r,this.g=color1.g+color2.g,this.b=color1.b+color2.b,this}addScalar(s){return this.r+=s,this.g+=s,this.b+=s,this}sub(color){return this.r=Math.max(0,this.r-color.r),this.g=Math.max(0,this.g-color.g),this.b=Math.max(0,this.b-color.b),this}multiply(color){return this.r*=color.r,this.g*=color.g,this.b*=color.b,this}multiplyScalar(s){return this.r*=s,this.g*=s,this.b*=s,this}invert(){return this.r=1-this.r,this.g=1-this.g,this.b=1-this.b,this}lerp(color,alpha){return this.r+=(color.r-this.r)*alpha,this.g+=(color.g-this.g)*alpha,this.b+=(color.b-this.b)*alpha,this}equals(c){return c.r===this.r&&c.g===this.g&&c.b===this.b}fromArray(array,offset){return void 0===offset&&(offset=0),this.r=array[offset],this.g=array[offset+1],this.b=array[offset+2],this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.r,array[offset+1]=this.g,array[offset+2]=this.b,array}toRGBA(alpha=1){return`rgba(${Math.floor(255*this.r)}, ${Math.floor(255*this.g)}, ${Math.floor(255*this.b)}, ${alpha})`}}class Cylindrical{constructor(radius=1,theta=0,y=0){this.radius=radius,this.theta=theta,this.y=y}set(radius,theta,y){return this.radius=radius,this.theta=theta,this.y=y,this}clone(){return(new this.constructor).copy(this)}copy(other){return this.radius=other.radius,this.theta=other.theta,this.y=other.y,this}setFromVector3(vec3){return this.radius=Math.sqrt(vec3.x*vec3.x+vec3.z*vec3.z),this.theta=Math.atan2(vec3.x,vec3.z),this.y=vec3.y,this}}class Euler{constructor(x,y,z,order){this._x=x||0,this._y=y||0,this._z=z||0,this._order=order||"XYZ",this.isEuler=!0}set x(value){this._x=value,this.onChangeCallback()}get x(){return this._x}set y(value){this._y=value,this.onChangeCallback()}get y(){return this._y}set z(value){this._z=value,this.onChangeCallback()}get z(){return this._z}set order(value){this._order=value,this.onChangeCallback()}get order(){return this._order}set(x,y,z,order){return this._x=x,this._y=y,this._z=z,this._order=order||this._order,this.onChangeCallback(),this}clone(){return new Euler(this._x,this._y,this._z,this._order)}copy(euler){return this._x=euler._x,this._y=euler._y,this._z=euler._z,this._order=euler._order,this.onChangeCallback(),this}setFromRotationMatrix(m,order,update){let clamp=Math.clamp,te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10];return"XYZ"===(order=order||this._order)?(this._y=Math.asin(clamp(m13,-1,1)),Math.abs(m13)<.99999?(this._x=Math.atan2(-m23,m33),this._z=Math.atan2(-m12,m11)):(this._x=Math.atan2(m32,m22),this._z=0)):"YXZ"===order?(this._x=Math.asin(-clamp(m23,-1,1)),Math.abs(m23)<.99999?(this._y=Math.atan2(m13,m33),this._z=Math.atan2(m21,m22)):(this._y=Math.atan2(-m31,m11),this._z=0)):"ZXY"===order?(this._x=Math.asin(clamp(m32,-1,1)),Math.abs(m32)<.99999?(this._y=Math.atan2(-m31,m33),this._z=Math.atan2(-m12,m22)):(this._y=0,this._z=Math.atan2(m21,m11))):"ZYX"===order?(this._y=Math.asin(-clamp(m31,-1,1)),Math.abs(m31)<.99999?(this._x=Math.atan2(m32,m33),this._z=Math.atan2(m21,m11)):(this._x=0,this._z=Math.atan2(-m12,m22))):"YZX"===order?(this._z=Math.asin(clamp(m21,-1,1)),Math.abs(m21)<.99999?(this._x=Math.atan2(-m23,m22),this._y=Math.atan2(-m31,m11)):(this._x=0,this._y=Math.atan2(m13,m33))):"XZY"===order&&(this._z=Math.asin(-clamp(m12,-1,1)),Math.abs(m12)<.99999?(this._x=Math.atan2(m32,m22),this._y=Math.atan2(m13,m11)):(this._x=Math.atan2(-m23,m33),this._y=0)),this._order=order,!1!==update&&this.onChangeCallback(),this}setFromQuaternion(q,order,update){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.makeRotationFromQuaternion(q),this.setFromRotationMatrix(matrix,order,update)}setFromVector3(v,order){return this.set(v.x,v.y,v.z,order||this._order)}reorder(newOrder){let q=this.Q1||new Quaternion;return this.Q1=q,q.setFromEuler(this),this.setFromQuaternion(q,newOrder)}lerp(euler,alpha){this._x+=(euler._x-this._x)*alpha,this._y+=(euler._y-this._y)*alpha,this._z+=(euler._z-this._z)*alpha,this.onChangeCallback()}equals(euler){return euler._x===this._x&&euler._y===this._y&&euler._z===this._z&&euler._order===this._order}fromArray(array){return this._x=array[0],this._y=array[1],this._z=array[2],void 0!==array[3]&&(this._order=array[3]),this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this._x,array[offset+1]=this._y,array[offset+2]=this._z,array[offset+3]=this._order,array}toVector3(optionalResult){return optionalResult?optionalResult.set(this._x,this._y,this._z):new Vector3(this._x,this._y,this._z)}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}Euler.DefaultOrder="XYZ",Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class Frustum{constructor(p0,p1,p2,p3,p4,p5){this.planes=[void 0!==p0?p0:new Plane,void 0!==p1?p1:new Plane,void 0!==p2?p2:new Plane,void 0!==p3?p3:new Plane,void 0!==p4?p4:new Plane,void 0!==p5?p5:new Plane]}set(p0,p1,p2,p3,p4,p5){let planes=this.planes;return planes[0].copy(p0),planes[1].copy(p1),planes[2].copy(p2),planes[3].copy(p3),planes[4].copy(p4),planes[5].copy(p5),this}clone(){return(new Frustum).copy(this)}copy(frustum){let planes=this.planes;for(let i=0;i<6;i++)planes[i].copy(frustum.planes[i]);return this}setFromMatrix(m){let planes=this.planes,me=m.elements,me0=me[0],me1=me[1],me2=me[2],me3=me[3],me4=me[4],me5=me[5],me6=me[6],me7=me[7],me8=me[8],me9=me[9],me10=me[10],me11=me[11],me12=me[12],me13=me[13],me14=me[14],me15=me[15];return planes[0].setComponents(me3-me0,me7-me4,me11-me8,me15-me12).normalize(),planes[1].setComponents(me3+me0,me7+me4,me11+me8,me15+me12).normalize(),planes[2].setComponents(me3+me1,me7+me5,me11+me9,me15+me13).normalize(),planes[3].setComponents(me3-me1,me7-me5,me11-me9,me15-me13).normalize(),planes[4].setComponents(me3-me2,me7-me6,me11-me10,me15-me14).normalize(),planes[5].setComponents(me3+me2,me7+me6,me11+me10,me15+me14).normalize(),this}setFromCamera(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse),this.setFromMatrix(matrix)}intersectsObject(object){let sphere=this.S1||new Sphere;this.S1=sphere;let geometry=object.geometry;return!!geometry&&(null===geometry.boundingSphere&&geometry.computeBoundingSphere(),sphere.copy(geometry.boundingSphere).applyMatrix4(object.matrixWorld),this.intersectsSphere(sphere))}intersectsSphere(sphere){let planes=this.planes,center=sphere.center,negRadius=-sphere.radius;for(let i=0;i<6;i++){if(planes[i].distanceToPoint(center)<negRadius)return!1}return!0}intersectsBox(box){let p1=this.V1||new Vector3,p2=this.V2||new Vector3;this.V1=p1,this.V2=p2;let planes=this.planes;for(let i=0;i<6;i++){let plane=planes[i];p1.x=plane.normal.x>0?box.min.x:box.max.x,p2.x=plane.normal.x>0?box.max.x:box.min.x,p1.y=plane.normal.y>0?box.min.y:box.max.y,p2.y=plane.normal.y>0?box.max.y:box.min.y,p1.z=plane.normal.z>0?box.min.z:box.max.z,p2.z=plane.normal.z>0?box.max.z:box.min.z;let d1=plane.distanceToPoint(p1),d2=plane.distanceToPoint(p2);if(d1<0&&d2<0)return!1}return!0}containsPoint(point){let planes=this.planes;for(let i=0;i<6;i++)if(planes[i].distanceToPoint(point)<0)return!1;return!0}}class Line3{constructor(start=new Vector3,end=new Vector3){this.start=start,this.end=end}set(start,end){return this.start.copy(start),this.end.copy(end),this}clone(){return(new this.constructor).copy(this)}copy(line){return this.start.copy(line.start),this.end.copy(line.end),this}getCenter(target=new Vector3){return target.addVectors(this.start,this.end).multiplyScalar(.5)}delta(target=new Vector3){return target.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,target=new Vector3){return this.delta(target).multiplyScalar(t).add(this.start)}closestPointToPointParameter(point,clampToLine){let startP=this.V1||new Vector3,startEnd=this.V2||new Vector3;this.V1=startP,this.V2=startEnd,startP.subVectors(point,this.start),startEnd.subVectors(this.end,this.start);let startEnd2=startEnd.dot(startEnd),t=startEnd.dot(startP)/startEnd2;return clampToLine&&(t=Math.clamp(t,0,1)),t}closestPointToPoint(point,clampToLine,target=new Vector3){let t=this.closestPointToPointParameter(point,clampToLine);return this.delta(target).multiplyScalar(t).add(this.start)}applyMatrix4(matrix){return this.start.applyMatrix4(matrix),this.end.applyMatrix4(matrix),this}equals(line){return line.start.equals(this.start)&&line.end.equals(this.end)}}class Matrix3{constructor(){this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}set(n11,n12,n13,n21,n22,n23,n31,n32,n33){let te=this.elements;return te[0]=n11,te[1]=n21,te[2]=n31,te[3]=n12,te[4]=n22,te[5]=n32,te[6]=n13,te[7]=n23,te[8]=n33,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}clone(){return(new Matrix3).fromArray(this.elements)}copy(m){let te=this.elements,me=m.elements;return te[0]=me[0],te[1]=me[1],te[2]=me[2],te[3]=me[3],te[4]=me[4],te[5]=me[5],te[6]=me[6],te[7]=me[7],te[8]=me[8],this}setFromMatrix4(m){let me=m.elements;return this.set(me[0],me[4],me[8],me[1],me[5],me[9],me[2],me[6],me[10]),this}multiply(m){return this.multiplyMatrices(this,m)}premultiply(m){return this.multiplyMatrices(m,this)}multiplyMatrices(a,b){let ae=a.elements,be=b.elements,te=this.elements,a11=ae[0],a12=ae[3],a13=ae[6],a21=ae[1],a22=ae[4],a23=ae[7],a31=ae[2],a32=ae[5],a33=ae[8],b11=be[0],b12=be[3],b13=be[6],b21=be[1],b22=be[4],b23=be[7],b31=be[2],b32=be[5],b33=be[8];return te[0]=a11*b11+a12*b21+a13*b31,te[3]=a11*b12+a12*b22+a13*b32,te[6]=a11*b13+a12*b23+a13*b33,te[1]=a21*b11+a22*b21+a23*b31,te[4]=a21*b12+a22*b22+a23*b32,te[7]=a21*b13+a22*b23+a23*b33,te[2]=a31*b11+a32*b21+a33*b31,te[5]=a31*b12+a32*b22+a33*b32,te[8]=a31*b13+a32*b23+a33*b33,this}multiplyScalar(s){let te=this.elements;return te[0]*=s,te[3]*=s,te[6]*=s,te[1]*=s,te[4]*=s,te[7]*=s,te[2]*=s,te[5]*=s,te[8]*=s,this}determinant(){let te=this.elements,a=te[0],b=te[1],c=te[2],d=te[3],e=te[4],f=te[5],g=te[6],h=te[7],i=te[8];return a*e*i-a*f*h-b*d*i+b*f*g+c*d*h-c*e*g}getInverse(matrix,throwOnDegenerate){let me=matrix.elements,te=this.elements,n11=me[0],n21=me[1],n31=me[2],n12=me[3],n22=me[4],n32=me[5],n13=me[6],n23=me[7],n33=me[8],t11=n33*n22-n32*n23,t12=n32*n13-n33*n12,t13=n23*n12-n22*n13,det=n11*t11+n21*t12+n31*t13;if(0===det){let msg=".getInverse() can't invert matrix, determinant is 0";if(!0===throwOnDegenerate)throw new Error(msg);return this.identity()}let detInv=1/det;return te[0]=t11*detInv,te[1]=(n31*n23-n33*n21)*detInv,te[2]=(n32*n21-n31*n22)*detInv,te[3]=t12*detInv,te[4]=(n33*n11-n31*n13)*detInv,te[5]=(n31*n12-n32*n11)*detInv,te[6]=t13*detInv,te[7]=(n21*n13-n23*n11)*detInv,te[8]=(n22*n11-n21*n12)*detInv,this}transpose(){let tmp,m=this.elements;return tmp=m[1],m[1]=m[3],m[3]=tmp,tmp=m[2],m[2]=m[6],m[6]=tmp,tmp=m[5],m[5]=m[7],m[7]=tmp,this}getNormalMatrix(matrix4){return this.setFromMatrix4(matrix4).getInverse(this).transpose()}setUvTransform(tx,ty,sx,sy,rotation,cx,cy){let c=Math.cos(rotation),s=Math.sin(rotation);this.set(sx*c,sx*s,-sx*(c*cx+s*cy)+cx+tx,-sy*s,sy*c,-sy*(-s*cx+c*cy)+cy+ty,0,0,1)}scale(sx,sy){let te=this.elements;return te[0]*=sx,te[3]*=sx,te[6]*=sx,te[1]*=sy,te[4]*=sy,te[7]*=sy,this}rotate(theta){let c=Math.cos(theta),s=Math.sin(theta),te=this.elements,a11=te[0],a12=te[3],a13=te[6],a21=te[1],a22=te[4],a23=te[7];return te[0]=c*a11+s*a21,te[3]=c*a12+s*a22,te[6]=c*a13+s*a23,te[1]=-s*a11+c*a21,te[4]=-s*a12+c*a22,te[7]=-s*a13+c*a23,this}translate(tx,ty){let te=this.elements;return te[0]+=tx*te[2],te[3]+=tx*te[5],te[6]+=tx*te[8],te[1]+=ty*te[2],te[4]+=ty*te[5],te[7]+=ty*te[8],this}equals(matrix){let te=this.elements,me=matrix.elements;for(let i=0;i<9;i++)if(te[i]!==me[i])return!1;return!0}fromArray(array,offset){void 0===offset&&(offset=0);for(let i=0;i<9;i++)this.elements[i]=array[i+offset];return this}toArray(array,offset){void 0===array&&(array=[]),void 0===offset&&(offset=0);let te=this.elements;return array[offset]=te[0],array[offset+1]=te[1],array[offset+2]=te[2],array[offset+3]=te[3],array[offset+4]=te[4],array[offset+5]=te[5],array[offset+6]=te[6],array[offset+7]=te[7],array[offset+8]=te[8],array}applyToBufferAttribute(attribute){let v1=this.V1||new Vector3;this.V1=v1;for(let i=0,l=attribute.count;i<l;i++)v1.x=attribute.array[3*i+0],v1.y=attribute.array[3*i+1],v1.z=attribute.array[3*i+2],v1.applyMatrix3(this),attribute.array[3*i+0]=v1.x,attribute.array[3*i+1]=v1.y,attribute.array[3*i+2]=v1.z;return attribute}}class Matrix4{constructor(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}set(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){let te=this.elements;return te[0]=n11,te[4]=n12,te[8]=n13,te[12]=n14,te[1]=n21,te[5]=n22,te[9]=n23,te[13]=n24,te[2]=n31,te[6]=n32,te[10]=n33,te[14]=n34,te[3]=n41,te[7]=n42,te[11]=n43,te[15]=n44,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Matrix4).fromArray(this.elements)}copy(m){let te=this.elements,me=m.elements;return te[0]=me[0],te[1]=me[1],te[2]=me[2],te[3]=me[3],te[4]=me[4],te[5]=me[5],te[6]=me[6],te[7]=me[7],te[8]=me[8],te[9]=me[9],te[10]=me[10],te[11]=me[11],te[12]=me[12],te[13]=me[13],te[14]=me[14],te[15]=me[15],this}copyPosition(m){let te=this.elements,me=m.elements;return te[12]=me[12],te[13]=me[13],te[14]=me[14],this}extractBasis(xAxis,yAxis,zAxis){return xAxis.setFromMatrixColumn(this,0),yAxis.setFromMatrixColumn(this,1),zAxis.setFromMatrixColumn(this,2),this}makeBasis(xAxis,yAxis,zAxis){return this.set(xAxis.x,yAxis.x,zAxis.x,0,xAxis.y,yAxis.y,zAxis.y,0,xAxis.z,yAxis.z,zAxis.z,0,0,0,0,1),this}extractRotation(m){let v1=this.V1||new Vector3;this.V1=v1;let te=this.elements,me=m.elements,scaleX=1/v1.setFromMatrixColumn(m,0).length(),scaleY=1/v1.setFromMatrixColumn(m,1).length(),scaleZ=1/v1.setFromMatrixColumn(m,2).length();return te[0]=me[0]*scaleX,te[1]=me[1]*scaleX,te[2]=me[2]*scaleX,te[4]=me[4]*scaleY,te[5]=me[5]*scaleY,te[6]=me[6]*scaleY,te[8]=me[8]*scaleZ,te[9]=me[9]*scaleZ,te[10]=me[10]*scaleZ,this}makeRotationFromEuler(euler){let te=this.elements,x=euler.x,y=euler.y,z=euler.z,a=Math.cos(x),b=Math.sin(x),c=Math.cos(y),d=Math.sin(y),e=Math.cos(z),f=Math.sin(z);if("XYZ"===euler.order){let ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e,te[4]=-c*f,te[8]=d,te[1]=af+be*d,te[5]=ae-bf*d,te[9]=-b*c,te[2]=bf-ae*d,te[6]=be+af*d,te[10]=a*c}else if("YXZ"===euler.order){let ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce+df*b,te[4]=de*b-cf,te[8]=a*d,te[1]=a*f,te[5]=a*e,te[9]=-b,te[2]=cf*b-de,te[6]=df+ce*b,te[10]=a*c}else if("ZXY"===euler.order){let ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce-df*b,te[4]=-a*f,te[8]=de+cf*b,te[1]=cf+de*b,te[5]=a*e,te[9]=df-ce*b,te[2]=-a*d,te[6]=b,te[10]=a*c}else if("ZYX"===euler.order){let ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e,te[4]=be*d-af,te[8]=ae*d+bf,te[1]=c*f,te[5]=bf*d+ae,te[9]=af*d-be,te[2]=-d,te[6]=b*c,te[10]=a*c}else if("YZX"===euler.order){let ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e,te[4]=bd-ac*f,te[8]=bc*f+ad,te[1]=f,te[5]=a*e,te[9]=-b*e,te[2]=-d*e,te[6]=ad*f+bc,te[10]=ac-bd*f}else if("XZY"===euler.order){let ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e,te[4]=-f,te[8]=d*e,te[1]=ac*f+bd,te[5]=a*e,te[9]=ad*f-bc,te[2]=bc*f-ad,te[6]=b*e,te[10]=bd*f+ac}return te[3]=0,te[7]=0,te[11]=0,te[12]=0,te[13]=0,te[14]=0,te[15]=1,this}makeRotationFromQuaternion(q){let te=this.elements,x=q._x,y=q._y,z=q._z,w=q._w,x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;return te[0]=1-(yy+zz),te[4]=xy-wz,te[8]=xz+wy,te[1]=xy+wz,te[5]=1-(xx+zz),te[9]=yz-wx,te[2]=xz-wy,te[6]=yz+wx,te[10]=1-(xx+yy),te[3]=0,te[7]=0,te[11]=0,te[12]=0,te[13]=0,te[14]=0,te[15]=1,this}lookAt(eye,target,up){let x=this.V1||new Vector3,y=this.V2||new Vector3,z=this.V3||new Vector3;this.V1=x,this.V2=y,this.V3=z;let te=this.elements;return z.subVectors(eye,target),0===z.lengthSq()&&(z.z=1),z.normalize(),x.crossVectors(up,z),0===x.lengthSq()&&(1===Math.abs(up.z)?z.x+=1e-4:z.z+=1e-4,z.normalize(),x.crossVectors(up,z)),x.normalize(),y.crossVectors(z,x),te[0]=x.x,te[4]=y.x,te[8]=z.x,te[1]=x.y,te[5]=y.y,te[9]=z.y,te[2]=x.z,te[6]=y.z,te[10]=z.z,this}multiply(m){return this.multiplyMatrices(this,m)}premultiply(m){return this.multiplyMatrices(m,this)}multiplyMatrices(ae,be){let a=ae.elements,b=be.elements,out=this.elements,a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b0=b[0],b1=b[1],b2=b[2],b3=b[3];return out[0]=b0*a00+b1*a10+b2*a20+b3*a30,out[1]=b0*a01+b1*a11+b2*a21+b3*a31,out[2]=b0*a02+b1*a12+b2*a22+b3*a32,out[3]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[4],b1=b[5],b2=b[6],b3=b[7],out[4]=b0*a00+b1*a10+b2*a20+b3*a30,out[5]=b0*a01+b1*a11+b2*a21+b3*a31,out[6]=b0*a02+b1*a12+b2*a22+b3*a32,out[7]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[8],b1=b[9],b2=b[10],b3=b[11],out[8]=b0*a00+b1*a10+b2*a20+b3*a30,out[9]=b0*a01+b1*a11+b2*a21+b3*a31,out[10]=b0*a02+b1*a12+b2*a22+b3*a32,out[11]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[12],b1=b[13],b2=b[14],b3=b[15],out[12]=b0*a00+b1*a10+b2*a20+b3*a30,out[13]=b0*a01+b1*a11+b2*a21+b3*a31,out[14]=b0*a02+b1*a12+b2*a22+b3*a32,out[15]=b0*a03+b1*a13+b2*a23+b3*a33,this}multiplyScalar(s){let te=this.elements;return te[0]*=s,te[4]*=s,te[8]*=s,te[12]*=s,te[1]*=s,te[5]*=s,te[9]*=s,te[13]*=s,te[2]*=s,te[6]*=s,te[10]*=s,te[14]*=s,te[3]*=s,te[7]*=s,te[11]*=s,te[15]*=s,this}determinant(){let te=this.elements,n11=te[0],n12=te[4],n13=te[8],n14=te[12],n21=te[1],n22=te[5],n23=te[9],n24=te[13],n31=te[2],n32=te[6],n33=te[10],n34=te[14];return te[3]*(+n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34)+te[7]*(+n11*n23*n34-n11*n24*n33+n14*n21*n33-n13*n21*n34+n13*n24*n31-n14*n23*n31)+te[11]*(+n11*n24*n32-n11*n22*n34-n14*n21*n32+n12*n21*n34+n14*n22*n31-n12*n24*n31)+te[15]*(-n13*n22*n31-n11*n23*n32+n11*n22*n33+n13*n21*n32-n12*n21*n33+n12*n23*n31)}transpose(){let tmp,te=this.elements;return tmp=te[1],te[1]=te[4],te[4]=tmp,tmp=te[2],te[2]=te[8],te[8]=tmp,tmp=te[6],te[6]=te[9],te[9]=tmp,tmp=te[3],te[3]=te[12],te[12]=tmp,tmp=te[7],te[7]=te[13],te[13]=tmp,tmp=te[11],te[11]=te[14],te[14]=tmp,this}setPosition(v){let te=this.elements;return te[12]=v.x,te[13]=v.y,te[14]=v.z,this}getInverse(m,throwOnDegenerate){let te=this.elements,me=m.elements,n11=me[0],n21=me[1],n31=me[2],n41=me[3],n12=me[4],n22=me[5],n32=me[6],n42=me[7],n13=me[8],n23=me[9],n33=me[10],n43=me[11],n14=me[12],n24=me[13],n34=me[14],n44=me[15],t11=n23*n34*n42-n24*n33*n42+n24*n32*n43-n22*n34*n43-n23*n32*n44+n22*n33*n44,t12=n14*n33*n42-n13*n34*n42-n14*n32*n43+n12*n34*n43+n13*n32*n44-n12*n33*n44,t13=n13*n24*n42-n14*n23*n42+n14*n22*n43-n12*n24*n43-n13*n22*n44+n12*n23*n44,t14=n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34,det=n11*t11+n21*t12+n31*t13+n41*t14;if(0===det){let msg=".getInverse() can't invert matrix, determinant is 0";if(!0===throwOnDegenerate)throw new Error(msg);return this.identity()}let detInv=1/det;return te[0]=t11*detInv,te[1]=(n24*n33*n41-n23*n34*n41-n24*n31*n43+n21*n34*n43+n23*n31*n44-n21*n33*n44)*detInv,te[2]=(n22*n34*n41-n24*n32*n41+n24*n31*n42-n21*n34*n42-n22*n31*n44+n21*n32*n44)*detInv,te[3]=(n23*n32*n41-n22*n33*n41-n23*n31*n42+n21*n33*n42+n22*n31*n43-n21*n32*n43)*detInv,te[4]=t12*detInv,te[5]=(n13*n34*n41-n14*n33*n41+n14*n31*n43-n11*n34*n43-n13*n31*n44+n11*n33*n44)*detInv,te[6]=(n14*n32*n41-n12*n34*n41-n14*n31*n42+n11*n34*n42+n12*n31*n44-n11*n32*n44)*detInv,te[7]=(n12*n33*n41-n13*n32*n41+n13*n31*n42-n11*n33*n42-n12*n31*n43+n11*n32*n43)*detInv,te[8]=t13*detInv,te[9]=(n14*n23*n41-n13*n24*n41-n14*n21*n43+n11*n24*n43+n13*n21*n44-n11*n23*n44)*detInv,te[10]=(n12*n24*n41-n14*n22*n41+n14*n21*n42-n11*n24*n42-n12*n21*n44+n11*n22*n44)*detInv,te[11]=(n13*n22*n41-n12*n23*n41-n13*n21*n42+n11*n23*n42+n12*n21*n43-n11*n22*n43)*detInv,te[12]=t14*detInv,te[13]=(n13*n24*n31-n14*n23*n31+n14*n21*n33-n11*n24*n33-n13*n21*n34+n11*n23*n34)*detInv,te[14]=(n14*n22*n31-n12*n24*n31-n14*n21*n32+n11*n24*n32+n12*n21*n34-n11*n22*n34)*detInv,te[15]=(n12*n23*n31-n13*n22*n31+n13*n21*n32-n11*n23*n32-n12*n21*n33+n11*n22*n33)*detInv,this}scale(v){let te=this.elements,x=v.x,y=v.y,z=v.z;return te[0]*=x,te[4]*=y,te[8]*=z,te[1]*=x,te[5]*=y,te[9]*=z,te[2]*=x,te[6]*=y,te[10]*=z,te[3]*=x,te[7]*=y,te[11]*=z,this}getMaxScaleOnAxis(){let te=this.elements,scaleXSq=te[0]*te[0]+te[1]*te[1]+te[2]*te[2],scaleYSq=te[4]*te[4]+te[5]*te[5]+te[6]*te[6],scaleZSq=te[8]*te[8]+te[9]*te[9]+te[10]*te[10];return Math.sqrt(Math.max(scaleXSq,scaleYSq,scaleZSq))}makeTranslation(x,y,z){return this.set(1,0,0,x,0,1,0,y,0,0,1,z,0,0,0,1),this}makeRotationX(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(1,0,0,0,0,c,-s,0,0,s,c,0,0,0,0,1),this}makeRotationY(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1),this}makeRotationZ(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(c,-s,0,0,s,c,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(axis,angle){let c=Math.cos(angle),s=Math.sin(angle),t=1-c,x=axis.x,y=axis.y,z=axis.z,tx=t*x,ty=t*y;return this.set(tx*x+c,tx*y-s*z,tx*z+s*y,0,tx*y+s*z,ty*y+c,ty*z-s*x,0,tx*z-s*y,ty*z+s*x,t*z*z+c,0,0,0,0,1),this}makeScale(x,y,z){return this.set(x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1),this}makeShear(x,y,z){return this.set(1,y,z,0,x,1,z,0,x,y,1,0,0,0,0,1),this}compose(position,quaternion,scale){return this.makeRotationFromQuaternion(quaternion),this.scale(scale),this.setPosition(position),this}decompose(position,quaternion,scale){let vector=this.V1||new Vector3;this.V1=vector;let matrix=this.M1||new Matrix4;this.M1=matrix;let te=this.elements,sx=vector.set(te[0],te[1],te[2]).length(),sy=vector.set(te[4],te[5],te[6]).length(),sz=vector.set(te[8],te[9],te[10]).length();this.determinant()<0&&(sx=-sx),position.x=te[12],position.y=te[13],position.z=te[14],matrix.copy(this);let invSX=1/sx,invSY=1/sy,invSZ=1/sz;return matrix.elements[0]*=invSX,matrix.elements[1]*=invSX,matrix.elements[2]*=invSX,matrix.elements[4]*=invSY,matrix.elements[5]*=invSY,matrix.elements[6]*=invSY,matrix.elements[8]*=invSZ,matrix.elements[9]*=invSZ,matrix.elements[10]*=invSZ,quaternion.setFromRotationMatrix(matrix),scale.x=sx,scale.y=sy,scale.z=sz,this}makePerspective(left,right,top,bottom,near,far){let te=this.elements,x=2*near/(right-left),y=2*near/(top-bottom),a=(right+left)/(right-left),b=(top+bottom)/(top-bottom),c=-(far+near)/(far-near),d=-2*far*near/(far-near);return te[0]=x,te[4]=0,te[8]=a,te[12]=0,te[1]=0,te[5]=y,te[9]=b,te[13]=0,te[2]=0,te[6]=0,te[10]=c,te[14]=d,te[3]=0,te[7]=0,te[11]=-1,te[15]=0,this}makeOrthographic(left,right,top,bottom,near,far){let te=this.elements,w=1/(right-left),h=1/(top-bottom),p=1/(far-near),x=(right+left)*w,y=(top+bottom)*h,z=(far+near)*p;return te[0]=2*w,te[4]=0,te[8]=0,te[12]=-x,te[1]=0,te[5]=2*h,te[9]=0,te[13]=-y,te[2]=0,te[6]=0,te[10]=-2*p,te[14]=-z,te[3]=0,te[7]=0,te[11]=0,te[15]=1,this}equals(matrix){let te=this.elements,me=matrix.elements;return te[0]==me[0]&&(te[1]==me[1]&&(te[2]==me[2]&&(te[3]==me[3]&&(te[4]==me[4]&&(te[5]==me[5]&&(te[6]==me[6]&&(te[7]==me[7]&&(te[8]==me[8]&&(te[9]==me[9]&&(te[10]==me[10]&&(te[11]==me[11]&&(te[12]==me[12]&&(te[13]==me[13]&&(te[14]==me[14]&&te[15]==me[15]))))))))))))))}fromArray(array,offset=0){let te=this.elements;return te[0]=array[0+offset],te[1]=array[1+offset],te[2]=array[2+offset],te[3]=array[3+offset],te[4]=array[4+offset],te[5]=array[5+offset],te[6]=array[6+offset],te[7]=array[7+offset],te[8]=array[8+offset],te[9]=array[9+offset],te[10]=array[10+offset],te[11]=array[11+offset],te[12]=array[12+offset],te[13]=array[13+offset],te[14]=array[14+offset],te[15]=array[15+offset],this}toArray(array,offset){void 0===array&&(array=[]),void 0===offset&&(offset=0);let te=this.elements;return array[offset]=te[0],array[offset+1]=te[1],array[offset+2]=te[2],array[offset+3]=te[3],array[offset+4]=te[4],array[offset+5]=te[5],array[offset+6]=te[6],array[offset+7]=te[7],array[offset+8]=te[8],array[offset+9]=te[9],array[offset+10]=te[10],array[offset+11]=te[11],array[offset+12]=te[12],array[offset+13]=te[13],array[offset+14]=te[14],array[offset+15]=te[15],array}applyToBufferAttribute(attribute){let v1=this.V1||new Vector3;this.V1=v1;for(let i=0,l=attribute.count;i<l;i++)v1.x=attribute.array[3*i+0],v1.y=attribute.array[3*i+1],v1.z=attribute.array[3*i+2],v1.applyMatrix4(this),attribute.array[3*i+0]=v1.x,attribute.array[3*i+1]=v1.y,attribute.array[3*i+2]=v1.z;return attribute}isIdentity(){let te=this.elements;return 0==te[0]&&(0==te[1]&&(0==te[2]&&(1==te[3]&&(0==te[4]&&(0==te[5]&&(0==te[6]&&(1==te[7]&&(0==te[8]&&(0==te[9]&&(0==te[10]&&(1==te[11]&&(0==te[12]&&(0==te[13]&&(0==te[14]&&1==te[15]))))))))))))))}}Matrix4.__IDENTITY__=new Matrix4;class Plane{constructor(normal,constant){this.normal=void 0!==normal?normal:new Vector3(1,0,0),this.constant=void 0!==constant?constant:0}set(normal,constant){return this.normal.copy(normal),this.constant=constant,this}setComponents(x,y,z,w){return this.normal.set(x,y,z),this.constant=w,this}setFromNormalAndCoplanarPoint(normal,point){return this.normal.copy(normal),this.constant=-point.dot(this.normal),this}setFromCoplanarPoints(a,b,c){let v1=this.V1||new Vector3,v2=this.V2||new Vector3;this.V1=v1,this.V2=v2;var normal=v1.subVectors(c,b).cross(v2.subVectors(a,b)).normalize();return this.setFromNormalAndCoplanarPoint(normal,a),this}clone(){return(new Plane).copy(this)}copy(plane){return this.normal.copy(plane.normal),this.constant=plane.constant,this}normalize(){var inverseNormalLength=1/this.normal.length();return this.normal.multiplyScalar(inverseNormalLength),this.constant*=inverseNormalLength,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(point){return this.normal.dot(point)+this.constant}distanceToSphere(sphere){return this.distanceToPoint(sphere.center)-sphere.radius}projectPoint(point,target){return target.copy(this.normal).multiplyScalar(-this.distanceToPoint(point)).add(point)}intersectLine(line,target){let v1=this.V1||new Vector3;this.V1=v1;var direction=line.delta(v1),denominator=this.normal.dot(direction);if(0===denominator)return 0===this.distanceToPoint(line.start)?target.copy(line.start):void 0;var t=-(line.start.dot(this.normal)+this.constant)/denominator;return t<0||t>1?void 0:target.copy(direction).multiplyScalar(t).add(line.start)}intersectsLine(line){var startSign=this.distanceToPoint(line.start),endSign=this.distanceToPoint(line.end);return startSign<0&&endSign>0||endSign<0&&startSign>0}intersectsBox(box){return box.intersectsPlane(this)}intersectsSphere(sphere){return sphere.intersectsPlane(this)}coplanarPoint(target){return target.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(matrix,optionalNormalMatrix){let v1=this.V1||new Vector3;this.V1=v1;let m1=this.M1||new Matrix3;this.M1=m1;var normalMatrix=optionalNormalMatrix||m1.getNormalMatrix(matrix),referencePoint=this.coplanarPoint(v1).applyMatrix4(matrix),normal=this.normal.applyMatrix3(normalMatrix).normalize();return this.constant=-referencePoint.dot(normal),this}translate(offset){return this.constant-=offset.dot(this.normal),this}equals(plane){return plane.normal.equals(this.normal)&&plane.constant===this.constant}}class Quaternion{constructor(x,y,z,w){this._x=x||0,this._y=y||0,this._z=z||0,this._w=void 0!==w?w:1,this.isQuaternion=!0}set x(v){this._x=v,this.onChangeCallback&&this.onChangeCallback()}get x(){return this._x}set y(v){this._y=v,this.onChangeCallback&&this.onChangeCallback()}get y(){return this._y}set z(v){this._z=v,this.onChangeCallback&&this.onChangeCallback()}get z(){return this._z}set w(v){this._w=v,this.onChangeCallback&&this.onChangeCallback()}get w(){return this._w}clone(){return new Quaternion(this._x,this._y,this._z,this._w)}copy(quaternion){return this._x=quaternion.x,this._y=quaternion.y,this._z=quaternion.z,this._w=quaternion.w,this.onChangeCallback(),this}set(x,y,z,w){this._x=x,this._y=y,this._z=z,this._w=w,this.onChangeCallback()}setFromEuler(euler,update){let x=euler._x,y=euler._y,z=euler._z,order=euler.order,cos=Math.cos,sin=Math.sin,c1=cos(x/2),c2=cos(y/2),c3=cos(z/2),s1=sin(x/2),s2=sin(y/2),s3=sin(z/2);return"XYZ"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"YXZ"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3):"ZXY"===order?(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"ZYX"===order?(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3):"YZX"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"XZY"===order&&(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3),!1!==update&&this.onChangeCallback(),this}setFromAxisAngle(axis,angle){let halfAngle=angle/2,s=Math.sin(halfAngle);return this._x=axis.x*s,this._y=axis.y*s,this._z=axis.z*s,this._w=Math.cos(halfAngle),this.onChangeCallback(),this}setFromRotationMatrix(m){let s,te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10],trace=m11+m22+m33;return trace>0?(s=.5/Math.sqrt(trace+1),this._w=.25/s,this._x=(m32-m23)*s,this._y=(m13-m31)*s,this._z=(m21-m12)*s):m11>m22&&m11>m33?(s=2*Math.sqrt(1+m11-m22-m33),this._w=(m32-m23)/s,this._x=.25*s,this._y=(m12+m21)/s,this._z=(m13+m31)/s):m22>m33?(s=2*Math.sqrt(1+m22-m11-m33),this._w=(m13-m31)/s,this._x=(m12+m21)/s,this._y=.25*s,this._z=(m23+m32)/s):(s=2*Math.sqrt(1+m33-m11-m22),this._w=(m21-m12)/s,this._x=(m13+m31)/s,this._y=(m23+m32)/s,this._z=.25*s),this.onChangeCallback(),this}setFromUnitVectors(vFrom,vTo){let v1=this.V1||new Vector3;this.V1=v1;let r=vFrom.dot(vTo)+1;return r<1e-6?(r=0,Math.abs(vFrom.x)>Math.abs(vFrom.z)?v1.set(-vFrom.y,vFrom.x,0):v1.set(0,-vFrom.z,vFrom.y)):v1.crossVectors(vFrom,vTo),this._x=v1.x,this._y=v1.y,this._z=v1.z,this._w=r,this.normalize()}inverse(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this}dot(v){const w=void 0===v._w?1:v._w;return this._x*v._x+this._y*v._y+this._z*v._z+this._w*w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let l=this.length();return 0===l?(this._x=0,this._y=0,this._z=0,this._w=1):(l=1/l,this._x=this._x*l,this._y=this._y*l,this._z=this._z*l,this._w=this._w*l),this.onChangeCallback(),this}multiply(q){return this.multiplyQuaternions(this,q)}premultiply(q){return this.multiplyQuaternions(q,this)}multiplyQuaternions(a,b){let qax=a._x,qay=a._y,qaz=a._z,qaw=a._w,qbx=b._x,qby=b._y,qbz=b._z,qbw=b._w;return this._x=qax*qbw+qaw*qbx+qay*qbz-qaz*qby,this._y=qay*qbw+qaw*qby+qaz*qbx-qax*qbz,this._z=qaz*qbw+qaw*qbz+qax*qby-qay*qbx,this._w=qaw*qbw-qax*qbx-qay*qby-qaz*qbz,this.onChangeCallback(),this}slerp(qb,t,hz=!0){if(0===(t=Math.clamp(t*(hz?Render.HZ_MULTIPLIER:1),0,1)))return this;if(1===t)return this.copy(qb);let x=this._x,y=this._y,z=this._z,w=this._w,cosHalfTheta=w*qb._w+x*qb._x+y*qb._y+z*qb._z;if(cosHalfTheta<0?(this._w=-qb._w,this._x=-qb._x,this._y=-qb._y,this._z=-qb._z,cosHalfTheta=-cosHalfTheta):this.copy(qb),cosHalfTheta>=1)return this._w=w,this._x=x,this._y=y,this._z=z,this;let sinHalfTheta=Math.sqrt(1-cosHalfTheta*cosHalfTheta);if(Math.abs(sinHalfTheta)<.001)return this._w=.5*(w+this._w),this._x=.5*(x+this._x),this._y=.5*(y+this._y),this._z=.5*(z+this._z),this;let halfTheta=Math.atan2(sinHalfTheta,cosHalfTheta),ratioA=Math.sin((1-t)*halfTheta)/sinHalfTheta,ratioB=Math.sin(t*halfTheta)/sinHalfTheta;return this._w=w*ratioA+this._w*ratioB,this._x=x*ratioA+this._x*ratioB,this._y=y*ratioA+this._y*ratioB,this._z=z*ratioA+this._z*ratioB,this.onChangeCallback(),this}equals(quaternion){return quaternion._x===this._x&&quaternion._y===this._y&&quaternion._z===this._z&&quaternion._w===this._w}fromArray(array,offset){return void 0===offset&&(offset=0),this._x=array[offset],this._y=array[offset+1],this._z=array[offset+2],this._w=array[offset+3],this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this._x,array[offset+1]=this._y,array[offset+2]=this._z,array[offset+3]=this._w,array}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}class RayManager{constructor(origin,direction,near=0,far=1/0){this.ray=new Ray(origin,direction),this.near=near,this.far=far,this.params={Mesh:{},Points:{threshold:1}}}set(origin,direction){return this.ray.set(origin,direction),this}setFromCamera(coords,camera){camera.isPerspective?(this.ray.origin.setFromMatrixPosition(camera.matrixWorld),this.ray.direction.set(coords.x,coords.y,.5).unproject(camera).sub(this.ray.origin).normalize()):(this.ray.origin.set(coords.x,coords.y,(camera.near+camera.far)/(camera.near-camera.far)).unproject(camera),this.ray.direction.set(0,0,-1).transformDirection(camera.matrixWorld))}_ascSort(a,b){return a.distance-b.distance}_intersectObject(object,raycaster,intersects,recursive){if(!1!==object.visible&&(object.raycast(raycaster,intersects),!0===recursive)){let children=object.children;for(let i=0,l=children.length;i<l;i++)this._intersectObject(children[i],raycaster,intersects,!0)}}intersectObject(object,recursive,optionalTarget){let intersects=optionalTarget||[];return this._intersectObject(object,this,intersects,recursive),intersects.sort(this._ascSort),intersects}intersectObjects(objects,recursive,optionalTarget){let intersects=optionalTarget||[];for(let i=0,l=objects.length;i<l;i++)this._intersectObject(objects[i],this,intersects,recursive);return intersects.sort(this._ascSort),intersects}}class Ray{constructor(origin=new Vector3,direction=new Vector3){this.origin=origin,this.direction=direction}set(origin,direction){return this.origin.copy(origin),this.direction.copy(direction),this}clone(){return(new Ray).copy(this)}copy(ray){return this.origin.copy(ray.origin),this.direction.copy(ray.direction),this}at(t,target=new Vector3){return target.copy(this.direction).multiplyScalar(t).add(this.origin)}lookAt(v){return this.direction.copy(v).sub(this.origin).normalize(),this}recast(t){let v1=this.V1||new Vector3;this.V1=v1,this.origin.copy(this.at(t,v1))}closestPointToPoint(point,target=new Vector3){target.subVectors(point,this.origin);let directionDistance=target.dot(this.direction);return directionDistance<0?target.copy(this.origin):target.copy(this.direction).multiplyScalar(directionDistance).add(this.origin)}distanceToPoint(point){return Math.sqrt(this.distanceSqToPoint(point))}distanceSqToPoint(point){let v1=this.V1||new Vector3;this.V1=v1;let directionDistance=v1.subVectors(point,this.origin).dot(this.direction);return directionDistance<0?this.origin.distanceToSquared(point):(v1.copy(this.direction).multiplyScalar(directionDistance).add(this.origin),v1.distanceToSquared(point))}distanceSqToSegment(v0,v1,optionalPointOnRay,optionalPointOnSegment){let segCenter=this.V1||new Vector3,segDir=this.V2||new Vector3,diff=this.V3||new Vector3;this.V1=segCenter,this.V2=segDir,this.V3=diff,segCenter.copy(v0).add(v1).multiplyScalar(.5),segDir.copy(v1).sub(v0).normalize(),diff.copy(this.origin).sub(segCenter);let s0,s1,sqrDist,extDet,segExtent=.5*v0.distanceTo(v1),a01=-this.direction.dot(segDir),b0=diff.dot(this.direction),b1=-diff.dot(segDir),c=diff.lengthSq(),det=Math.abs(1-a01*a01);if(det>0)if(s0=a01*b1-b0,s1=a01*b0-b1,extDet=segExtent*det,s0>=0)if(s1>=-extDet)if(s1<=extDet){let invDet=1/det;s0*=invDet,s1*=invDet,sqrDist=s0*(s0+a01*s1+2*b0)+s1*(a01*s0+s1+2*b1)+c}else s1=segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;else s1=-segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;else s1<=-extDet?(s0=Math.max(0,-(-a01*segExtent+b0)),s1=s0>0?-segExtent:Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=-s0*s0+s1*(s1+2*b1)+c):s1<=extDet?(s0=0,s1=Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=s1*(s1+2*b1)+c):(s0=Math.max(0,-(a01*segExtent+b0)),s1=s0>0?segExtent:Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=-s0*s0+s1*(s1+2*b1)+c);else s1=a01>0?-segExtent:segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;return optionalPointOnRay&&optionalPointOnRay.copy(this.direction).multiplyScalar(s0).add(this.origin),optionalPointOnSegment&&optionalPointOnSegment.copy(segDir).multiplyScalar(s1).add(segCenter),sqrDist}intersectSphere(sphere,target){let v1=this.V1||new Vector3;this.V1=v1,v1.subVectors(sphere.center,this.origin);let tca=v1.dot(this.direction),d2=v1.dot(v1)-tca*tca,radius2=sphere.radius*sphere.radius;if(d2>radius2)return null;let thc=Math.sqrt(radius2-d2),t0=tca-thc,t1=tca+thc;return t0<0&&t1<0?null:t0<0?this.at(t1,target):this.at(t0,target)}intersectsSphere(sphere){return this.distanceSqToPoint(sphere.center)<=sphere.radius*sphere.radius}distanceToPlane(plane){let denominator=plane.normal.dot(this.direction);if(0===denominator)return 0===plane.distanceToPoint(this.origin)?0:null;let t=-(this.origin.dot(plane.normal)+plane.constant)/denominator;return t>=0?t:null}intersectPlane(plane,target){let t=this.distanceToPlane(plane);return null===t?null:this.at(t,target)}intersectsPlane(plane){let distToPoint=plane.distanceToPoint(this.origin);return 0===distToPoint||plane.normal.dot(this.direction)*distToPoint<0}intersectBox(box,target){let tmin,tmax,tymin,tymax,tzmin,tzmax,invdirx=1/this.direction.x,invdiry=1/this.direction.y,invdirz=1/this.direction.z,origin=this.origin;return invdirx>=0?(tmin=(box.min.x-origin.x)*invdirx,tmax=(box.max.x-origin.x)*invdirx):(tmin=(box.max.x-origin.x)*invdirx,tmax=(box.min.x-origin.x)*invdirx),invdiry>=0?(tymin=(box.min.y-origin.y)*invdiry,tymax=(box.max.y-origin.y)*invdiry):(tymin=(box.max.y-origin.y)*invdiry,tymax=(box.min.y-origin.y)*invdiry),tmin>tymax||tymin>tmax?null:((tymin>tmin||tmin!=tmin)&&(tmin=tymin),(tymax<tmax||tmax!=tmax)&&(tmax=tymax),invdirz>=0?(tzmin=(box.min.z-origin.z)*invdirz,tzmax=(box.max.z-origin.z)*invdirz):(tzmin=(box.max.z-origin.z)*invdirz,tzmax=(box.min.z-origin.z)*invdirz),tmin>tzmax||tzmin>tmax?null:((tzmin>tmin||tmin!=tmin)&&(tmin=tzmin),(tzmax<tmax||tmax!=tmax)&&(tmax=tzmax),tmax<0?null:this.at(tmin>=0?tmin:tmax,target)))}intersectsBox(box){let v=this.V1||new Vector3;return this.V1=v,null!==this.intersectBox(box,v)}intersectsTriangle(a,b,c,backfaceCulling,target){let diff=this.V1||new Vector3,edge1=this.V2||new Vector3,edge2=this.V3||new Vector3,normal=this.V4||new Vector3;this.V1=diff,this.V2=edge1,this.V3=edge2,this.V4=normal,edge1.subVectors(b,a),edge2.subVectors(c,a),normal.crossVectors(edge1,edge2);let sign,DdN=this.direction.dot(normal);if(DdN>0){if(backfaceCulling)return null;sign=1}else{if(!(DdN<0))return null;sign=-1,DdN=-DdN}diff.subVectors(this.origin,a);let DdQxE2=sign*this.direction.dot(edge2.crossVectors(diff,edge2));if(DdQxE2<0)return null;let DdE1xQ=sign*this.direction.dot(edge1.cross(diff));if(DdE1xQ<0)return null;if(DdQxE2+DdE1xQ>DdN)return null;let QdN=-sign*diff.dot(normal);return QdN<0?null:this.at(QdN/DdN,target)}applyMatrix4(matrix4){return this.origin.applyMatrix4(matrix4),this.direction.transformDirection(matrix4),this}equals(ray){return ray.origin.equals(this.origin)&&ray.direction.equals(this.direction)}}class Sphere{constructor(center=new Vector3,radius=0){this.center=center,this.radius=radius}set(center,radius){return this.center.copy(center),this.radius=radius,this}setFromPoints(points,optionalCenter){let box=this.V1||new Box3;this.V1=box;let center=this.center;void 0!==optionalCenter?center.copy(optionalCenter):box.setFromPoints(points).getCenter(center);let maxRadiusSq=0;for(let i=0,il=points.length;i<il;i++)maxRadiusSq=Math.max(maxRadiusSq,center.distanceToSquared(points[i]));return this.radius=Math.sqrt(maxRadiusSq),this}clone(){return(new this.constructor).copy(this)}copy(sphere){return this.center.copy(sphere.center),this.radius=sphere.radius,this}empty(){return this.radius<=0}containsPoint(point){return point.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(point){return point.distanceTo(this.center)-this.radius}intersectsSphere(sphere){let radiusSum=this.radius+sphere.radius;return sphere.center.distanceToSquared(this.center)<=radiusSum*radiusSum}intersectsBox(box){return box.intersectsSphere(this)}intersectsPlane(plane){return Math.abs(plane.distanceToPoint(this.center))<=this.radius}clampPoint(point,target=new Vector3){let deltaLengthSq=this.center.distanceToSquared(point);return target.copy(point),deltaLengthSq>this.radius*this.radius&&(target.sub(this.center).normalize(),target.multiplyScalar(this.radius).add(this.center)),target}getBoundingBox(target=new Box3){return target.set(this.center,this.center),target.expandByScalar(this.radius),target}applyMatrix4(matrix){return this.center.applyMatrix4(matrix),this.radius=this.radius*matrix.getMaxScaleOnAxis(),this}translate(offset){return this.center.add(offset),this}equals(sphere){return sphere.center.equals(this.center)&&sphere.radius===this.radius}}class Spherical{constructor(radius=1,phi=0,theta=0){this.radius=radius,this.phi=phi,this.theta=theta}set(radius,phi,theta){return this.radius=radius,this.phi=phi,this.theta=theta,this}clone(){return(new Spherical).copy(this)}copy(other){return this.radius=other.radius,this.phi=other.phi,this.theta=other.theta,this}makeSafe(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this}setFromVector3(vec3){return this.radius=vec3.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(vec3.x,vec3.z),this.phi=Math.acos(Math.clamp(vec3.y/this.radius,-1,1))),this}}class Triangle{constructor(a=new Vector3,b=new Vector3,c=new Vector3){this.a=a,this.b=b,this.c=c}set(a,b,c){return this.a.copy(a),this.b.copy(b),this.c.copy(c),this}setFromPointsAndIndices(points,i0,i1,i2){return this.a.copy(points[i0]),this.b.copy(points[i1]),this.c.copy(points[i2]),this}clone(){return(new Triangle).copy(this)}copy(triangle){return this.a.copy(triangle.a),this.b.copy(triangle.b),this.c.copy(triangle.c),this}getArea(){let v0=this.V0||new Vector3,v1=this.V1||new Vector3;return this.V0=v0,this.V1=v1,v0.subVectors(this.c,this.b),v1.subVectors(this.a,this.b),.5*v0.cross(v1).length()}getMidpoint(target=new Vector3){return target.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(target){return Triangle.getNormal(this.a,this.b,this.c,target)}getPlane(target=new Vector3){return target.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(point,target){return Triangle.getBarycoord(point,this.a,this.b,this.c,target)}containsPoint(point){return Triangle.containsPoint(point,this.a,this.b,this.c)}intersectsBox(box){return box.intersectsTriangle(this)}equals(triangle){return triangle.a.equals(this.a)&&triangle.b.equals(this.b)&&triangle.c.equals(this.c)}}class Vector2{constructor(x=0,y=0){this.x=x,this.y=y}set(x,y){return this.x=x,this.y=y,this}get width(){return this.x}get height(){return this.y}setScalar(s){return this.x=this.y=s,this}clone(){return new Vector2(this.x,this.y)}copy(v){return this.x=v.x,this.y=v.y,this}add(v){return this.x+=v.x,this.y+=v.y,this}addScalar(s){return this.x+=s,this.y+=s,this}addVectors(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this}addScaledVector(v,s){return this.x+=v.x*s,this.y+=v.y*s,this}sub(v){return this.x-=v.x,this.y-=v.y,this}subScalar(s){return this.x-=s,this.y-=s,this}subVectors(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this}multiply(v){return this.x*=v.x,this.y*=v.y,this}multiplyScalar(scalar){return this.x*=scalar,this.y*=scalar,this}divide(v){return this.x/=v.x,this.y/=v.y,this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}applyMatrix3(m){let x=this.x,y=this.y,e=m.elements;return this.x=e[0]*x+e[3]*y+e[6],this.y=e[1]*x+e[4]*y+e[7],this}min(v){return this.x=Math.min(this.x,v.x),this.y=Math.min(this.y,v.y),this}max(v){return this.x=Math.max(this.x,v.x),this.y=Math.max(this.y,v.y),this}clamp(min,max){return this.x=Math.max(min.x,Math.min(max.x,this.x)),this.y=Math.max(min.y,Math.min(max.y,this.y)),this}clampScalar(minVal,maxVal){let min=new Vector2,max=new Vector2;return min.set(minVal,minVal),max.set(maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(v){return this.x*v.x+this.y*v.y}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){let angle=Math.atan2(this.y,this.x);return angle<0&&(angle+=2*Math.PI),angle}angleTo(a,b){return b||(b=this),Math.atan2(a.y-b.y,a.x-b.x)}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this.x-v.x,dy=this.y-v.y;return dx*dx+dy*dy}manhattanDistanceTo(v){return Math.abs(this.x-v.x)+Math.abs(this.y-v.y)}setLength(length){return this.normalize().multiplyScalar(length)}lerp(v,alpha,hz){return this.x=Math.lerp(v.x,this.x,alpha,hz),this.y=Math.lerp(v.y,this.y,alpha,hz),this}lerpVectors(v1,v2,alpha){return this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}equals(v){return v.x===this.x&&v.y===this.y}setAngleRadius(a,r){return this.x=Math.cos(a)*r,this.y=Math.sin(a)*r,this}addAngleRadius(a,r){return this.x+=Math.cos(a)*r,this.y+=Math.sin(a)*r,this}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=array[offset],this.y=array[offset+1],this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array}rotateAround(center,angle){let c=Math.cos(angle),s=Math.sin(angle),x=this.x-center.x,y=this.y-center.y;return this.x=x*c-y*s+center.x,this.y=x*s+y*c+center.y,this}fromBufferAttribute(attribute,index){this.x=attribute.array[2*index+0],this.y=attribute.array[2*index+1]}}class Vector3{constructor(x,y,z){this.x=x||0,this.y=y||0,this.z=z||0}set(x,y,z){return this.x=x||0,this.y=y||0,this.z=z||0,this}setScalar(scalar){return this.x=scalar,this.y=scalar,this.z=scalar,this}clone(){return new Vector3(this.x,this.y,this.z)}copy(v){return this.x=v.x,this.y=v.y,this.z=v.z,this}add(v){return this.x+=v.x,this.y+=v.y,this.z+=v.z,this}addScalar(s){return this.x+=s,this.y+=s,this.z+=s,this}addVectors(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this}addScaledVector(v,s){return this.x+=v.x*s,this.y+=v.y*s,this.z+=v.z*s,this}sub(v){return this.x-=v.x,this.y-=v.y,this.z-=v.z,this}subScalar(s){return this.x-=s,this.y-=s,this.z-=s,this}subVectors(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this}multiply(v){return this.x*=v.x,this.y*=v.y,this.z*=v.z,this}multiplyScalar(scalar){return this.x*=scalar,this.y*=scalar,this.z*=scalar,this}multiplyVectors(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this}applyEuler(euler){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromEuler(euler))}applyAxisAngle(axis,angle){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromAxisAngle(axis,angle))}applyMatrix3(m){let x=this.x,y=this.y,z=this.z,e=m.elements;return this.x=e[0]*x+e[3]*y+e[6]*z,this.y=e[1]*x+e[4]*y+e[7]*z,this.z=e[2]*x+e[5]*y+e[8]*z,this}applyMatrix4(m){let x=this.x,y=this.y,z=this.z,e=m.elements,w=1/(e[3]*x+e[7]*y+e[11]*z+e[15]);return this.x=(e[0]*x+e[4]*y+e[8]*z+e[12])*w,this.y=(e[1]*x+e[5]*y+e[9]*z+e[13])*w,this.z=(e[2]*x+e[6]*y+e[10]*z+e[14])*w,this}applyQuaternion(q){let x=this.x,y=this.y,z=this.z,qx=q.x,qy=q.y,qz=q.z,qw=q.w;if(0==qx&&0==qy&&0==qz&&1==qw)return this;let ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return this.x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this.y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this.z=iz*qw+iw*-qz+ix*-qy-iy*-qx,this}project(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,matrix.getInverse(camera.matrixWorld)),this.applyMatrix4(matrix)}unproject(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.matrixWorld,matrix.getInverse(camera.projectionMatrix)),this.applyMatrix4(matrix)}transformDirection(m){let x=this.x,y=this.y,z=this.z,e=m.elements;return this.x=e[0]*x+e[4]*y+e[8]*z,this.y=e[1]*x+e[5]*y+e[9]*z,this.z=e[2]*x+e[6]*y+e[10]*z,this.normalize()}divide(v){return this.x/=v.x,this.y/=v.y,this.z/=v.z,this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}min(v){return this.x=Math.min(this.x,v.x),this.y=Math.min(this.y,v.y),this.z=Math.min(this.z,v.z),this}max(v){return this.x=Math.max(this.x,v.x),this.y=Math.max(this.y,v.y),this.z=Math.max(this.z,v.z),this}clamp(min,max){return this.x=Math.max(min.x,Math.min(max.x,this.x)),this.y=Math.max(min.y,Math.min(max.y,this.y)),this.z=Math.max(min.z,Math.min(max.z,this.z)),this}clampScalar(minVal,maxVal){let min=new Vector3,max=new Vector3;return min.set(minVal,minVal,minVal),max.set(maxVal,maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(v){return this.x*v.x+this.y*v.y+this.z*v.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(length){return this.normalize().multiplyScalar(length)}lerp(v,alpha,hz){return this.x=Math.lerp(v.x,this.x,alpha,hz),this.y=Math.lerp(v.y,this.y,alpha,hz),this.z=Math.lerp(v.z,this.z,alpha,hz),this}lerpVectors(v1,v2,alpha){return this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}cross(v){return this.crossVectors(this,v)}crossVectors(a,b){let ax=a.x,ay=a.y,az=a.z,bx=b.x,by=b.y,bz=b.z;return this.x=ay*bz-az*by,this.y=az*bx-ax*bz,this.z=ax*by-ay*bx,this}projectOnVector(vector){let scalar=vector.dot(this)/vector.lengthSq();return this.copy(vector).multiplyScalar(scalar)}projectOnPlane(planeNormal){let v1=this.V1||new Vector3;return this.V1=v1,v1.copy(this).projectOnVector(planeNormal),this.sub(v1)}reflect(normal){let v1=this.V1||new Vector3;return this.V1=v1,this.sub(v1.copy(normal).multiplyScalar(2*this.dot(normal)))}angleTo(v){let theta=this.dot(v)/Math.sqrt(this.lengthSq()*v.lengthSq());return Math.acos(Math.clamp(theta,-1,1))}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this.x-v.x,dy=this.y-v.y,dz=this.z-v.z;return dx*dx+dy*dy+dz*dz}manhattanDistanceTo(v){return Math.abs(this.x-v.x)+Math.abs(this.y-v.y)+Math.abs(this.z-v.z)}setFromCylindrical(c){return this.x=c.radius*Math.sin(c.theta),this.y=c.y,this.z=c.radius*Math.cos(c.theta),this}setFromMatrixPosition(m){let e=m.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(m){let sx=this.setFromMatrixColumn(m,0).length(),sy=this.setFromMatrixColumn(m,1).length(),sz=this.setFromMatrixColumn(m,2).length();return this.x=sx,this.y=sy,this.z=sz,this}setFromMatrixColumn(m,index){return this.fromArray(m.elements,4*index)}setAngleRadius(a,r,dir="xy"){return this[dir[0]]=Math.cos(a)*r,this[dir[1]]=Math.sin(a)*r,this}addAngleRadius(a,r,dir="xy"){return this[dir[0]]+=Math.cos(a)*r,this[dir[1]]+=Math.sin(a)*r,this}equals(v){return v.x===this.x&&v.y===this.y&&v.z===this.z}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=array[offset],this.y=array[offset+1],this.z=array[offset+2],this}setFromSpherical(s){this.setFromSphericalCoords(s.radius,s.phi,s.theta)}setFromSphericalCoords(radius,phi,theta){let sinPhiRadius=Math.sin(phi)*radius;return this.x=sinPhiRadius*Math.sin(theta),this.y=Math.cos(phi)*radius,this.z=sinPhiRadius*Math.cos(theta),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array[offset+2]=this.z,array}fromBufferAttribute(attribute,index){return this.x=attribute.array[3*index+0],this.y=attribute.array[3*index+1],this.z=attribute.array[3*index+2],this}}class Vector3D{constructor(x,y,z){this._x=x||0,this._y=y||0,this._z=z||0}get x(){return this._x}set x(v){if(window.Hydra&&Hydra.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");Math.abs(this._x-v)>1e-4&&this.onChangeCallback(),this._x=v}get y(){return this._y}set y(v){if(window.Hydra&&Hydra.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");Math.abs(this._y-v)>1e-4&&this.onChangeCallback(),this._y=v}get z(){return this._z}set z(v){if(window.Hydra&&Hydra.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");Math.abs(this._z-v)>1e-4&&this.onChangeCallback(),this._z=v}onChangeCallback(){}set(x,y,z){return this._x=x||0,this._y=y||0,this._z=z||0,this.onChangeCallback(),this}setScalar(scalar){return this._x=scalar,this._y=scalar,this._z=scalar,this.onChangeCallback(),this}clone(){return new Vector3(this._x,this._y,this._z)}copy(v){let dirty=Math.abs(this._x-v.x)>1e-4||Math.abs(this._y-v.y)>1e-4||Math.abs(this._z-v.z)>1e-4;return this._x=v.x,this._y=v.y,this._z=v.z,dirty&&this.onChangeCallback(),this}add(v){return this._x+=v.x,this._y+=v.y,this._z+=v.z,this.onChangeCallback(),this}addScalar(s){return this._x+=s,this._y+=s,this._z+=s,this.onChangeCallback(),this}addVectors(a,b){return this._x=a.x+b.x,this._y=a.y+b.y,this._z=a.z+b.z,this.onChangeCallback(),this}addScaledVector(v){return this._x+=v.x*s,this._y+=v.y*s,this._z+=v.z*s,this.onChangeCallback(),this}sub(v){return this._x-=v.x,this._y-=v.y,this._z-=v.z,this.onChangeCallback(),this}subScalar(s){return this._x-=s,this._y-=s,this._z-=s,this.onChangeCallback(),this}subVectors(a,b){return this._x=a.x-b.x,this._y=a.y-b.y,this._z=a.z-b.z,this.onChangeCallback(),this}multiply(v){return this._x*=v.x,this._y*=v.y,this._z*=v.z,this.onChangeCallback(),this}multiplyScalar(scalar){return this._x*=scalar,this._y*=scalar,this._z*=scalar,this.onChangeCallback(),this}multiplyVectors(a,b){return this._x=a.x*b.x,this._y=a.y*b.y,this._z=a.z*b.z,this.onChangeCallback(),this}applyEuler(euler){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromEuler(euler))}applyAxisAngle(axis,angle){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromAxisAngle(axis,angle))}applyMatrix3(m){let x=this._x,y=this._y,z=this._z,e=m.elements;return this._x=e[0]*x+e[3]*y+e[6]*z,this._y=e[1]*x+e[4]*y+e[7]*z,this._z=e[2]*x+e[5]*y+e[8]*z,this.onChangeCallback(),this}applyMatrix4(m){let x=this._x,y=this._y,z=this._z,e=m.elements,w=1/(e[3]*x+e[7]*y+e[11]*z+e[15]);return this._x=(e[0]*x+e[4]*y+e[8]*z+e[12])*w,this._y=(e[1]*x+e[5]*y+e[9]*z+e[13])*w,this._z=(e[2]*x+e[6]*y+e[10]*z+e[14])*w,this.onChangeCallback(),this}applyQuaternion(q){let x=this._x,y=this._y,z=this._z,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return this._x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this._y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this._z=iz*qw+iw*-qz+ix*-qy-iy*-qx,this.onChangeCallback(),this}project(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,matrix.getInverse(camera.matrixWorld)),this.applyMatrix4(matrix)}unproject(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.matrixWorld,matrix.getInverse(camera.projectionMatrix)),this.applyMatrix4(matrix)}transformDirection(m){let x=this._x,y=this._y,z=this._z,e=m.elements;return this._x=e[0]*x+e[4]*y+e[8]*z,this._y=e[1]*x+e[5]*y+e[9]*z,this._z=e[2]*x+e[6]*y+e[10]*z,this.onChangeCallback(),this.normalize()}divide(v){return this._x/=v.x,this._y/=v.y,this._z/=v.z,this.onChangeCallback(),this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}min(v){return this._x=Math.min(this._x,v.x),this._y=Math.min(this._y,v.y),this._z=Math.min(this._z,v.z),this.onChangeCallback(),this}max(v){return this._x=Math.max(this._x,v.x),this._y=Math.max(this._y,v.y),this._z=Math.max(this._z,v.z),this}clamp(min,max){return this._x=Math.max(min.x,Math.min(max.x,this._x)),this._y=Math.max(min.y,Math.min(max.y,this._y)),this._z=Math.max(min.z,Math.min(max.z,this._z)),this}clampScalar(minVal,maxVal){let min=new Vector3,max=new Vector3;return min.set(minVal,minVal,minVal),max.set(maxVal,maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this._x=Math.floor(this._x),this._y=Math.floor(this._y),this._z=Math.floor(this._z),this.onChangeCallback(),this}ceil(){return this._x=Math.ceil(this._x),this._y=Math.ceil(this._y),this._z=Math.ceil(this._z),this.onChangeCallback(),this}round(){return this._x=Math.round(this._x),this._y=Math.round(this._y),this._z=Math.round(this._z),this.onChangeCallback(),this}roundToZero(){return this._x=this._x<0?Math.ceil(this._x):Math.floor(this._x),this._y=this._y<0?Math.ceil(this._y):Math.floor(this._y),this._z=this._z<0?Math.ceil(this._z):Math.floor(this._z),this.onChangeCallback(),this}negate(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this.onChangeCallback(),this}dot(v){return this._x*v.x+this._y*v.y+this._z*v.z}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}manhattanLength(){return Math.abs(this._x)+Math.abs(this._y)+Math.abs(this._z)}normalize(){return this.onChangeCallback(),this.divideScalar(this.length()||1)}setLength(length){return this.onChangeCallback(),this.normalize().multiplyScalar(length)}lerp(v,alpha,hz){return this._x=Math.lerp(v.x,this._x,alpha,hz),this._y=Math.lerp(v.y,this._y,alpha,hz),this._z=Math.lerp(v.z,this._z,alpha,hz),this.onChangeCallback(),this}lerpVectors(v1,v2,alpha){return this.onChangeCallback(),this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}cross(v){return this.crossVectors(this,v)}crossVectors(a,b){let ax=a.x,ay=a.y,az=a.z,bx=b.x,by=b.y,bz=b.z;return this._x=ay*bz-az*by,this._y=az*bx-ax*bz,this._z=ax*by-ay*bx,this.onChangeCallback(),this}projectOnVector(vector){let scalar=vector.dot(this)/vector.lengthSq();return this.copy(vector).multiplyScalar(scalar)}projectOnPlane(planeNormal){let v1=this.V1||new Vector3;return this.V1=v1,this.onChangeCallback(),v1.copy(this).projectOnVector(planeNormal),this.sub(v1)}reflect(normal){let v1=this.V1||new Vector3;return this.V1=v1,this.onChangeCallback(),this.sub(v1.copy(normal).multiplyScalar(2*this.dot(normal)))}angleTo(v){let theta=this.dot(v)/Math.sqrt(this.lengthSq()*v.lengthSq());return Math.acos(Math.clamp(theta,-1,1))}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this._x-v.x,dy=this._y-v.y,dz=this._z-v.z;return dx*dx+dy*dy+dz*dz}manhattanDistanceTo(v){return Math.abs(this._x-v.x)+Math.abs(this._y-v.y)+Math.abs(this._z-v.z)}setFromSpherical(s){let sinPhiRadius=Math.sin(s.phi)*s.radius;return this._x=sinPhiRadius*Math.sin(s.theta),this._y=Math.cos(s.phi)*s.radius,this._z=sinPhiRadius*Math.cos(s.theta),this.onChangeCallback(),this}setFromCylindrical(c){return this._x=c.radius*Math.sin(c.theta),this._y=c.y,this._z=c.radius*Math.cos(c.theta),this.onChangeCallback(),this}setFromMatrixPosition(m){let e=m.elements;return this._x=e[12],this._y=e[13],this._z=e[14],this.onChangeCallback(),this}setFromMatrixScale(m){let sx=this.setFromMatrixColumn(m,0).length(),sy=this.setFromMatrixColumn(m,1).length(),sz=this.setFromMatrixColumn(m,2).length();return this.onChangeCallback(),this._x=sx,this._y=sy,this._z=sz,this}setFromMatrixColumn(m,index){return this.onChangeCallback(),this.fromArray(m.elements,4*index)}equals(v){return v.x===this._x&&v.y===this._y&&v.z===this._z}fromArray(array,offset){return void 0===offset&&(offset=0),this._x=array[offset],this._y=array[offset+1],this._z=array[offset+2],this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this._x,array[offset+1]=this._y,array[offset+2]=this._z,array}fromBufferAttribute(attribute,index){this._x=attribute.array[3*index+0],this._y=attribute.array[3*index+1],this._z=attribute.array[3*index+2],this.onChangeCallback()}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}class Vector4{constructor(x=0,y=0,z=0,w=0){this.x=x,this.y=y,this.z=z,this.w=w}multiplyScalar(s){return this.x*=s,this.y*=s,this.z*=s,this.w*=s,this}set(x,y,z,w){return this.x=x,this.y=y,this.z=z,this.w=w,this}copy(v){return this.x=v.x,this.y=v.y,this.z=v.z,this.w=v.w,this}dot(v){return this.x*v.x+this.y*v.y+this.z*v.z+this.w*v.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}equals(v){return v.x===this.x&&v.y===this.y&&v.z===this.z&&v.w===this.w}lerp(v,alpha,hz){return this.x=Math.lerp(v.x,this.x,alpha,hz),this.y=Math.lerp(v.y,this.y,alpha,hz),this.z=Math.lerp(v.z,this.z,alpha,hz),this.w=Math.lerp(v.w,this.w,alpha,hz),this}applyMatrix4(m){let x=this.x,y=this.y,z=this.z,w=this.w,e=m.elements;return this.x=e[0]*x+e[4]*y+e[8]*z+e[12]*w,this.y=e[1]*x+e[5]*y+e[9]*z+e[13]*w,this.z=e[2]*x+e[6]*y+e[10]*z+e[14]*w,this.w=e[3]*x+e[7]*y+e[11]*z+e[15]*w,this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array[offset+2]=this.z,array[offset+3]=this.w,array}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=array[offset],this.y=array[offset+1],this.z=array[offset+2],this.w=array[offset+3],this}set width(v){this.z=v}set height(v){this.w=v}get width(){return this.z}get height(){return this.w}clone(){return new Vector4(this.x,this.y,this.z,this.w)}}class Face3{constructor(a,b,c,normal=new Vector3){this.a=a,this.b=b,this.c=c,this.normal=normal}}function NoGLPolyfill(){this.activeTexture=this.attachShader=this.bindAttribLocation=this.bindBuffer=this.bindFramebuffer=this.bindRenderbuffer=this.bindTexture=this.blendColor=this.blendEquation=this.blendEquationSeparate=this.blendFunc=this.blendFuncSeparate=this.bufferData=this.bufferSubData=this.checkFramebufferStatus=this.clear=this.clearColor=this.clearDepthf=this.clearStencil=this.colorMask=this.compileShader=this.compressedTexImage2D=this.compressedTexSubImage2D=this.copyTexImage2D=this.copyTexSubImage2D=this.createProgram=this.createShader=this.cullFace=this.deleteBuffers=this.deleteFramebuffers=this.deleteProgram=this.deleteRenderbuffers=this.deleteShader=this.deleteTextures=this.depthFunc=this.depthMask=this.depthRangef=this.detachShader=this.disable=this.disableVertexAttribArray=this.drawArrays=this.drawElements=this.enable=this.enableVertexAttribArray=this.finish=this.flush=this.framebufferRenderbuffer=this.framebufferTexture2D=this.frontFace=this.generateMipmap=this.getActiveAttrib=this.getActiveUniform=this.getAttachedShaders=this.getAttribLocation=this.getBooleanv=this.getBufferParameteriv=this.getError=this.getFloatv=this.getFramebufferAttachmentParameteriv=this.getIntegerv=this.getProgramiv=this.getProgramInfoLog=this.getRenderbufferParameteriv=this.getShaderiv=this.getShaderInfoLog=this.getShaderPrecisionFormat=this.getShaderSource=this.getString=this.getTexParameterfv=this.getTexParameteriv=this.getUniformfv=this.getUniformiv=this.getUniformLocation=this.getVertexAttribfv=this.getVertexAttribiv=this.getVertexAttribPointerv=this.isBuffer=this.isEnabled=this.isFramebuffer=this.isProgram=this.isRenderbuffer=this.isShader=this.isTexture=this.lineWidth=this.linkProgram=this.pixelStorei=this.polygonOffset=this.readPixels=this.releaseShaderCompiler=this.renderbufferStorage=this.sampleCoverage=this.scissor=this.shaderBinary=this.shaderSource=this.stencilFunc=this.stencilFuncSeparate=this.stencilMask=this.stencilMaskSeparate=this.stencilOp=this.stencilOpSeparate=this.texParameterf=this.texParameterfv=this.texParameteri=this.texParameteriv=this.texSubImage2D=this.uniform1f=this.uniform1fv=this.uniform1i=this.uniform1iv=this.uniform2f=this.uniform2fv=this.uniform2i=this.uniform2iv=this.uniform3f=this.uniform3fv=this.uniform3i=this.uniform3iv=this.uniform4f=this.uniform4fv=this.uniform4i=this.uniform4iv=this.uniformMatrix2fv=this.uniformMatrix3fv=this.uniformMatrix4fv=this.useProgram=this.validateProgram=this.vertexAttrib1f=this.vertexAttrib1fv=this.vertexAttrib2f=this.vertexAttrib2fv=this.vertexAttrib3f=this.vertexAttrib3fv=this.vertexAttrib4f=this.vertexAttrib4fv=this.vertexAttribPointer=this.viewport=this.getParameter=this.getExtension=this.drawElementsInstanced=this.drawArraysInstanced=this.vertexAttribDivisor=this.getUniformBlockIndex=this.uniformBlockBinding=this.bindBufferBase=this.createVertexArray=this.bindVertexArray=this.deleteVertexArray=this.drawBuffers=this.blitFramebuffer=this.texImage2D=this.getContextAttributes=this.isContextLost=this.clearDepth=this.depthRange=this.createTexture=this.createBuffer=this.createFramebuffer=this.createRenderbuffer=this.deleteTexture=this.deleteBuffer=this.deleteFramebuffer=this.getBufferParameter=this.getRenderbufferParameter=this.getProgramParameter=this.getVertexAttribOffset=this.getFramebufferAttachmentParemeter=this.getUniform=this.getTexParameter=this.getShaderParameter=this.getSupportedExtensions=this.activeTexture=this.attachShader=_=>{},this.getShaderParameter=this.getProgramParameter=function(){return!0}}Class((function zUtils3D(){var diff,edge1,edge2,normal,v1,v0;Math.euclideanModulo=function(n,m){return(n%m+m)%m},Math.isPowerOf2=function(w,h){let test=value=>0==(value&value-1);return test(w)&&test(h)},Math.floorPowerOf2=function(value){return Math.pow(2,Math.floor(Math.log(value)/Math.LN2))},Geometry.createAttributes=function(geom){let attributes={},handler={set(target,property,value){target[property]=value,geom._attributeKeys.length=0,geom._attributeValues.length=0;for(let key in attributes)geom._attributeKeys.push(key),geom._attributeValues.push(attributes[key]);return!0}};return geom._attributeKeys=[],geom._attributeValues=[],new Proxy(attributes,handler)},Geometry.TYPES={SphereGeometry:SphereGeometry,IcosahedronGeometry:IcosahedronGeometry,BoxGeometry:BoxGeometry,PlaneGeometry:PlaneGeometry,CylinderGeometry:CylinderGeometry},Matrix4.prototype.isMatrix4=!0,Matrix3.prototype.isMatrix3=!0,Vector3.prototype.isVector3=!0,Vector3D.prototype.isVector3=!0,Vector2.prototype.isVector2=!0,CameraBase3D.prototype.isCamera=!0,PerspectiveCamera.prototype.isPerspective=!0,Scene.FRONT_TO_BACK="sort_front_to_back",window.THREAD&&(Shader={FRONT_SIDE:"shader_front_side",BACK_SIDE:"shader_back_side",DOUBLE_SIDE:"shader_double_side"}),Ray.prototype.intersectTriangle=(diff=new Vector3,edge1=new Vector3,edge2=new Vector3,normal=new Vector3,function intersectTriangle(a,b,c,backfaceCulling,target){edge1.subVectors(b,a),edge2.subVectors(c,a),normal.crossVectors(edge1,edge2);var sign,DdN=this.direction.dot(normal);if(DdN>0){if(backfaceCulling)return null;sign=1}else{if(!(DdN<0))return null;sign=-1,DdN=-DdN}diff.subVectors(this.origin,a);var DdQxE2=sign*this.direction.dot(edge2.crossVectors(diff,edge2));if(DdQxE2<0)return null;var DdE1xQ=sign*this.direction.dot(edge1.cross(diff));if(DdE1xQ<0)return null;if(DdQxE2+DdE1xQ>DdN)return null;var QdN=-sign*diff.dot(normal);return QdN<0?null:this.at(QdN/DdN,target)}),Mesh.prototype.raycast=function(){let inverseMatrix=new Matrix4,ray=new Ray,sphere=new Sphere,vA=new Vector3,vB=new Vector3,vC=new Vector3,uvA=(new Vector3,new Vector3,new Vector3,new Vector3,new Vector2),uvB=new Vector2,uvC=new Vector2,barycoord=new Vector3,intersectionPoint=new Vector3,intersectionPointWorld=new Vector3;function checkBufferGeometryIntersection(object,raycaster,ray,position,uv,a,b,c){if(vA.fromBufferAttribute(position,a),vB.fromBufferAttribute(position,b),vC.fromBufferAttribute(position,c),object.raycastLimit){let{radiusSq:radiusSq,position:position}=object.raycastLimit;if(vA.distanceToSquared(position)>radiusSq)return}let intersection=function checkIntersection(object,shader,raycaster,ray,pA,pB,pC,point){let intersect;if(intersect=shader.side===Shader.BACK_SIDE?ray.intersectTriangle(pC,pB,pA,!0,point):ray.intersectTriangle(pA,pB,pC,shader.side!==Shader.DOUBLE_SIDE,point),null===intersect)return null;intersectionPointWorld.copy(point),intersectionPointWorld.applyMatrix4(object.matrixWorld);let distance=raycaster.ray.origin.distanceTo(intersectionPointWorld);return distance<raycaster.near||distance>raycaster.far?null:{distance:distance,point:intersectionPointWorld.clone(),object:object}}(object,object.shader,raycaster,ray,vA,vB,vC,intersectionPoint);if(intersection){uv&&(uvA.fromBufferAttribute(uv,a),uvB.fromBufferAttribute(uv,b),uvC.fromBufferAttribute(uv,c),intersection.uv=function uvIntersection(point,p1,p2,p3,uv1,uv2,uv3){return Triangle.getBarycoord(point,p1,p2,p3,barycoord),uv1.multiplyScalar(barycoord.x),uv2.multiplyScalar(barycoord.y),uv3.multiplyScalar(barycoord.z),uv1.add(uv2).add(uv3),uv1.clone()}(intersectionPoint,vA,vB,vC,uvA,uvB,uvC));let face=new Face3(a,b,c);Triangle.getNormal(vA,vB,vC,face.normal),intersection.face=face}return intersection}return function raycast(raycaster,intersects){let intersection,a,b,c,geometry=this.geometry,shader=this.shader,matrixWorld=this.matrixWorld;if(void 0===shader)return;if(null===geometry.boundingSphere&&geometry.computeBoundingSphere(),0==this.scale.x)return;if(this.staticRaycast){if(this.raySphere||(this.raySphere=new Sphere,this.raySphere.copy(geometry.boundingSphere),this.raySphere.applyMatrix4(matrixWorld)),this.raycastNeedsUpdate&&(this.raySphere.copy(geometry.boundingSphere),this.raySphere.applyMatrix4(matrixWorld),this.raycastNeedsUpdate=!1),!1===raycaster.ray.intersectsSphere(this.raySphere))return}else if(sphere.copy(geometry.boundingSphere),sphere.applyMatrix4(matrixWorld),!1===raycaster.ray.intersectsSphere(sphere))return;if(inverseMatrix.getInverse(matrixWorld),ray.copy(raycaster.ray).applyMatrix4(inverseMatrix),null!==geometry.boundingBox&&!1===ray.intersectsBox(geometry.boundingBox))return;let i,l,index=geometry.index,position=geometry.attributes.position,uv=geometry.attributes.uv;if(null!==index)for(i=0,l=index.length;i<l;i+=3)a=index[i],b=index[i+1],c=index[i+2],intersection=checkBufferGeometryIntersection(this,raycaster,ray,position,uv,a,b,c),intersection&&(intersection.faceIndex=Math.floor(i/3),intersects.push(intersection));else if(void 0!==position)for(i=0,l=position.count;i<l;i+=3)a=i,b=i+1,c=i+2,intersection=checkBufferGeometryIntersection(this,raycaster,ray,position,uv,a,b,c),intersection&&(intersection.faceIndex=Math.floor(i/3),intersects.push(intersection))}}(),Triangle.prototype.closestPointToPoint=function(){let plane=new Plane,edgeList=[new Line3,new Line3,new Line3],projectedPoint=new Vector3,closestPoint=new Vector3;return function closestPointToPoint(point,target=new Vector3){let minDistance=1/0;if(plane.setFromCoplanarPoints(this.a,this.b,this.c),plane.projectPoint(point,projectedPoint),!0===this.containsPoint(projectedPoint))target.copy(projectedPoint);else{edgeList[0].set(this.a,this.b),edgeList[1].set(this.b,this.c),edgeList[2].set(this.c,this.a);for(let i=0;i<edgeList.length;i++){edgeList[i].closestPointToPoint(projectedPoint,!0,closestPoint);let distance=projectedPoint.distanceToSquared(closestPoint);distance<minDistance&&(minDistance=distance,target.copy(closestPoint))}}return target}}(),Points.prototype.raycast=function(){let inverseMatrix=new Matrix4,ray=new Ray,sphere=new Sphere;return function raycast(raycaster,intersects){let object=this,geometry=this.geometry,matrixWorld=this.matrixWorld,threshold=raycaster.params.Points.threshold;if(null===geometry.boundingSphere&&geometry.computeBoundingSphere(),sphere.copy(geometry.boundingSphere),sphere.applyMatrix4(matrixWorld),sphere.radius+=threshold,!1===raycaster.ray.intersectsSphere(sphere))return;inverseMatrix.getInverse(matrixWorld),ray.copy(raycaster.ray).applyMatrix4(inverseMatrix);let localThreshold=threshold/((this.scale.x+this.scale.y+this.scale.z)/3),localThresholdSq=localThreshold*localThreshold,position=new Vector3,intersectPoint=new Vector3;function testPoint(point,index){let rayPointDistanceSq=ray.distanceSqToPoint(point);if(rayPointDistanceSq<localThresholdSq){ray.closestPointToPoint(point,intersectPoint),intersectPoint.applyMatrix4(matrixWorld);let distance=raycaster.ray.origin.distanceTo(intersectPoint);if(distance<raycaster.near||distance>raycaster.far)return;intersects.push({distance:distance,distanceToRay:Math.sqrt(rayPointDistanceSq),point:intersectPoint.clone(),index:index,face:null,object:object})}}let index=geometry.index,positions=geometry.attributes.position.array;if(null!==index){let indices=index.array;for(let i=0,il=indices.length;i<il;i++){let a=indices[i];position.fromArray(positions,3*a),testPoint(position,a)}}else for(let i=0,l=positions.length/3;i<l;i++)position.fromArray(positions,3*i),testPoint(position,i)}}(),Object.assign(Triangle,{getNormal:(v0=new Vector3,function getNormal(a,b,c,target=new Vector3){target.subVectors(c,b),v0.subVectors(a,b),target.cross(v0);var targetLengthSq=target.lengthSq();return targetLengthSq>0?target.multiplyScalar(1/Math.sqrt(targetLengthSq)):target.set(0,0,0)}),getBarycoord:function(){var v0=new Vector3,v1=new Vector3,v2=new Vector3;return function getBarycoord(point,a,b,c,target=new Vector3){v0.subVectors(c,a),v1.subVectors(b,a),v2.subVectors(point,a);var dot00=v0.dot(v0),dot01=v0.dot(v1),dot02=v0.dot(v2),dot11=v1.dot(v1),dot12=v1.dot(v2),denom=dot00*dot11-dot01*dot01;if(0===denom)return target.set(-2,-1,-1);var invDenom=1/denom,u=(dot11*dot02-dot01*dot12)*invDenom,v=(dot00*dot12-dot01*dot02)*invDenom;return target.set(1-u-v,v,u)}}(),containsPoint:(v1=new Vector3,function containsPoint(point,a,b,c){return Triangle.getBarycoord(point,a,b,c,v1),v1.x>=0&&v1.y>=0&&v1.x+v1.y<=1})})}),"static"),Class((function FXLayer(_parentNuke,_type,_preventDrawBuffers=!1){Inherit(this,Component);var _nuke,_rt,_this=this,_scene=new Scene,_objects=[],_textureIndex=-1,_visible=!0,_id=Utils.timestamp(),_name=Utils.getConstructorName(_this),_useDrawBuffers=!_preventDrawBuffers;function resizeHandler(){_rt.setSize&&_rt.setSize(_nuke.stage.width*_this.resolution*_nuke.dpr,_nuke.stage.height*_this.resolution*_nuke.dpr)}this.resolution=1,this.enabled=!0,this.renderShadows=!0,this.set("visible",(v=>_this.scene.visible=_visible=v)),this.get("visible",(_=>_visible)),this.onInvisible=function(){_this.scene.visible=!1},this.onVisible=function(){_this.scene.visible=!0},this.create=function(nuke=World.NUKE,type,rt){if(!nuke)return;let format;_useDrawBuffers=nuke.useDrawBuffers,type&&"object"==typeof type&&("boolean"==typeof type.useDrawBuffers&&(_useDrawBuffers=type.useDrawBuffers),format=type.format,type=type.type),_this.rtType=type||Texture.UNSIGNED_BYTE,_this.rtFormat=format||Texture.RGBFormat,(_this=this).scene=_scene,(_nuke=_this.initClass(Nuke,nuke.stage,{renderer:nuke.renderer,camera:nuke.camera,scene:_scene,dpr:nuke.dpr,useDrawBuffers:!1})).parentNuke=nuke,_parentNuke=nuke,_this.nuke=_nuke,function initRT(rt){if(_useDrawBuffers){let texture=new Texture;texture.minFilter=Texture.LINEAR,texture.magFilter=Texture.LINEAR,texture.format=Texture.RGBAFormat,_this.rtType&&(texture.type=_this.rtType),_this.rtFormat&&(texture.format=_this.rtFormat),texture.type==Texture.FLOAT&&(texture.format=Texture.RGBAFormat),texture.wrapS=texture.wrapT=Texture.CLAMP_TO_EDGE,texture.fxLayer=_this,_this.textureIndex=_textureIndex=_parentNuke.attachDrawBuffer(texture),_rt={texture:texture}}else _this.rtType&&_this.rtType==Texture.FLOAT&&"ios"==Device.system.os&&(_this.rtType=Texture.HALF_FLOAT),_rt=rt||Utils3D.createRT(Math.round(_nuke.stage.width*_this.resolution*_nuke.dpr),Math.round(_nuke.stage.height*_this.resolution*_nuke.dpr),_this.rtType,_this.rtFormat);_this.rt=_rt,_this.nuke.setSize(_rt.width,_rt.height)}(rt),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),_this.startRender((_=>_this.draw()),nuke)},this.addObject=this.add=function(object){if(_nuke){if(!_useDrawBuffers){let clone=object.clone();for(object["clone_"+_id]=clone,_scene.add(clone),_objects.push(object),object.shader&&function editShader(mesh){let modifyShader=(shader,name)=>{let fs=shader._fragmentShader;if(!fs)return;let marker="#drawbuffer "+name;if(fs.includes(marker)){let split=fs.split(marker+" ");fs=split[0]+split[1]}for(;fs.includes("#drawbuffer");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)fs[i].includes("#drawbuffer")&&(fs[i]="");fs=fs.join("\n")}shader.fragmentShader=fs},applyShadow=(shader,bool)=>{let fs=shader.fragmentShader;if(fs){for(;fs.includes("#applyShadow");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)bool?fs[i].includes("#applyShadow")&&(fs[i]=fs[i].replace("#applyShadow","")):fs[i].includes("#applyShadow")&&(fs[i]="");fs=fs.join("\n")}shader.fragmentShader=fs}};mesh.shader._fragmentShader||(mesh.shader._fragmentShader=mesh.shader.fragmentShader),modifyShader(mesh.shader,"Color");let shader=mesh.shader.clone(!_this.renderShadows,"-"+(_this.name||_name));modifyShader(shader,_this.name||_name),applyShadow(shader,_this.renderShadows),applyShadow(mesh.shader,!0),mesh.shader.copyUniformsTo(shader,!0),mesh.shader=shader}(clone);clone.children.length;)clone.remove(clone.children[0]);return clone}object.shader&&object.shader.fragmentShader&&(!function editDBShader(mesh){const WEBGL2=Renderer.type==Renderer.WEBGL2;let modifyMarker=(fs,name,index)=>{if(WEBGL2&&!fs.includes(`layout(location=${index})`)){let mainAt=(fs=fs.replace("out vec4 FragColor;","")).indexOf("void main()"),before=fs.slice(0,mainAt),after=fs.slice(mainAt);fs=before+`layout(location=${index}) out vec4 ${name};\n`+after}let marker="#drawbuffer "+name;if(fs.includes(marker)){let split=fs.split(marker+" "),finalOut=WEBGL2?name:`gl_FragData[${index}]`;split[1]=split[1].replace("gl_FragColor",finalOut),fs=split[0]+split[1]}for(;fs.includes("#applyShadow");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)fs[i].includes("#applyShadow")&&(fs[i]=fs[i].replace("#applyShadow",""));fs=fs.join("\n")}return fs},shader=mesh.shader,fs=shader.fragmentShader,name=_this.name||_name;WEBGL2&&fs.includes("location=0")||(fs=modifyMarker(fs,"Color",0)),fs=modifyMarker(fs,name,_textureIndex),shader.fragmentShader=fs}(object),object.shader._attachmentData={format:_this.rtFormat,type:_this.rtType,attachments:_parentNuke.attachments})}},this.removeObject=function(object){_nuke&&(_scene.remove(object["clone_"+_id]),_objects.remove(object),delete object["clone_"+_id])},this.render=this.draw=function(stage,camera){if(_nuke&&_this.enabled&&!_useDrawBuffers&&_parentNuke.enabled&&_objects.length){stage&&(_nuke.stage=stage,_this.setSize(stage.width,stage.height)),_nuke.camera=camera||_nuke.parentNuke.camera,_this.renderShadows||(_nuke.renderer.overridePreventShadows=!0);for(let i=_objects.length-1;i>-1;i--){let obj=_objects[i],clone=obj["clone_"+_id];_this.forceVisible?clone.visible=!0:clone.visible=obj.determineVisible(),clone.visible&&(obj.updateMatrixWorld(),obj.ignoreMatrix||Utils3D.decompose(obj,clone))}_nuke.rtt=_rt,_nuke.render(),RenderStats.update("FXLayer"),_nuke.renderer.overridePreventShadows=!1}},this.addPass=function(pass){_nuke&&_nuke.add(pass)},this.removePass=function(pass){_nuke&&_nuke.remove(pass)},this.setSize=function(width,height){_nuke&&(_rt.width==width&&_rt.height==height||(_this.events.unsub(Events.RESIZE,resizeHandler),_rt&&_rt.setSize(width*_this.resolution*_nuke.dpr,height*_this.resolution*_nuke.dpr),_nuke.setSize(width*_this.resolution*_nuke.dpr,height*_this.resolution*_nuke.dpr)))},this.setDPR=function(dpr){_nuke&&(_nuke.dpr=dpr,resizeHandler())},this.setResolution=function(res){_this.resolution=res,resizeHandler()},this.getObjects=function(){return _objects},this.useRT=function(rt){_rt=_this.rt=rt},this.getName=function(){return _this.name||_name},_parentNuke instanceof Nuke&&this.create(_parentNuke,_type)})),Namespace("FX"),Class((function FXScene(_parentNuke,_type){Inherit(this,Component);var _nuke,_rt,_rtPool,_this=this,_scene=new Scene,_id=Utils.timestamp(),_objects=[],_renderTime=Render.TIME,_visible=!0;function resizeHandler(){_rt.setSize&&_rt.setSize(_nuke.stage.width*_this.resolution*_nuke.dpr,_nuke.stage.height*_this.resolution*_nuke.dpr),_this.nuke.setSize(_rt.width,_rt.height),_this.width=_rt.width,_this.height=_rt.height}this.resolution=1,this.autoVisible=!0,this.enabled=!0,this.scene=_scene,this.renderShadows=!0,this.set("visible",(v=>{_this.scene&&(_this.scene.visible=_visible=v,_this.onFXSceneVisibility?.(v))})),this.get("visible",(_=>_visible)),this.onInvisible=function(){this.scene.visible&&(this.scene.visible=!1,_this.flag("needsOnVisible",!0)),_rtPool&&_rtPool.putRT(_this.rt)},this.onVisible=function(){_this.flag("needsOnVisible")&&(this.scene.visible=!0,_this.flag("needsOnVisible",!1)),_rtPool&&_this.useRT(_rtPool.getRT())},this.create=function(nuke=World.NUKE,rt,options){_this.nuke||(nuke instanceof RTPool?(options=rt,rt=(_rtPool=nuke).nullRT,nuke=World.NUKE):rt&&"object"==typeof rt?rt.isRT||(options=rt,rt=void 0):!nuke||nuke instanceof Nuke||(options=nuke,nuke=World.NUKE),options||(options={}),_this.rtFormat=options.format||Texture.RGBFormat,_this.rtType=options.type||Texture.UNSIGNED_BYTE,options.vr&&(_this.vrRT=RenderManager.type==RenderManager.VR),(_this=this).scene=_scene,_this.nuke=_nuke=_this.initClass(Nuke,nuke.stage,{renderer:nuke.renderer,camera:nuke.camera,scene:_scene,dpr:nuke.dpr,format:options.format}),_scene.nuke=_nuke,function initRT(rt,options={}){options.type==Texture.FLOAT&&(options.format=Texture.RGBAFormat,"ios"==Device.system.os&&(options.type=Texture.HALF_FLOAT,options.minFilter=Texture.NEAREST,options.magFilter=Texture.NEAREST));const RT=_this.nuke.useDrawBuffers&&options.multiRenderTarget?MultiRenderTarget:RenderTarget;_this.width=_nuke.stage.width*_this.resolution*_nuke.dpr,_this.height=_nuke.stage.height*_this.resolution*_nuke.dpr,_rt=rt||new RT(_this.width,_this.height,Object.assign({minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,generateMipmaps:!1},options)),_nuke.rtt=_this.rt=_rt,_rt.fxscene=_this,_this.vrRT&&(_rt.vrRT=!0)}(rt,options),rt?_this.flag("recycle_rt",!0):function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),FXScene.onCreate&&FXScene.onCreate(_this),options.manualRender||FXScene.manualRender||_this.startRender((_=>_this.draw()),nuke))},this.onDestroy=this.fxDestroy=function(){_this.scene.deleted=!0,_this.flag("recycle_rt")||_rt&&_rt.destroy&&_rt.destroy()},this.setSize=function(width,height,exact){_nuke&&(_rt.width==width&&_rt.height==height||(_this.events.unsub(Events.RESIZE,resizeHandler),exact?(_this.width=width,_this.height=height):(_this.width=width*_this.resolution*_nuke.dpr,_this.height=height*_this.resolution*_nuke.dpr),_rt&&_rt.setSize(_this.width,_this.height),_nuke.setSize(_this.width,_this.height)))},this.add=this.addObject=function(object){if(!object)return console.error("FXScene addObject undefined!");let clone=object.clone();for(object["clone_"+_id]=clone,_scene.add(clone),_objects.push(object),object.shader._attachmentData={format:_this.rtFormat,type:_this.rtType,attachments:1};clone.children.length;)clone.remove(clone.children[0]);return clone},this.removeObject=function(object){_scene.remove(object["clone_"+_id]),_objects.remove(object),delete object["clone_"+_id]},this.setScissor=function(x,y,w,h){this.scissor||(this.scissor=new Vector4),this.scissor.x=x*_this.width,this.scissor.y=_this.height-h*_this.height-y*_this.height,this.scissor.width=w*_this.width,this.scissor.height=h*_this.height,this.rt.scissor=this.scissor},this.render=this.draw=function(stage,camera){if(_this.isVrWorldMode)return;if(Render.TIME-_renderTime<1e3/Render.REFRESH_RATE-1)return;if(_renderTime=Render.TIME,_this.isVrSceneMode){let rt=World.NUKE.enabled&&World.NUKE.passes.length?World.NUKE.rttBuffer:void 0,autoClear=_nuke.renderer.autoClear;return _nuke.renderer.autoClear=!1,_nuke.renderer.clearDepth(rt),_nuke.renderer.render(_scene,_nuke.camera,rt),void(_nuke.renderer.autoClear=autoClear)}stage&&(_this.events.unsub(Events.RESIZE,resizeHandler),_this.setSize(stage.width,stage.height),_this.nuke.stage=stage),camera&&(_this.nuke.camera=camera);let clearColor=null,alpha=1;_this.clearColor&&(clearColor=_nuke.renderer.getClearColor().getHex(),_nuke.renderer.setClearColor(_this.clearColor)),_this.clearAlpha>-1&&(alpha=_nuke.renderer.getClearAlpha(),_nuke.renderer.setClearAlpha(_this.clearAlpha)),_this.renderShadows||(_nuke.renderer.overridePreventShadows=!0);for(let i=_objects.length-1;i>-1;i--){let obj=_objects[i],clone=obj["clone_"+_id];_this.forceVisible||obj.cloneVisible?clone.visible="boolean"!=typeof clone.isVisible||clone.isVisible:clone.visible=obj.determineVisible(),clone.visible&&(obj.updateMatrixWorld(!1===obj.visible||void 0),obj.ignoreMatrix||(Utils3D.decompose(obj,clone),clone.overrideScale&&clone.scale.setScalar(clone.overrideScale)))}_this.preventRTDraw||(RenderStats.update("FXScene",1,_this),_nuke.rtt=_rt,_nuke.render()),_nuke.renderer.overridePreventShadows=!1,_this.clearColor&&_nuke.renderer.setClearColor(clearColor),_this.clearAlpha>-1&&_nuke.renderer.setClearAlpha(_this.clearAlpha),RenderManager.fire(_this)},this.setDPR=function(dpr){return _nuke?(_nuke.dpr=dpr,resizeHandler(),_this):_this},this.addPass=function(pass){_nuke&&_nuke.add(pass)},this.removePass=function(pass){_nuke&&_nuke.remove(pass)},this.setResolution=function(res){return _this.resolution=res,resizeHandler(),this},this.useRT=function(rt){_rt=_this.rt=rt,_this.vrRT&&(rt.vrRT=!0)},this.upload=function(){_rt&&_rt.upload()},this.useCamera=function(camera){_this.nuke.camera=camera.camera||camera},this.useScene=function(scene){_this.nuke.scene=scene},this.vrWorldMode=function(){_this.isVrWorldMode=!0,_this.group=new Group;for(let i=0;i<this.scene.children.length;i++)this.group.add(this.scene.children[i]);_scene=_this.scene=_this.group,World.SCENE.add(_this.group)},this.vrSceneMode=function(){_this.isVrSceneMode=!0,World.NUKE.autoClear=!1,RenderManager.renderer.autoClear=!1},this.createDepthTexture=function(useRTTBuffer){return _this.depthTexture||(_this.nuke.passes.length||useRTTBuffer?(_this.nuke.rttBuffer.createDepthTexture(),_this.depthTexture=_this.nuke.rttBuffer.depth):(_this.rt.createDepthTexture(),_this.depthTexture=_this.rt.depth)),_this.depthTexture},_parentNuke instanceof Nuke&&this.create(_parentNuke,_type)})),Class((function FXSceneCompositor(_shader,_options={}){Inherit(this,Object3D);const _this=this;var _basicShader;function decorateShader(shader){shader.addUniforms({tFrom:{value:null},tTo:{value:null},uTransition:{value:0}})}function loop(){_this.mesh.shader=_shader.uniforms.uTransition.value>0?_shader:_basicShader,_shader.uniforms.uTransition.value>=1&&(_this.mesh.shader=_basicShader,_basicShader.set("tMap",_shader.get("tTo")),_shader.set("uTransition",0))}!function initOptions(){(null===_options||_options instanceof Texture||_options.texture||_options.rt&&_options.rt.texture)&&(_options={startTexture:_options})}(),decorateShader(_shader),function initMesh(){let uniforms={tMap:{value:_options.startTexture||null}};_options.basicShader?(_basicShader=_options.basicShader).addUniforms(uniforms):_basicShader=_this.initClass(Shader,"ScreenQuad",uniforms),_this.mesh=new Mesh(World.QUAD,_basicShader),_this.mesh.frustumCulled=!1,_this.add(_this.mesh)}(),_this.startRender(loop),this.useShader=function(shader){_shader=shader,decorateShader(shader)},this.useBasicShader=function(shader){_basicShader.copyUniformsTo(shader,!0),_basicShader=shader},this.swap=function(showTransition){showTransition?_this.mesh.shader=_shader:(_basicShader.set("tMap",_shader.get("tTo")),_this.mesh.shader=_basicShader,_shader.set("tFrom",_basicShader.get("tMap")))},this.set("manual",(v=>{v?_this.stopRender(loop):_this.startRender(loop)}))})),Class((function BlitPass(_forceNuke){Inherit(this,NukePass);this.uniforms={},this.init("BlitPass"),_forceNuke||(this.blitFramebuffer=!0)})),Class((function Nuke(_stage,_params){Inherit(this,Component);var _width,_height,_nukeMesh,_this=this;_params.renderer||console.error("Nuke :: Must define renderer"),_this.stage=_stage,_this.renderer=_params.renderer,_this.camera=_params.camera,_this.scene=_params.scene,_this.rtt=_params.rtt,_this.enabled=0!=_params.enabled,_this.passes=_params.passes||[],_this.format=_params.format||Texture.RGBFormat,_this.useDrawBuffers=void 0!==_params.useDrawBuffers?_params.useDrawBuffers:!(Renderer.type!=Renderer.WEBGL2&&!window.Metal&&(Utils.query("noDrawBuffers"),1));var _rttPing,_rttPong,_rttBuffer,_dpr=_params.dpr||1,_drawBuffers=[];function resizeHandler(){var width=_this.stage.width*_dpr,height=_this.stage.height*_dpr;_rttPing.setSize(width,height),_rttPong.setSize(width,height),_rttBuffer.setSize(width,height)}_this.scene.nuke=_this,function initNuke(){let width=_this.stage.width*_dpr,height=_this.stage.height*_dpr;_rttPing=Nuke.getRT(width,height,!1,1,_this.format),_rttPong=Nuke.getRT(width,height,!1,2,_this.format),_rttBuffer=Nuke.getRT(width,height,_this.useDrawBuffers,-1,_this.format),(_nukeMesh=new Mesh(World.QUAD,null)).frustumCulled=!1,_nukeMesh.noMatrices=!0,_nukeMesh.transient=!0,_width=width,_height=height}(),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),_this.onBeforeShaderCompile=function(obj){if(!obj)return;let shader=obj.shader;if(!(shader&&shader.fragmentShader&&_this.useDrawBuffers&&_drawBuffers.length))return;const WEBGL2=Renderer.type==Renderer.WEBGL2;let matched=!1;_drawBuffers.forEach(((t,i)=>{let name=t.fxLayer.getName(),key=WEBGL2?name+" =":`gl_FragData[${i+1}]`;if(!shader.fragmentShader.includes(key)&&_this.useDrawBuffers){let fs=shader.fragmentShader,idx=fs.length-1;fs=fs.slice(0,idx)+`#drawbuffer ${name} gl_FragColor = vec4(0.0);\n`+fs.slice(idx),shader.fragmentShader=fs,t.fxLayer.add(obj),matched=!0}}));let key=WEBGL2?" Color ":"gl_FragData[0]";if(!shader.fragmentShader.includes(key)){let fs=shader.fragmentShader;WEBGL2||(fs="#extension GL_EXT_draw_buffers : require\n"+fs),fs=fs.split("void main() {"),fs=fs[0]+"void main() {\nvec4 tmpFragColor;\n"+fs[1],fs=fs.replace(/gl_FragColor/g,"tmpFragColor");let idx=fs.lastIndexOf("}");fs=matched?WEBGL2?fs.slice(0,idx)+"Color = tmpFragColor;\n"+fs.slice(idx):fs.slice(0,idx)+"gl_FragData[0] = tmpFragColor;\n"+fs.slice(idx):fs.slice(0,idx)+"#drawbuffer Color gl_FragColor = tmpFragColor;\n"+fs.slice(idx),shader.fragmentShader=fs}},_this.add=function(pass,index){"number"!=typeof index?_this.passes.push(pass):_this.passes.splice(index,0,pass)},_this.remove=function(pass){"number"==typeof pass?_this.passes.splice(pass):_this.passes.remove(pass)},_this.render=function(directCallback){if(RenderStats.update("Nuke"),RenderManager.fire(_this),_this.events.fire(Nuke.RENDER,_this,!0),_this.onBeforeRender&&_this.onBeforeRender(),!_this.enabled||!_this.passes.length){let autoClear=_this.renderer.autoClear;return 0==_this.autoClear&&(_this.renderer.autoClear=!1),_this.renderer.render(_this.scene,_this.camera,_this.rtt,null,directCallback),_this.onBeforeProcess&&_this.onBeforeProcess(),_this.postRender&&_this.postRender(),_this.events.fire(Nuke.POST_RENDER,_this,!0),void(0==_this.autoClear&&(_this.renderer.autoClear=autoClear,_this.renderer.clearColor()))}RenderStats.update("NukePass",_this.passes.length),_this.hasRendered=!0,_this.onBeforeProcess&&_this.onBeforeProcess();let autoClear=_this.renderer.autoClear;0==_this.autoClear&&(_this.renderer.autoClear=!1),_this.renderer.render(_this.scene,_this.camera,_rttBuffer,!0),0==_this.autoClear&&(_this.renderer.autoClear=autoClear);let usedBuffer=!1,pingPong=!0,count=_this.passes.length;for(var i=0;i<count;i++){if(_this.passes[i].disabled)continue;let shader=_this.passes[i].pass,inTexture=usedBuffer?pingPong?_rttPing.texture:_rttPong.texture:_rttBuffer.texture,outTexture=pingPong?_rttPong:_rttPing;i==count-1&&(outTexture=_this.rtt),_nukeMesh.shader=shader,_nukeMesh.shader.depthTest=!1,_nukeMesh.shader.depthWrite=!1,_nukeMesh.shader.uniforms.tDiffuse.value=inTexture,_this.renderer.renderSingle(_nukeMesh,_this.camera||World.CAMERA,outTexture,i==count-1?directCallback:null),usedBuffer=!0,pingPong=!pingPong}_this.postRender&&_this.postRender(),_this.events.fire(Nuke.POST_RENDER,_this,!0),0==_this.autoClear&&_this.renderer.clearColor(_rttBuffer)},_this.setSize=function(width,height){width==_width&&height==_height||(_width=width,_height=height,resizeHandler())},_this.attachDrawBuffer=function(texture){if(_this.hasRendered&&console.warn("Attempt to attach draw buffer after first render! Create FXLayer instance before first render."),_drawBuffers.push(texture),_rttBuffer&&_rttBuffer.attachments){_rttBuffer.attachments=[_this.rtt&&_this.rtt.attachments?_this.rtt.attachments[0]:_rttBuffer.attachments[0]];for(let i=0;i<_drawBuffers.length;i++)_rttBuffer.attachments.push(_drawBuffers[i]),_this.rtt&&_this.rtt.attachments&&_this.rtt.attachments.push(_drawBuffers[i])}return _drawBuffers.length},_this.upload=function(){_this.passes.length&&_this.enabled&&(_rttPing.upload(),_rttPong.upload(),_rttBuffer.upload()),_rttBuffer.depth&&_rttBuffer.depth.upload(),_this.rtt&&_this.rtt.upload()},_this.set("dpr",(function(v){_dpr=v,resizeHandler()})),_this.get("dpr",(function(){return _dpr})),_this.get("output",(function(){return _nukeMesh.shader&&_nukeMesh.shader.uniforms?_nukeMesh.shader.uniforms.tDiffuse.value:null})),_this.get("rttBuffer",(function(){return _rttBuffer})),this.set("rttBuffer",(function(v){_rttBuffer=v})),_this.get("prevFrameRT",(function(){return _rttBuffer&&_rttBuffer.texture?_rttBuffer.texture:null})),_this.get("nukeScene",(function(){return _nukeScene})),_this.get("ping",(function(){return _rttPing})),_this.get("pong",(function(){return _rttPong})),_this.get("attachments",(function(){return _rttBuffer.attachments?_rttBuffer.attachments.length:0})),this.onDestroy=function(){_rttBuffer.destroy()}}),(function(){Nuke.RENDER="nuke_render",Nuke.POST_RENDER="nuke_post_render";var _rts={};Nuke.getRT=function(width,height,multi,index,format){let rt,exists=_rts[`${width}_${height}_${multi}_${index}_${format}`];return exists||(rt=multi?Utils3D.createMultiRT(width,height,void 0,format):Utils3D.createRT(width,height,void 0,format),index>0&&Nuke.recyclePingPong&&(_rts[`${width}_${height}_${multi}_${index}_${format}`]=rt),rt)}})),Class((function NukePass(_fs,_uniforms,_pass){Inherit(this,Component);var _this=this;this.UILPrefix="string"==typeof _fs?_fs:Utils.getConstructorName(_fs),this.init=function(fs,vs){if(_this.pass)return;_this=this;fs||this.constructor.toString().match(/function ([^\(]+)/)[1],Array.isArray(fs)&&fs.join("");if(_this.uniforms=_uniforms||_this.uniforms||{},_this.uniforms.tDiffuse={type:"t",value:null,ignoreUIL:!0},_this.uniforms.unique&&(_this.UILPrefix+="_"+_this.uniforms.unique+"_"),window.UILStorage)for(let key in _this.uniforms)"unique"!==key&&(_this.uniforms[key]=UILStorage.parse(_this.UILPrefix+key,_this.uniforms[key].value)||_this.uniforms[key]);_this.pass=_this.initClass(Shader,vs||"NukePass",fs,Utils.mergeObject(_this.uniforms,{precision:"high"}),((code,type)=>"fs"==type?function prefix(code){if(!code)throw`No shader ${_fs} found`;let pre="";return code.includes("uniform sampler2D tDiffuse")||(pre+="uniform sampler2D tDiffuse;\n",pre+="varying vec2 vUv;\n"),pre+code}(code):code)),_this.uniforms=_this.pass.uniforms},this.set=function(key,value){TweenManager.clearTween(_this.uniforms[key]),_this.uniforms[key].value=value},this.get=function(key){return void 0===_this.uniforms[key]?null:_this.uniforms[key].value},this.tween=function(key,value,time,ease,delay,callback,update){return tween(_this.uniforms[key],{value:value},time,ease,delay,callback,update)},this.clone=function(){return _this.pass||_this.init(_fs),new NukePass(null,null,_this.pass.clone())},this.upload=function(){_this.pass.upload()},"string"==typeof _fs?_this.init(_fs):_pass&&(_this.pass=_pass,_this.uniforms=_pass.uniforms)})),Class((function Raycaster(_camera){Inherit(this,Component);const _this=this;let _mouse=new Vector3,_raycaster=new RayManager;function ascSort(a,b){return a.distance-b.distance}function intersectObject(object,raycaster,intersects,recursive){let obj=object;for(;obj&&_this.testVisibility;){if(!1===obj.visible&&!obj.forceRayVisible&&!1!==obj.testVisibility)return;obj=obj.parent}if(object.raycast&&(object.raycast(raycaster,intersects),!0===recursive)){let children=object.children;for(let i=0,l=children.length;i<l;i++)intersectObject(children[i],raycaster,intersects,!0)}}function intersect(objects){Array.isArray(objects)||(objects=[objects]);let intersects=[];return objects.forEach((object=>{intersectObject(object,_raycaster,intersects,!1)})),intersects.sort(ascSort),intersects}this.testVisibility=!0,this.set("camera",(function(camera){_camera=camera})),this.set("pointsThreshold",(function(value){_raycaster.params.Points.threshold=value})),this.get("ray",(()=>_raycaster.ray)),this.checkHit=function(objects,mouse,rect=Stage){return mouse=mouse||Mouse,_mouse.x=mouse.x/rect.width*2-1,_mouse.y=-mouse.y/rect.height*2+1,_raycaster.setFromCamera(_mouse,_camera),intersect(objects)},this.checkFromValues=function(objects,origin,direction){return _raycaster.set(origin,direction,0,Number.POSITIVE_INFINITY),intersect(objects)}}),(_=>{var _ray,_map=new WeakMap;Raycaster.checkHit=function(objects,mouse){return _ray||(_ray=new Raycaster(World.CAMERA)),_ray.checkHit(objects,mouse)},Raycaster.checkFromValues=function(objects,origin,direction){return _ray||(_ray=new Raycaster(World.CAMERA)),_ray.checkFromValues(objects,origin,direction)},Raycaster.find=function(camera){if(!_map.has(camera)){let ray=new Raycaster(camera);_map.set(camera,ray)}return _map.get(camera)}})),Class((function ScreenProjection(_camera){Inherit(this,Component);var _v3=new Vector3,_v32=new Vector3,_value=new Vector3;_camera=_camera.camera||_camera,this.set("camera",(function(v){_camera=v.camera||v})),this.get("camera",(_=>_camera)),this.unproject=function(mouse,rect=Stage,distance=1){"number"==typeof rect&&(distance=rect,rect=Stage),_v3.set(mouse.x/rect.width*2-1,-mouse.y/rect.height*2+1,.5),_v3.unproject(_camera);let pos=_camera.getWorldPosition();return _v3.sub(pos).normalize().multiplyScalar(distance),_value.copy(pos).add(_v3),_value},this.project=function(pos,screen){return screen=screen||Stage,pos instanceof Base3D?(pos.updateMatrixWorld(),_v32.set(0,0,0).setFromMatrixPosition(pos.matrixWorld)):_v32.copy(pos),_v32.project(_camera),_v32.x=(_v32.x+1)/2*screen.width,_v32.y=-(_v32.y-1)/2*screen.height,_v32}}),(_=>{var _screen,_map=new WeakMap;ScreenProjection.unproject=function(mouse,distance){return _screen||(_screen=new ScreenProjection(World.CAMERA)),_screen.unproject(mouse,distance)},ScreenProjection.project=function(pos,screen){return _screen||(_screen=new ScreenProjection(World.CAMERA)),_screen.project(pos,screen)},ScreenProjection.find=function(camera){if(!_map.has(camera)){let projection=new ScreenProjection(camera);_map.set(camera,projection)}return _map.get(camera)}})),Class((function Object3D(){Inherit(this,Component);var _this=this,_visible=!0;this.__element=!0,this.group=new Group,this.group.classRef=this,this.add=function(child){this.group.add(child.group||child)},this.remove=function(child){child&&this.group.remove(child.group||child)},this.onDestroy=function(){this.group.deleted=!0,this.group.classRef=null,this.group&&this.group.parent&&this.group.parent.remove(this.group)},this.set("visible",(v=>_this.group.visible=_visible=v)),this.get("visible",(_=>_visible))})),Class((function Utils3D(){const _this=this;var _emptyTexture,_q,_v3,_v3b,_m4,_textures={};window.Vec2=window.Vector2,window.Vec3=window.Vector3,async function(){await Hydra.ready();let threads=Thread.shared(!0);for(let i=0;i<threads.array.length;i++)_this.loadEngineOnThread(threads.array[i])}(),this.decompose=function(local,world){local.matrixWorld.decompose(world.position,world.quaternion,world.scale)},this.createDebug=function(size=1,color){return new Mesh(new IcosahedronGeometry(size,1),_this.getTestShader(color))},this.getTestShader=function(color){return color?new Shader("ColorMaterial",{color:{value:color instanceof Color?color:new Color(color)},alpha:{value:1}}):new Shader("TestMaterial")},this.createMultiRT=function(width,height,type,format){let rt=new MultiRenderTarget(width,height,{minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:format||Texture.RGBFormat,type:type});return rt.texture.generateMipmaps=!1,rt},this.createRT=function(width,height,type,format){let rt=new RenderTarget(width,height,{minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:format||Texture.RGBFormat,type:type});return rt.texture.generateMipmaps=!1,rt},this.getFloatType=function(){return"android"==Device.system.os?Texture.FLOAT:Texture.HALF_FLOAT},this.getTexture=function(path,params={}){if(!Device.graphics.webgl&&!window.AURA){let texture=new Texture;return texture.promise=Promise.resolve(),texture.dimensions={width:0,height:0},texture}if(path.includes("://")){let guard=path.split("://");guard[1]=guard[1].replace(/\/\//g,"/"),path=guard.join("://")}else path=path.replace(/\/\//g,"/");let compressed=path.includes("compressedKtx"),cacheBust=path.includes("?");if(cacheBust&&(path=path.split("?")[0]),Hydra.LOCAL||(cacheBust=!1),_textures[path])_textures[path].exists++;else{let texture=new Texture;texture.exists=1,texture.loaded=!1,texture.compressed=compressed,texture.promise=Promise.create(),texture._destroy=texture.destroy,texture.destroy=function(force){!force&&(texture.forcePersist||--texture.exists>0)||(delete _textures[path],this._destroy())},_textures[path]=texture,texture.format=path.match(/jpe?g/)?Texture.RGBFormat:Texture.RGBAFormat,texture.src=path,!1===params.premultiplyAlpha&&(texture.premultiplyAlpha=!1),_this.onTextureCreated&&_this.onTextureCreated(texture);let cb=imgBmp=>{imgBmp.crossOrigin="anonymous",texture.image=imgBmp,texture.dimensions={width:imgBmp.width,height:imgBmp.height},texture.loaded=!0,texture.needsReupload=!0,Math.isPowerOf2(imgBmp.width,imgBmp.height)||(texture.minFilter=Texture.LINEAR,texture.generateMipmaps=!1),imgBmp.gliFormat&&(texture.minFilter=Texture.LINEAR),texture.onUpdate=function(){!params.preserveData&&imgBmp.close&&imgBmp.close(),texture.onUpdate=null},texture.promise.resolve(),texture.onload&&(texture.onload(),texture.onload=null)},imgPath=cacheBust?path+"?"+Date.now():path;compressed&&!imgPath.includes("compressed")&&(imgPath+="-compressedKtx"),ImageDecoder.decode(imgPath,params).then(cb).catch((e=>{texture.promise.reject(e)}))}return _textures[path]},this.getLookupTexture=function(path){let texture=_this.getTexture(path);return texture.minFilter=texture.magFilter=Texture.NEAREST,texture.generateMipmaps=!1,texture},this.clearTextureCache=function(){for(let key in _textures)_textures[key].destroy();_textures={}},this.loadCurve=function(obj){"string"==typeof obj&&((obj=Assets.JSON[obj]).curves=obj.curves[0]);let data=obj.curves,points=[];for(let j=0;j<data.length;j+=3)points.push(new Vector3(data[j+0],data[j+1],data[j+2]));if(!window.CatmullRomCurve)throw"loadCurve requires curve3d module";return new CatmullRomCurve(points)},this.getEmptyTexture=function(){return _emptyTexture||(_emptyTexture=new Texture),_emptyTexture},this.getRepeatTexture=function(src,scale){let texture=_this.getTexture(src,scale);return texture.wrapS=texture.wrapT=Texture.REPEAT,texture},this.findTexturesByPath=function(path){let array=[];for(let key in _textures)key.includes(path)&&array.push(_textures[key]);return array},this.getHeightFromCamera=function(camera,dist){camera=camera.camera||camera,dist||(dist=camera.position.length());let fov=camera.fov;return 2*dist*Math.tan(.5*Math.radians(fov))},this.getPositionFromCameraSize=function(camera,size){camera=camera.camera||camera;let fov=Math.radians(camera.fov);return Math.abs(size/Math.sin(fov/2))},this.loadEngineOnThread=function(thread){["Base3D","CameraBase3D","Mesh","OrthographicCamera","PerspectiveCamera","Geometry","GeometryAttribute","Points","Scene","BoxGeometry","CylinderGeometry","PlaneGeometry","PolyhedronGeometry","IcosahedronGeometry","SphereGeometry","Box2","Box3","Face3","Color","Cylindrical","Euler","Frustum","Line3","Matrix3","Matrix4","Plane","Quaternion","Ray","Sphere","Spherical","Triangle","Vector2","Vector3","Vector4","RayManager","Vector3D","Group"].forEach((name=>{thread.importES6Class(name)})),thread.importCode(`Class(${zUtils3D.constructor.toString()}, 'static')`)},this.billboard=function(mesh,camera=World.CAMERA){_q||(_q=new Quaternion),mesh._parent?(mesh._parent.getWorldQuaternion(_q).inverse(),_q.multiply(camera.quaternion),mesh.quaternion.copy(_q),mesh.customRotation&&mesh.quaternion.multiply(mesh.customRotation)):mesh.quaternion.copy(World.CAMERA.quaternion)},this.positionInFrontOfCamera=function(object,distance,alpha=1,camera=World.CAMERA){_v3||(_v3=new Vector3),_v3b||(_v3b=new Vector3),_m4||(_m4=new Matrix4),_q||(_q=new Quaternion);let cameraPosition=_v3b,cameraQuaternion=_q;camera.updateMatrixWorld(),camera.matrixWorld.decompose(cameraPosition,cameraQuaternion,_v3),_v3.set(0,0,-distance).applyQuaternion(cameraQuaternion).add(cameraPosition),_m4.lookAt(cameraPosition,_v3,object.up),_q.setFromRotationMatrix(_m4),object.position.lerp(_v3,alpha),object.quaternion.slerp(_q,alpha)},this.getQuad=function(){let geom=new Geometry,position=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),uv=new Float32Array([0,0,2,0,0,2]);return geom.addAttribute("position",new GeometryAttribute(position,3)),geom.addAttribute("uv",new GeometryAttribute(uv,2)),geom},this.findParentCamera=function(group){let parent=group.parent;for(;parent;){if(parent.nuke)return parent.nuke.camera;parent=parent.parent}return World.CAMERA},this.cameraIntrinsicsToObject=function(camera,object){object.fov=camera.fov,object.aspect=camera.aspect,object.near=camera.near,object.far=camera.far,object.p||(object.p=[],object.q=[],object.projectionMatrix=[]),camera.getWorldPosition().toArray(object.p),camera.getWorldQuaternion().toArray(object.q),camera.projectionMatrix.toArray(object.projectionMatrix),object.width=Stage.width,object.height=Stage.height}}),"static"),window.WebGLRenderingContext&&function(){"use strict";var e={};function r(r,t){var i;e[r]=!0,void 0!==t&&(i=t,window.console&&window.console.error&&window.console.error(i))}var t=function e(r){var t=r.gl;this.ext=r,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(r.maxVertexAttribs);for(var i=0;i<this.attribs.length;i++){var a=new e.VertexAttrib(t);this.attribs[i]=a}this.maxAttrib=0};(t.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var i=function(r){var t,i,a=this;this.gl=r,i=(t=r).getError,t.getError=function(){do{(r=i.apply(t))!=t.NO_ERROR&&(e[r]=!0)}while(r!=t.NO_ERROR);for(var r in e)if(e[r])return delete e[r],parseInt(r);return t.NO_ERROR};var n=this.original={getParameter:r.getParameter,enableVertexAttribArray:r.enableVertexAttribArray,disableVertexAttribArray:r.disableVertexAttribArray,bindBuffer:r.bindBuffer,getVertexAttrib:r.getVertexAttrib,vertexAttribPointer:r.vertexAttribPointer};r.getParameter=function(e){return e==a.VERTEX_ARRAY_BINDING_OES?a.currentVertexArrayObject==a.defaultVertexArrayObject?null:a.currentVertexArrayObject:n.getParameter.apply(this,arguments)},r.enableVertexAttribArray=function(e){var r=a.currentVertexArrayObject;return r.maxAttrib=Math.max(r.maxAttrib,e),r.attribs[e].enabled=!0,n.enableVertexAttribArray.apply(this,arguments)},r.disableVertexAttribArray=function(e){var r=a.currentVertexArrayObject;return r.maxAttrib=Math.max(r.maxAttrib,e),r.attribs[e].enabled=!1,n.disableVertexAttribArray.apply(this,arguments)},r.bindBuffer=function(e,t){switch(e){case r.ARRAY_BUFFER:a.currentArrayBuffer=t;break;case r.ELEMENT_ARRAY_BUFFER:a.currentVertexArrayObject.elementArrayBuffer=t}return n.bindBuffer.apply(this,arguments)},r.getVertexAttrib=function(e,t){var i=a.currentVertexArrayObject.attribs[e];switch(t){case r.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return i.buffer;case r.VERTEX_ATTRIB_ARRAY_ENABLED:return i.enabled;case r.VERTEX_ATTRIB_ARRAY_SIZE:return i.size;case r.VERTEX_ATTRIB_ARRAY_STRIDE:return i.stride;case r.VERTEX_ATTRIB_ARRAY_TYPE:return i.type;case r.VERTEX_ATTRIB_ARRAY_NORMALIZED:return i.normalized;default:return n.getVertexAttrib.apply(this,arguments)}},r.vertexAttribPointer=function(e,r,t,i,s,A){var o=a.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,e);var c=o.attribs[e];return c.buffer=a.currentArrayBuffer,c.size=r,c.type=t,c.normalized=i,c.stride=s,c.offset=A,c.recache(),n.vertexAttribPointer.apply(this,arguments)},r.instrumentExtension&&r.instrumentExtension(this,"OES_vertex_array_object"),r.canvas.addEventListener("webglcontextrestored",(function(){window.console&&window.console.log&&window.console.log("OESVertexArrayObject emulation library context restored"),a.reset_()}),!0),this.reset_()};i.prototype.VERTEX_ARRAY_BINDING_OES=34229,i.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var r=this.gl;this.maxVertexAttribs=r.getParameter(r.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new t(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},i.prototype.createVertexArrayOES=function(){var e=new t(this);return this.vertexArrayObjects.push(e),e},i.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},i.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof t&&e.hasBeenBound&&e.ext==this)},i.prototype.bindVertexArrayOES=function(e){var t=this.gl;if(!e||e.isAlive){var i=this.original,a=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var n=this.currentVertexArrayObject;if(a!=n){a&&n.elementArrayBuffer==a.elementArrayBuffer||i.bindBuffer.call(t,t.ELEMENT_ARRAY_BUFFER,n.elementArrayBuffer);for(var s=this.currentArrayBuffer,A=Math.max(a?a.maxAttrib:0,n.maxAttrib),o=0;o<=A;o++){var c=n.attribs[o],b=a?a.attribs[o]:null;if(a&&c.enabled==b.enabled||(c.enabled?i.enableVertexAttribArray.call(t,o):i.disableVertexAttribArray.call(t,o)),c.enabled){var u=!1;a&&c.buffer==b.buffer||(s!=c.buffer&&(i.bindBuffer.call(t,t.ARRAY_BUFFER,c.buffer),s=c.buffer),u=!0),(u||c.cached!=b.cached)&&i.vertexAttribPointer.call(t,o,c.size,c.type,c.normalized,c.stride,c.offset)}}this.currentArrayBuffer!=s&&i.bindBuffer.call(t,t.ARRAY_BUFFER,this.currentArrayBuffer)}}else r(t.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},function(){var e=WebGLRenderingContext.prototype.getSupportedExtensions;WebGLRenderingContext.prototype.getSupportedExtensions=function(){var r=e.call(this)||[];return r.indexOf("OES_vertex_array_object")<0&&r.push("OES_vertex_array_object"),r};var r=WebGLRenderingContext.prototype.getExtension;WebGLRenderingContext.prototype.getExtension=function(e){return r.call(this,e)||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new i(this)),this.__OESVertexArrayObject))}}()}(),Class((function GeomThread(){Inherit(this,Component);const _this=this;var _cache={},_cacheWait={},_receive={};function computeBounding(data){let geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(data.position,3)),geom.computeBoundingBox(),geom.computeBoundingSphere(),data.boundingBox=geom.boundingBox,data.boundingSphere=geom.boundingSphere}function loadGeometry(e,id){get(e.path).then((data=>{let buffers=[];for(let key in data)Array.isArray(data[key])?(data[key]=new Float32Array(data[key]),buffers.push(data[key].buffer)):data[key].length>0&&buffers.push(data[key].buffer);computeBounding(data),e.custom&&self[e.custom](data),resolve(data,id,buffers)})).catch((er=>{e.preloading||console.error(er);let plane=new PlaneGeometry(1,1).toNonIndexed(),buffers=[],data={};for(let key in plane.attributes)data[key]=plane.attributes[key].array,buffers.push(data[key].buffer);computeBounding(data),resolve(data,id,buffers)}))}function loadSkinnedGeometry(e,id){get(e.path).then((data=>{let buffers=[];for(let key in data)"bones"!=key&&(Array.isArray(data[key])?(data[key]=new Float32Array(data[key]),buffers.push(data[key].buffer)):data[key].length>0&&buffers.push(data[key].buffer));computeBounding(data),e.custom&&self[e.custom](data),resolve(data,id,buffers)}))}function geom_useFn(e){Global.FNS||(Global.FNS=[]),Global.FNS.push(e.name)}this.caching=!0,async function(){await Hydra.ready(),Thread.upload(loadGeometry,loadSkinnedGeometry,geom_useFn,computeBounding)}(),this.loadGeometry=function(path,custom,preloading){if(!Device.graphics.gpu)return Promise.resolve(new PlaneGeometry(1,1));if(_cache[path])return Promise.resolve(_cache[path]);let cacheBust=!1;if(path.includes("?")&&(path=path.split("?")[0],cacheBust="?"+Utils.timestamp()),Hydra.LOCAL||(cacheBust=!1),path.includes("assets/geometry/")||(path="assets/geometry/"+path),path.includes(".")||(path+=".json"),cacheBust&&(path+=cacheBust),path=Thread.absolutePath(Assets.getPath(path)),_this.caching){if(_cacheWait[path])return _cacheWait[path];_cacheWait[path]=Promise.create()}return Thread.shared().loadGeometry({path:path,custom:custom,preloading:preloading}).then((data=>{let geometry;if(custom&&_receive[custom])geometry=_receive[custom](data);else{let geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(data.position,3)),geom.addAttribute("normal",new GeometryAttribute(data.normal||data.position.length,3)),geom.addAttribute("uv",new GeometryAttribute(data.uv||data.position.length/3*2,2)),data.uv2&&geom.addAttribute("uv2",new GeometryAttribute(data.uv2,2)),data.vdata&&geom.addAttribute("vdata",new GeometryAttribute(data.vdata,3)),geom.boundingBox=new Box3((new Vector3).set(data.boundingBox.min.x,data.boundingBox.min.y,data.boundingBox.min.z),(new Vector3).set(data.boundingBox.max.x,data.boundingBox.max.y,data.boundingBox.max.z)),geom.boundingSphere=new Sphere((new Vector3).set(data.boundingSphere.center.x,data.boundingSphere.center.y,data.boundingSphere.center.z),data.boundingSphere.radius),geometry=geom,geom._src=path}_this.caching&&(_cache[path]=geometry),_cacheWait[path]?.resolve(geometry)})),_cacheWait[path]},this.removeFromCache=function(path){path.includes("assets/geometry/")||(path="assets/geometry/"+path),path.includes(".")||(path+=".json"),path=Thread.absolutePath(Assets.getPath(path)),delete _cache[path],delete _cacheWait[path]},this.loadSkinnedGeometry=function(path,custom){if(!Device.graphics.webgl)return Promise.resolve(new PlaneGeometry(1,1));if(_cache[path])return Promise.resolve(_cache[path]);if(path.includes("assets/geometry/")||(path="assets/geometry/"+path),path.includes(".")||(path+=".json"),path=Thread.absolutePath(Assets.getPath(path)),_this.caching){if(_cacheWait[path])return _cacheWait[path];_cacheWait[path]=Promise.create()}return Thread.shared().loadSkinnedGeometry({path:path,custom:custom}).then((data=>{let geometry;if(custom&&_receive[custom])geometry=_receive[custom](data);else{let geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(data.position,3)),geom.addAttribute("normal",new GeometryAttribute(data.normal||data.position.length,3)),geom.addAttribute("uv",new GeometryAttribute(data.uv||data.position.length/3*2,2)),geom.addAttribute("skinIndex",new GeometryAttribute(data.skinIndex,4)),geom.addAttribute("skinWeight",new GeometryAttribute(data.skinWeight,4)),data.uv2&&geom.addAttribute("uv2",new GeometryAttribute(data.uv2,2)),data.vdata&&geom.addAttribute("vdata",new GeometryAttribute(data.vdata,3)),geom.bones=(data.rig?data.rig.bones:data.bones).slice(0),geom.boundingBox=new Box3((new Vector3).set(data.boundingBox.min.x,data.boundingBox.min.y,data.boundingBox.min.z),(new Vector3).set(data.boundingBox.max.x,data.boundingBox.max.y,data.boundingBox.max.z)),geom.boundingSphere=new Sphere((new Vector3).set(data.boundingSphere.center.x,data.boundingSphere.center.y,data.boundingSphere.center.z),data.boundingSphere.radius),geometry=geom,geom._src=path}_this.caching&&(_cache[path]=geometry),_cacheWait[path].resolve(geometry)})),_cacheWait[path]},this.customFunction=function(fn,receive){let name=Thread.upload(fn);name=name[0],t.geom_useFn({name:name}),_receive[name]=receive}}),"static"),Class((function InstanceMesh(_mesh,_shader,_group,_input){Inherit(this,Component);const _this=this;var _config,_shaderKey;function initHotReload(){_mesh.cacheGeom=_mesh.geometry.clone(),_this.events.sub(SceneLayout.HOTLOAD_GEOMETRY,(({file:file})=>{_mesh.geometry?._src?.includes(file)&&GeomThread.loadGeometry(file).then((_=>{createInstanceMesh(_config.get("json"))})),file.includes(_config.get("json"))&&createInstanceMesh(_config.get("json"))})),_this.events.sub(ShaderUIL.SHADER_UPDATE,(({shader:shader})=>{if(shader.includes(_shader.vsName)){let newShader=new Shader(_shader.vsName,_shader.fsName);delete MeshBatch.shaders[`${_shader.vsName}|${_shader.fsName}`],updateShader(newShader),Shader.renderer.hotReloadClearProgram(_shader.vsName),newShader.upload(_mesh,_mesh.cacheGeom),_shader._gl&&(_shader._gl=newShader._gl),_shader._gpu&&(_shader._gpu=newShader._gpu),_shader._metal&&(_shader._metal=newShader._metal)}}))}function updateShader(shader){let prefetchCode=Shaders.getShader(shader.vsName+".vs");shader.customCompile=`${shader.vsName}|${shader.fsName}|instance`,shader.resetProgram();let cached=MeshBatch.shaders[`${shader.vsName}|${shader.fsName}`];if(cached)return shader.fragmentShader=cached.fragment,void(shader.vertexShader=cached.vertex);let vsSplit=shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__");if(!vsSplit[1].includes("vec3 pos = position;")&&!vsSplit[1].includes("pos = pos;")&&!shader.vertexShader.includes("vec3 transformPosition"))throw`Shader ${shader.vsName} needs to have "vec3 pos = position;" in order for batching to work`;vsSplit[1]=vsSplit[1].replace(/vec3 pos = position;/g,"vec3 pos = transformPosition(position, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/pos = pos;/g,"pos = transformPosition(pos, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/vNormal = normalMatrix \* normal;/g,"vNormal = normalMatrix * transformNormal(normal, orientation);"),vsSplit[1]=vsSplit[1].replace(/vec3 transformedNormal = normal;/g,"vec3 transformedNormal = transformNormal(normal, orientation);"),vsSplit[0]+="\n",vsSplit[0]+="#define INSTANCED 1\n",prefetchCode&&prefetchCode.includes("attribute vec3 offset")||(vsSplit[0]+="\n",vsSplit[0]+="attribute vec3 offset;\n",vsSplit[0]+="attribute vec3 scale;\n",vsSplit[0]+="attribute vec4 orientation;\n"),shader.vertexShader.includes("vec3 transformPosition")||(vsSplit[0]+=Shaders.getShader("instance.vs")+"\n"),vsSplit=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),fsSplit=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),shader.vertexShader=vsSplit,shader.fragmentShader=fsSplit,_shaderKey=`${shader.vsName}|${shader.fsName}`,MeshBatch.shaders[_shaderKey]={fragment:shader.fragmentShader,vertex:shader.vertexShader}}async function createInstanceMesh(json){if(!json)return;json.includes("assets/geometry")||(json="assets/geometry/"+json),json.includes(".json")||(json+=".json"),_mesh.cacheGeom&&(json+="?"+Utils.timestamp()),_mesh.instanceMesh&&(_mesh.instanceMesh.visible=!1);let geom=(new Geometry).instanceFrom(_mesh.cacheGeom||_mesh.geometry),buffers=await Thread.shared().parseInstanceMesh({url:Thread.absolutePath(Assets.getPath(json))});for(let key in buffers){let b=buffers[key];geom.addAttribute(key,new GeometryAttribute(b.buffer,b.components,1))}let test=_config.get("test");test&&(_this.instanceMultiplier=eval(test)),void 0===_this.maxInstancedCount&&(_this.maxInstancedCount=geom.maxInstancedCount);let shader=_mesh.shader;updateShader(shader);let mesh=new Mesh(geom,shader);mesh.renderOrder=_mesh.renderOrder,mesh.castShadow=_mesh.castShadow,mesh.frustumCulled=!1,mesh.renderOrder=_mesh.renderOrder,mesh.castShadow=_mesh.castShadow,mesh.receiveLight=_mesh.receiveLight,_this.frustumCulled=!0,_mesh._parent.add(mesh),_mesh.instanceMesh=mesh,_mesh.instanceMeshReady.resolve(),_this.startRender((_=>{mesh.renderOrder=_mesh.renderOrder,mesh.castShadow=_mesh.castShadow,mesh.depthWrite=_mesh.depthWrite,mesh.depthTest=_mesh.depthTest,mesh.receiveLight=_mesh.receiveLight,mesh.geometry.maxInstancedCount=_this.maxInstancedCount*_this.instanceMultiplier}),10)}this.instanceMultiplier=1,(_config=InputUIL.create("im_"+_input.prefix,_group)).add("json"),_config.add("test"),_config.setLabel("Instance"),!1!==_input.get("visible")&&(_mesh._parent.remove(_mesh),_mesh.visible=!1,_mesh.instanceMeshReady=Promise.create(),_mesh.instanceMeshBeforeReady=Promise.create(),createInstanceMesh(_config.get("json")),_config.onUpdate=_=>{createInstanceMesh(_config.get("json"))},Hydra.LOCAL&&initHotReload()),this.applyToShader=function(shader){updateShader(shader)},this.onDestroy=function(){_mesh.instanceMesh&&_mesh.instanceMesh.destroy(),delete MeshBatch.shaders[_shaderKey]},this.set("frustumCulled",(async _=>{await _mesh.instanceMeshReady;let buffers=[],obj={};for(let key in _mesh.instanceMesh.geometry.attributes){if(!key.includes(["position","scale","offset","orientation"]))continue;let attrib=_mesh.instanceMesh.geometry.attributes[key],array=new Float32Array(attrib.array);obj[key]=array,buffers.push(array.buffer)}let bounding=await Thread.shared().generateBoundingInstanceMesh(obj,buffers);_mesh.instanceMesh.geometry.boundingBox=bounding.boundingBox,_mesh.instanceMesh.geometry.boundingSphere=bounding.boundingSphere,_mesh.instanceMesh.frustumCulled=!0}))}),(_=>{Thread.upload((function parseInstanceMesh({url:url},id){get(url).then((data=>{let buffers=[];for(let key in data)data[key].buffer=new Float32Array(data[key].buffer),buffers.push(data[key].buffer.buffer);resolve(data,id,buffers)}))})),Thread.upload((function generateBoundingInstanceMesh(e,id){let geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(e.position,3));let box=new Box3,mesh=new Mesh(geom),count=e.offset.length/3;for(let i=0;i<count;i++)mesh.position.fromArray(e.offset,3*i),mesh.quaternion.fromArray(e.orientation,4*i),mesh.scale.fromArray(e.scale,3*i),box.expandByObject(mesh);let boundingBox=box,boundingSphere=box.getBoundingSphere();resolve({boundingBox:boundingBox,boundingSphere:boundingSphere},id)}))})),Class((function MeshBatch(_input,_config){Inherit(this,Object3D);const _this=this;var _geom,_shader,_mesh,_firstRender,_static,_shaderKey,_availableIndices,_packedData,_packedTexture,_maxIndices,_renderOrder=0,_objects=[],_offset=[],_quaternion=[],_scale=[],_attributes={},_uniformToAttrib=[],_uniformNoAttrib=[],_frustumCulled=!0,_v1=new Vector3,_v2=new Vector3,_q=new Quaternion,_list=new LinkedList;async function initFromSceneLayout(){let wildcard=_input.get("wildcard");if(!wildcard||!wildcard.length)return;let groupName=wildcard.split("|")[0],group=await _this.parent.getLayer(groupName);await _this.wait(group.children,"length");let children=[...group.children];children.sort(((a,b)=>a.renderOrder-b.renderOrder)),children.forEach((mesh=>_this.add(mesh))),wildcard.includes("static")&&(_this.static=!0),_this.group.renderOrder=children[0].renderOrder,group.add(_this.group)}function updateShader(shader,castShadow){let prefetchCode=Shaders.getShader(shader.vsName+".vs");shader.customCompile=`${shader.vsName}|${shader.fsName}|instance`,shader.castShadow=castShadow;let cached=MeshBatch.shaders[`${shader.vsName}|${shader.fsName}`];if(cached)return shader.fragmentShader=shader.restoreFS=cached.fragment,shader.vertexShader=shader.restoreVS=cached.vertex,shader.resetProgram();shader.resetProgram();let vsSplit=shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__");if(!vsSplit[1].includes("vec3 pos = position;")&&!vsSplit[1].includes("pos = pos;")&&!shader.vertexShader.includes("vec3 transformPosition"))throw`Shader ${shader.vsName} needs to have "vec3 pos = position;" in order for batching to work`;let definitions=[];vsSplit[1].split("\n").forEach((line=>{if(line.includes("uniform")){if(line.includes("sampler2D"))return;let data=line.split(" "),uni=data[2].replace(";","");(function uniformToAttrib(key){key=key.trim();for(let i=0;i<_uniformToAttrib.length;i++){let val=_uniformToAttrib[i];if(key.includes(val)||val.includes(key))return!_uniformNoAttrib.includes(key)}return!1})(uni)&&(definitions.push(`${uni} = a_${data[2]}`),vsSplit[1]=vsSplit[1].replace(line,`attribute ${data[1]} a_${data[2]}\nvarying ${data[1]} ${data[2]}`),fsSplit[1]=fsSplit[1].replace(line,`varying ${data[1]} ${data[2]}`))}})),vsSplit[1]=vsSplit[1].replace(/vec3 pos = position;/g,"vec3 pos = transformPosition(position, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/pos = pos;/g,"pos = transformPosition(pos, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/vNormal = normalMatrix \* normal;/g,"vNormal = normalMatrix * transformNormal(normal, orientation);"),vsSplit[1]=vsSplit[1].replace(/vec3 transformedNormal = normal;/g,"vec3 transformedNormal = transformNormal(normal, orientation);");let main=vsSplit[1].split("main() {");main[1]="\n"+definitions.join("\n")+main[1],vsSplit[1]=main.join("main() {"),vsSplit[0]+="#define INSTANCED 1\n",fsSplit[0]+="#define INSTANCED 1\n",prefetchCode&&prefetchCode.includes("attribute vec3 offset")||(vsSplit[0]+="\n",vsSplit[0]+="attribute vec3 offset;\n",vsSplit[0]+="attribute vec3 scale;\n",vsSplit[0]+="attribute vec4 orientation;\n"),shader.vertexShader.includes("vec3 transformPosition")||(vsSplit[0]+=Shaders.getShader("instance.vs")+"\n"),_packedData&&(vsSplit[0]+="\n            attribute float batchIndex;\n            uniform vec3 uPackedInfo;\n            uniform sampler2D tPackedTexture;\n            vec2 getPackedUV(float index, float offset) {\n                float pixel = (index*uPackedInfo.x) + offset;\n            \n                float size = uPackedInfo.y;\n                float p0 = pixel / size;\n                float y = floor(p0);\n                float x = p0 - y;\n            \n                vec2 uv = vec2(0.0);\n                uv.x = x;\n                uv.y = y / size;\n                return uv;\n            }\n            \n            vec4 getPackedData(float offset) {\n                return texture2D(tPackedTexture, getPackedUV(batchIndex, offset));\n            }\n            "),vsSplit=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),fsSplit=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),shader.vertexShader=shader.restoreVS=vsSplit,shader.fragmentShader=shader.restoreFS=fsSplit,_shaderKey=`${shader.vsName}|${shader.fsName}`,MeshBatch.shaders[_shaderKey]={fragment:shader.fragmentShader,vertex:shader.vertexShader}}function modifyGeometry(dir){if(!_geom||!_geom.attributes||!_geom.attributes.offset)return;let count=_geom.attributes.offset.count+dir;_offset=new Float32Array(3*count),_scale=new Float32Array(3*count),_quaternion=new Float32Array(4*count),_geom.attributes.offset.setArray(new Float32Array(3*count)),_geom.attributes.scale.setArray(new Float32Array(3*count)),_geom.attributes.orientation.setArray(new Float32Array(4*count));for(let key in _attributes){let components=_geom.attributes[key].itemSize;_attributes[key]=new Float32Array(count*components),_geom.attributes[key].setArray(new Float32Array(count*components))}_geom.maxInstancedCount=_objects.length,loop()}function dirty(a,b){for(let i=a.length-1;i>-1;i--)if(a[i]!=b[i])return!0;return!1}function prepareMesh(mesh,i){let pos=_v1,scale=_v2,quaternion=_q;if(_config.worldCoords)try{if(_config.parent>0)switch(_config.parent){case 1:pos.copy(mesh._parent.position),scale.copy(mesh._parent.scale),quaternion.copy(mesh._parent.quaternion);break;case 2:pos.copy(mesh._parent._parent.position),scale.copy(mesh._parent._parent.scale),quaternion.copy(mesh._parent._parent.quaternion)}else _config.addParentPosition?(pos.copy(mesh.position).add(mesh._parent.position),2==_config.addParentPosition&&pos.add(mesh._parent._parent.position),scale.copy(mesh.scale),quaternion.copy(mesh.quaternion)):(pos.copy(mesh.getWorldPosition()),scale.copy(mesh.getWorldScale()),quaternion.copy(mesh.getWorldQuaternion()));_config.bypassVisibilityCheck||mesh.determineVisible()||(scale.x=scale.y=scale.z=0)}catch(e){pos.copy(mesh.position),scale.copy(mesh.scale),quaternion.copy(mesh.quaternion)}else pos.copy(mesh.position),scale.copy(mesh.scale),quaternion.copy(mesh.quaternion);let i3=3*i,i4=4*i;if(_offset[i3+0]=pos.x,_offset[i3+1]=pos.y,_offset[i3+2]=pos.z,_scale[i3+0]=scale.x,_scale[i3+1]=scale.y,_scale[i3+2]=scale.z,_quaternion[i4+0]=quaternion.x,_quaternion[i4+1]=quaternion.y,_quaternion[i4+2]=quaternion.z,_quaternion[i4+3]=quaternion.w,mesh.attributes)for(let key in mesh.attributes){let attr=mesh.attributes[key],value=void 0===attr.value?attr:attr.value;value instanceof Color?(_attributes[key][3*i+0]=value.r,_attributes[key][3*i+1]=value.g,_attributes[key][3*i+2]=value.b):value instanceof Vector3?(_attributes[key][3*i+0]=value.x,_attributes[key][3*i+1]=value.y,_attributes[key][3*i+2]=value.z):value instanceof Vector4||value instanceof Quaternion?(_attributes[key][4*i+0]=value.x,_attributes[key][4*i+1]=value.y,_attributes[key][4*i+2]=value.z,_attributes[key][4*i+3]=value.w):value instanceof Vector2?(_attributes[key][2*i+0]=value.x,_attributes[key][2*i+1]=value.y):_attributes[key][i]=value}if(_packedTexture){let batchIndex=mesh.batchIndex,stride=4*_packedTexture.keys;for(let key in _packedData){let offset=4*_packedData[key],value=mesh.packedData[key].value,index=batchIndex*stride+offset,r=g=b=a=1;value instanceof Color?(r=value.r,g=value.g,b=value.b):value instanceof Vector3?(r=value.x,g=value.y,b=value.z):value instanceof Vector4||value instanceof Quaternion?(r=value.x,g=value.y,b=value.z,a=value.w):value instanceof Vector2?(r=value.x,g=value.y):r=value,_packedTexture.data[index+0]=r,_packedTexture.data[index+1]=g,_packedTexture.data[index+2]=b,_packedTexture.data[index+3]=a}_packedTexture.needsUpdate=!0}}function updateBuffers(){if(_mesh){dirty(_quaternion,_geom.attributes.orientation.array)&&(_geom.attributes.orientation.array.set(_quaternion),_geom.attributes.orientation.needsUpdate=!0),dirty(_offset,_geom.attributes.offset.array)&&(_geom.attributes.offset.array.set(_offset),_geom.attributes.offset.needsUpdate=!0),dirty(_scale,_geom.attributes.scale.array)&&(_geom.attributes.scale.array.set(_scale),_geom.attributes.scale.needsUpdate=!0);for(let key in _attributes)dirty(_attributes[key],_geom.attributes[key].array)&&(_geom.attributes[key].array.set(_attributes[key]),_geom.attributes[key].needsUpdate=!0)}else!function initMesh(){if(_geom.addAttribute("offset",new GeometryAttribute(new Float32Array(_offset),3,1)),_geom.addAttribute("scale",new GeometryAttribute(new Float32Array(_scale),3,1)),_geom.addAttribute("orientation",new GeometryAttribute(new Float32Array(_quaternion),4,1)),_frustumCulled){let box=new Box3;_objects.forEach((mesh=>box.expandByObject(mesh,!0))),_geom.boundingBox=box,_geom.boundingSphere=box.getBoundingSphere()}_mesh=new Mesh(_geom,_shader),_shader.castShadow&&(_mesh.castShadow=!0),_mesh.asyncPromise=Promise.resolve(),_this.mesh=_mesh,_this.mesh.isMeshBatch=!0,_this.group.add(_mesh),_mesh.frustumCulled=_frustumCulled,_renderOrder&&(_mesh.renderOrder=_renderOrder),_offset=new Float32Array(_offset),_quaternion=new Float32Array(_quaternion),_scale=new Float32Array(_scale);for(let key in _attributes){_attributes[key]=new Float32Array(_attributes[key]);let components=1,attr=_objects[0].attributes[key],value=attr.value||attr;value instanceof Vector3?components=3:value instanceof Vector4||value instanceof Quaternion?components=4:value instanceof Color?components=3:value instanceof Vector2&&(components=2),_geom.addAttribute(key,new GeometryAttribute(new Float32Array(_attributes[key]),components,1))}_this.onMeshCreated&&_this.onMeshCreated(_mesh)}()}async function initializeStatic(){await(_=>{let promise=Promise.create(),mesh=_list.start(),i=0,worker=new Render.Worker((_=>{mesh.updateMatrixWorld(!0),prepareMesh(mesh,i),i++,mesh=_list.next(),mesh||(worker.stop(),promise.resolve())}),1);return promise})(),updateBuffers()}function loop(){_static&&_this.stopRender(loop,RenderManager.AFTER_LOOPS);let first=!_firstRender;_firstRender=!0;let i=0,mesh=_list.start();for(;mesh;)(!1!==mesh.batchNeedsUpdate||first)&&(first&&mesh.updateMatrixWorld(!0),prepareMesh(mesh,i)),mesh=_list.next(),i++;updateBuffers()}_input instanceof InputUILConfig||(_config=_input,_input=null),_config=_config||{},_input&&_this.parent.ready(!0).then(initFromSceneLayout),Utils3D.getTestShader().visible=!1,Hydra.LOCAL&&function initHotReload(){_this.events.sub(ShaderUIL.SHADER_UPDATE,(({shader:shader})=>{if(shader.includes(_shader.vsName)){let newShader=new Shader(_shader.vsName,_shader.fsName);delete MeshBatch.shaders[`${_shader.vsName}|${_shader.fsName}`],updateShader(newShader),Shader.renderer.hotReloadClearProgram(_shader.vsName),newShader.upload(_mesh,_geom),_shader._gl&&(_shader._gl=newShader._gl),_shader._gpu&&(_shader._gpu=newShader._gpu),_shader._metal&&(_shader._metal=newShader._metal)}}))}(),this.add=function(mesh){_objects.push(mesh),_list.push(mesh),mesh.uploadIgnore=!0,mesh.batch=_this,_availableIndices&&(mesh.batchIndex=_availableIndices.shift(),mesh.attributes||(mesh.attributes={}),mesh.attributes.batchIndex={value:mesh.batchIndex});let shader=mesh.shader;for(let key in shader.uniforms){let uniform=shader.uniforms[key];if(uniform.value instanceof Color||uniform.value instanceof Vector2||uniform.value instanceof Vector3||uniform.value instanceof Vector4||uniform.value instanceof Quaternion||"number"==typeof uniform.value)if(uniform.batchUnique||_config.batchUnique)_uniformToAttrib.push(key),mesh.attributes||(mesh.attributes={}),mesh.attributes["a_"+key]=uniform;else if(_uniformNoAttrib.includes(key)||_uniformNoAttrib.push(key),void 0!==uniform.packedIndex){if(_packedData||(_packedData={}),!_availableIndices)throw"Can't use packedData without first setting .maxIndices";_packedData[key]||(_packedData[key]=uniform.packedIndex),mesh.packedData||(mesh.packedData={}),mesh.packedData[key]=uniform}}_geom||function initGeometry(mesh){if(_geom=(new Geometry).instanceFrom(mesh.geometry),_this.geom=_geom,!_shader){if((_shader=mesh.shader.clone()).debug=!0,_packedData){let total=Object.keys(_packedData).length,pixels=Math.sqrt(_maxIndices*total),size=Math.pow(2,Math.ceil(Math.log(pixels)/Math.log(2)));(_packedTexture=new DataTexture(new Float32Array(size*size*4),size,size,Texture.RGBAFormat,Texture.FLOAT)).keys=total,_shader.addUniforms({tPackedTexture:{value:_packedTexture},uPackedInfo:{value:new Vector3(total,size,_maxIndices)}})}mesh.shader.copyUniformsTo(_shader,!0),updateShader(_shader,mesh.castShadow)}if(mesh.attributes)for(let key in mesh.attributes)_attributes[key]=[];_static&&defer(initializeStatic)}(mesh),_mesh&&(modifyGeometry(1),_static&&console.error("Don't add more meshes to a static MeshBatch")),mesh.shader.neverRender=!0,_static||_this.startRender(loop,RenderManager.AFTER_LOOPS)},this.remove=function(mesh){_objects.includes(mesh)&&(_objects.remove(mesh),_list.remove(mesh),mesh.batchIndex>-1&&(_availableIndices.push(mesh.batchIndex),_availableIndices.sort(((a,b)=>a-b))),modifyGeometry(-1))},this.onDestroy=function(){_this.mesh&&_this.mesh.destroy&&_this.mesh.destroy(),delete MeshBatch.shaders[_shaderKey]},this.loadFromFile=async function(shader,geomFile,instanceFile){geomFile.includes("assets/geometry")||(geomFile="assets/geometry/"+geomFile),geomFile.includes(".json")||(geomFile+=".json"),instanceFile.includes("assets/geometry")||(instanceFile="assets/geometry/"+instanceFile),instanceFile.includes(".json")||(instanceFile+=".json");let[geom,data]=await Promise.all([GeomThread.loadGeometry(Assets.getPath(geomFile)),get(Assets.getPath(instanceFile))]),array=[],count=data.offset.buffer.length/3;for(let i=0;i<count;i++){let mesh=new Mesh(geom,shader);mesh.position.fromArray(data.offset.buffer,3*i),mesh.scale.fromArray(data.scale.buffer,3*i),mesh.quaternion.fromArray(data.orientation.buffer,4*i),array.push(mesh),_this.add(mesh)}return await _this.ready(),array},this.ready=function(){return _this.wait("mesh")},this.getMeshByIndex=function(index){return _objects[index]},this.set("static",(b=>{_objects.length?(_config||console.warn("For better initialization performance, set meshBatch.static before adding any meshes"),loop(),_this.stopRender(loop,RenderManager.AFTER_LOOPS)):_static=!0})),this.set("maxIndices",(value=>{_maxIndices=value,_availableIndices=[];for(let i=0;i<value;i++)_availableIndices.push(i)})),this.get("attributes",(_=>_attributes)),this.get("maxIndices",(_=>_maxIndices)),this.set("renderOrder",(v=>{_renderOrder=v,_mesh&&(_mesh.renderOrder=v)})),this.get("renderOrder",(_=>_renderOrder)),this.set("frustumCulled",(b=>{_frustumCulled=b,_mesh&&(_mesh.frustumCulled=b)}))}),(_=>{MeshBatch.shaders={}})),Class((function MeshMerge(_input,_dynamic){Inherit(this,Object3D);const _this=this;var _mesh,_geom,_texture,_shaderKey,_meshes=[],_pending=[],_index=0;function initDynamic(){let array=new Float32Array(1024);(_texture=new DataTexture(array,16,16,Texture.RGBAFormat,Texture.FLOAT)).dynamic=!0,function updateShader(shader){shader.customCompile=`${shader.vsName}|${shader.fsName}|dynamicMerge`,shader.addUniforms({tDynamicMerge:{value:_texture}});let cached=MeshMerge.shaders[`${shader.vsName}|${shader.fsName}`];if(cached)return shader.fragmentShader=cached.fragment,shader.resetProgram();shader.resetProgram();let vsSplit=shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__");if(!vsSplit[1].includes("vec3 pos = position;"))throw`Shader ${shader.vsName} needs to have "vec3 pos = position;" in order for dynamic merging to work`;vsSplit[0]+="attribute float mIndex;\n",vsSplit[0]+="uniform sampler2D tDynamicMerge;\n",vsSplit[0]+="vec3 offset;\n",vsSplit[0]+="vec3 scale;\n",vsSplit[0]+="vec4 orientation;\n",shader.vertexShader.includes("vec3 transformPosition")||(vsSplit[0]+=Shaders.getShader("instance.vs")+"\n");vsSplit[0]+="\n        vec2 getDMUV(float index, float offset) {\n            float pixel = (index*3.0) + offset;\n        \n            float size = 16.0;\n            float p0 = pixel / size;\n            float y = floor(p0);\n            float x = p0 - y;\n        \n            vec2 uv = vec2(0.0);\n            uv.x = x;\n            uv.y = y / size;\n            return uv;\n        }\n        \n",vsSplit[1]=vsSplit[1].replace(/vec3 pos = position;/g,"vec3 pos = transformPosition(position, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/vNormal = normalMatrix \* normal;/g,"vNormal = normalMatrix * transformNormal(normal, orientation);"),vsSplit[1]=vsSplit[1].replace(/vec3 transformedNormal = normal;/g,"vec3 transformedNormal = transformNormal(normal, orientation);");let oso="\n        offset = texture2D(tDynamicMerge, getDMUV(mIndex, 0.0)).xyz;\n        scale = texture2D(tDynamicMerge, getDMUV(mIndex, 1.0)).xyz;\n        orientation = texture2D(tDynamicMerge, getDMUV(mIndex, 2.0));\n        ",main=vsSplit[1].split("main() {");main[1]="\n"+oso+main[1],vsSplit[1]=main.join("main() {"),vsSplit=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),shader.vertexShader=vsSplit,_shaderKey=`${shader.vsName}|${shader.fsName}`,MeshMerge.shaders[_shaderKey]={vertex:shader.vertexShader}}(_mesh.shader);let loop=_=>{for(let i=_meshes.length-1;i>-1;i--){let mesh=_meshes[i],index=mesh.mergeIndex;array[12*index+0]=mesh.position.x,array[12*index+1]=mesh.position.y,array[12*index+2]=mesh.position.z,array[12*index+3]=1,array[12*index+4]=mesh.scale.x,array[12*index+5]=mesh.scale.y,array[12*index+6]=mesh.scale.z,array[12*index+7]=1,array[12*index+8]=mesh.quaternion.x,array[12*index+9]=mesh.quaternion.y,array[12*index+10]=mesh.quaternion.z,array[12*index+11]=mesh.quaternion.w}};defer(loop),_this.startRender(loop)}function completeMerge(){_mesh.geometry=_geom,_mesh.asyncPromise.resolve(),_this.onMeshCreated&&_this.onMeshCreated(_mesh),_this.mesh=_mesh}async function initFromSceneLayout(){let wildcard=_input.get("wildcard");if(!wildcard||!wildcard.length)return;let[groupName,dynamic]=wildcard.split("|");await _this.parent.loadedAllLayers();let group=await _this.parent.getLayer(groupName);_dynamic="dynamic"==dynamic;let children=[...group.children];children.sort(((a,b)=>a.renderOrder-b.renderOrder)),children.forEach((mesh=>_this.add(mesh))),group.add(_this.group),MeshMerge.cache[_input.prefix]||(MeshMerge.cache[_input.prefix]=Promise.create())}!function(){if("object"==typeof _input){if(!1===_input.get("visible"))return;_this.parent.ready().then(initFromSceneLayout)}else"boolean"==typeof _input&&(_dynamic=_input)}(),this.onDestroy=function(){_mesh.destroy(),delete MeshBatch.shaders[_shaderKey]},this.ready=function(){return _this.wait("mesh")},this.add=function(mesh){if(mesh.uploadIgnore=!0,!mesh.visible)return;if(mesh.merge=_this,mesh.updateMatrixWorld(!0),_mesh||async function initMesh(mesh){if((_mesh=new Mesh(World.QUAD,mesh.shader)).asyncPromise=Promise.create(),_this.group.add(_mesh),_dynamic&&initDynamic(),_input?.prefix){let cached=MeshMerge.cache[_input.prefix];if(cached)return _geom=await cached,void completeMerge()}await defer();let data=await Promise.all(_pending),buffers=[];data.forEach((obj=>{for(let key in obj)obj[key].buffer&&buffers.push(obj[key].buffer)}));let merged=await Thread.shared().meshMergeComplete({data:data},buffers);_geom=new Geometry;for(let key in merged)"components"!==key&&_geom.addAttribute(key,new GeometryAttribute(merged[key],merged.components[key]));_input?.prefix&&MeshMerge.cache[_input.prefix].resolve(_geom),completeMerge()}(mesh),_input?.prefix){if(MeshMerge.cache[_input.prefix])return mesh.visible=!1,_meshes.push(mesh),void(mesh.mergeIndex=_index++)}let geom=mesh.geometry;if(mesh.attributes)for(let key in mesh.attributes){let attr=mesh.attributes[key];attr instanceof Vector4&&(attr.isVector4=!0),attr instanceof Vector3&&(attr.isVector3=!0),attr instanceof Vector2&&(attr.isVector2=!0),attr instanceof Color&&(attr.isColor=!0)}let data={},components={},buffers=[];for(let key in geom.attributes)data[key]=new Float32Array(geom.attributes[key].array),buffers.push(data[key].buffer),components[key]=geom.attributes[key].itemSize;data.attributes=mesh.attributes,data.components=components,data.matrix="world"==_input?mesh.matrixWorld.elements:mesh.matrix.elements,_dynamic&&(data.matrix=null),data.dynamic=_dynamic,data.index=mesh.mergeIndex=_index++,mesh.visible=!1,_meshes.push(mesh),_pending.push(Thread.shared().meshMergeTransform(data,buffers))},this.onDestroy=function(){_input?.prefix&&delete MeshMerge.cache[_input.prefix]}}),(_=>{Thread.upload((function meshMergeTransform(e,id){let geom=new Geometry;for(let key in e)!key.includes(["components","matrix"])&&e[key]instanceof Float32Array&&geom.addAttribute(key,new GeometryAttribute(e[key],e.components[key]));if(e.attributes)for(let key in e.attributes){let components=1,attr=e.attributes[key];attr.isVector4?components=4:attr.isVector3||attr.isColor?components=3:attr.isVector2&&(components=2);let buffer=new Float32Array(geom.attributes.position.count*components),step=buffer.length/components;for(let i=0;i<step;i++)4==components?(buffer[3*i+0]=attr.x,buffer[3*i+1]=attr.y,buffer[3*i+2]=attr.z,buffer[3*i+3]=attr.w):3==components?(buffer[3*i+0]=attr.x||attr.r||0,buffer[3*i+1]=attr.y||attr.g||0,buffer[3*i+2]=attr.z||attr.b||0):2==components?(buffer[2*i+0]=attr.x,buffer[2*i+1]=attr.y):buffer[i]=attr;geom.addAttribute(key,new GeometryAttribute(buffer,components))}e.matrix&&geom.applyMatrix((new Matrix4).fromArray(e.matrix));let indexBuffer=new Float32Array(geom.attributes.position.count);for(let i=0;i<indexBuffer.length;i++)indexBuffer[i]=e.index;geom.addAttribute("mIndex",new GeometryAttribute(indexBuffer,1));let data={},buffers=[],components={};for(let key in geom.attributes)data[key]=geom.attributes[key].array,components[key]=geom.attributes[key].itemSize,buffers.push(data[key].buffer);data.components=components,resolve(data,id,buffers)})),Thread.upload((function meshMergeComplete({data:data},id){let _geom;data.forEach((data=>{let geom=new Geometry;for(let key in data)"components"!=key&&geom.addAttribute(key,new GeometryAttribute(data[key],data.components[key]));_geom?_geom.merge(geom):_geom=geom}));let result={},components={},buffers=[];for(let key in _geom.attributes)result[key]=_geom.attributes[key].array,components[key]=_geom.attributes[key].itemSize,buffers.push(result[key].buffer);result.components=components,resolve(result,id,buffers)})),MeshMerge.shaders={},MeshMerge.cache={}})),Class((function RTPool(_type,_size=3,_format){Inherit(this,Component);const _this=this;var _pool;this.nullRT=Utils3D.createRT(2,2);var _array=[],_resizeDisabled=!1;function createRT(){let rt=Utils3D.createRT(Stage.width*World.DPR,Stage.height*World.DPR,_type,_format);return rt.index=_pool.length(),rt}function addListeners(){_resizeDisabled||_this.events.sub(Events.RESIZE,resizeHandler)}function resizeHandler(){_array.forEach((rt=>{rt.setSize(Stage.width*World.DPR,Stage.height*World.DPR)}))}!function initPool(){_pool=new ObjectPool;for(let i=0;i<_size;i++){let rt=createRT();_pool.put(rt),_array.push(rt)}}(),defer(addListeners),this.get("array",(_=>_array)),this.getRT=function(){return _pool.get()||createRT()},this.putRT=function(rt){rt.scissor&&delete rt.scissor,_pool.put(rt)},this.setSize=function(width,height){_this.disableResize(),_array.forEach((rt=>{rt.setSize(width,height)}))},this.onDestroy=function(){let p=_pool.get();for(;p;)p.dispose(),p=_pool.get()},this.clone=function(type=_type,size=_size,format=_format){return new RTPool(type,size,format)},this.disableResize=function(){_resizeDisabled=!0,_this.events.unsub(Events.RESIZE,resizeHandler)}}),"singleton"),Class((function RenderCount(){const _this=this;var $container,LOG,_map={},_display={};!async function(){await Hydra.ready(),_this.active=Utils.query("renderCount"),LOG=_this.active&&Utils.query("log"),_this.active&&async function initUIL(){await Hydra.ready(),($container=Stage.create("RenderCount")).css({width:150,height:"auto",paddingBottom:5,bottom:0}).bg("#111").setZ(9999999)}()}(),this.add=function(name,detail,amt=1){if(_this.active){if(void 0===_map[name]&&(_map[name]=0,$container)){let $wrapper=$container.create("wrapper");$wrapper.css({position:"relative",width:"100%",height:20}),$wrapper.label=$wrapper.create("label"),$wrapper.label.fontStyle("Arial",12,"#fff").text(name).css({left:10}),$wrapper.value=$wrapper.create("value"),$wrapper.value.fontStyle("Arial",12,"#fff").text(0).css({right:10}),_display[name]=$wrapper}LOG&&(console.groupCollapsed(name),detail&&console.log(detail),console.trace(),console.groupEnd()),_map[name]+=amt,_display[name].value.text(_map[name]||"0")}},this.remove=function(name,amt=1){_this.active&&_map[name]&&(_map[name]-=amt,_display[name].value.text(_map[name]||"0"))}}),"static"),Class((function RenderStats(){const _this=this;var _trace,_filter,$container,_map={},_stats={},_display={};function flush(){for(let key in _map)_stats[key]=_map[key],_display[key]&&_display[key].value.text(_map[key]||"0"),_map[key]=0;_trace=null}!async function(){await Hydra.ready(),_this.active=Utils.query("renderStats"),Utils.query("renderStats")&&async function initUIL(){await Hydra.ready(),($container=Stage.create("RenderStats")).css({position:"fixed",width:150,height:"auto",paddingTop:5}).bg("#111").setZ(99999)}(),Render.drawFrame=flush,Render.start((_=>{_this.update("FPS",Math.round(1e3/Render.DELTA))}))}(),this.update=function(name,amt=1,detail,detail2){if(_trace==name){if(_filter&&detail){if(!("string"==typeof detail?detail:Utils.getConstructorName(detail)).toLowerCase().includes(_filter.toLowerCase()))return}console.groupCollapsed(name),detail&&console.log("string"==typeof detail?detail:Utils.getConstructorName(detail)),detail2&&console.log(detail2),console.trace(),console.groupEnd()}if(void 0===_map[name]&&(_map[name]=0,$container)){let $wrapper=$container.create("wrapper");$wrapper.css({position:"relative",width:"100%",height:20}),$wrapper.label=$wrapper.create("label"),$wrapper.label.fontStyle("Arial",12,"#fff").text(name).css({left:10}),$wrapper.value=$wrapper.create("value"),$wrapper.value.fontStyle("Arial",12,"#fff").text(0).css({right:10}),_display[name]=$wrapper}_map[name]+=amt},this.trace=function(name,filter=null){_trace=name,_filter=filter},this.log=function(){for(let key in _stats)console.log(key,_stats[key]);console.log("----")}}),"static"),Class((function GameCenter(){Inherit(this,Component);let _socket,_coords,_this=this,_id=Utils.timestamp();function getCoords(){if(!_this.useCoordinates)return _coords=[0,0],Promise.resolve();let promise=Promise.create();return navigator.geolocation.getCurrentPosition((data=>{_coords=[data.coords.latitude,data.coords.longitude],_this.events.fire(_this.LOCATED),promise.resolve()}),(error=>{_this.events.fire(_this.LOCATION_ERROR)})),promise}function connected(){_this.events.fire(_this.CONNECTED),_this.events.sub(_socket,"server_data",handleServerData),_this.flag("connected",!0)}function handleServerData(e){_this.events.fire(_this.SERVER_DATA,e)}this.userData={},this.useCoordinates=!1,this.ports=1,this.maxServerConnections=900,this.CONNECTED="gamecenter_connect",this.DISCONNECTED="gamecenter_disconnected",this.LOCATION_ERROR="gamecenter_location_error",this.LOCATED="gamecenter_located",this.DATA="gamecenter_data",this.START_GAME="gamecenter_start_game",this.END_GAME="gamecenter_end_game",this.LOST_CONNECTION="gamecenter_lost_connection",this.SERVER_DATA="gamecenter_server_data",this.BROADCAST="gamecenter_server_data",this.BLOCKED_ERROR="gamecenter_blocked_error",this.connect=async function(server){let port="number"==typeof this.ports?":"+(7e3+Math.random(0,this.ports-1)):"",connectTime=0;await(async _=>{let promise=Promise.create();if(_socket&&_socket.close(),!(Date.now()-connectTime<100))return connectTime=Date.now(),_this.server=server,_socket=new SocketConnection(server+port),_this.socket=_socket,_this.events.sub(_socket,SocketConnection.OPEN,(_=>{promise.resolve(),connected()})),_this.events.sub(_socket,SocketConnection.BLOCKED,(_=>{_this.events.fire(_this.BLOCKED_ERROR),AppState.set(_this.BLOCKED_ERROR,!0),_this.BLOCKED=!0})),_this.events.sub(_socket,SocketConnection.CLOSE,(_=>{_this.BLOCKED||(_this.flag("connected",!1),_this.events.fire(_this.LOST_CONNECTION,{reconnected:_=>_this.wait("connected")}))})),_this.events.sub(_socket,SocketConnection.ERROR,(_=>{_this.BLOCKED||(_this.flag("connected",!1),_this.events.fire(_this.LOST_CONNECTION,{reconnected:_=>_this.wait("connected")}))})),_this.events.sub(_socket,"broadcast",(e=>{_this.events.fire(_this.BROADCAST,e)})),promise})(),_this.flag("initialized",!0)},this.locateUser=function(){getCoords()},this.findRoom=async function(type="any",config){await _this.wait("initialized");let promise=Promise.create(),find=function(){_this.roundTrip("findAny",{coords:_coords,type:type,forceNewRoom:config.forceNewRoom},(async data=>{let room=new GameCenterRoom(data.id,_socket);type.includes("community")&&room.communityRoom();try{await room.join(config),promise.resolve(room)}catch(e){promise.reject()}}))};return _coords?find():getCoords().then(find),promise},this.joinRoom=async function(id,config,watcher){await _this.wait("initialized");try{let room=new GameCenterRoom(id,_socket);return id.includes("community")&&room.communityRoom(),await room.join(config,watcher),room}catch(e){throw"Couldn't join!"}},this.watchRoom=async function(id,watcher){await _this.wait("initialized");try{let room=new GameCenterRoom(id,_socket);return id.includes("community")&&room.communityRoom(),await room.watch(watcher),room}catch(e){throw"Couldn't join!"}},this.findNearby=async function(type="any"){await _this.wait("initialized");let promise=Promise.create();if(!this.useCoordinates)throw"findNearby requires user coords";let find=function(){_this.roundTrip("findNearby",{coords:_coords,type:type},(data=>{promise.resolve(data)}))};return _coords?find():getCoords().then(find),promise},this.roundTrip=function(evt,data,callback){let receive=e=>{_this.events.unsub(_socket,evt+"_response",receive),callback&&callback(e)};_this.events.sub(_socket,evt+"_response",receive),_socket.send(evt,data)},this.sendData=function(data={}){_socket&&(data.id=_id,_socket.send("server_data",data))},this.broadcast=function(data={}){_socket.send("broadcast",data)},this.locateServer=function(roomId){let promise=Promise.create();return _this.roundTrip("locate_server",{roomId:roomId},promise.resolve),promise},this.getRoomCount=async function(roomId){let promise=Promise.create();return _this.roundTrip("roomCount",{roomId:roomId},promise.resolve),promise},this.get("coords",(v=>{_coords=v})),this.get("coords",(_=>_coords))}),"static"),Class((function GameCenterPlayer(_id,_socket,_data,_initiator,_community){Inherit(this,Component);var _this=this,_evt={target:_this,id:_id},_results=[],_messages={},_lastMessage=Render.TIME;function sendPing(){if(_results.length>=3)return;let message={_ping:!0};message.id=Utils.timestamp(),message.outTime=Date.now(),message.to=_id,message.from=GameCenter.GCID,_messages[message.id]=message,_this.emit(message)}function handlePing(data){if(_messages[data.id]){let difference=Date.now()-data.inTime;_results.unshift(difference),_this.offset=difference,_results.length<3?sendPing():function calculate(){_this.flag("ready",!0),_this.events.fire(Events.READY),_results.length>3&&(_results=_results.slice(0,3)),_results.sort(((a,b)=>a-b)),_this.offset=_results[1]}()}else data.inTime=Date.now(),_this.emit(data)}function onMessage(data){if(!data.to||data.to==GameCenter.GCID){if(_this.ping=Render.TIME-_lastMessage,_lastMessage=Render.TIME,data._ping)return handlePing(data);_evt.player=_this,_evt.data=data,_this.events.fire(GameCenter.DATA,_evt)}}function ready(e){_this.connection.isNull||_this.parent.flag("watcher")||(e.socket&&_this.events.fire(GameCenterPlayer.FALLBACK_SOCKET),_this.delayedCall((()=>{sendPing()}),10))}this.connection=_this.initClass(_community?GameCenterNull:GameCenterRTC,_id,_socket,_initiator,_this),this.id=_id,this.data=_data,this.offset=0,this.ping=0,function addListeners(){_this.connection.isNull||(_this.events.sub(_this.connection,Events.READY,ready),_this.events.bubble(_this.connection,Events.ERROR),_this.connection.onMessage=onMessage)}(),this.onMessage=onMessage,this.emit=function(data){_this.connection.emit(data.length?data:JSON.stringify(data))},this.disconnect=function(){_this.connection.close(),_this.events.fire(GameCenter.DISCONNECTED)},this.connected=function(){return _this.wait("ready")},this.sever=function(){_this.videos?.forEach((v=>v.destroy()))}}),(_=>{GameCenterPlayer.UPDATE_DATA="gcp_update_data",GameCenterPlayer.FALLBACK_SOCKET="gcp_fallback_socket"})),Class((function GameCenterUser(_socket,_community){Inherit(this,Component);this.connection=new(_community?GameCenterSocket:GameCenterNull)(_socket),this.me=!0,this.data=GameCenter.userData,this.id=GameCenter.GCID,this.disconnect=function(){}})),Class((function GameCenterConnection(){Inherit(this,Component);this.establish=function(){},this.emit=function(){},this.wsData=function(){}})),Class((function GameCenterNull(){const prototype=GameCenterNull.prototype;void 0===prototype.establish&&(prototype.isNull=!0,prototype.establish=function(){},prototype.emit=function(){},prototype.wsData=function(){},prototype.close=function(){})})),Class((function GameCenterRTC(_id,_socket,_initiator,_parent){Inherit(this,Component);var _peer,_data,_fallbackSocket,_timeout,_this=this;function fallbackToSocket(){clearTimeout(_timeout),_socket.send("ws_data",{from:GameCenter.GCID,fallbackToSocket:!0}),_fallbackSocket=!0,_this.events.fire(Events.READY,{socket:!0})}function sendNegotiation(type,sdp){let data={to:_id,type:type,sdp:sdp};_socket.send("establish_rtc",data)}function dataMessage(e){_this.onMessage&&_this.onMessage(JSON.parse(e.data))}function dataOpen(e){_this.events.fire(Events.READY)}function dataClose(e){clearTimeout(_timeout),_this.events.fire(Events.ERROR,{gcID:_id})}function dataError(e){_this.events.fire(Events.ERROR,{gcID:_id})}!function initPeerConnection(){_peer=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),_timeout=_this.delayedCall(fallbackToSocket,7e3),_peer.onicecandidate=e=>{_peer&&e&&e.candidate&&sendNegotiation("candidate",e.candidate)},(_data=_peer.createDataChannel("gamecenter",{ordered:!1,negotiated:!0,id:7})).onmessage=dataMessage,_data.onopen=dataOpen,_data.onclose=dataClose,_data.onerror=dataError,_peer.ondatachannel=e=>{e.channel.onmessage=dataMessage,e.channel.onclose=dataClose,e.channel.onerror=dataError},_peer.onconnectionstatechange=e=>{switch(_peer.iceConnectionState){case"connected":_this.flag("connected",!0),clearTimeout(_timeout);break;case"disconnected":_this.flag("connected",!1)}},_peer.oniceconnectionstatechange=e=>{"failed"==_peer.iceConnectionState&&fallbackToSocket()}}(),_initiator&&async function initConnection(){let sdp=await _peer.createOffer();_peer.setLocalDescription(sdp),sendNegotiation("offer",sdp)}(),this.establish=function(data){if(_peer)switch(data.type){case"candidate":!function processIce(iceCandidate){if(!_this.flag("connected"))try{_peer.addIceCandidate(new RTCIceCandidate(iceCandidate))}catch(e){_this.events.fire(Events.ERROR,{gcID:_id})}}(data.sdp);break;case"offer":!async function processOffer(offer){if(!_this.flag("connected"))try{await _peer.setRemoteDescription(new RTCSessionDescription(offer));let sdp=await _peer.createAnswer();_peer.setLocalDescription(sdp).catch((e=>_this.events.fire(Events.ERROR,{gcID:_id}))),sendNegotiation("answer",sdp)}catch(e){}}(data.sdp);break;case"answer":!async function processAnswer(answer){if(!_this.flag("connected")){try{await _peer.setRemoteDescription(new RTCSessionDescription(answer))}catch(e){_this.events.fire(Events.ERROR,{gcID:_id})}return!0}}(data.sdp)}},this.emit=function(data){if("string"!=typeof data&&(data=JSON.stringify(data)),_fallbackSocket)_socket.sendBinary(data);else{if(_data&&"open"!=_data.readyState)return;try{_data&&_data.send(data)}catch(e){}}},this.wsData=function(data){if(data.fallbackToSocket)return _fallbackSocket=!0,void _this.events.fire(Events.READY);_this.onMessage&&_this.onMessage(data)},this.close=function(){_peer&&(_peer.close(),_peer.onconnectionstatechange=null,_peer.ondatachannel=null,_peer.oniceconnectionstatechange=null,_peer.onicecandidate=null,_peer=null,clearTimeout(_timeout))}})),Class((function GameCenterSocket(_socket){Inherit(this,Component);this.emit=function(data={}){_socket.sendBinary(data)}})),Class((function GameCenterRoom(_id,_socket){Inherit(this,Component);const _this=this;var _aliveTimer,_fallbackSocket,_roomConfig;this.id=_id,this.host=!1,this.players=[];var _waiting={},_pending=[],_playerMap=new Map,_players=_this.players;function handlePlayers(players){let player;players.forEach(((obj,i)=>{obj.id==GameCenter.GCID?player=new GameCenterUser(_socket,_this.isCommunity):(player=_playerMap.get(obj.id),player||(player=createPlayer(obj.id,obj.data),_playerMap.set(obj.id,player))),_players[i]=player}))}function createPlayer(id,data,init){data.data&&(data=data.data);let player=_this.initClass(GameCenterPlayer,id,_socket,data,init,_this.isCommunity);return _this.events.sub(player,GameCenter.DATA,playerData),_this.events.sub(player,Events.ERROR,playerDisconnect),_this.events.sub(player,GameCenterPlayer.FALLBACK_SOCKET,fallbackSocket),_this.events.sub(player,Events.READY,(async()=>{await defer(),_this.events.fire(GameCenterRoom.PLAYER_READY,{player:player})})),_waiting[id]&&_waiting[id].resolve(player),player}function fallbackSocket(){_fallbackSocket=!0}function alive(){_socket.send("alive"),Render.blurTime>0&&Date.now()-Render.blurTime>(_roomConfig.timeoutDisconnect||6e6)&&(forceDisconnect(),_this.leave&&_this.leave())}function requestInitialState(){if(_this.events)try{_socket.send("request_state")}catch(e){setTimeout(requestInitialState,50)}}function addListeners(){_this.events.sub(_socket,"player_disconnect",playerDisconnect),_this.events.sub(_socket,"become_host",becomeHost),_this.events.sub(_socket,"open_connection",openConnection),_this.events.sub(_socket,"establish_rtc",establishRTC),_this.events.sub(_socket,"ws_data",websocketData),_this.events.sub(_socket,"promote_watcher",promoteWatcher),_this.events.sub(_socket,"rebroadcast_players",rebroadcastPlayers),_this.events.sub(_socket,"start_game",startGame),_this.events.sub(_socket,"end_game",endGame),_this.events.sub(_socket,"force_disconnect",forceDisconnect),_this.events.sub(_socket,"update_user_data",updateUserData),_this.events.sub(_socket,"pin",handlePin),_this.events.sub(_socket,"unpin",handleUnpin),_this.events.sub(GameCenter.LOST_CONNECTION,closeRoom),_this.events.sub(_socket,SocketConnection.BINARY,communityData)}function updateUserData({data:data}){_players.forEach((player=>{player.id==data.gcID&&(player.data=data.data,player.data.data&&(player.data=player.data.data),player.events.fire(GameCenterPlayer.UPDATE_DATA,{player:player,data:player.data}))}))}function forceDisconnect(e){_this.events.fire(GameCenterRoom.ERROR)}function closeRoom(){_this.destroy()}function startGame(e){_this.events.fire(GameCenter.START_GAME,e),_this.playing=!0}function endGame(e){_this.events.fire(GameCenter.END_GAME,e),_this.playing=!1}function establishRTC(e){let found=!1;if(_players.forEach((player=>{player.id==e.from&&(found=!0,player.connection.establish(e))})),!found){let player=createPlayer(e.from,e.data);_players.push(player),_playerMap.set(e.gcID,player),player.connection.establish(e)}}function playerDisconnect(e){let toRemove;_playerMap.delete(e.gcID),_players.forEach((player=>{player.id==e.gcID&&(player.disconnect(),toRemove=player,_this.events.fire(GameCenterRoom.PLAYER_DISCONNECT,{player:player}),player.destroy())})),toRemove&&_players.remove(toRemove)}function becomeHost(e){_this.host=!0,_this.events.fire(GameCenterRoom.BECOME_HOST)}function rebroadcastPlayers({data:data}){data.forEach((obj=>{obj.id!=GameCenter.GCID&&(obj.gcID=obj.id,openConnection(obj))}))}function openConnection(e){if(_playerMap.has(e.gcID))return;let player=createPlayer(e.gcID,e.data,!0);_playerMap.set(e.gcID,player),_players.push(player),_this.events.fire(GameCenterRoom.PLAYER_JOIN,{player:player})}function playerData(e){_this.events.fire(GameCenter.DATA,e)}function websocketData(e){let player=_playerMap.get(e.from);player&&player.connection.wsData(e)}function promoteWatcher(){_this.flag("canPromote")&&(_this.join(),_this.events.fire(GameCenterRoom.PROMOTED))}function communityData({data:data}){_pending.length=0;for(let i=data.length-1;i>-1;i--){let obj=data[i],player=_playerMap.get(obj.from);player&&!_pending.includes(obj.from)&&(player.onMessage(obj),_pending.push(obj.from))}}function handlePin(e){let player;_players.forEach((p=>{p.id==e.message.playerId&&(player=p)})),_this.events.fire(GameCenterRoom.PIN,{message:e.message,player:player})}function handleUnpin(e){let player;_players.forEach((p=>{p.id==e.message.playerId&&(player=p)})),_this.events.fire(GameCenterRoom.UNPIN,{message:e.message,player:player})}this.onDestroy=function(){this.leave&&this.leave()},this.updateUserData=function(data=GameCenter.userData){GameCenter.userData=data,GameCenter.GCID&&_socket.send("update_user_data",{gcID:GameCenter.GCID,data:data})},this.create=function(type,data={}){_this.host=!0,GameCenter.roundTrip("create",{id:_id,coords:GameCenter.coords,type:type,MAX_IN_ROOM:data.maxInRoom,TIMEOUT_DISCONNECT:data.timeoutDisconnect},_this.join)},this.join=function(data={}){if(_this.flag("joined"))return Promise.resolve();_this.flag("joined",!0),_this.flag("watching",!1);let promise=Promise.create();return(_roomConfig=data).timeoutDisconnect>0&&(_roomConfig.timeoutDisconnect=Math.max(_roomConfig.timeoutDisconnect,5e3)),GameCenter.roundTrip("join",{id:_id,user:GameCenter.userData,MAX_IN_ROOM:data.maxInRoom,TIMEOUT_DISCONNECT:data.timeoutDisconnect,type:data.type},(e=>{if(!e.success)return promise.reject();e.host&&(_this.host=!0),GameCenter.GCID=e.myID,GameCenter.SERVER_ID=e.serverId,handlePlayers(e.players),addListeners(),_aliveTimer=setInterval(alive,4e3),promise.resolve(),setTimeout(requestInitialState,500)})),promise},this.watch=function(canPromote){let promise=Promise.create();return _this.flag("canPromote",canPromote),_this.flag("watching",!0),GameCenter.roundTrip("watch",{id:_id,user:GameCenter.userData},(e=>{if(!e.success)return promise.reject();GameCenter.GCID=e.myID,handlePlayers(e.players),addListeners(),promise.resolve()})),promise},this.leave=function(){_this.leave=null,clearTimeout(_aliveTimer),_this.flag("joined",!1),_players.forEach((player=>player.disconnect())),GameCenter.roundTrip("leave",{id:_id,user:GameCenter.userData}),_this.destroy()},this.broadcast=function(data){if(_players.length&&!_this.flag("watching")){data.from=GameCenter.GCID,_fallbackSocket||_this.isCommunity||(data=JSON.stringify(data));for(let i=0;i<_players.length;i++)_players[i].connection.emit(data)}},this.start=function(data){_this.host&&_socket.send("start_game",data)},this.end=function(data){_this.host&&_socket.send("end_game",data)},this.pin=function(data,timeInSeconds=5){data.playerId=GameCenter.GCID,_socket.send("pin",{message:data,time:timeInSeconds,userData:GameCenter.userData,playerId:GameCenter.GCID})},this.unpin=function(data){data.playerId=GameCenter.GCID,_socket.send("unpin",{playerId:GameCenter.GCID,message:data})},this.communityRoom=function(){_this.isCommunity=!0},this.waitForPlayer=function(id){return _playerMap.has(id)?_playerMap.get(id):(_waiting[id]=Promise.create(),_waiting[id])},this.get("me",(_=>{for(let i=0;i<_players.length;i++){let player=_players[i];if(player.me)return player}})),this.get("watcher",(_=>_this.flag("watching")))}),(()=>{GameCenterRoom.PLAYER_DISCONNECT="gc_room_player_dc",GameCenterRoom.BECOME_HOST="gc_become_host",GameCenterRoom.PLAYER_JOIN="gc_player_join",GameCenterRoom.PLAYER_READY="gc_player_ready",GameCenterRoom.PROMOTED="gc_player_promoted",GameCenterRoom.ERROR="gc_room_error",GameCenterRoom.PIN="gc_room_pin",GameCenterRoom.UNPIN="gc_room_unpin"})),Class((function GameCenterMedia(){Inherit(this,Component);const _this=this;var _room,_client,_applicationId,_secret,_mode,_channel,_server,_roomID,_remote={},_screenShare={};this.state=AppState.createLocal(),this.videoStream=!1,this.audioStream=!1,this.p2p=!1,this.simulcast=!0,this.streamingSimulcast=!1,this._outputDevice=Storage.get("gcmedia_output_device"),this.videoDimensions={width:640,height:480},this.UPDATE_PLAYER_VIDEO="game_center_media_video_update",this.SCREEN_SHARE_TOGGLE="game_center_media_screen_share_toggle";const DEBUG=Utils.query("debugFM");async function register(){DEBUG&&console.log("FROZEN MOUNTAIN CONNECTING",_roomID);let channels=[new fm.liveswitch.ChannelClaim(_roomID)],token=fm.liveswitch.Token.generateClientRegisterToken(_applicationId,_client.getUserId(),_client.getDeviceId(),_client.getId(),null,channels,_secret),channelResponse=await _client.register(token);if(!channelResponse||!channelResponse.length)return _this.delayedCall(register,250);let channel=channelResponse[0];channel.addOnRemoteClientJoin(clientJoin),channel.addOnRemoteClientLeave(clientLeave),channel.addOnRemoteUpstreamConnectionOpen(upstreamConnectionOpen),channel.addOnRemoteUpstreamConnectionClose(upstreamConnectionClose),channel.addOnMcuVideoLayout(onMCULayout),channel.addOnPeerConnectionOffer(onPeerConnection),_channel=channel,function createLocalPlayer(){switch(_mode){case"sfu":_channel.getRemoteUpstreamConnectionInfos().forEach(upstreamConnectionOpen);break;case"p2p":_channel.getRemoteClientInfos().forEach(clientJoin)}_this.local=_this.initClass(GameCenterMediaLocal,_room.me,_roomID,GameCenter.GCID,_mode)}()}async function unregister(){_this.userStream&&_this.userStream.reset(!1,!1),_this.local&&(_this.local=_this.local.destroy());for(let key in _remote){try{for(let id in _remote[key])_remote[key][id].destroy()}catch(e){}delete _remote[key]}await function unregisterClient(){let promise=Promise.create(),tryUnregister=async _=>{try{await _client.unregister(),promise.resolve()}catch(e){_this.delayedCall(tryUnregister,100)}};return tryUnregister(),promise}(),_this.fmLoadBalancer&&(_client=null)}function updateBitrateAndResolution(){let connections=_channel.getRemoteClientInfos().length;if(_this.maxBitrate&&(_this.local?.updateBitrate(_this.maxBitrate/(connections+1)),_this.videoStream)){let{width:width,height:height}=_this.videoDimensions;connections>5&&(width=480,height=320),connections>10&&(width=320,height=213),connections>20&&(width=160,height=107),_this.local?.updateResolution(width,height)}}async function clientJoin(connectionInfo){if(_room&&_room.waitForPlayer){if(_this.p2p){let id=connectionInfo.getUserId(),player=await _room.waitForPlayer(id),blocked=window.User&&DreamModeration?.isBlocked(player.data.uid);_remote[id]||(_remote[id]={}),_remote[id][connectionInfo.getDeviceId()]=_this.initClass(blocked?GameCenterMediaDummy:GameCenterMediaRemote,player,_roomID,id,_mode,connectionInfo)}"sfu"==_mode&&updateBitrateAndResolution()}}function clientLeave(connectionInfo){let id=connectionInfo.getUserId();if(_remote[id]){for(let key in _remote[id])try{_remote[id][key].destroy()}catch(e){}delete _remote[id]}"sfu"==_mode&&updateBitrateAndResolution()}async function upstreamConnectionOpen(connectionInfo){if(!_room||!_room.waitForPlayer)return;let id=connectionInfo.getUserId(),player=await _room.waitForPlayer(id);_remote[id]||(_remote[id]={});let blocked=window.User&&DreamModeration?.isBlocked(player.data.uid);_remote[id][connectionInfo.getDeviceId()]=_this.initClass(blocked?GameCenterMediaDummy:GameCenterMediaRemote,player,_roomID,id,_mode,connectionInfo),"sfu"==_mode&&updateBitrateAndResolution()}async function upstreamConnectionClose(connectionInfo){if(!_room||!_room.waitForPlayer)return;let id=connectionInfo.getUserId(),deviceId=(await _room.waitForPlayer(id),connectionInfo.getDeviceId());if(_remote[id]&&_remote[id][deviceId]){try{_remote[id][deviceId].destroy()}catch(e){}delete _remote[id][deviceId]}"sfu"==_mode&&updateBitrateAndResolution()}function onMCULayout(layout){}async function onPeerConnection(peerConnectionOffer){let connectionInfo=peerConnectionOffer.getRemoteClientInfo(),id=connectionInfo.getUserId(),deviceId=connectionInfo.getDeviceId(),player=await _room.waitForPlayer(id);window.User&&DreamModeration?.isBlocked(player.data.uid)||_remote[id][deviceId]?.connectPeer(peerConnectionOffer)}function onPlayerDisconnect({player:player}){let id=player.id;if(_remote[id]){for(let key in _remote[id])try{_remote[id][key].destroy()}catch(e){}delete _remote[id]}}async function createClient(){if(!_room)return;let server=_server;_this.fmLoadBalancer&&(server=await function getLBServer(){let promise=Promise.create(),tryGet=async _=>{try{let data=await get(`${_this.fmLoadBalancer}?room=${_roomID}`);promise.resolve(data)}catch(e){_this.delayedCall(tryGet,250)}};return tryGet(),promise}()),_client=new fm.liveswitch.Client(server,_applicationId,Utils.uuid(),Utils.uuid())}async function load(){await AssetLoader.loadAssets(["~assets/js/lib/fm.liveswitch.js"]),await createClient(),_this.flag("loaded",!0),_this.flag("mount",!0),DEBUG&&(fm.liveswitch.Log.setLogLevel(fm.liveswitch.LogLevel.Debug),fm.liveswitch.Log.registerProvider(new fm.liveswitch.ConsoleLogProvider(fm.liveswitch.LogLevel.Debug)))}this.state.set("hasMediaAccess","pending"),this.hasMediaAccess=!0,this.connect=async function(server,applicationId,secret){_applicationId=applicationId,_secret=secret,_server=server},this.useRoom=async function(room){if(_room&&(null===room?(_this.state.set("lowBandwidth",!1),_this.videoStream=!1,_this.audioStream=!1,_this.p2p=!1,_client&&await unregister()):!1===room&&_client&&await unregister()),_room=room,(_this.audioStream||_this.videoStream)&&(_this.flag("mount")||load(),await _this.mounted()),_room){if(_roomID=_room.mediaId||_room.id,_this.videoStream&&(_this.audioStream=!0),!_this.audioStream&&!_this.videoStream)return _this.userStream&&_this.userStream.reset(_this.audioStream,_this.videoStream),!1;_client||await createClient(),_this.userStream?_this.userStream.reset(_this.audioStream,_this.videoStream):_this.userStream=_this.initClass(GameCenterMediaUserStream,this.videoDimensions),_mode=_this.p2p?"p2p":"mcu"==_this.simulcast?"mcu":"sfu",_client.setUserId(GameCenter.GCID),_this.events.sub(_room,GameCenterRoom.PLAYER_DISCONNECT,onPlayerDisconnect),await register()}},this.mounted=function(){return _this.flag("mount")||load(),_this.wait("loaded")},this.getUserVideo=async function(width=this.videoDimensions.width,height=this.videoDimensions.height,noReset){return"boolean"==typeof width&&(noReset=width,width=this.videoDimensions.width,height=this.videoDimensions.height),await this.getUserStreamReference(width,height,noReset),_this.userStream.video},this.getUserStreamReference=async function(width=this.videoDimensions.width,height=this.videoDimensions.height,noReset){return _this.userStream||(_this.flag("mount")||load(),await _this.mounted(),_this.userStream||(_this.userStream=_this.initClass(GameCenterMediaUserStream,{width:width,height:height}))),noReset||_this.userStream.reset(!0,!0),await _this.wait("userStream"),await _this.userStream.ready(),_this.userStream},this.getUserStream=async function(){return await _this.wait("userStream"),_this.userStream.getStream()},this.shareScreen=async function(){let screen=_this.initClass(GameCenterMediaUserStream,null,!0);await screen.ready(),screen.media.addOnVideoStopped(_this.stopScreenShare);let media=_this.initClass(GameCenterMediaLocal,_room.me,_roomID,GameCenter.GCID,_mode,screen);_screenShare={isActive:!0,screen:screen,media:media},_this.events.fire(_this.SCREEN_SHARE_TOGGLE,{isSharing:!0,media:media})},this.stopScreenShare=function(){_screenShare.isActive&&_screenShare.screen.destroy&&_screenShare.media.destroy&&(_screenShare.screen.destroy(),_screenShare.media.destroy(),_screenShare.isActive=!1,_this.events.fire(_this.SCREEN_SHARE_TOGGLE,{isSharing:!1}))},this.get("_channel",(_=>_channel)),this._setOutputDevice=function(id){Storage.set("gcmedia_output_device",id),_this._outputDevice=id;for(let key in _remote)_this.wait(_remote[key],"video").then((()=>{_remote[key].video&&_remote[key].video.setSinkId(id)}))},this.requestAllPermissions=async function(){let promise=Promise.create();try{await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),promise.resolve("yes")}catch(e){try{await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),promise.resolve("yes")}catch(e){promise.resolve("no"),_this._setMediaAccessFail()}}return promise},this.requestAudioPermissions=async function(){let promise=Promise.create();try{await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),promise.resolve("yes")}catch(e){promise.resolve("no"),_this._setMediaAccessFail()}return promise},this._setMediaAccessFail=function(){_this.state.set("hasMediaAccess","fail"),_this.hasMediaAccess=!1},this._setHasMediaAccess=function(){_this.hasMediaAccess=!0,_this.state.set("hasMediaAccess","success")}}),"static"),Class((function GameCenterMediaDummy(){Inherit(this,Component);this.connectPeer=function(){}})),Class((function GameCenterMediaLocal(_playerObj,_roomId,_playerId,_mode,_screenShare){Inherit(this,Component);const _this=this;var _connection,_media;this.id=_playerId,this.player=_playerObj,async function(){let userStream=_screenShare||_this.parent.userStream;if(await userStream.ready(),_media=userStream.media,!_this.initClass||!_playerObj)return;_playerObj.videos||(_playerObj.videos=[]),_playerObj.videos.push(_this),_this.isScreenShare=userStream.isScreenShare,_this.video=userStream.video,_this.video&&(_this.video.autoplay=!0,_this.video.volume=1e-4,_this.videoTexture=_this.initClass(StreamVideoTexture,_this.video),_this.flag("videoTextureReady",!0)),_playerObj.events.fire(GameCenterMedia.UPDATE_PLAYER_VIDEO,{media:_this,type:"add"});let sinkId=Storage.get("gcmedia_output_device");sinkId&&_this.video?.setSinkId(sinkId),_screenShare||userStream.resetAnalyzer();let audioStream=_this.parent.audioStream?new fm.liveswitch.AudioStream(_media):void 0,videoStream=_this.parent.videoStream?new fm.liveswitch.VideoStream(_media):void 0,createSFU=_=>{videoStream?.setSimulcastMode(fm.liveswitch.SimulcastMode.Disabled),_connection=_this.parent._channel.createSfuUpstreamConnection(audioStream,videoStream,null),_this.parent.maxBitrate&&_this.updateBitrate(_this.parent.maxBitrate/(_this.parent._channel.getRemoteClientInfos().length+1)),_connection.addOnStateChange((_=>{switch(_connection.getState()){case fm.liveswitch.ConnectionState.Failed:"sfu"===_mode&&createSFU()}})),_connection.open()};"sfu"===_mode&&createSFU()}(),this.getVideoTexture=async function(){return await _this.wait("videoTextureReady"),_this.videoTexture},this.onDestroy=async function(){PlayerModel.set("gcmedia_speaking",!1),_connection&&_connection.close(),_playerObj?.videos?.remove(_this),_playerObj?.events.fire(GameCenterMedia.UPDATE_PLAYER_VIDEO,{media:_this,type:"remove"}),_screenShare&&_media?.stop()},this.updateBitrate=function(bitrate){if(!_screenShare)try{_connection.getVideoStream().setMaxSendBitrate(bitrate)}catch(e){_this.delayedCall((_=>_this.updateBitrate(bitrate)),500)}},this.updateResolution=function(width,height){if(!_screenShare)try{media._getInternal()._videoMediaStream.getVideoTracks()[0].applyConstraints({width:width,height:height})}catch(e){_this.delayedCall((_=>_this.updateResolution(width,height)),500)}}})),Class((function GameCenterMediaRemote(_playerObj,_roomId,_remoteId,_mode,_connectionInfo){Inherit(this,Component);const _this=this;var _connection,_local;this.player=_playerObj,this.id=_remoteId,async function(){let remoteMedia=new fm.liveswitch.RemoteMedia;if(remoteMedia.setAudioMuted(!1),remoteMedia.setVideoMuted(!_connectionInfo.getHasVideo()),_connectionInfo.getHasVideo()){if(_this.video=await function getVideo(remoteMedia){let promise=Promise.create(),timer=_this.delayedCall((_=>{console.warn("5 second timeout getting remote video")}),5e3);function loop(){let video=remoteMedia.getView().childNodes[0];video&&(clearTimeout(timer),Render.stop(loop),promise.resolve(video))}return Render.start(loop),promise}(remoteMedia),!_this.initClass)return;if(_this.video.autoplay=!0,_this.videoTexture=_this.initClass(StreamVideoTexture,_this.video),_playerObj.videos||(_playerObj.videos=[]),_playerObj.videos.push(_this),_this.isScreenShare=_playerObj.videos.indexOf(_this)>0,!_this.isScreenShare){let speaking;GameCenterMedia.state.bind("lowBandwidth",(isLowBandwidth=>{isLowBandwidth?speaking=_playerObj.dreamPlayer?.state.bind("gcmedia_speaking",(isSpeaking=>{isSpeaking?(remoteMedia.setVideoMuted(!1),_playerObj.dreamPlayer?.state.set("gcmedia_mute_video",!1)):(remoteMedia.setVideoMuted(!0),_playerObj.dreamPlayer?.state.set("gcmedia_mute_video",!0))})):speaking?.destroy?.()}))}}let sinkId=Storage.get("gcmedia_output_device");sinkId&&_this.video?.setSinkId(sinkId);let connectSFU=_=>{let audioStream=_this.parent.audioStream?new fm.liveswitch.AudioStream(remoteMedia):void 0,videoStream=_connectionInfo.getHasVideo()?new fm.liveswitch.VideoStream(remoteMedia):void 0;if(videoStream&&_connectionInfo.getHasVideo()){let encodings=_connectionInfo.getVideoStream().getSendEncodings();encodings&&encodings.forEach((e=>videoStream.setRemoteEncoding(e)))}(_connection=_this.parent._channel.createSfuDownstreamConnection(_connectionInfo,audioStream,videoStream,null)).addOnStateChange((_=>{switch(_connection.getState()){case fm.liveswitch.ConnectionState.Failed:connectSFU();break;case fm.liveswitch.ConnectionState.Connected:_playerObj.events.fire(GameCenterMedia.UPDATE_PLAYER_VIDEO,{media:_this,type:"add"})}})),_connection.open()},connectP2P=async _=>{await _this.parent.userStream.ready();let media=_this.parent.userStream.media,audioStream=_this.parent.audioStream?new fm.liveswitch.AudioStream(media,remoteMedia):void 0,videoStream=_connectionInfo.getHasVideo()?new fm.liveswitch.VideoStream(media,remoteMedia):void 0;(_connection=_this.parent._channel.createPeerConnection(_connectionInfo,audioStream,videoStream)).addOnStateChange((_=>{switch(_connection.getState()){case fm.liveswitch.ConnectionState.Failed:connectP2P()}})),_connection.open()};"sfu"==_mode&&connectSFU(),"p2p"==_mode&&connectP2P()}(),this.connectPeer=async function(peerData){let remoteMedia=new fm.liveswitch.RemoteMedia;remoteMedia.setAudioMuted(!1),remoteMedia.setVideoMuted(!_this.parent.videoStream),await _this.parent.userStream.ready();let connect=_=>{let media=_this.parent.userStream.media,audioStream=_this.parent.audioStream?new fm.liveswitch.AudioStream(media,remoteMedia):void 0,videoStream=_connectionInfo.getHasVideo()?new fm.liveswitch.VideoStream(media,remoteMedia):void 0;(_local=_this.parent._channel.createPeerConnection(peerData,audioStream,videoStream)).addOnStateChange((_=>{switch(_local.getState()){case fm.liveswitch.ConnectionState.Failed:connect();break;case fm.liveswitch.ConnectionState.Connected:_playerObj.events.fire(GameCenterMedia.UPDATE_PLAYER_VIDEO,{media:_this,type:"add"})}})),_local.open()};connect()},this.onDestroy=function(){_local&&_local.close&&_local.close(),_connection&&_connection.close&&_connection.close(),_playerObj?.videos?.remove(_this),_playerObj?.events?.fire(GameCenterMedia.UPDATE_PLAYER_VIDEO,{media:_this,type:"remove"})}})),Class((function GameCenterMediaUserStream(_dimensions,_screen=!1){Inherit(this,Component);const _this=this;var _media,_audioInputId,_audioOutputId,_videoInputId,_resetPromise,_audioContext,_node,_analyzer,_microphone,_settingSource;this.isScreenShare=_screen,this.hasVideo=_this.parent.videoStream;var _playDelay=100;async function accessCamera(){if(!_this.flag)return;await GameCenterMedia.mounted();let videoConfig=new fm.liveswitch.VideoConfig(_screen?screen.width:_dimensions.width,_screen?screen.height:_dimensions.height,24);_media=new fm.liveswitch.LocalMedia(!0,_this.hasVideo?videoConfig:null,_screen),async function usePreviousSettings(){let[audioId,videoId,audioOutputId]=await Promise.all([Storage.get("gcmu_audioSource"),Storage.get("gcmu_videoSource"),Storage.get("gcmedia_output_device")]);if(_videoInputId=videoId,_audioOutputId=audioOutputId,_audioInputId=audioId){let audioInputs=await _media.getAudioInputs();for(let i=0;i<audioInputs.length;i++){let input=audioInputs[i];if(input._id==_audioInputId){_media.setAudioInput(input);break}}}if(_videoInputId){let videoInputs=await _media.getVideoInputs();for(let i=0;i<videoInputs.length;i++){let input=videoInputs[i];if(input._id==_videoInputId){_media.setVideoInput(input);break}}}if(_audioOutputId){let audioOutputs=getConnectedDevices("audiooutputs");for(let i=0;i<audioOutputs.length;i++){if(audioOutputs[i]._id==_audioOutputId){GameCenterMedia._setOutputDevice(option.deviceId);break}}}}();try{await _media.start()}catch(e){return!_screen&&(GameCenterMedia._setMediaAccessFail(),setTimeout(accessCamera,100))}_this.parent.videoStream&&(_this.video=await function getVideo(media){let promise=Promise.create(),timer=_this.delayedCall((_=>{console.warn("5 second timeout getting userStream video")}),5e3);function loop(){let video=media.getView().childNodes[0];video&&(clearTimeout(timer),Render.stop(loop),promise.resolve(video))}return Render.start(loop),promise}(_media),_this.video.autoplay=!0,_this.video.volume=1e-4,playVideo()),_screen||_this.delayedCall(initAnalyzer,1e3),_this.flag("started",!0),_this.flag("loaded",!0),Render.TIME,GameCenterMedia._setHasMediaAccess()}async function playVideo(){if(_this.ready)try{await _this.video.play(),_this.delayedCall(playVideo,_playDelay),_playDelay+=100,_playDelay=Math.min(5e3,_playDelay)}catch(e){setTimeout(playVideo,100)}}async function getConnectedDevices(type){return(await navigator.mediaDevices.enumerateDevices()).filter((device=>device.kind===type))}function initAnalyzer(){let run=_=>{try{!function setupAnalyzer(){const AudioContext=window.AudioContext||window.webkitAudioContext||!1;let array,timeout;_audioContext=new AudioContext,_analyzer=_audioContext.createAnalyser(),_microphone=_audioContext.createMediaStreamSource(_media._getInternal()._audioMediaStream),_node=_audioContext.createScriptProcessor(2048,1,1),_analyzer.smoothingTimeConstant=.8,_analyzer.fftSize=1024,_microphone.connect(_analyzer),_analyzer.connect(_node),_node.connect(_audioContext.destination),_node.onaudioprocess=function(){if(!_this.flag)return _audioContext.close(),_node.onaudioprocess=null,void(_node=_audioContext=_analyzer=null);array||(array=new Uint8Array(_analyzer.frequencyBinCount)),_analyzer&&_analyzer.getByteFrequencyData(array);for(var values=0,length=array.length,i=0;i<length;i++)values+=array[i];values/length>20?_this.flag("speaking_flag")||(clearTimeout(timeout),_this.flag("speaking",!0),_this.flag("speaking_flag",!0),PlayerModel.set("gcmedia_speaking",!0),_this.events.fire(GameCenterMediaUserStream.SPEAKING,{value:!0})):_this.flag("speaking")&&(_this.flag("speaking",!1),clearTimeout(timeout),timeout=_this.delayedCall((_=>{_this.flag("speaking_flag",!1),PlayerModel.set("gcmedia_speaking",!1),_this.events.fire(GameCenterMediaUserStream.SPEAKING,{value:!1})}),500))}}()}catch(e){_this.delayedCall(run,250)}};run()}function resetAnalyzer(){try{_microphone&&(_microphone=_audioContext.createMediaStreamSource(_media._getInternal()._audioMediaStream)).connect(_analyzer)}catch(e){setTimeout(resetAnalyzer,100)}}!async function(){await accessCamera()}(),this.ready=function(){return _this.wait("loaded")},this.resetAccess=async function(){try{await accessCamera(),_this.events.fire(GameCenterMediaUserStream.RESET_ACCESS)}catch(e){}},this.reset=async function(audio,video){if(!GameCenter.TEMP_BLOCK_RESET){await _resetPromise,_resetPromise=Promise.create(),(audio||video)&&(_this.hasVideo&&!video||!_this.hasVideo&&video)&&(_this.hasVideo=video,video||(_this.video=null),await accessCamera()),PlayerModel.set("gcmedia_mute_audio",!1),PlayerModel.set("gcmedia_mute_video",!1);try{audio||video?_this.flag("started")||(_this.flag("started",!0),await _media.start(),resetAnalyzer(),playVideo()):(PlayerModel.set("gcmedia_speaking",!1),_this.flag("started")&&(_this.flag("started",!1),await _media.stop()))}catch(e){}_this.events.fire(GameCenterMediaUserStream.UPDATE),_resetPromise.resolve()}},this.getStream=async function(){return await _this.wait("loaded"),_this.video},this.getAudioInputs=async function(){await _this.wait("loaded");let inputs=await _media.getAudioInputs();return inputs.forEach(((input,index)=>{input.selected=_audioInputId?input._id==_audioInputId:0==index,input.kind="audioinput"})),inputs},this.getAudioOutputs=async function(){await _this.wait("loaded");let inputs=await getConnectedDevices("audiooutput");const audioId=_this.getChosenOutputSource();return inputs.forEach(((input,index)=>{input.selected=audioId?input.deviceId==audioId:0==index,input.kind="audiooutput",input._name=input.label})),inputs},this.getVideoInputs=async function(){await _this.wait("loaded");let inputs=await _media.getVideoInputs();return inputs.forEach(((input,index)=>{input.selected=_videoInputId?input._id==_videoInputId:0==index,input.kind="videoinput"})),inputs},this.setVideoSource=async function(device){await _settingSource,_settingSource=Promise.create(),Storage.set("gcmu_videoSource",device._id),PlayerModel.set("gcmedia_mute_video",!0),await _media.stop(),_media.setVideoInput(device),_videoInputId=device._id,await _media.start(),PlayerModel.set("gcmedia_mute_video",!1),_this.events.fire(GameCenterMediaUserStream.UPDATE),resetAnalyzer(),_settingSource.resolve()},this.setAudioSource=async function(device){await _settingSource,_settingSource=Promise.create(),Storage.set("gcmu_audioSource",device._id),PlayerModel.set("gcmedia_mute_video",!0),_media.changeAudioSourceInput(device),_audioInputId=device._id,_this.events.fire(GameCenterMediaUserStream.UPDATE),PlayerModel.set("gcmedia_mute_video",!1),resetAnalyzer(),_settingSource.resolve()},this.setAudioOutputSource=async function(option){Storage.set("gcmedia_output_device",option.deviceId),GameCenterMedia._setOutputDevice(option.deviceId),_this.events.fire(GameCenterMediaUserStream.UPDATE)},this.getChosenOutputSource=function(){return Storage.get("gcmedia_output_device")},this.enableVideo=async function(){_media.setVideoMuted(!1),PlayerModel.set("gcmedia_mute_video",!1),_this.events.fire(GameCenterMediaUserStream.VIDEO_MUTE,{value:!1}),_this.flag("mute_video",!1)},this.disableVideo=function(){PlayerModel.set("gcmedia_mute_video",!0),_this.events.fire(GameCenterMediaUserStream.VIDEO_MUTE,{value:!0}),_media.setVideoMuted(!0),_this.flag("mute_video",!0)},this.enableAudio=async function(){PlayerModel.set("gcmedia_mute_audio",!1),_this.events.fire(GameCenterMediaUserStream.AUDIO_MUTE,{value:!1}),_media.setAudioMuted(!1),_this.flag("mute_audio",!1),resetAnalyzer()},this.disableAudio=function(){_this.events.fire(GameCenterMediaUserStream.AUDIO_MUTE,{value:!0}),PlayerModel.set("gcmedia_mute_audio",!0),_media.setAudioMuted(!0),_this.flag("mute_audio",!0)},this.shareScreen=async function(){},this.get("media",(_=>_media)),this.ready=function(){return _this.wait("loaded")},this.resetAnalyzer=resetAnalyzer,this.onDestroy=function(){PlayerModel.set("gcmedia_mute_audio",!1),PlayerModel.set("gcmedia_mute_video",!1),_this.events.fire(GameCenterMediaUserStream.VIDEO_MUTE,{value:!1}),_this.events.fire(GameCenterMediaUserStream.AUDIO_MUTE,{value:!1})}}),(_=>{GameCenterMediaUserStream.UPDATE="gcmus_update",GameCenterMediaUserStream.SPEAKING="gcmus_speaking",GameCenterMediaUserStream.AUDIO_MUTE="gcmus_audio_mute",GameCenterMediaUserStream.VIDEO_MUTE="gcmus_video_mute",GameCenterMediaUserStream.UPDATE_AUDIO_OUTPUT="gcmao_update",GameCenterMediaUserStream.RESET_ACCESS="gcmus_reset_access"})),Class((function AreaLightUtil(){Inherit(this,Component);var _init,_loaded=Promise.create(),_textures=[];this.append=async function(shader){Lighting.fallbackAreaToPoint||(_init||async function load(){_init=!0;let data=await fetch(Assets.getPath("assets/images/_lighting/arealights.json")),json=await data.json();_textures[0]=new DataTexture(new Float32Array(json.LTC1),64,64,Texture.RGBAFormat,Texture.FLOAT),_textures[1]=new DataTexture(new Float32Array(json.LTC2),64,64,Texture.RGBAFormat,Texture.FLOAT),_loaded.resolve()}(),shader.uniforms.tLTC1={type:"t",value:null},shader.uniforms.tLTC2={type:"t",value:null},await _loaded,shader.set("tLTC1",_textures[0]),shader.set("tLTC2",_textures[1]))}}),"static"),Class((function Light(_input,_group){Inherit(this,Object3D);const _this=this;var _config,_folder,_debug,prefix="L_"+_input.prefix,_light=this.light=new BaseLight;function loop(){_light.position.copy(_this.group.position),_light.rotation.copy(_this.group.rotation)}function initNumber(key){let initValue=UILStorage.get(`${prefix}${key}`)||_light[key];if(_folder){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onChange((e=>{_light[key]=e,_this.events.fire(Light.UPDATE,{prefix:prefix,key:key,val:e,group:_this})})),number.onFinishChange((e=>UILStorage.set(`${prefix}${key}`,e))),_folder.add(number)}_light[key]=initValue}function update(e){e.prefix==prefix&&e.group!=_this&&(e.color?_light[e.key].set(e.val):_light[e.key]=e.val)}!function(){!async function initConfig(){(_config=InputUIL.create(prefix+"_config",_group)).setLabel("Config"),_config.addSelect("type",[{label:"Null",value:"-1"},{label:"Directional",value:"0"},{label:"Point",value:"1"},{label:"Spot",value:"2"},{label:"Area",value:"3"}]),await defer();let setup=_=>{_light.properties.w=_config.getNumber("type")+1,_group&&Utils.query("debugLight")&&(_debug&&_debug.destroy(),_debug=_this.initClass(LightDebug,_config.getNumber("type"),_light,_folder))};setup(),function initSpecificUIL(type){switch(type){case 0:break;case 2:_light.radius=1,_light.feather=0,_light.rotation.set(0,Math.radians(90),0),initNumber("radius"),initNumber("feather"),_light.data.set(_light.rotation.z,_light.rotation.y,_light.rotation.x,_light.radius),_light.data2.x=_light.feather,_group&&_this.startRender((_=>{_light.data2.x=_light.feather,_light.data.set(_light.rotation.z,_light.rotation.y,_light.rotation.x,_light.radius)}));break;case 3:_light._overridePos=new Vector3,_light.width=1,_light.height=1,_light.roughness=.5,_light.isAreaLight=!0,initNumber("width"),initNumber("height"),initNumber("roughness");let pos=new Vector3,matrix4=new Matrix4,matrix42=new Matrix4,halfWidth=new Vector3,halfHeight=new Vector3,camera=World.CAMERA,p=_this.group._parent;for(;p;)p instanceof Scene&&p.nuke&&(camera=p.nuke.camera),p=p._parent;let updateProperties=_=>{_light.updateMatrixWorld(!0),pos.setFromMatrixPosition(_light.matrixWorld),pos.applyMatrix4(camera.matrixWorldInverse),_light.data.x=pos.x,_light.data.y=pos.y,_light.data.z=pos.z,_light.data.w=_light.roughness,matrix42.identity(),matrix4.copy(_light.matrixWorld),matrix4.premultiply(camera.matrixWorldInverse),matrix42.extractRotation(matrix4),halfWidth.set(.5*_light.width,0,0),halfHeight.set(0,.5*_light.height,0),halfWidth.applyMatrix4(matrix42),halfHeight.applyMatrix4(matrix42),_light.data2.x=halfWidth.x,_light.data2.y=halfWidth.y,_light.data2.z=halfWidth.z,_light.data3.x=halfHeight.x,_light.data3.y=halfHeight.y,_light.data3.z=halfHeight.z};RenderManager.type==RenderManager.WEBVR?_this.events.sub(RenderManager.EYE_RENDER,(e=>{_this.invisible||(camera=e.camera,updateProperties())})):_this.startRender(updateProperties)}}(_config.getNumber("type")),_config.onUpdate=setup}(),_group&&(_folder=function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:"Params",closed:!0});return _group.add(folder),folder}(),function addListeners(){_this.events.sub(Light.UPDATE,update)}()),initNumber("intensity"),initNumber("distance"),initNumber("bounce"),function initColor(key){let initValue=UILStorage.get(`${prefix}${key}`);if(_folder){let color=new UILControlColor(`${prefix}${key}`,{label:key,value:initValue});color.onChange((e=>{_light[key].set(e),_this.events.fire(Light.UPDATE,{prefix:prefix,key:key,val:e,color:!0,group:_this})})),color.onFinishChange((e=>UILStorage.set(`${prefix}${key}`,e))),_folder.add(color)}initValue&&_light[key].set(initValue)}("color");let p=_this.parent.group._parent;for(;p;)p instanceof Scene&&p._lightingData&&(_light._lightingData=p._lightingData),p=p._parent;Lighting.add(_light),_this.startRender(loop)}(),this.onDestroy=function(){_light.destroy()}}),(_=>{Light.UPDATE="light_update"})),Class((function LightDebug(_type,_light,_folder){Inherit(this,Object3D);const _this=this;function createLight(){let geom=World.SPHERE,shader=Utils3D.getTestShader(_light.color);shader.set("color",_light.color),shader.depthTest=!1,shader.transparent=!0;let mesh=new Mesh(geom,shader);mesh.scale.setScalar(.5),_this.add(mesh)}!function(){switch(_type){case-1:case 1:case 0:!function initPoint(){createLight();let geom=new IcosahedronGeometry(1,1),shader=Utils3D.getTestShader(_light.color);shader.set("color",_light.color),shader.wireframe=!0,shader.transparent=!0,shader.set("alpha",.2);let mesh=new Mesh(geom,shader);mesh.scale.setScalar(_light.distance),_this.add(mesh),_this.startRender((_=>mesh.scale.setScalar(_light.distance)))}();break;case 2:!function initSpot(){createLight()}();break;case 3:!function initArea(){let geom=World.PLANE,shader=Utils3D.getTestShader(_light.color);shader.set("color",_light.color),shader.transparent=!0,shader.side=Shader.DOUBLE_SIDE;let mesh=new Mesh(geom,shader);_this.add(mesh),_this.startRender((_=>mesh.scale.set(_light.width,_light.height,1)))}()}}(),this.onDestroy=function(){_this.parent.group.remove(_this.group)}})),Class((function ShadowLight(_input,_group){Inherit(this,Object3D);const _this=this;var _light,_timer;function findScene(){let p=_this.group._parent;for(;p;){if(p instanceof Scene)return p;p=p._parent}}!async function(){(_light=new BaseLight).prefix=_input.prefix,_this.add(_light),_light.silentShadow=ShadowLight.LOCKED,_this.light=_light;let p=_this.parent.group._parent;for(;p;)p instanceof Scene&&p._lightingData&&(_light._lightingData=p._lightingData),p=p._parent;if(_light.castShadow=!0,ShadowUIL.add(_light,_group).setLabel("Shadows"),ShadowLight.LOCKED)return;_this.startRender((_=>{})),await defer();let scene=findScene();if(scene||await _this.wait(100),scene=findScene(),!scene)return console.warn("Shadow light has no parent scene");scene.hasShadowLight=!0,scene.bindSceneChange((_=>{_light.static&&(_light.shadow.frozen=!1,clearTimeout(_timer),_timer=_this.delayedCall((_=>_light.shadow.frozen=!0),250))}))}(),this.onVisible=async function(){await defer(),_light.static&&(_light.shadow.frozen=!1,clearTimeout(_timer),_timer=_this.delayedCall((_=>_light.shadow.frozen=!0),250))},this.onDestroy=function(){_light.destroy()}})),Class((function Line3D(_params={}){Inherit(this,Object3D);const _this=this;let _geometry,_shader,_mesh,_vs,_fs,_prevPoint,_index=_params.index||0,_points=_params.points||[],_pressure=_params.pressure||[],_taperFunction=_params.taperFunction||(()=>1);function initMesh(){_points.length<2||_mesh||(_mesh=new Mesh(_geometry.geometry,_shader),_mesh.frustumCulled=!1,_mesh.renderOrder=_params.renderOrder,_this.add(_mesh),_this.mesh=_mesh,_geometry.mesh=_mesh)}!function initGeometry(){_geometry=_this.initClass(LineGeometry,{index:_index,points:_points,pressure:_pressure,taperFunction:_taperFunction})}(),window.THREAD||(function initShader(){const shaderName=_params.customShader||"Line";_shader=_this.initClass(Shader,shaderName,{uLineWidth:{value:_params.width||Line3D.defaultLineWidth,ignoreUIL:!0},uBaseWidth:Line3D.BASE_WIDTH,uColor:{value:new Color(_params.color||Line3D.defaultColor),ignoreUIL:!0},uOpacity:{value:_params.opacity||Line3D.defaultOpacity,ignoreUIL:!0},transparent:!0,depthWrite:!1!==_params.depthWrite,depthTest:!1!==_params.depthTest}),_vs=_shader.vertexShader,_fs=_shader.fragmentShader,_vs&&(Line3D.vertexShader=_shader.vertexShader,Line3D.fragmentShader=_shader.fragmentShader),_this.shader=_shader}(),initMesh()),this.get("data",(()=>({geometry:{points:_points,pressure:_pressure,index:_index},meta:{fs:_shader.fsName,vs:_shader.vsName,width:_shader.uniforms.uLineWidth.value,opacity:_shader.uniforms.uOpacity.value,color:_shader.uniforms.uColor.value.getHex()}}))),this.get("lineGeometry",(()=>_geometry)),this.get("geometry",(()=>_geometry.geometry)),this.set("lineWidth",(v=>{_shader.set("uLineWidth",v)})),this.set("color",(hex=>{_shader.uniforms.uColor.value.set(hex)})),this.set("opacity",(value=>{_shader.uniforms.uOpacity.value=value})),this.useShader=function(shader){_shader.vertexShader=_vs,_shader.fragmentShader=_fs,_shader=Line3D.mergeShaders(shader,_shader),_this.shader=_shader,_mesh&&(_mesh.shader=_shader)},this.draw=function(pos,pressure=1){_points.push(pos.x,pos.y,pos.z),_pressure.push(pressure),_points.length<2||(_geometry.update(_points,!0),_mesh||initMesh())},this.moveTo=function(pos,subdivisions=30){if(_prevPoint){let v=new Vector3;for(let i=0;i<subdivisions;i++)v.copy(_prevPoint).lerp(pos,i/(subdivisions-1),!1),_points.push(v.x,v.y,v.z),_pressure.push(1)}_prevPoint=pos,_points.length<2||(_geometry.update(_points,!0),_mesh||initMesh())},this.clear=function(){_points.length=0,_prevPoint=null,_geometry.clear()},this.onDestroy=function(){_this.parent&&_this.parent.group&&_this.parent.group.remove(_this.group),_mesh&&_mesh.destroy&&_mesh.destroy()}}),(()=>{Line3D.defaultLineWidth=1,Line3D.defaultOpacity=1,Line3D.defaultColor="#ffffff",Line3D.BASE_WIDTH={value:.005,ignoreUIL:!0},Line3D.MAX_LINE_LENGTH=500,Line3D.mergeShaders=function(s0,s1){s1.copyUniformsTo(s0);for(let key in s1.properties)s0.properties[key]=s1.properties[key];if(s0.lineFormat||!s0.vertexShader)return s0.lineFormat=!0,s0;s1.fragmentShader||(s1.fragmentShader=Line3D.fragmentShader,s1.vertexShader=Line3D.vertexShader);let vs=s0.vertexShader.split("__ACTIVE_THEORY_LIGHTS__")[1],fs=s0.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__")[1],split=vs.split("void main() {"),fsParams=s1.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__")[1].split("void main")[0];if(s0.fragmentShader=s0.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__").join(fsParams),s1.vertexShader=s1.vertexShader.replace("//params",split[0]),s1.vertexShader=s1.vertexShader.replace("//main",split[1].split("}")[0]),s0.vertexShader.includes("customMatrix")){let content=s0.vertexShader.split("customMatrix() {")[1];content=content.split("}")[0];let matrix=s1.vertexShader.split("//startMatrix")[1].split("//endMatrix")[0];s1.vertexShader=s1.vertexShader.replace(matrix,content)}if(s0.vertexShader.includes("customDirection")){let content=s0.vertexShader.split("customDirection() {")[1];content=content.split("}")[0],s1.vertexShader=s1.vertexShader.replace("//direction",content)}return split=fs.split("void main() {"),s1.fragmentShader=s1.fragmentShader.replace("//fsmain",split[1].split("}")[0]),s1.fragmentShader=s1.fragmentShader.replace("//fsparams",split[0]),s0.vertexShader=s1.vertexShader,s0.fragmentShader=s1.fragmentShader,s0}})),Class((function Line3DLayer(_input,_group){Inherit(this,Object3D);const _this=this;var _shader,_line,_config;async function load(json,subdivisions,color,width){json.includes("assets/geometry")||(json="assets/geometry/"+json),json.includes(".json")||(json+=".json");let merged=await LineUtil.loadFromSplines(Assets.getPath(json),subdivisions,color,width);_line=merged,_this.add(merged),_shader&&merged.useShader(_shader),_this.flag("loaded",!0)}!function(){let config=InputUIL.create(_input.prefix+"line3d",_group);config.add("json").add("subdivisions",100).addColor("color",new Color).add("width",10).setLabel("Spline");let json=config.get("json");if(json){load(json,_this.parent.data&&_this.parent.data.line3DSubdivisions?_this.parent.data.line3DSubdivisions:config.getNumber("subdivisions"),config.get("color"),config.getNumber("width"))}_config=config,function initShader(){let shader=_input.get("shader");shader&&shader.length&&(_this.shader=_shader=_this.initClass(Shader,shader,{transparent:!0}),function completeShader(shader){let transparent=_input.get("transparent"),depthWrite=_input.get("depthWrite"),depthTest=_input.get("depthTest"),blending=_input.get("blending"),castShadow=_input.get("castShadow"),receiveShadow=_input.get("receiveShadow");"boolean"==typeof depthWrite&&(shader.depthWrite=depthWrite);"boolean"==typeof depthTest&&(shader.depthTest=depthTest);"boolean"==typeof transparent&&(shader.transparent=transparent);"boolean"==typeof castShadow&&defer((_=>_this.mesh.castShadow=castShadow));"boolean"==typeof receiveShadow&&(shader.receiveShadow=receiveShadow);blending&&(shader.blending=blending)}(_shader),window[shader]&&_this.initClass(window[shader],_this,_shader),ShaderUIL.add(_shader,_group).setLabel("Shader"))}()}(),this.ready=function(){return _this.wait("loaded")},this.getRandomPosition=async function(){let positions=_line.geometry.attributes.position.array,index=3*Math.random(0,positions.length/3,0);return new Vector3(positions[index],positions[index+1],positions[index+2])},this.loadFile=function(path){if(_line&&(_this.flag("loaded",!1),_this.group.remove(_line.group),_line.destroy()),"string"==typeof path)load(path,_config.getNumber("subdivisions"),_config.get("color"),_config.getNumber("width"));else{let merged=path;_line=merged,_this.add(merged),_shader&&merged.useShader(_shader),_this.flag("loaded",!0)}}})),Class((function LineGeometry({index:index=0,points:points=[],taperFunction:taperFunction=(()=>1),defaultCount:defaultCount=512}){Inherit(this,Component);const _this=this;_this.index=index,_this.points=points,_this.taperFunction=taperFunction;const _geometry=_this.geometry=new Geometry,_attr=_geometry.attributes;let _prev=new Vector3,_curr=new Vector3,_length=0,_count=0,_defaultPoints=[];function initBuffers(count){_geometry.addAttribute("position",new GeometryAttribute(new Float32Array(3*count*2),3)),_geometry.addAttribute("previous",new GeometryAttribute(new Float32Array(3*count*2),3)),_geometry.addAttribute("next",new GeometryAttribute(new Float32Array(3*count*2),3)),_geometry.addAttribute("side",new GeometryAttribute(new Float32Array(1*count*2),1)),_geometry.addAttribute("lineIndex",new GeometryAttribute(new Float32Array(1*count*2),1)),_geometry.addAttribute("width",new GeometryAttribute(new Float32Array(1*count*2),1)),_geometry.addAttribute("uv",new GeometryAttribute(new Float32Array(2*count*2),2)),_geometry.addAttribute("uv2",new GeometryAttribute(new Float32Array(2*count*2),2)),_geometry.setIndex(new GeometryAttribute(new Uint16Array(3*(count-1)*2),1)),_length=0,_count=0,function setStaticBuffers(count){for(let i=0;i<count;i++){if(_attr.side.setXY(2*i,1,-1),_attr.lineIndex.setXY(2*i,_this.index,_this.index),i===count-1)continue;let ind=2*i;_geometry.index[3*(ind+0)+0]=ind+0,_geometry.index[3*(ind+0)+1]=ind+1,_geometry.index[3*(ind+0)+2]=ind+2,_geometry.index[3*(ind+1)+0]=ind+2,_geometry.index[3*(ind+1)+1]=ind+1,_geometry.index[3*(ind+1)+2]=ind+3}}(count)}function getPos(index){let i=3*index;return[points[i],points[i+1],points[i+2]]}function update(p=points,force=!1){_this.points=points=p;let newLength=points.length/3;2*newLength>_attr.position.count&&function increaseBuffers(){initBuffers(_attr.position.count/2+defaultCount)}();let oldLength=_count;if(oldLength&&!force){let nxt=getPos(oldLength);_attr.next.setXYZ(2*(oldLength-1)+0,nxt[0],nxt[1],nxt[2]),_attr.next.setXYZ(2*(oldLength-1)+1,nxt[0],nxt[1],nxt[2])}for(let i=force?0:oldLength;i<newLength;i++){_attr.position.setXYZ(2*i+0,points[3*i+0],points[3*i+1],points[3*i+2]),_attr.position.setXYZ(2*i+1,points[3*i+0],points[3*i+1],points[3*i+2]);let prv=getPos(Math.max(0,i-1));_attr.previous.setXYZ(2*i+0,prv[0],prv[1],prv[2]),_attr.previous.setXYZ(2*i+1,prv[0],prv[1],prv[2]);let nxt=getPos(Math.min(newLength-1,i+1));_attr.next.setXYZ(2*i+0,nxt[0],nxt[1],nxt[2]),_attr.next.setXYZ(2*i+1,nxt[0],nxt[1],nxt[2]),_prev.fromArray(prv),_curr.fromArray(getPos(i)),_length+=_prev.distanceTo(_curr),_attr.uv2.setX(2*i+0,_length),_attr.uv2.setX(2*i+1,_length)}for(let i=0;i<newLength;i++){_attr.uv.setXY(2*i+0,i/newLength,0),_attr.uv.setXY(2*i+1,i/newLength,1),_attr.uv2.setY(2*i+0,_length),_attr.uv2.setY(2*i+1,_length);let w=_this.taperFunction(i/(newLength-1),i,newLength);_attr.width.setXY(2*i,w,w)}_attr.position.needsUpdate=!0,_attr.previous.needsUpdate=!0,_attr.next.needsUpdate=!0,_attr.width.needsUpdate=!0,_attr.uv.needsUpdate=!0,_attr.uv2.needsUpdate=!0,_count=newLength,_this.points=points}!function(){initBuffers(points.length?points.length/3:defaultCount);for(let i=0;i<defaultCount;i++)_defaultPoints.push(0,0,0);points.length&&update()}(),this.update=update,this.clear=function clear(){update(_defaultPoints,!0),_length=0,_count=0}})),Class((function MergedLine(_geometry,_lineCount){Inherit(this,Object3D);const _this=this;var _shader,_mesh,_vs,_fs;this.geometry=_geometry,function initShader(){(_shader=_this.initClass(Shader,"Line",{uBaseWidth:Line3D.BASE_WIDTH,uLineCount:{type:"f",value:_lineCount||1,ignoreUIL:!0},transparent:!0})).vertexShader?(Line3D.vertexShader=_shader.vertexShader,Line3D.fragmentShader=_shader.fragmentShader):(_shader.vertexShader=Line3D.vertexShader,_shader.fragmentShader=Line3D.fragmentShader),_shader.vertexShader&&_shader.vertexShader.length||(_shader.vertexShader=Shaders.getShader("Line.vs")),_shader.fragmentShader&&_shader.fragmentShader.length||(_shader.fragmentShader=Shaders.getShader("Line.fs")),_shader.vertexShader=_shader.vertexShader.replace("uniform float uLineWidth;","attribute float thickness;"),_shader.vertexShader=_shader.vertexShader.replace("uLineWidth","thickness"),_shader.fragmentShader=_shader.fragmentShader.replace("uniform float uLineWidth;",""),_shader.vertexShader=_shader.vertexShader.replace("uniform vec3 uColor;","attribute vec3 aColor;"),_shader.vertexShader=_shader.vertexShader.replace("vColor = uColor;","vColor = aColor;"),_shader.vertexShader=_shader.vertexShader.replace("uniform float uOpacity;","attribute float aOpacity;"),_shader.vertexShader=_shader.vertexShader.replace("vOpacity = uOpacity;","vOpacity = aOpacity;"),_vs=_shader.vertexShader,_fs=_shader.fragmentShader,_this.shader=_shader}(),function createMesh(){(_mesh=new Mesh(_geometry,_shader)).frustumCulled=!1,_this.add(_mesh),_this.mesh=_mesh}(),this.useShader=function(shader){_shader.vertexShader=_vs,_shader.fragmentShader=_fs,_shader=Line3D.mergeShaders(shader,_shader),_this.shader=_shader,shader.uniforms.uBaseWidth.ignoreUIL=shader.uniforms.uLineCount.ignoreUIL=!0,shader.transparent=!0,_mesh&&(_mesh.shader=_shader)},this.onDestroy=function(){_this.events.fire(MergedLine.DESTROY),_mesh.destroy(),_this.group&&_this.group.parent&&_this.group.parent.remove(_this.group)},this.clone=function(){return new MergedLine(_geometry,_fs)},this.set("widthMultiplier",(v=>{_shader.set("uBaseWidth",1.8*v)})),this.set("color",(hex=>{_shader.uniforms.uColor.value.set(hex)}))}),(_=>{MergedLine.DESTROY="merged_line_destroy"})),Class((function MergedLineGroup(){Inherit(this,Object3D);const _this=this;this.lines=[],this.add=function(line){line.freezeMatrix(),line.mergedGroup=this,this.lines.push(line),this.group.add(line.group)},this.onDestroy=function(){_this.events.fire(MergedLine.DESTROY),this.lines.forEach((line=>line.destroy())),_this.group.parent.remove(_this.group)}})),Class((function LineBuilder(){const _this=this;var _cache={},_taperFunctions,_color;function merge(geom,line){geom.attributes.position?mergeAttributes(geom,line):copyAttributes(geom,line)}function copyAttributes(geom,line){for(let key in line.attributes)geom.attributes[key]=line.attributes[key];geom.index=line.index}function mergeAttributes(geom,line){for(let key in line.attributes)geom.attributes[key]=new GeometryAttribute(Float32ArrayConcat(geom.attributes[key].array,line.attributes[key].array),geom.attributes[key].itemSize);let indexArray=Array.prototype.slice.call(geom.index),startIndex=indexArray[indexArray.length-1]+1;for(let i=0;i<line.index.length;i++)indexArray.push(startIndex+line.index[i]);geom.index=new Uint16Array(indexArray)}function Float32ArrayConcat(first,second){var firstLength=first.length,result=new Float32Array(firstLength+second.length);return result.set(first),result.set(second,firstLength),result}function geomToObj(geom){let obj={},buffers=[];for(let key in geom.attributes)obj[key]=geom.attributes[key].array,buffers.push(obj[key].buffer);return obj.index=geom.index,buffers.push(obj.index.buffer),{obj:obj,buffers:buffers}}function createExtraAttrib(geom,key,value){let len=geom.attributes.position.count;if("number"==typeof value){let array=new Float32Array(len);for(let i=0;i<array.length;i++)array[i]=value;geom.addAttribute(key,new GeometryAttribute(array,1))}else{let array=new Float32Array(len*value.length);for(let i=0;i<len;i++)for(let j=0;j<value.length;j++)array[i*value.length+j]=value[j];geom.addAttribute(key,new GeometryAttribute(array,value.length))}}function parseData(data,e){"string"==typeof data&&(data=JSON.parse(JSON.parse(data)));let mergedGeom=new Geometry;return data.forEach((d=>{let lineGeom=new LineGeometry(d.geometry.index,d.geometry.points,d.geometry.pressure);createExtraAttrib(lineGeom.geometry,"thickness",d.meta.width),d.meta.color&&(_color||(_color=new Color),_color.set(d.meta.color),createExtraAttrib(lineGeom.geometry,"aColor",_color.toArray())),d.meta.opacity&&createExtraAttrib(lineGeom.geometry,"aOpacity",d.meta.opacity),merge(mergedGeom,lineGeom.geometry,d.meta)})),geomToObj(mergedGeom)}function parseGroups(data,e,callback,promise){let groups=[],cached=[];for(let i=0;i<data.length;i++){let meta=data[i].meta,key=`${meta.fs||"fs"}_${meta.vs||"vs"}`;cached[key]||(cached[key]=!0,groups.push({fs:meta.fs||"fs",vs:meta.vs||"vs"}))}void 0===callback?promise.resolve(groups):resolve(groups,callback)}this.parse=function(e,callback){window.taper&&(Line3D.taperFunction=taper);let promise=Promise.create();return get(e.file).then((data=>{if(data.data){let meta=data;data=data.data,delete meta.data,window.emit?emit("meta",meta):_this.onMeta&&_this.onMeta(meta)}_cache[e.file]=data,parseGroups(data,e,callback,promise)})),promise},this.createLine=function(e,callback){let data=e.data||_cache[e.file],selected=[];for(let i=0;i<data.length;i++){let meta=data[i].meta;meta.fs!=e.group.fs||meta.vs&&meta.vs!=e.group.vs||selected.push(data[i])}let meta=selected[0].meta;if(_taperFunctions){let key=meta.vs;_taperFunctions[key]&&(Line3D.taperFunction=_taperFunctions[key])}let{obj:obj,buffers:buffers}=parseData(selected,e);if(obj.meta=meta,obj.lineCount=selected.length,void 0===callback)return Promise.resolve(obj);resolve(obj,callback,buffers)},this.parseFromData=function(e,callback){window.taper&&(Line3D.taperFunction=taper);let data=e.data,promise=Promise.create();return parseGroups(data,e,callback,promise),promise},this.release=function(e){delete _cache[e.file]},this.uploadTaperFunctions=function(e){_taperFunctions=e.fns;for(let key in _taperFunctions)eval(`_taperFunctions['${key}'] = ${_taperFunctions[key]}`)},this.changeTaperFunction=function(e){Line3D.taperFunction=_taperFunctions[e.fn]},this.loadFromSplines=function({url:url,subdivisions:subdivisions,width:width,color:color,type:type},id){!async function(){let mergedGeom=new Geometry,array=await get(url),curves=array.curves.map((array=>new Curve(array,type))),total=0,maxLength=0;array.curves.forEach((c=>{maxLength=Math.max(c.length,maxLength)})),curves.forEach(((curve,i)=>{let points=[],count=Math.max(10,Math.round(subdivisions*(array.curves[i].length/maxLength)));for(let i=0;i<=count;i++){let pct=i/count,pos=curve.getPoint(pct);points.push(pos.x,pos.y,pos.z)}let line=new Line3D({width:width,color:color,index:total++,points:points});createExtraAttrib(line.geometry,"thickness",width),createExtraAttrib(line.geometry,"aColor",new Color(color||"#ffffff").toArray()),createExtraAttrib(line.geometry,"aOpacity",1),merge(mergedGeom,line.geometry)}));let{obj:obj,buffers:buffers}=geomToObj(mergedGeom);obj.lineCount=total,resolve(obj,id,buffers)}()},this.fromCurve=function({curvePoints:curvePoints,subdivisions:subdivisions,width:width,color:color,type:type},id){let curve=new Curve(curvePoints.map((p=>new Vector3(p.x,p.y,p.z))),type),points=[];for(let i=0;i<=subdivisions;i++){let pct=i/subdivisions,pos=curve.getPoint(pct);points.push(pos.x,pos.y,pos.z)}let line=new Line3D({width:width,color:color,points:points});createExtraAttrib(line.geometry,"thickness",width),createExtraAttrib(line.geometry,"aColor",new Color(color||"#ffffff").toArray()),createExtraAttrib(line.geometry,"aOpacity",1);let{obj:obj,buffers:buffers}=geomToObj(line.geometry);resolve(obj,id,buffers)}})),Class((function LineUtil(){Inherit(this,Component);const _this=this;var _builder,_meta;this.useThread=!0,this.precision=3;var _processing=!1,_queue=[];function createGeometry(attributes){let geom=new Geometry;for(let key in attributes){if("index"==key||!attributes[key].length)continue;let comp=attributes[key].length/attributes.width.length;geom.addAttribute(key,new GeometryAttribute(attributes[key],comp))}return geom.setIndex(new GeometryAttribute(new Uint16Array(attributes.index),1)),geom}function initBuilder(){_this.useThread?(_builder=_this.initClass(Thread,LineBuilder),Utils3D.loadEngineOnThread(_builder),_builder.importClass(LineGeometry,Line3D,Object3D),window.Curve&&Curve.loadOnThread(_builder),_builder.on("meta",receiveMeta),Line3D.taperFunction&&_builder.loadFunction(Line.taperFunction)):(_builder=_this.initClass(LineBuilder)).onMeta=receiveMeta}function trim(value,precision){let p=Math.pow(10,precision);return Math.round(value*p)/p}function build(groups,file,data){let promise=Promise.create(),promises=[],group=null;return groups.forEach((group=>{promises.push(_builder.createLine({file:file,data:data,group:group}))})),Promise.all(promises).then((array=>{array.forEach((attributes=>{let merged=new MergedLine(createGeometry(attributes),attributes.lineCount);merged.meta=attributes.meta,merged.lineCount=attributes.lineCount,1==array.length?promise.resolve(merged):(group||(group=new MergedLineGroup),group.add(merged))})),promise.resolve(group)})),promise}async function runQueue(){let data,obj=_queue.shift();obj&&(_processing=!0,data=obj.file?await function load(file){let promise=Promise.create();_builder||initBuilder();return file=Thread.absolutePath(file),_builder.parse({file:file}).then((groups=>{build(groups,file,null).then((merged=>{merged.fileMeta=_meta,promise.resolve(merged),_builder.release({file:file}),_meta=null}))})),promise}(obj.file):await function loadFromData(data){_builder||initBuilder();let promise=Promise.create();return _builder.parseFromData({data:data}).then((groups=>{build(groups,null,data).then((merged=>{promise.resolve(merged)}))})),promise}(obj.data),obj.promise.resolve(data),_processing=!1,runQueue())}function receiveMeta(e){_meta=e}this.load=function(file){let promise=Promise.create();return _queue.push({file:file,promise:promise}),_processing||runQueue(),promise},this.loadFromData=function(data){let promise=Promise.create();return _queue.push({data:data,promise:promise}),_processing||runQueue(),promise},this.outputFromArray=function(array){let output=[];return array.forEach((l=>{let data=l.data;for(let key in data.geometry)Array.isArray(data.geometry[key])&&data.geometry[key].forEach(((v,i)=>{data.geometry[key][i]=trim(v,_this.precision)}));output.push(data)})),output},this.trim=trim,this.uploadTaperFunctions=function(fn){if(!_this.useThread)return;_builder||initBuilder();let upload={fns:{}};for(let key in fn){let code=fn[key].toString();upload.fns[key]=code}_builder.uploadTaperFunctions(upload)},this.changeTaperFunction=function(fn){_builder.changeTaperFunction({fn:fn})},this.loadFromSplines=async function(url,subdivisions,color,width,type){_builder||initBuilder();let data=await _builder.loadFromSplines({url:Thread.absolutePath(url),subdivisions:subdivisions,width:width,color:color,type:type});return new MergedLine(createGeometry(data),data.lineCount)},this.fromCurve=async function(curve,config){_builder||initBuilder(),config.curvePoints=curve.points;let data=await _builder.fromCurve(config);return new MergedLine(createGeometry(data),data.lineCount)}}),"static"),Class((function MouseFlowMapRenderer(_size){Inherit(this,Component);const _this=this;let _shader;const _scene1=new Scene,_scene2=new Scene,_camera=new OrthographicCamera(0,1,1,0,.1,2);let _count=0;const _rtPing=Utils3D.createRT(_size,_size),_rtPong=Utils3D.createRT(_size,_size);this.rt=Utils3D.createRT(_size,_size,null,Texture.RGBAFormat),this.textureUniform={type:"t",value:null,ignoreUIL:!0},function init(){_camera.position.z=1}(),_scene1.disableAutoSort=!0,_scene2.disableAutoSort=!0,this.add=function(mesh){_scene1.add(mesh)},this.setShader=function(shader){_shader=shader;let mesh=new Mesh(World.QUAD,shader);_scene2.add(mesh)},this.draw=function(){if(!_shader)return;let autoClear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.renderSingle(_scene1.children[0],_camera,_this.rt),World.RENDERER.autoClear=autoClear,_this.textureUniform.value=_this.rt.texture},this.clear=function(){if(!_shader)return;_count++;const clearAlphaCache=Renderer.CLEAR[3];Renderer.CLEAR[3]=0,_count%2==0?(_shader.uniforms.uTexture.value=_rtPing.texture,World.RENDERER.renderSingle(_scene2.children[0],_camera,_rtPong),_this.textureUniform.value=_rtPong.texture):(_shader.uniforms.uTexture.value=_rtPong.texture,World.RENDERER.renderSingle(_scene2.children[0],_camera,_rtPing),_this.textureUniform.value=_rtPing.texture),_shader.uniforms.uFirstDraw.value=0,Renderer.CLEAR[3]=clearAlphaCache,Renderer.context.bindFramebuffer(Renderer.context.FRAMEBUFFER,_this.rt._gl),Renderer.context.clear(Renderer.context.COLOR_BUFFER_BIT),Renderer.context.bindFramebuffer(Renderer.context.FRAMEBUFFER,null)},this.upload=async function(){let uploads=[_rtPing,_rtPong,_this.rt];_shader&&uploads.push(_shader);for(let i=0;i<uploads.length;i++)uploads[i].upload(),await defer()}})),Class((function MouseFlowMapTouch(){Inherit(this,Component);const _this=this;new Vector2;var _touch=new Vector2,_touchLast=new Vector2,_touchStep=new Vector2,_velocity=new Vector2,_current=new Vector2,_delta={x:0,y:0},_last=new Vector2;this.velocity=new Vector2,this.ticks=0,this.render=function(decay,numStamps){_velocity.multiplyScalar(decay),_this.velocity.lerp(_velocity,.5),_touch.lerp(_current,.4),_touchStep.copy(_touch).sub(_touchLast).multiplyScalar(1/numStamps),_touchLast.copy(_touch)},this.move=function(e,hitMesh){_this.isMouseLeft&&(_this.isMouseLeft=!1,_touch.copy(Mouse.inverseNormal),_touchLast.copy(_touch)),e.x!=_last.x&&(hitMesh?(_current.x=e.x,_current.y=e.y):(_current.x=e.x/Stage.width,_current.y=1-e.y/Stage.height),_delta.x=e.x-_last.x,_delta.y=e.y-_last.y,_last.x=e.x,_last.y=e.y,_velocity.copy(_delta).multiplyScalar(.03/16))},this.get("step",(_=>_touchStep)),this.get("pos",(_=>_touch))})),Class((function ParticleDistributor(){Inherit(this,Component);const _this=this;function init(){_this.flag("initGenerate")||(_this.flag("initGenerate",!0),Thread.upload(distributeParticles),Thread.upload(generatePointCloud),Thread.upload(generatePointGrid))}function distributeParticles(e,id){let{position:position,count:count,normal:normal,uv:uv,skinIndex:skinIndex,skinWeight:skinWeight,offset:offset,scale:scale,orientation:orientation}=e,vertices=position.length/3,v3=new Vector3,v32=new Vector3,v33=new Vector3,q=new Quaternion,outputPosition=new Float32Array(3*count),outputNormal=normal?new Float32Array(3*count):null,outputUV=uv?new Float32Array(3*count):null,outputSkinIndex=skinIndex?new Float32Array(4*count):null,outputSkinWeight=skinWeight?new Float32Array(4*count):null;for(let i=0;i<count;i++){let j=3*Math.random(0,vertices/3);v3.set(Math.random(0,100),Math.random(0,100),Math.random(0,100));let m=1/(v3.x+v3.y+v3.z);if(v3.set(v3.x*m,v3.y*m,v3.z*m),outputPosition[3*i+0]=position[3*j+0]*v3.x+position[3*j+3]*v3.y+position[3*j+6]*v3.z,outputPosition[3*i+1]=position[3*j+1]*v3.x+position[3*j+4]*v3.y+position[3*j+7]*v3.z,outputPosition[3*i+2]=position[3*j+2]*v3.x+position[3*j+5]*v3.y+position[3*j+8]*v3.z,offset){let randomInstance=Math.random(0,offset.length/3-1);v32.fromArray(outputPosition,3*i),v33.fromArray(scale,3*randomInstance),v32.multiplyScalar(v33),q.fromArray(orientation,4*randomInstance),v32.applyQuaternion(q),v33.fromArray(offset,3*randomInstance),v32.add(v33),v32.toArray(outputPosition,3*i)}if(outputNormal&&(outputNormal[3*i+0]=normal[3*j+0]*v3.x+normal[3*j+3]*v3.y+normal[3*j+6]*v3.z,outputNormal[3*i+1]=normal[3*j+1]*v3.x+normal[3*j+4]*v3.y+normal[3*j+7]*v3.z,outputNormal[3*i+2]=normal[3*j+2]*v3.x+normal[3*j+5]*v3.y+normal[3*j+8]*v3.z),outputUV&&(outputUV[3*i+0]=uv[2*j+0]*v3.x+uv[2*j+2]*v3.y+uv[2*j+4]*v3.z,outputUV[3*i+1]=uv[2*j+1]*v3.x+uv[2*j+3]*v3.y+uv[2*j+5]*v3.z),outputSkinIndex){let skinCluster1={};skinCluster1[skinIndex[4*j+0]]=skinWeight[4*j+0],skinCluster1[skinIndex[4*j+1]]=skinWeight[4*j+1],skinCluster1[skinIndex[4*j+2]]=skinWeight[4*j+2],skinCluster1[skinIndex[4*j+3]]=skinWeight[4*j+3];let skinCluster2={};skinCluster2[skinIndex[4*j+4]]=skinWeight[4*j+4],skinCluster2[skinIndex[4*j+5]]=skinWeight[4*j+5],skinCluster2[skinIndex[4*j+6]]=skinWeight[4*j+6],skinCluster2[skinIndex[4*j+7]]=skinWeight[4*j+7];let skinCluster3={};skinCluster3[skinIndex[4*j+8]]=skinWeight[4*j+8],skinCluster3[skinIndex[4*j+9]]=skinWeight[4*j+9],skinCluster3[skinIndex[4*j+10]]=skinWeight[4*j+10],skinCluster3[skinIndex[4*j+11]]=skinWeight[4*j+11];let indices=[];for(let k=0;k<12;k++){let index=skinIndex[4*j+k];-1===indices.indexOf(index)&&indices.push(index)}let clusters=[];for(let k=0;k<indices.length;k++){let index=indices[k];clusters.push([index,(skinCluster1[index]||0)*v3.x+(skinCluster2[index]||0)*v3.y+(skinCluster3[index]||0)*v3.z])}clusters.sort((function(a,b){return b[1]-a[1]}));for(let l=clusters.length-1;l<4;l++)clusters.push([0,0]);let sum=clusters[0][1]+clusters[1][1]+clusters[2][1]+clusters[3][1];outputSkinIndex[4*i+0]=clusters[0][0],outputSkinIndex[4*i+1]=clusters[1][0],outputSkinIndex[4*i+2]=clusters[2][0],outputSkinIndex[4*i+3]=clusters[3][0],outputSkinWeight[4*i+0]=clusters[0][1]*(1/sum),outputSkinWeight[4*i+1]=clusters[1][1]*(1/sum),outputSkinWeight[4*i+2]=clusters[2][1]*(1/sum),outputSkinWeight[4*i+3]=clusters[3][1]*(1/sum)}}let output={},buffer=[];output.position=outputPosition,buffer.push(outputPosition.buffer),outputNormal&&(output.normal=outputNormal,buffer.push(outputNormal.buffer)),outputUV&&(output.uv=outputUV,buffer.push(outputUV.buffer)),outputSkinIndex&&(output.skinIndex=outputSkinIndex,output.skinWeight=outputSkinWeight,buffer.push(outputSkinIndex.buffer),buffer.push(outputSkinWeight.buffer)),resolve(output,id,buffer)}function generatePointCloud({path:path,particleCount:particleCount},id){!async function(){try{let data=await get(path),totalParticles=particleCount;if(data.colors.length>totalParticles){let buffer=new Float32Array(3*totalParticles);for(let i=0;i<totalParticles;i++)buffer[3*i+0]=data.positions[3*i+0],buffer[3*i+1]=data.positions[3*i+1],buffer[3*i+2]=data.positions[3*i+2];data.colors=data.colors.slice(0,totalParticles),data.positions=buffer}else{if(data.colors.length!=totalParticles)throw`Point Cloud particle size mismatch, got ${data.colors.length} for ${totalParticles} ${path}`;data.positions=new Float32Array(data.positions)}let colors=new Float32Array(3*totalParticles);for(let i=0;i<data.colors.length;i++){let hex=Math.floor(Number("0x"+data.colors[i])),r=(hex>>16&255)/255,g=(hex>>8&255)/255,b=(255&hex)/255;colors[3*i+0]=r,colors[3*i+1]=g,colors[3*i+2]=b}data.colors=colors,resolve(data,id,[data.positions.buffer,data.colors.buffer])}catch(e){throw console.log(e),"Could not load Point Cloud for "+path}}()}function generatePointGrid({path:path,particleCount:particleCount},id){let split=path.split("generateGrid-")[1].split("-"),dir=split[0],scale=Number(split[1]),textureSize=(Number(split[2]),Number(split[split.length-1].split(".")[0])),totalParticles=particleCount,positions=new Float32Array(3*totalParticles),colors=new Float32Array(3*totalParticles);for(let i=0;i<totalParticles;i++){let p0=i/textureSize,y=Math.floor(p0),x=p0-y;y/=textureSize,x=Math.range(x,0,1,-scale/2,scale/2),y=Math.range(y,0,1,-scale/2,scale/2),"xz"==dir?(positions[3*i+0]=x,positions[3*i+1]=0,positions[3*i+2]=y):(positions[3*i+0]=x,positions[3*i+1]=y,positions[3*i+2]=0),colors[3*i+0]=1,colors[3*i+1]=1,colors[3*i+2]=1}resolve({colors:colors,positions:positions},id,[colors.buffer,positions.buffer])}this.generate=async function(geom,count){init();let position=new Float32Array(geom.attributes.position.array);return(await Thread.shared().distributeParticles({position:position,count:count},[position.buffer])).position},this.generateInstanced=async function(geom,count){init();let position=new Float32Array(geom.attributes.position.array),offset=new Float32Array(geom.attributes.offset.array),scale=new Float32Array(geom.attributes.scale.array),orientation=new Float32Array(geom.attributes.orientation.array);return(await Thread.shared().distributeParticles({position:position,offset:offset,scale:scale,orientation:orientation,count:count},[position.buffer,offset.buffer,scale.buffer,orientation.buffer])).position},this.generateAll=async function(geom,count){init();let position=new Float32Array(geom.attributes.position.array),normal=new Float32Array(geom.attributes.normal.array),uv=new Float32Array(geom.attributes.uv.array);return await Thread.shared().distributeParticles({position:position,normal:normal,uv:uv,count:count},[position.buffer,normal.buffer,uv.buffer])},this.generateSkinned=async function(geom,count){init();let position=new Float32Array(geom.attributes.position.array),normal=new Float32Array(geom.attributes.normal.array),uv=new Float32Array(geom.attributes.uv.array),skinIndex=new Float32Array(geom.attributes.skinIndex.array),skinWeight=new Float32Array(geom.attributes.skinWeight.array);return await Thread.shared().distributeParticles({position:position,normal:normal,uv:uv,skinIndex:skinIndex,skinWeight:skinWeight,count:count},[position.buffer,normal.buffer,uv.buffer,skinIndex.buffer,skinWeight.buffer])},this.generatePointCloud=async function(path,particleCount){path.includes("assets/geometry")||(path="assets/geometry/"+path),path.includes(".json")||(path+=".json"),init();let fn=path.includes("generateGrid")?Thread.shared().generatePointGrid:Thread.shared().generatePointCloud,data=await fn({path:Thread.absolutePath(path),particleCount:particleCount});return{positions:new AntimatterAttribute(data.positions,3),colors:new AntimatterAttribute(data.colors,3)}}}),"static"),Class((function PBRShader(_vertexShader,_fragmentShader,_params){const _this=this;function defineSetter(prop){Object.defineProperty(_this,prop,{set:function(v){_this.shader[prop]=v},get:function(){return _this.shader[prop]}})}"object"==typeof _vertexShader&&(_params=_vertexShader,_vertexShader=_fragmentShader="PBR"),"object"==typeof _fragmentShader&&(_params=_fragmentShader,_fragmentShader=_vertexShader),_vertexShader||(_vertexShader=_fragmentShader="PBR"),function initShader(){let lookup=Utils3D.getLookupTexture("assets/images/pbr/lut.png");lookup.forcePersist=!0,_this.shader=new Shader(_vertexShader,_fragmentShader,Utils.mergeObject(_params||{},{tBaseColor:{value:null,getTexture:Utils3D.getRepeatTexture},tMRO:{value:null,getTexture:Utils3D.getRepeatTexture},tNormal:{value:null,getTexture:Utils3D.getRepeatTexture},tEnvDiffuse:{value:null,premultiplyAlpha:!1},tEnvSpecular:{value:null,premultiplyAlpha:!1},uMRO:{value:new Vector3(1,1,1)},uHDR:{value:0,ignoreUIL:!0},uNormalScale:{value:new Vector2(1,1)},tLUT:{value:lookup,ignoreUIL:!0},uEnv:{value:new Vector2(1,0)},uLight:{value:new Vector4(1,1,1,1)},receiveLight:!0})),_this.lights=_this.shader.lights,_this.uniforms=_this.shader.uniforms,["side","blending","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","receiveShadow","vertexShader","fragmentShader","depthTest","depthWrite","wireframe","transparent","visible","persists","material","customShadowShader"].forEach(defineSetter)}()}),(_=>{const prototype=PBRShader.prototype;prototype.set=function(key,value){return void 0!==value&&(this.shader.uniforms[key].value=value),this.shader.uniforms[key].value},prototype.get=function(key){return this.shader.uniforms[key].value},prototype.tween=function(key,value,time,ease,delay,callback,update){return tween(this.shader.uniforms[key],{value:value},time,ease,delay,callback,update)},prototype.setPBR=prototype.setOverride=function(key,value,src){switch(this.set(key,value),key){case"tEnvDiffuse":case"tEnvSpecular":case"tLUT":value.generateMipmaps=!1,value.minFilter=Texture.LINEAR}value.wrapS=value.wrapT=Texture.REPEAT,src||(src=value.src),src&&src.toLowerCase().includes("rgbm")&&this.shader.set("uHDR",1)},prototype.destroy=function(){this.shader.destroy()},prototype.copyUniformsTo=function(shader,linked){for(let key in this.uniforms)shader.uniforms[key]=linked?this.uniforms[key]:{type:this.uniforms[key].type,value:this.uniforms[key].value}},prototype.addUniforms=function(uniforms){uniforms.UILPrefix&&(this.UILPrefix=uniforms.UILPrefix,delete uniforms.UILPrefix);for(let key in uniforms)this.uniforms[key]=uniforms[key]}})),Class((function PhysicalLink(_id){const _this=this;var _events={},_globalEvents={},_globalLinks=[];this.initLink=function(id){_id=id,PhysicalSync.createInstanceLink(_this,id)},this.bindLink=function(obj,id){if(obj instanceof GLUIObject){let gluiObject=obj;obj=new Group,_this.startRender((_=>{let stage=_this.stage||Stage;_id?(gluiObject.x=obj.position.x*stage.width,gluiObject.y=obj.position.y*stage.height):(obj.position.x=gluiObject.x/stage.width,obj.position.y=gluiObject.y/stage.height)}))}_id?PhysicalSync.createRemoteLink(obj,_id,id):PhysicalSync.createLocalLink(obj,id)},this.bindEvent=function(name,callback){_events[name]=callback,PhysicalSync.createRemoteEvent(name,_id,callback)},this.bindGlobal=function(obj,id){PhysicalSync.createGlobalLink(obj,id),_globalLinks.push(id)},this.bindGlobalEvent=function(name,callback){PhysicalSync.createGlobalEvent(name,callback),_globalEvents[name]=callback},this.fireEvent=function(name,data={}){PhysicalSync.fireLocalEvent(name,data),_events[name]&&_events[name](data),_globalEvents[name]&&_globalEvents[name](data)},this.destroyLink=function(){PhysicalSync.deleteInstanceLink(_id),_globalLinks.forEach((id=>PhysicalSync.deleteGlobalLink(id)));for(let key in _globalEvents)PhysicalSync.deleteGlobalEvent(key)},defer((_=>{_this&&_this._bindOnDestroy&&_this._bindOnDestroy((_=>{_this.destroyLink()}))})),_id&&_this.initLink(_id)})),Class((function PhysicalSync(){Inherit(this,Component);const _this=this;var _room,_playerQueue,_visibilityTimer,_matrix=new Matrix4,_instances={},_instanceBackup={},_objects={},_global={},_globalEvents={},_eventMap={},_events=[],_transmit={},_globalTransmit={},_handledEvents={},_receivedGlobals=[],_evt={pS:"d",events:[]};this.CONNECTION="physical_sync_connection",this.DISCONNECTION="physical_sync_disconnection",this.ROOM_TIMEOUT="physical_sync_room_timeout",this.baseLerp=.15,this.transmitFPS=30,this.compensateLag=!0;const ZERO_POS=new Vector3(0,0,0),ZERO_QUAT=new Quaternion(0,0,0,1);function startSync(){_room.host&&_room.broadcast({pS:"perform_sync",pos:World.CAMERA.position.toArray(),quaternion:World.CAMERA.quaternion.toArray()})}function optimize(obj){for(let i=0;i<3;i++)obj.p[i]=Number(obj.p[i].toFixed(3));for(let i=0;i<4;i++)obj.q[i]=Number(obj.q[i].toFixed(3))}function shouldHandle(event){return!_handledEvents[event.id]&&(_handledEvents[event.id]=!0,_this.delayedCall((_=>{delete _handledEvents[event.id]}),1e3),!0)}function isZero(obj){return obj.position.equals(ZERO_POS)&&obj.quaternion.equals(ZERO_QUAT)}function transmit(){if(_objects.local&&_room){for(let key in _objects.local){let obj=_objects.local[key];obj.preventSync||!obj.extraData&&isZero(obj)?_transmit[key]&&delete _transmit[key]:(_transmit[key]||(_transmit[key]={p:[],q:[]}),obj.position.toArray(_transmit[key].p),obj.quaternion.toArray(_transmit[key].q),optimize(_transmit[key]),obj.extraData&&(_transmit[key].extraData=obj.extraData))}for(let key in _global){let obj=_global[key];obj.broadcastSync||obj.forceBroadcastSync?(_globalTransmit[key]||(_globalTransmit[key]={p:[],q:[],f:obj.forceBroadcastSync}),obj.position.toArray(_globalTransmit[key].p),obj.quaternion.toArray(_globalTransmit[key].q),optimize(_globalTransmit[key])):_globalTransmit[key]&&delete _globalTransmit[key]}_evt.events.length=0;for(let i=0;i<_events.length;i++){let event=_events[i];Render.TIME-event.time<250?_evt.events.push(event.evt):_events.splice(i,1)}_evt.objects=_transmit,_evt.global=_globalTransmit,_room&&_room.broadcast&&(_evt.events.length||Object.keys(_evt.global).length||Object.keys(_evt.objects).length)&&_room.broadcast(_evt)}}function loop(){for(let player in _objects){if("local"==player)continue;let playerObj=_objects[player];for(let key in playerObj){let obj=playerObj[key],lerp=_this.baseLerp*obj.lerpMult;obj.positionTarget&&!obj.preventSync&&(obj.position.lerp(obj.positionTarget,lerp),obj.quaternion.slerp(obj.quaternionTarget,lerp))}}if(_receivedGlobals.length){for(let i=0;i<_receivedGlobals.length;i++){let key=_receivedGlobals[i],obj=_global[key];if(obj.positionTarget&&!obj.preventSync){let lerp=obj.forced?1:_this.baseLerp*obj.lerpMult;obj.position.lerp(obj.positionTarget,lerp),obj.quaternion.slerp(obj.quaternionTarget,lerp)}}_receivedGlobals.length=0}if(_playerQueue.length){for(let i=0;i<10;i++){let obj=_playerQueue.shift();obj&&_this.events.fire(_this.CONNECTION,obj)}}}function handleEvent({evtData:evtData,evtName:evtName,from:from}){let callbacks=_eventMap[from];if(callbacks){let callback=callbacks[evtName];callback&&callback(evtData)}let callback=_globalEvents[evtName];callback&&callback(evtData)}function playerJoin(e){if(_room.isCommunity?_playerQueue.push({id:e.player.id,userData:e.player.data,player:e.player}):_this.events.fire(_this.CONNECTION,{id:e.player.id,userData:e.player.data,player:e.player}),_room.host&&!_room.isCommunity){for(let key in _global)_global[key].forceBroadcastSync=e.player.id;_this.delayedCall((_=>{for(let key in _global)_global[key].forceBroadcastSync=!1}),500)}}function playerDisconnect(e){let obj=_instances[e.player.id]||_instanceBackup[e.player.id];obj&&(_this.events.fire(_this.DISCONNECTION,{id:e.player.id,userData:e.player.data}),obj.onDisconnect?obj.onDisconnect():obj.destroy&&obj.destroy()),delete _instances[e.player.id],delete _instanceBackup[e.player.id],delete _eventMap[e.player.id];for(let i=0;i<_playerQueue.length;i++)_playerQueue[i].player==e.player&&_playerQueue.splice(i,1)}function roomError(){_this.events.fire(_this.ROOM_TIMEOUT),_room&&_room.players&&_room.players.forEach((player=>{playerDisconnect({player:player})}))}function data({data:data,player:player}){if(data.pS)switch(data.pS){case"start_sync":startSync();break;case"perform_sync":!function performSync({pos:pos,quaternion:quaternion}){let remotePos=(new Vector3).fromArray(pos),cameraQuat=World.CAMERA.quaternion,cameraPos=World.CAMERA.position,localQuaternion=World.SCENE.quaternion,localScene=World.SCENE.position,orientedRemotePos=((new Quaternion).fromArray(quaternion),(new Vector3).copy(remotePos).applyQuaternion(cameraQuat)),localOrigin=(new Vector3).copy(cameraPos),remoteOrigin=(new Vector3).copy(orientedRemotePos).multiplyScalar(-1);localScene.copy(localOrigin).add(remoteOrigin),localQuaternion.copy(cameraQuat)}(data);break;case"d":!function transmitData({objects:objects,from:from,global:global,events:events},player){let lerpMultiplier=_this.compensateLag?Math.range(player.ping,50,200,1,.25,!0):1;for(let key in global){let obj=_global[key];obj&&(obj.lerpMult=lerpMultiplier,obj.positionTarget||(obj.positionTarget=new Vector3,obj.quaternionTarget=new Quaternion),global[key].p&&(_receivedGlobals.push(key),global[key].f==GameCenter.GCID&&(obj.physics&&(void 0===obj.physics.stashKinematic&&(obj.physics.stashKinematic=obj.physics.kinematic,obj.physics.kinematic=!0),clearTimeout(obj.physics.timer),obj.physics.timer=_this.delayedCall((_=>{obj.physics.kinematic=obj.physics.stashKinematic}),100)),obj.forced=!0),obj.positionTarget.fromArray(global[key].p),obj.quaternionTarget.fromArray(global[key].q)))}if(_objects[from])for(let key in objects){let obj=_objects[from][key];obj&&(obj.lerpMult=lerpMultiplier,obj.positionTarget||(obj.positionTarget=new Vector3,obj.quaternionTarget=new Quaternion),objects[key].p&&(obj.positionTarget.fromArray(objects[key].p),obj.quaternionTarget.fromArray(objects[key].q)),objects[key].extraData&&(obj.extraData=objects[key].extraData))}if(events)for(let i=events.length-1;i>-1;i--){let event=events[i];shouldHandle(event)&&(event.from=from,handleEvent(event))}}(data,player);break;case"event":handleEvent(data)}}function handleVisibility(e){"blur"==e.type?_visibilityTimer=setInterval(transmit,250):clearInterval(_visibilityTimer)}_this.events.sub(GameCenter.LOST_CONNECTION,(_=>_this.useRoom(null))),_this.events.sub(Events.VISIBILITY,handleVisibility),this.connect=async function(server){GameCenter.ports=this.ports||1,GameCenter.userData=this.userData||{},GameCenter.connect(server);try{_room=await GameCenter.findRoom(),_this.events.sub(_room,GameCenterRoom.PLAYER_JOIN,playerJoin),_this.events.sub(_room,GameCenterRoom.PLAYER_DISCONNECT,playerDisconnect),_this.events.sub(_room,GameCenter.DATA,data)}catch(e){console.error(e)}_room.players.forEach((player=>{player.me||_this.events.fire(_this.CONNECTION,{id:player.id,userData:player.data,player:player})}))},this.useRoom=function(room){if(null==room&&_room&&_room.players&&_room.players.forEach((player=>{player.me||playerDisconnect({player:player})})),_room=room,_playerQueue=[],_this.startRender(loop),_room){try{_this.events.sub(_room,GameCenterRoom.PLAYER_JOIN,playerJoin),_this.events.sub(_room,GameCenterRoom.PLAYER_DISCONNECT,playerDisconnect),_this.events.sub(_room,GameCenterRoom.ERROR,roomError),_this.events.sub(_room,GameCenter.DATA,data)}catch(e){console.error(e)}_room.players.forEach((player=>{player.me||(_room.isCommunity?_playerQueue.push({id:player.id,userData:player.data,player:player}):_this.events.fire(_this.CONNECTION,{id:player.id,userData:player.data,player:player}))}))}},this.sync=function(){_room.host?startSync():_room.broadcast({pS:"start_sync"})},this.createInstanceLink=function(obj,id){_instances[id]=obj,_instanceBackup[id]=obj},this.deleteInstanceLink=function(id){id&&(delete _instances[id],delete _objects[id],delete _eventMap[id])},this.createLocalLink=function(obj,id){_objects.local||(_objects.local={}),_objects.local[id]=obj,_this.startRender(transmit,_this.transmitFPS)},this.deleteLocalLink=function(id){delete _objects.local[id]},this.createRemoteEvent=function(name,id,callback){_eventMap[id]||(_eventMap[id]={}),_eventMap[id][name]=callback},this.createGlobalEvent=function(id,callback){_globalEvents[id]=callback},this.deleteGlobalEvent=function(id){delete _globalEvents[id]},this.fireLocalEvent=function(name,data={}){_events.push({evt:{evtData:data,evtName:name,id:Utils.uuid()},time:Render.TIME})},this.createGlobalLink=function(obj,id){_global[id]=obj},this.deleteGlobalLink=function(id){delete _global[id]},this.createRemoteLink=function(obj,playerId,id){_objects[playerId]||(_objects[playerId]={}),_objects[playerId][id]=obj,_this.startRender(loop)},this.alignLocally=function(yOffset=0){World.SCENE.quaternion.copy(World.CAMERA.quaternion),World.SCENE.rotation.z=0,World.SCENE.rotation.x=0,World.SCENE.position.copy(World.CAMERA.position),World.SCENE.position.y+=yOffset,World.SCENE.updateMatrixWorld(!0),_matrix.getInverse(World.SCENE.matrix),_this.flag("aligned",!0)},this.realignObject=function(obj){_this.flag("aligned")&&obj.applyMatrix(_matrix)}}),"static"),Class((function Proton(_input,_group){Inherit(this,Object3D);const _this=this;var _config,_size,_antimatter,_behaviorInput;const prefix=this.prefix="P_"+_input.prefix;async function initConfig(){(_config=_this.uilConfig=InputUIL.create(prefix+"_config",_group)).setLabel("Config"),_config.addButton("load-values",{label:"Values",actions:[{title:"Load",callback:loadValues},{title:"Save",callback:saveValues}]}).addButton("save",{label:"Configuration",actions:[{title:"Load",callback:loadConfig},{title:"Save",callback:saveConfig}]}).addButton("load-shader",{label:"Shader",actions:[{title:"Load",callback:()=>loadShader()}]}).addButton("load-behavior",{label:"Behavior",actions:[{title:"Load",callback:()=>loadBehavior()}]});_config.addSelect("type",[{label:"Permanent",value:"permanent"},{label:"Lifecycle",value:"lifecycle"}]),_config.add("particleCount",1e3);let output=[{label:"Particles",value:"particles"},{label:"Custom",value:"custom"}];window.ProtonTubes&&output.push({label:"Tubes",value:"tubes"}),_config.addSelect("output",output),_config.add("shader"),_config.get("shader")&&_config.addTextarea("uniforms"),_config.add("class");_config.get("type");try{if(!1===_input.get("visible"))throw"Layer set to invisible";_this.particleCount=_size=getSize(),initAntimatter()}catch(e){console.warn("Proton skipped",e),_this.disabled=!0}}function loadValues(){const name=prompt("Name of values to be loaded");if(null===name)return;let data=UILStorage.get("proton_values_"+name);data||alert(`No values ${name} found`),data=JSON.parse(data);let apply=(shader,obj)=>{for(let key in obj)UILStorage.set(shader.UILPrefix+key,obj[key])};apply(_this.behavior,data.behavior),apply(_this.shader,data.shader),_this.customClass&&_this.customClass.saveValues&&apply(_this.customClass.saveValues(),data.custom),alert("Values imported. Save and refresh.")}function saveValues(){const name=prompt("Name of values to be saved");if(null===name)return;let store=(shader,to)=>{for(let key in shader.uniforms){if(shader.uniforms[key].ignoreUIL)continue;let uilValue=UILStorage.get(shader.UILPrefix+key);void 0!==uilValue&&(to[key]=uilValue)}},output={behavior:{},shader:{}};store(_this.behavior,output.behavior),store(_this.shader,output.shader),_this.customClass&&_this.customClass.saveValues&&(output.custom={},store(_this.customClass.saveValues(),output.custom)),UILStorage.setWrite("proton_values_"+name,JSON.stringify(output))}function loadConfig(){const name=prompt("Name of configuration to be loaded");if(null===name)return;let toLoad=UILStorage.get("proton_config_"+name);loadBehavior(toLoad),loadShader(toLoad),alert("Loaded. Save and refresh")}function saveConfig(){let name=prompt("Name of configuration to be saved");null!==name&&UILStorage.setWrite("proton_config_"+name,prefix)}function loadShader(toLoad){let shouldNotify=!toLoad;if(!toLoad){const name=prompt("Name of shader to be loaded");if(null===name)return;toLoad=UILStorage.get("proton_config_"+name)}let copyConfig=InputUIL.create(toLoad+"_config",null);_config.copyFrom(copyConfig,["shader","uniforms"]),(_config.get("uniforms")||"").split("\n").forEach((line=>{if(!line.includes(":"))return;let name=(line=line.replace(/ /g,"")).split(":")[0],shaderName=copyConfig.get("shader"),store=`${shaderName}/${shaderName}/${prefix}/`,lookup=`${shaderName}/${shaderName}/${toLoad}/`,val=UILStorage.get(lookup+name);val?UILStorage.set(store+name,val):(val=UILStorage.get(lookup+"_tx_"+name),val&&UILStorage.set(store+"_tx_"+name,val))})),shouldNotify&&alert("Loaded. Save and refresh")}function loadBehavior(toLoad){let shouldNotify=!toLoad;if(!toLoad){const name=prompt("Name of behavior to be loaded");if(null===name)return;toLoad=UILStorage.get("proton_config_"+name)}let copyConfig=InputUIL.create(toLoad+"_config",null);_config.copyFrom(copyConfig,["type","particleCount","output","class"]);let copyBehavior=InputUIL.create(toLoad+"_behavior",null);InputUIL.create(prefix+"_behavior",null).copyFrom(copyBehavior,["uniforms","data","codeCount"]);let data=copyBehavior.get("data")||[],buniformString=copyBehavior.get("uniforms")+"\n";ListUIL.create(prefix+"_code",null).internalAddItems(data.length),data.forEach((postfix=>{let toCode=InputUIL.create(prefix+postfix,null),fromCode=InputUIL.create(toLoad+postfix,null);toCode.copyFrom(fromCode,["name","code","uniforms","preset"]),buniformString+=fromCode.get("uniforms")+"\n"})),buniformString.split("\n").forEach((line=>{if(!line.includes(":"))return;let name=(line=line.replace(/ /g,"")).split(":")[0],lookup="am_ProtonAntimatter_"+toLoad,store="am_ProtonAntimatter_"+prefix,val=UILStorage.get(lookup+name);val&&UILStorage.set(store+name,val)}));let className=copyConfig.get("class");className&&(_this.customClass=_this.parent.initClass(window[className],_this,_group,_input),_this.customClass.loadConfig&&_this.customClass.loadConfig(toLoad,prefix)),shouldNotify&&alert("Loaded. Save and refresh")}function getSize(){if(_this.parent.data&&_this.parent.data.particleCount)return"string"==typeof _this.parent.data.particleCount?eval(_this.parent.data.particleCount):_this.parent.data.particleCount;let size=_config.getNumber("particleCount");if(isNaN(size))try{size=eval(_config.get("particleCount"))}catch(e){throw"Proton particleCount is not a number or valid test function"}if(isNaN(size))throw"Proton particleCount is falsy!";return _this.particleCount=size,size}async function initCustomClass(){_this.shader.addUniforms({DPR:{value:World.DPR,ignoreUIL:!0}});let className=_config.get("class");className&&(_this.customClass=_this.parent.initClass(window[className],_this,_group,_input))}function parseUniforms(text,predefined){if(!text)return{};let split=text.split("\n"),output={};return split.forEach((line=>{if(!(line=line.replace(/ /g,"")).length||!line.includes(":"))return;let split=line.split(":"),name=split[0],val=split[1];if(val.includes("[")){let array=JSON.parse(val);switch(array.length){case 2:output[name]={value:(new Vector2).fromArray(array)};break;case 3:output[name]={value:(new Vector3).fromArray(array)};break;case 4:output[name]={value:(new Vector4).fromArray(array)};break;default:throw"Unknown uniform type "+line}}else"C"==val.charAt(0)?predefined[name]=val.slice(1):"T"===val?output[name]={value:null}:"OEST"===val?output[name]={value:null,oes:!0}:val.includes(["0x","#"])?output[name]={value:new Color(val)}:output[name]={value:Number(val)}})),output}function getUniformGLSLType(obj){return"number"==typeof obj.value?"float":obj.oes?"samplerExternalOES":null===obj.value||obj.value instanceof Texture?"sampler2D":obj.value instanceof Vector2?"vec2":obj.value instanceof Vector3||obj.value instanceof Vector3D?"vec3":obj.value instanceof Vector4?"vec4":obj.value instanceof Color?"vec3":void 0}async function initBehavior(behavior){let glsl=[],predefinedUniforms={HZ:"float"},input;_behaviorInput?input=_behaviorInput:(input=InputUIL.create(prefix+"_behavior",_group),input.setLabel("Behavior Uniforms"),input.addTextarea("uniforms"),input.add("data","hidden"),input.add("codeCount","hidden"),_behaviorInput=input);let map={},list=[],count=input.getNumber("codeCount")||0,data=input.get("data")||[],panel=ListUIL.create(prefix+"_code",_group);panel.setLabel("Behavior Code"),panel.onAdd(((name,input,index)=>{list[index]||addCode(),input.group.add(list[index].group),list[index].mapId=name,map[name]=list[index],input.setLabel(map[name].get("name")||"Code")})),panel.onRemove((name=>{let postfix=map[name].postfix;list.remove(map[name]),data.remove(postfix),input.setValue("data",JSON.stringify(data))})),panel.onSort((array=>{let arr=[];array.forEach((name=>{arr.push(map[name].postfix)})),data=arr,input.setValue("data",JSON.stringify(data))}));let uniforms=parseUniforms(input.get("uniforms")),createCode=postfix=>{let input=InputUIL.create(prefix+postfix,_group,!0);if(input.prefix=prefix+postfix,input.postfix=postfix,input.setLabel("Editor"),input.add("name","hidden"),Proton.ignorePresets&&Proton.ignorePresets.includes(input.get("name")))return;ProtonPresets.bind(input),input.customPresetCallback&&input.customPresetCallback(_this);let code=input.get("code")||"";if(!input.disabled&&code.length){for(uniforms=Utils.mergeObject(uniforms,parseUniforms(input.get("uniforms"),predefinedUniforms));code.includes("#test ");)try{let test=code.split("#test ")[1],name=test.split("\n")[0],glsl=code.split("#test "+name+"\n")[1].split("#endtest")[0];eval(name)||(code=code.replace(glsl,"")),code=code.replace("#test "+name+"\n",""),code=code.replace("#endtest","")}catch(e){throw"Error parsing test :: "+e}glsl.push(code)}list.push(input)};data.forEach(createCode);let addCode=_=>{count++,data.push("code_"+count),input.setValue("data",JSON.stringify(data)),input.setValue("codeCount",count),createCode("code_"+count)};behavior instanceof AntimatterPass&&(behavior.addInput("tOrigin",_antimatter.vertices),behavior.addInput("tAttribs",_antimatter.attribs),behavior.addUniforms(uniforms));let filledRequire=[],insertUniform=(code,line)=>code.split("//uniforms").join(line+"\n//uniforms"),insertCode=(code,line)=>code.split("//code").join(line+"\n//code"),insertRequire=(code,line)=>{let name=line.split("require(")[1].split(")")[0];return filledRequire.includes(name)?code:(filledRequire.push(name),code.split("//require").join(Shaders.getShader(name)+"\n//require"))},insertGLSL=(code,line)=>{if(line.includes("#require")){let split=line.split("\n");for(let l of split)code=l.includes("#require")?insertRequire(code,l):insertCode(code,l);return code}return insertCode(code,line)};behavior.onCreateShader=code=>{for(let name in uniforms)code=insertUniform(code,`uniform ${getUniformGLSLType(uniforms[name])} ${name};`);for(let name in predefinedUniforms)code=insertUniform(code,`uniform ${predefinedUniforms[name]} ${name};`);for(let str of glsl)code=insertGLSL(code,str);return _this.tubes&&(code=_this.tubes.overrideShader(code)),Renderer.type==Renderer.WEBGL2&&(code=code.replace(/gl_FragColor/g,"FragColor")),code.includes("samplerExternalOES")&&window.AURA&&"android"==Device.system.os&&(code="#version 300 es\n#extension GL_OES_EGL_image_external_essl3 : require\n"+code.replace("#version 300 es","")),code},behavior.uniforms.uMaxCount={value:_this.particleCount,ignoreUIL:!0},ShaderUIL.add(behavior,_group).setLabel("Behavior Shader"),behavior.uniforms.HZ={value:1},_this.startRender((_=>{behavior.uniforms.HZ.value=Render.HZ_MULTIPLIER}),10),ProtonPresets.onCodeEdit=rebuildShader}async function rebuildShader(){let lifecycle="lifecycle"==_config.get("type"),behavior=_this.initClass(AntimatterPass,"ProtonAntimatter"+(lifecycle?"Lifecycle":""),{unique:prefix,customCompile:prefix+Utils.uuid()});await initBehavior(behavior),behavior.initialize(64),behavior.upload(),_this.behavior.shader._gl&&(_this.behavior.shader._gl=behavior.shader._gl),_this.behavior.shader._metal&&(_this.behavior.shader._metal=behavior.shader._metal),_this.behavior.shader._gpu&&(_this.behavior.shader._gpu=behavior.shader._gpu)}function completeShader(shader){let transparent=_input.get("transparent"),depthWrite=_input.get("depthWrite"),depthTest=_input.get("depthTest"),blending=_input.get("blending"),castShadow=_input.get("castShadow"),receiveShadow=_input.get("receiveShadow");"boolean"==typeof depthWrite&&(shader.depthWrite=depthWrite),"boolean"==typeof depthTest&&(shader.depthTest=depthTest),"boolean"==typeof transparent&&(shader.transparent=transparent),"boolean"==typeof castShadow&&(_this.mesh.castShadow=castShadow),"boolean"==typeof receiveShadow&&(shader.receiveShadow=receiveShadow),blending&&(shader.blending=blending),shader.uniforms.tRandom={value:_antimatter.attribs}}function update(){_this.preventUpdate||_antimatter.update()}async function initAntimatter(){let lifecycle="lifecycle"==_config.get("type");_config.addVector("width",[-1,1]),_config.addVector("height",[-1,1]),_config.addVector("depth",[-1,1]);let dimensions={w:_config.get("width")||[-1,1],h:_config.get("height")||[-1,1],d:_config.get("depth")||[-1,1],pot:"tubes"===_config.get("output")};_antimatter=_this.initClass(Antimatter,_size,dimensions),Proton.forceCloneVertices.includes(_config.get("class"))&&(_antimatter.cloneVertices=!0),_this.antimatter=_antimatter,await _antimatter.ready();let output=_config.get("output");"tubes"==output&&(_this.tubes=_this.initClass(ProtonTubes,_this));let overrideShader,wildcard=_input.get("wildcard");if(wildcard&&wildcard.includes(".behavior")){let layer=await _this.parent.getLayer(wildcard.split(".")[0]);await _this.wait(layer,"behavior"),_this.behavior=layer.behavior}else{let behavior=_this.initClass(AntimatterPass,"ProtonAntimatter"+(lifecycle?"Lifecycle":""),{unique:prefix,customCompile:prefix});_this.behavior=behavior,initBehavior(behavior)}let shaderName=_config.get("shader");if(shaderName)if(shaderName.includes(".shader")){let layer=await _this.parent.getLayer(shaderName.split(".")[0]);await _this.wait(layer,"shader"),overrideShader=layer.shader}else{let uniforms=parseUniforms(_config.get("uniforms"));uniforms.unique=prefix+(_this.onGenerateUniqueShader?_this.onGenerateUniqueShader():""),_antimatter.useShader(shaderName,uniforms)}_antimatter.addPass(_this.behavior),_this.mesh=_antimatter.getMesh(),_this.onCreateMesh&&_this.onCreateMesh(_this.mesh),output&&"particles"!=output||_this.delayedCall((_=>{_this.add(_antimatter.mesh)}),480),Utils.query("uilOnly")||_this.startRender(update,RenderManager.AFTER_LOOPS),shaderName&&!shaderName.includes(".shader")&&(ShaderUIL.add(_antimatter.shader,_group).setLabel("Shader"),completeShader(_antimatter.shader)),overrideShader&&_antimatter.overrideShader(overrideShader),_this.shader=_antimatter.shader,_this.initialized=!0,lifecycle&&(_this.spawn=_this.initClass(AntimatterSpawn,_this,_group,_input)),initCustomClass()}this.uilInput=_input,this.uilGroup=_group,this.prefix=prefix,initConfig(),this.parseUniforms=parseUniforms,this.ready=function(){return this.wait(this,"initialized")},this.applyToInstancedGeometry=function(geometry){geometry.addAttribute("lookup",new GeometryAttribute(_antimatter.getLookupArray(),3,1)),geometry.addAttribute("random",new GeometryAttribute(_antimatter.getRandomArray(),4,1))},this.applyToShader=function(shader){shader.addUniforms({tPos:_antimatter.getOutput(),tPrevPos:_antimatter.getPrevOutput()})},this.upload=async function(){_this.disabled||(_this.group.visible=!1,await this.ready(),await _antimatter.upload("particles"===_config.get("output")),_this.spawn&&await _this.spawn.upload(),_this.tubes&&await _this.tubes.upload(),_this.group.visible=!0)},this.uploadSync=async function(){_this.disabled||(await this.ready(),await _antimatter.uploadSync("particles"===_config.get("output")),_this.spawn&&await _this.spawn.upload(),_this.tubes&&await _this.tubes.uploadSync())},this.stopUpdating=function(){_this.stopRender(update)},this.set("renderOrder",(async v=>{await _this.ready(),await _antimatter.ready(),_antimatter.mesh.renderOrder=v})),this.get("renderOrder",(v=>_antimatter.mesh.renderOrder))}),(_=>{Proton.forceCloneVertices=[],Proton.ignore=function(name){Proton.ignorePresets||(Proton.ignorePresets=[]),Proton.ignorePresets.push(name)}})),Class((function ProtonPresets(){const _this=this,LIST=[{label:"Custom Code",value:"custom"},{label:"Curl Noise",value:"curl"},{label:"Sine Move",value:"sine"},{label:"Plane Shape",value:"planeshape"},{label:"3D Shape",value:"3dshape"},{label:"Point Cloud",value:"pointcloud"},{label:"Force",value:"force"},{label:"Follow",value:"follow"},{label:"Mouse Fluid",value:"fluid"}],CALLBACKS={custom:function customCode(input){input.setValue("name","Custom Code"),input.setLabel("Custom Code")},curl:function curlNoise(input){input.setValue("name","Curl Noise"),input.setLabel("Curl Noise");input.setValue("uniforms","\n        uCurlNoiseScale: 1\n        uCurlTimeScale: 0\n        uCurlNoiseSpeed: 0\n        "),setPresetCodeIfRequired(input,"#require(curl.glsl)\n\nvec3 curl = curlNoise(pos * uCurlNoiseScale*0.1 + (time * uCurlTimeScale * 0.1));\npos += curl * uCurlNoiseSpeed * 0.01 * HZ;","uCurlNoise")},sine:function sineMove(input){input.setValue("name","Sine Move"),input.setLabel("Sine Move");input.setValue("uniforms","\n        uSinSpeed: 1\n        uSinMovement: 0\n        "),setPresetCodeIfRequired(input,"pos = origin;\npos.x += sin(time*uSinSpeed + radians(360.0 * random.x)) * 0.03 * random.z * uSinMovement;\npos.y += sin(time*uSinSpeed + radians(360.0 * random.y)) * 0.03 * random.w * uSinMovement;\npos.z += sin(time*uSinSpeed + radians(360.0 * random.w)) * 0.03 * random.x * uSinMovement;","uSinSpeed")},planeshape:function planeShape(input){input.setValue("name","Plane Shape"),input.setLabel("Plane Shape");input.setValue("uniforms","\n        uTakePlaneShape: 1\n        uPlaneScale: 1\n        tPlaneTexture: Csampler2D\n        "),setPresetCodeIfRequired(input,"vec2 planeLookup = texture2D(tPlaneTexture, uv).xy;\nvec3 plane;\nplane.x = uPlaneScale * 0.5 * range(planeLookup.x, 0.0, 1.0, -1.0, 1.0);\nplane.y = uPlaneScale * 0.5 * -range(planeLookup.y, 0.0, 1.0, -1.0, 1.0);\nif (uTakePlaneShape > 0.5) pos = plane;","uPlaneScale"),input.customPresetCallback=proton=>{proton.behavior.addUniforms({tPlaneTexture:{value:null}})}},"3dshape":function shape3D(input){input.setValue("name","3D Shape"),input.setLabel("3D Shape"),input.add("geometry");let geometry=input.get("geometry");input.setValue("uniforms","\n        tShape3D: Csampler2D\n        "),setPresetCodeIfRequired(input,"vec3 shape3d = texture2D(tShape3D, uv).xyz;","tShape3D"),input.customPresetCallback=proton=>{let create=async g=>{let geom=await GeomThread.loadGeometry(g),distribution=await ParticleDistributor.generate(geom,proton.antimatter.particleCount),attribute=new AntimatterAttribute(distribution,3);proton.behavior.addInput("tShape3D",attribute)};geometry&&create(geometry),proton.set3DShape=create}},pointcloud:function pointCloud(input){input.setValue("name","Point Cloud"),input.setLabel("Point Cloud"),input.add("file");let file=input.get("file");input.setValue("uniforms","\n        tPointCloud: Csampler2D\n        "),setPresetCodeIfRequired(input,"vec3 pointShape = texture2D(tPointCloud, uv).xyz;","tPointCloud"),input.customPresetCallback=proton=>{let create=async filePath=>{let data;"string"==typeof filePath?(filePath+="-"+proton.antimatter.powerOf2,data=await ParticleDistributor.generatePointCloud(filePath,proton.antimatter.particleCount)):data=filePath,proton.behavior.shader.uniforms.tPointCloud&&(proton.behavior.shader.uniforms.tPointCloud.value.destroy(),proton.shader.uniforms.tPointColor.value.destroy()),proton.behavior.addInput("tPointCloud",data.positions),proton.shader.addUniforms({tPointColor:{value:data.colors}})};file||(file=proton.parent.data?proton.parent.data.pointCloudFile:void 0),file&&create(file),proton.setPointCloud=create}},force:function force(input){input.setValue("name","Force"),input.setLabel("Force");input.setValue("uniforms","\n        uForceDir: [0, 1, 0]\n        uForceScale: 1\n        "),setPresetCodeIfRequired(input,"vec3 force = normalize(uForceDir) * uForceScale * 0.1;\npos += force * HZ;","uForceDir")},follow:function follow(input){input.setValue("name","Follow"),input.setLabel("Follow");input.setValue("uniforms","\n        uFollowPos: [0, 0, 0]\n        uFollowRadius: 2\n        uFollowLerp: 0.7\n        "),setPresetCodeIfRequired(input,"float speed = range(random.x, 0.0, 1.0, 0.5, 1.5);\nvec3 followPos = uFollowPos;\nfollowPos.x += range(random.y, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\nfollowPos.y += range(random.z, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\nfollowPos.z += range(random.w, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\npos += (followPos - pos) * (uFollowLerp*0.1*speed*HZ);","followPos")},fluid:function fluid(input){input.setValue("name","Mouse Fluid"),input.setLabel("Mouse Fluid");input.setValue("uniforms","\n        uProjMatrix: Cmat4\n        uProjNormalMatrix: Cmat4\n        uModelMatrix: Cmat4\n        tFluidMask: Csampler2D\n        tFluid: Csampler2D\n        uMouseStrength: 1\n        "),setPresetCodeIfRequired(input,"#require(glscreenprojection.glsl)\n\nvec3 mpos = vec3(uModelMatrix * vec4(pos, 1.0));\nvec2 screenUV = getProjection(mpos, uProjMatrix);\nvec3 flow = vec3(texture2D(tFluid, screenUV).xy, 0.0);\napplyNormal(flow, uProjNormalMatrix);\npos += flow * 0.0001 * uMouseStrength * texture2D(tFluidMask, screenUV).r;","glscreenprojection");input.customPresetCallback=async proton=>{if(!("MouseFluid"in window))return void alert("'mousefluid' module not found. To use Mouse Fluid preset, import module, load the MouseFluid class, and add a layer named 'fluid' with customCLass FluidLayer.");let camera=(proton=>{let camera=World.CAMERA,p=proton.group._parent;for(;p;)p instanceof Scene&&p.nuke&&(camera=p.nuke.camera),p=p._parent;return camera})(proton),projection=proton.initClass(GLScreenProjection,camera);projection.start(),proton.projection=projection,proton.wait("behavior").then((_=>{proton.behavior.addUniforms({uProjMatrix:projection.uniforms.projMatrix,uModelMatrix:projection.uniforms.modelMatrix,uProjNormalMatrix:projection.uniforms.normalMatrix}),MouseFluid.instance().applyTo(proton.behavior)}))}}};function setPresetCodeIfRequired(input,presetCode,keyShaderComponentString){const editorCode=input.get("code");editorCode&&editorCode.includes(keyShaderComponentString)||input.setValue("code",presetCode)}this.register=function(name,callback){let key=name.replace(/ /g,"").toLowerCase();LIST.push({label:name,value:key}),CALLBACKS[key]=callback},this.bind=function(input){input.add("code","hidden");input.add("uniforms","hidden"),input.addSelect("preset",LIST);let callback=CALLBACKS[input.get("preset")];callback&&callback(input),input.addButton("btn",{actions:[{title:"Edit Code",callback:_=>{let editor=new UILExternalEditor(input.get("name")||"Code",300);editor.setCode(input.get("code"),"c"),editor.onSave=value=>{input.setValue("code",value),_this.onCodeEdit?.()},UIL.add(editor)}}],hideLabel:!0})}}),"static"),Class((function SceneLayout(_name,_options={}){Inherit(this,Object3D);const _this=this;var _dataStore,_data,_timeline,_breakpoint;const ZERO=new Vector3;var _initializers=[],_promises=[],_breakpoints=[],_folders={},_groups={},_custom={},_meshes={},_exists={},_layers={},_uil=UIL.sidebar,_graph,_config,_groupIndex=0,_groupsSynced=Promise.create();function initialize(promise){_promises.push(promise)}function createFolder(name){let folder=new UILFolder(`sl_${_name}_${name}`,{label:name,closed:!0});return folder.hide(),_folders[`sl_${_name}_${name}`]=folder,folder}async function initConfig(){let input=InputUIL.create("CONFIG_sl_"+_name,_uil);input.add("Animation"),input.add("Layout"),input.add("Cinema Config"),_graph&&_graph.addSpecial("Config",`Config (${_name})`,"Config"),input.setLabel("Config");let animation=input.get("Animation"),layout=input.get("Layout");animation&&(await ready(),_groupsSynced.then((async()=>{if(animation=animation.replace(/^\//g,""),_this.animation=_this.initClass(HierarchyAnimation,animation,linkObjects),_timeline)_this.startRender((_=>{_this.animation.elapsed=_timeline.elapsed,_this.animation.update()}));else if(_uil){let range=new UILControlRange("Animation",{min:0,max:1,step:.001});range.onChange((val=>{_this.animation.elapsed=val,_this.animation.update()})),_uil.add(range)}await _this.animation.ready(),_this.animation.update()}))),layout&&(await ready(),_this.layout=_this.initClass(HierarchyLayout,layout,linkObjects),await _this.layout.ready()),_config=input,await defer(),_this.configured=!0}async function linkObjects(data){let array=[];for(let i=0;i<data.length;i++){let name=data[i].name,exists=_this.exists(name);exists||"null"==name.toLowerCase()||console.warn(`linkAnimation :: ${name} does not exist`);let group=new Group,mesh=exists?await _this.getLayer(name):null;mesh&&(_this.layout&&mesh instanceof Mesh?(mesh._parent.add(group),group.add(mesh)):group=mesh.group||mesh),group.name=name,array.push(group)}return array}async function initGraph(){if(_options.noGraph||!window.UILGraph||SceneLayout.noGraph)return _uil=null;(_graph=UILGraph.instance().getGraph(_name,_this))&&(UIL.sidebar.element.show(),await _this.ready(),_graph.syncVisibility(_layers),_graph.syncGroupNames(_groups,_folders),_groupsSynced.resolve(),Global.PLAYGROUND&&Utils.getConstructorName(_this.parent)==Global.PLAYGROUND&&_graph.open())}function initParams(){if(_options.rootPath?"/"!=_options.rootPath.charAt(_options.rootPath.length-1)&&(_options.rootPath+="/"):_options.rootPath="",_this.timeline=_timeline=_options.timeline,_timeline&&(_timeline.add({v:0},{v:1},100,"linear"),_uil)){let range=new UILControlRange("Timeline",{min:0,max:1,step:.001});range.onChange((val=>{_timeline.elapsed=val,_timeline.update()})),_uil.add(range),range.hide(),_graph&&_graph.addSpecial("Timeline","Timeline")}_this.baseRenderOrder=_options.baseRenderOrder||0,_this.data=_options.data,_breakpoint=_options.breakpoint||SceneLayout.breakpoint,_options.breakpoint&&(_this.localBreakpoint=!0),_options.uil&&(_uil=_options.uil)}async function initData(){if(await UILStorage.ready(),_dataStore=InputUIL.create("scenelayout_"+_name,null),void 0===(_data=JSON.parse(_dataStore.get("data")||"{}")).layers&&(_data.layers=-1),_options.perFrame)_data.layers>0&&createLayers();else{for(let i=0,c=_data.layers+1;i<c;i++)initialize(createLayer(i));_this.loaded=!0}}function createLayers(){let index=0,renderWorker=new Render.Worker((function(){initialize(createLayer(index)),index++==_data.layers&&(renderWorker.stop(),_this.loaded=!0)}),_options.perFrame)}function getGroup(name){if(!name)return _this.group;if(name==_name)return _this.group;if(!_groups[name]){let uilGroup=_uil?createFolder(name):null;uilGroup&&(uilGroup.setLabel(name+" (Group)"),_uil.add(uilGroup),_graph&&_graph.addGroup(uilGroup.id,name));let config=InputUIL.create(`GROUP_${_name}_${name}`,uilGroup);config.setLabel("Parameters"),_timeline&&config.add("tween"),config.addToggle("billboard"),config.add("breakpoints"),config.add("name","hidden");let breakpoints=config.get("breakpoints");breakpoints&&(breakpoints=breakpoints.replace(/ /g,"").split(","));let breakpoint=breakpoints&&_breakpoint?"-"+_breakpoint:"";"-"==breakpoint.charAt(breakpoint.length-1)&&(breakpoint="");let group=new Group;_groups[name]=group,_layers[name]=group,_exists[name]="group",group.prefix=`${name}_${_name}${breakpoint}`,MeshUIL.add(group,uilGroup).setLabel("Mesh"),_this.add(group),uilGroup&&(uilGroup.params=config),breakpoints&&_breakpoints.push(group),config.get("billboard")&&updateBillboard(!0,mesh)}return _groupIndex++,_groups[name]}async function createLayer(index,groupName){let id="number"==typeof index?index:++_data.layers,graphGroupName=groupName;if(graphGroupName){let nameLabel=UILStorage.get(`INPUT_GROUP_${_name}_${groupName}_name`);nameLabel&&(groupName=nameLabel)}if(UILStorage.get(`sl_${_name}_${id}_deleted`))return;if(_this.preventLayerCreation&&_this.preventLayerCreation(UILStorage.get(`INPUT_Config_${id}_${_name}_name`)))return;let group=_uil?createFolder(id):null,shader,mesh,input=InputUIL.create(`Config_${id}_${_name}`,group);input.setLabel("Parameters"),input.add("name","hidden").add("geometry").addToggle("visible",!0).addToggle("transparent").addToggle("depthWrite",!0).addToggle("depthTest",!0).addToggle("castShadow").addToggle("receiveShadow").addToggle("receiveLight").addToggle("billboard").add("shader").add("customClass").add("scriptClass").add("wildcard").add("renderOrder","hidden").add("group","hidden").add("breakpoints").addSelect("side",[{label:"Front Side",value:"shader_front_side"},{label:"Back Side",value:"shader_back_side"},{label:"Double Side",value:"shader_double_side"}]).addSelect("blending",[{label:"Normal",value:"shader_normal_blending"},{label:"Additive",value:"shader_additive_blending"}]),input.name=_name,input.prefix=`Element_${id}_${_name}`,input.id=id,group&&(group.params=input),_timeline&&input.addToggle("tween"),_options.physics&&(input.addToggle("physics"),input.add("physicsCode"));let name=input.get("name")||id,shaderName=input.get("shader")||"SceneLayout",geomPath=input.get("geometry"),visible=input.get("visible"),transparent=input.get("transparent"),depthWrite=input.get("depthWrite"),depthTest=input.get("depthTest"),billboard=input.get("billboard"),doTween=input.get("tween"),renderOrder=input.getNumber("renderOrder"),blending=input.get("blending"),side=input.get("side"),physics=input.get("physics"),castShadow=input.get("castShadow"),receiveShadow=input.get("receiveShadow"),receiveLight=input.get("receiveLight"),breakpoints=input.get("breakpoints");breakpoints&&(breakpoints=breakpoints.replace(/ /g,"").split(","));let breakpoint=breakpoints&&_breakpoint?"-"+_breakpoint:"";"-"==breakpoint.charAt(breakpoint.length-1)&&(breakpoint=""),name&&group&&group.setLabel(name),groupName&&input.setValue("group",groupName);let groupParent=getGroup(input.get("group"));if(group){let groupName=input.get("group"),groupId=groupName?`sl_${_name}_${graphGroupName||groupName}`:void 0;_graph&&_graph.addLayer(group.id,name||id+"",groupId)}if(_uil&&_uil.add(group),"ignore"==name)return;let customClass=input.get("customClass"),scriptClass=input.get("scriptClass");if(_exists[name]=customClass?"custom":"mesh",customClass){if(!window[customClass])return console.warn(`Tried to initialize ${customClass} but it doesn't  exist!`);let obj=_this.initClass(window[customClass],input,group,id,null);if(mesh=obj.group,"boolean"==typeof visible&&mesh&&(mesh.visible=visible),_custom[name]=obj,_layers[name]=obj,_this.onCreateLayer){let capture=cb=>(_this.delayedCall((_=>cb(obj,name)),32),!0);if(!0===_this.onCreateLayer(name,group,capture))return}return obj.group&&groupParent.add(obj.group),obj.renderOrder=_this.baseRenderOrder+renderOrder,void(mesh&&(obj.camera||(mesh.prefix=`Element_${id}_${_name}${breakpoint}`,MeshUIL.add(mesh,group).setLabel("Mesh")),_breakpoints.push(mesh),scriptClass&&visible&&(scriptClass.includes(",")?(scriptClass=scriptClass.replace(/ /g,"").split(","),scriptClass.forEach((script=>{window[script]?(mesh.scriptClass=mesh.scriptClass||[],mesh.scriptClass.push(_this.initClass(window[script],mesh,shader,group,input))):console.warn(`scriptClass ${script} not found`)}))):window[scriptClass]?mesh.scriptClass=_this.initClass(window[scriptClass],mesh,shader,group,input):console.warn(`scriptClass ${scriptClass} not found`))))}if(_this.onCreateLayer){let capture=cb=>{let mesh=new Group;return mesh.prefix=`Element_${id}_${_name}${breakpoint}`,MeshUIL.add(mesh,group),_meshes[name]=mesh,_layers[name]=mesh,_this.delayedCall((_=>cb(mesh,name)),32),!0};if(!0===_this.onCreateLayer(name,group,capture))return}let geom=World.PLANE;if(geomPath&&geomPath.includes(["World","SceneLayout"])&&(geom=eval(geomPath),geomPath=null),shaderName.includes(".shader")){let shaderLayer=shaderName.split(".shader")[0],layer=await _this.getLayer(shaderLayer);shader=layer.shader,shader._copied=layer}else if(shaderName.includes("PBR"))shader=_this.initClass(PBRShader,shaderName,{unique:`Element_${id}_${_name}`});else{let texturePath=input.getImage("texture");texturePath?texturePath.includes("assets/images")||(texturePath=_options.rootPath+texturePath):texturePath="assets/images/_scenelayout/uv.jpg",shader=_this.initClass(Shader,shaderName,{unique:`Element_${id}_${_name}`}),"SceneLayout"!=shaderName&&window[shaderName]||shader.addUniforms({tMap:{value:Utils3D.getTexture(texturePath)},uAlpha:{value:1}}),defer((_=>{for(let key in shader.uniforms){let uniform=shader.uniforms[key];uniform.value instanceof Texture&&initialize(uniform.value.promise)}}))}if("boolean"==typeof depthWrite&&(shader.depthWrite=depthWrite),"boolean"==typeof depthTest&&(shader.depthTest=depthTest),"boolean"==typeof transparent&&(shader.transparent=transparent),_this.onCreateGeometry&&(geomPath=_this.onCreateGeometry(geomPath,input.get("wildcard"))),geomPath&&(geom=await GeomThread.loadGeometry(geomPath)),mesh=new Mesh(geom,shader),"boolean"==typeof _options.frustumCulled&&(mesh.frustumCulled=_options.frustumCulled),"boolean"==typeof visible&&(mesh.visible=visible),groupParent.add(mesh),mesh.prefix=`Element_${id}_${_name}${breakpoint}`,MeshUIL.add(mesh,group).setLabel("Mesh"),physics){let obj=Physics.instance().create(mesh);obj.prefix=`Physics_${id}_${_name}`,PhysicsUIL.add(obj,group).setLabel("Physics");let code=input.get("physicsCode");code&&_this.initClass(window[code],obj,mesh,group,input)}if(_meshes[name]=mesh,_layers[name]=mesh,breakpoints&&_breakpoints.push(mesh),mesh.renderOrder=_this.baseRenderOrder+(renderOrder||0),billboard&&updateBillboard(!0,mesh),"SceneLayout"!=shaderName&&window[shaderName]&&(mesh.shaderClass=_this.initClass(window[shaderName],mesh,shader,group,input)),shader._copied||shader!==mesh.shader&&!shaderName.includes("PBR")||ShaderUIL.add(shader,group).setLabel("Shader"),shader._copied&&shader._copied.shaderClass&&shader._copied.shaderClass.applyClone&&shader._copied.shaderClass.applyClone(mesh),"number"!=typeof index&&_dataStore.setValue("data",JSON.stringify(_data)),blending&&(shader.blending=blending),side&&(shader.side=side),castShadow&&(mesh.castShadow=castShadow),receiveShadow&&(shader.receiveShadow=receiveShadow),receiveLight&&(shader.receiveLight=receiveLight),scriptClass&&(scriptClass.includes(",")?(scriptClass=scriptClass.replace(/ /g,"").split(","),scriptClass.forEach((script=>{window[script]?(mesh.scriptClass=mesh.scriptClass||[],mesh.scriptClass.push(_this.initClass(window[script],mesh,shader,group,input))):console.warn(`scriptClass ${script} not found`)}))):window[scriptClass]?mesh.scriptClass=_this.initClass(window[scriptClass],mesh,shader,group,input):console.warn(`scriptClass ${scriptClass} not found`)),input.onUpdate=key=>{switch(key){case"name":group.setLabel(input.get(key));break;case"visible":mesh.visible=input.get(key);break;case"renderOrder":mesh.renderOrder=_this.baseRenderOrder+input.getNumber(key);break;case"transparent":shader.transparent=input.get(key);break;case"depthWrite":shader.depthWrite=input.get(key);break;case"depthTest":shader.depthTest=input.get(key);break;case"side":shader.side=input.get(key);break;case"blending":shader.blending=input.get(key);break;case"geometry":updateGeometry(input.get(key),mesh);break;case"shader":updateShader(input.get(key),mesh,id,group,input);break;case"scriptClass":updateScriptClass(input.get(key),mesh,group,input);break;case"receiveShadow":updateShadow(input.get(key),mesh);break;case"receiveLight":updateLighting(input.get(key),mesh);break;case"billboard":updateBillboard(input.get(key),mesh)}},Hydra.LOCAL&&Global.PLAYGROUND){_this.events.sub(SceneLayout.HOTLOAD_GEOMETRY,(({file:file})=>{mesh.geometry?._src?.includes(file)&&updateGeometry(file,mesh)}));const scriptClassNeedsUpdate=(inst,file)=>(inst.__cacheName||(inst.__cacheName=Utils.getConstructorName(inst)),!!file.includes(inst.__cacheName)&&inst.__cacheName);_this.events.sub(SceneLayout.HOTLOAD_SCRIPT,(({file:file})=>{if(file.includes(mesh.shader?.vsName)&&(shader.hotReloading=!0,window[shaderName]&&(mesh.shaderClass=_this.initClass(window[shaderName],mesh,shader,group,input)),group.remove(shader.UILPrefix),delete ShaderUIL.exists[shader.UILPrefix],ShaderUIL.add(shader,group).setLabel("Shader"),shader.hotReloading=!1),mesh.scriptClass)if(Array.isArray(mesh.scriptClass))mesh.scriptClass.every(((inst,index)=>{let name=scriptClassNeedsUpdate(inst,file);return!name||(mesh.scriptClass.remove(inst),updateScriptClass(name,mesh,group,input),!1)}));else{let name=scriptClassNeedsUpdate(mesh.scriptClass,file);name&&updateScriptClass(name,mesh,group,input)}}))}}async function updateGeometry(geomPath,mesh){let geom=World.PLANE;geomPath&&geomPath.includes(["World","SceneLayout"])?(geom=eval(geomPath),geomPath=null):geomPath&&(geom=await GeomThread.loadGeometry(geomPath+"?"+Utils.timestamp())),mesh.geometry=geom}async function updateShader(shaderName,mesh,id,group,input){let shader;if(shaderName.includes(".shader")){let shaderLayer=shaderName.split(".shader")[0],layer=await _this.getLayer(shaderLayer);shader=layer.shader,shader._copied=layer}else shader=shaderName.includes("PBR")?_this.initClass(PBRShader,shaderName,{unique:`Element_${id}_${_name}`}):_this.initClass(Shader,shaderName,{unique:`Element_${id}_${_name}`});group.remove(mesh.shader.UILPrefix),mesh.shader=shader,window[shaderName]&&(mesh.shaderClass=_this.initClass(window[shaderName],mesh,shader,group,input)),ShaderUIL.add(shader,group).setLabel("Shader")}function updateLighting(bool,mesh){mesh.shader.customCompile=Utils.uuid(),mesh.shader.receiveLight=bool,mesh.shader.resetProgram(),mesh.shader.upload()}function updateShadow(bool,mesh){mesh.shader.customCompile=Utils.uuid(),mesh.shader.receiveShadow=bool,mesh.shader.resetProgram(),mesh.shader.upload()}function updateBillboard(bool,mesh){bool?(mesh._billboardLoop=_=>Utils3D.billboard(mesh),_this.startRender(mesh._billboardLoop)):(mesh.rotation.set(0,0,0),_this.stopRender(mesh._billboardLoop))}function updateScriptClass(scriptClass,mesh,group,input){scriptClass&&(scriptClass.includes(",")?(scriptClass=scriptClass.replace(/ /g,"").split(",")).forEach((script=>{window[script]?(mesh.scriptClass=mesh.scriptClass||[],mesh.scriptClass.push(_this.initClass(window[script],mesh,mesh.shader,group,input))):console.warn(`scriptClass ${script} not found`)})):window[scriptClass]?mesh.scriptClass=_this.initClass(window[scriptClass],mesh,mesh.shader,group,input):console.warn(`scriptClass ${scriptClass} not found`))}function addListeners(){_this.events.sub(SceneLayout.BREAKPOINT,(e=>_this.localBreakpoint?null:setBreakpoint(e)))}function setBreakpoint({value:value}){value!=_breakpoint&&(_breakpoint=value,_breakpoints.forEach((mesh=>{mesh.prefix&&(mesh.prefix=mesh.prefix.split("-")[0]+"-"+_breakpoint,"-"==mesh.prefix.charAt(mesh.prefix.length-1)&&(mesh.prefix=mesh.prefix.slice(0,-1)),new MeshUILConfig(mesh))})))}async function ready(){await _this.wait(_this,"loaded"),UIL.sidebar&&UIL.sidebar.toolbar.hideAll()}function copyFolderProps(from,to){let mesh,params,shader;to.forEachFolder((child=>{switch(child.label){case"Parameters":params=child;break;case"Mesh":mesh=child;break;case"Shader":shader=child}}));let allowed=["Parameters","Mesh","Shader"];from.forEachFolder((child=>{if(!(allowed.indexOf(child.label)<0))switch(child.toClipboard(),child.label){case"Parameters":params.fromClipboard();break;case"Mesh":mesh.fromClipboard();break;case"Shader":shader.fromClipboard()}}))}this.isSceneLayout=!0,this.name=_name,async function(){_this.group.sceneLayout=_this,await initialize(defer()),SceneLayout.getTexture||(SceneLayout.getTexture=Utils3D.getTexture),initGraph(),initParams(),initialize(initConfig()),initData(),addListeners(),ready()}(),this.ready=async function(early){if(await _this.wait(_this,"loaded"),await _this.wait(_this,"configured"),early)return!0;await defer(),await defer()},this.getLayer=async function(name){let timer;return Hydra.LOCAL&&(timer=_this.delayedCall((_=>{_exists[name]||console.warn(`${name} doesn't exist in SceneLayout ${_name}`)}),1e3)),await _this.wait(_layers,name),timer&&clearTimeout(timer),_layers[name]},this.getLayers=async function(){let array=[];for(let i=0;i<arguments.length;i++)array.push(_this.getLayer(arguments[i]));return Promise.all(array)},this.getAllLayers=async function(){return await this.ready(),await this.loadedAllLayers(),_layers},this.getAllMatching=async function(label){let layers=await _this.getAllLayers(),array=[];for(let key in layers)key.includes(label)&&array.push(layers[key]);return array},this.exists=function(name){return _exists[name]},this._createLayer=function(parentId){createLayer(null,parentId)},this._createGroup=function(parentId){getGroup("group_"+_groupIndex,parentId)},this._rename=function(id,name,value){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];folder&&(folder.setLabel(value),folder.params&&folder.params.setValue("name",value),[_groups,_custom,_meshes,_exists,_layers].forEach((function(store){store[name]&&(store[value]=store[name],store[name]=null,delete store[name])})))},this._deleteLayer=function(id,name){id.includes("_")&&(id=(id=id.split("_"))[id.length-1]);let folder=_folders[id]||_folders[`sl_${_name}_${id}`],layer=_layers[id]||_layers[name];return layer&&layer.isGroup&&layer.length>1?(alert("Can't delete a group that has nested layers."),!1):!!confirm("Are you sure you want to delete this layer?")&&(layer&&layer._parent&&(layer._parent.remove(layer),layer._parent=null),folder&&folder.parent&&folder.parent.remove(folder),UILStorage.set(`sl_${_name}_${id}_deleted`,!0),!0)},this._changeParent=function(childId,childName,parentId,parentName){let child=_layers[childId]||_layers[childName],parent=_layers[parentId]||_layers[parentName]||_this;if(!child)return;let folder=_folders[childId]||_folders[`sl_${_name}_${childName}`];folder&&folder.params&&folder.params.setValue("group",parentName||null);let parentObject=parent.group||parent,childObject=child.group||child;parentObject.isObject3D&&childObject.isObject3D&&parentObject.add(childObject),child.updateMatrix&&child.updateMatrix()},this._visible=function(name,visible){let mesh=_layers[name];mesh&&(mesh.group&&(mesh=mesh.group),mesh.visible=visible)},this._focus=function(name){UIL.sidebar.toolbar.filterSingle(name)},this._blur=function(name){let folder=_folders[name]||_folders[`sl_${_name}_${name}`];folder&&folder.forEachFolder&&(folder.forEachFolder((f=>f.close())),folder.close())},this._sort=function(order){order.forEach(((label,index)=>{label.children&&label.children.forEach((function(child,j,all){let folder=_folders[child];if(!folder||!folder.params)return;let renderOrder=_this.baseRenderOrder+index+(j+1)/(all.length+1);folder.params.setValue("renderOrder",renderOrder-_this.baseRenderOrder);let mesh=_layers[child]||_layers[folder.label];mesh&&(mesh.renderOrder=renderOrder)}));let folder=_folders[label];if(!folder||!folder.params)return;let renderOrder=_this.baseRenderOrder+index;folder.params.setValue("renderOrder",renderOrder-_this.baseRenderOrder);let mesh=_layers[label]||_layers[folder.label];mesh&&(mesh.renderOrder=renderOrder)}))},this._duplicateLayer=function(id,parentId){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];folder&&(createLayer(null,parentId),copyFolderProps(folder,Object.values(_folders).last()))},this._duplicateGroup=function(id,children){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];if(!folder)return;let copyId="group_"+(_groupIndex+1);getGroup(copyId),copyFolderProps(folder,Object.values(_folders).last()),children.forEach((childId=>{_this._duplicateLayer(childId,copyId)}))},this._getCinemaConfig=async function(){let _cinemaConfig=_config.get("Cinema Config").replace(".json","");return await get(Assets.getPath(`assets/geometry/${_cinemaConfig}.json`))},this._applyCinemaConfig=function(id,params){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];if(!folder)return;let mesh=folder.getAll().filter((sub=>"Mesh"==sub.label))[0];if(params.geometry&&folder.params.setValue("geometry",params.geometry.replace("assets/geometry/","")),["position","quaternion","scale"].forEach((transform=>{if(params[transform]){let value=JSON.parse(params[transform]);if("quaternion"==transform){let quat=(new Quaternion).fromArray(value);value=(new Euler).setFromQuaternion(quat).toArray().slice(0,3).map((angle=>180*angle/Math.PI)),transform="rotation"}mesh.getAll().filter((control=>control.label==transform))[0].force(value)}})),params.visible&&"false"===params.visible&&!params.geometry&&(folder.params.setValue("geometry","World.PLANE"),folder.params.setValue("side","shader_double_side"),!Global.PLAYGROUND)){_meshes[folder.params.get("name")].shader.neverRender=!0}params.shader&&folder.params.setValue("shader",params.shader)},this.loadedAllLayers=async function(){return await _this.ready(),Promise.all(_promises)},this.set("breakpoint",(value=>{_this.localBreakpoint=!0,setBreakpoint({value:value})})),this.get("breakpoint",(_=>_breakpoint)),this.get("layers",(_=>_layers)),this.get("layerCount",(_=>_data.layers)),this.onDestroy=function(){_this.textures&&!_options.persistTextures&&_this.textures.forEach((t=>{t.destroy&&t.destroy()}))},this.addInitializer=function(callback){_initializers.push(callback)},this._completeInitialization=async function(sync){if(!_initializers.length)return!0;for(let i=0;i<_initializers.length;i++)await _initializers[i](sync);_initializers.length=0}}),(_=>{SceneLayout.BREAKPOINT="sl_breakpoint",SceneLayout.HOTLOAD_GEOMETRY="sl_hotload_geom",SceneLayout.HOTLOAD_SCRIPT="sl_hotload_script",SceneLayout.setBreakpoint=function(value){SceneLayout.breakpoint!==value&&(SceneLayout.breakpoint=value,Events.emitter._fireEvent(SceneLayout.BREAKPOINT,{value:value}))}})),Class((function SceneLayoutPreloader(_name){Inherit(this,Component);function findMatch(src){if(!src)return!1;src=src.trim();for(let i=ASSETS.length-1;i>-1;i--)if(ASSETS[i].includes(src))return!0;return!1}this.load=function(name){let ext,promise=Promise.create(),array=[],settings_dxt=!!Renderer.extensions.s3tc,settings_etc=!!Renderer.extensions.etc1,settings_pvrtc=!!Renderer.extensions.pvrtc,settings_astc=!!Renderer.extensions.astc;settings_dxt?ext="dxt":settings_etc?ext="astc":settings_pvrtc?ext="pvrtc":settings_astc&&(ext="astc");let keys=UILStorage.getKeys(),i=0,worker=new Render.Worker((_=>{let key=keys[i];if(!key)return worker.stop(),void Promise.all(array).then(promise.resolve);if(key.includes(name)){let val=UILStorage.get(key);if(!val||!val.includes)return i++;if(key.includes("geometry")&&(val.includes(".json")||(val+=".json"),val.includes("assets/")||(val="assets/geometry/"+val),array.push(GeomThread.loadGeometry(val,null,!0))),val.includes(".json"))val.includes("assets/")||(val="assets/geometry/"+val),findMatch(val.split("assets/")[1])&&array.push(fetch(Assets.getPath(val)).catch((e=>{})));else if(val.includes("src")){let obj=JSON.parse(val),src=obj.src;if(obj.compressed){let src0=src.split(".")[0],src1=src0.split("/");src=src0+"/"+src1[src1.length-1]+"-"+ext+".ktx"}findMatch(src.split("assets/")[1])&&array.push(fetch(Assets.getPath(src)).catch((e=>{})))}}i++}),1);return promise}}),"static"),Class((function Scroll(_object,_params){Inherit(this,Component);const _this=this,PROHIBITED_ELEMENTS=["prevent_interactionScroll"];this.x=0,this.y=0,this.max={x:0,y:0},this.delta={x:0,y:0},this.enabled=!0;const _scrollTarget={x:0,y:0},_scrollInertia={x:0,y:0};let _axes=["x","y"];var _lastDelta,_deltaChange=0;function checkIfProhibited(element){let el=element;for(;el;){if(el.classList)for(let i=0;i<PROHIBITED_ELEMENTS.length;i++)if(el.classList.contains(PROHIBITED_ELEMENTS[i]))return!0;el=el.parentNode}return!1}function loop(){_this.object&&(Math.round(_this.object.div.scrollLeft)===Math.round(_this.x)&&Math.round(_this.object.div.scrollTop)===Math.round(_this.y)||(_this.x=_scrollTarget.x=_this.object.div.scrollLeft,_this.y=_scrollTarget.y=_this.object.div.scrollTop,stopInertia())),_axes.forEach((axis=>{_this.isInertia&&(_scrollInertia[axis]*=.9,_scrollTarget[axis]+=_scrollInertia[axis]),_this.limit&&(_scrollTarget[axis]=Math.max(_scrollTarget[axis],0)),_this.limit&&(_scrollTarget[axis]=Math.min(_scrollTarget[axis],_this.max[axis]/_this.scale)),_this.delta[axis]=_this.flag("block")?0:.5*(_scrollTarget[axis]*_this.scale-_this[axis]),_this[axis]+=_this.delta[axis],Math.abs(_this.delta[axis])<.01&&(_this.delta[axis]=0),Math.abs(_this[axis])<.001&&(_this[axis]=0),_this.flag("block")&&(_scrollTarget[axis]=0,_this.delta[axis]=0,_this[axis]=0),_this.object&&("x"==axis&&(_this.object.div.scrollLeft=Math.round(_this.x)),"y"==axis&&(_this.object.div.scrollTop=Math.round(_this.y)))}))}function stopInertia(){_this.isInertia=!1,clearTween(_scrollTarget)}function edgeScroll(e){let element=document.elementFromPoint(Math.clamp(Mouse.x,0,Stage.width),Math.clamp(Mouse.y,0,Stage.height));element&&checkIfProhibited(element)||_params.lockMouseX&&Mouse.x>Stage.width||"touch"===e.pointerType&&_this.enabled&&(e.preventDefault&&e.preventDefault(),_axes.forEach((axis=>{let dir=axis.toUpperCase(),delta="offset"+dir,diff=(_this["ieDelta"+dir]||e[delta])-e[delta];_scrollTarget[axis]+=diff,_scrollInertia[axis]=diff,_this.isInertia=!0,_this["ieDelta"+dir]=e[delta]})),_this.onUpdate&&_this.onUpdate(),_this.events.fire(Events.UPDATE,_scrollInertia))}function edgeScrollEnd(){_this.ieDeltaX=!1,_this.ieDeltaY=!1}function scroll(e){let element=document.elementFromPoint(Math.clamp(Mouse.x,0,Stage.width),Math.clamp(Mouse.y,0,Stage.height));if(element&&checkIfProhibited(element))return;if(_params.lockMouseX&&Mouse.x>Stage.width)return;if(!_this.enabled)return;if(_this.object&&_this.limit&&e.preventDefault&&e.preventDefault(),!_this.mouseWheel)return;stopInertia();let newDelta=0;_axes.forEach((axis=>{let delta="delta"+axis.toUpperCase();if("mac"==Device.system.os){if("firefox"==Device.system.browser)return 1===e.deltaMode?(_scrollTarget[axis]+=4*e[delta],_scrollInertia[axis]=4*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])):void(_scrollTarget[axis]+=e[delta]);if(Device.system.browser.includes(["chrome","safari"]))return _scrollTarget[axis]+=.33*e[delta],_scrollInertia[axis]=.33*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}if("windows"==Device.system.os){if("firefox"==Device.system.browser&&1===e.deltaMode)return _scrollTarget[axis]+=10*e[delta],_scrollInertia[axis]=10*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis]);if(Device.system.browser.includes(["chrome"])){let s=.025;return _scrollTarget[axis]+=e[delta]*s,_scrollInertia[axis]=e[delta]*s,_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}if("ie"==Device.system.browser)return _scrollTarget[axis]+=e[delta],_scrollInertia[axis]=e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}_scrollTarget[axis]+=e[delta],newDelta=_scrollInertia[axis]})),newDelta=Math.abs(newDelta),newDelta!=_lastDelta&&_deltaChange++,_this.flag("hardBlock")||(_deltaChange>3?newDelta>_lastDelta&&_this.flag("block",!1):newDelta>=_lastDelta&&_this.flag("block",!1)),_lastDelta=newDelta,_this.onUpdate&&_this.onUpdate(),_this.events.fire(Events.UPDATE,_scrollInertia)}function down(e){if(!_this.enabled)return;let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));element&&checkIfProhibited(element)||stopInertia()}function drag(e){if(!_this.enabled)return;let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));element&&checkIfProhibited(element)||(_axes.forEach((axis=>{let newDelta=Math.abs(Mouse.delta[axis]);_this.flag("hardBlock")||newDelta>_lastDelta&&_this.flag("block",!1),_lastDelta=newDelta,_scrollTarget[axis]-=Mouse.delta[axis]})),_this.events.fire(Events.UPDATE))}function up(e){if(!_this.enabled||_this.preventInertia)return;let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));if(element&&checkIfProhibited(element))return;const m="android"==Device.system.os?35:25,obj={};_axes.forEach((axis=>{obj[axis]=_scrollTarget[axis]-Mouse.delta[axis]*m})),tween(_scrollTarget,obj,2500,"easeOutQuint")}function resize(){if(!_this.enabled)return;if(stopInertia(),!_this.object)return;const p={};Device.mobile&&_axes.forEach((axis=>p[axis]=_this.max[axis]?_scrollTarget[axis]/_this.max[axis]:0)),void 0===_params.height&&(_this.max.y=_this.object.div.scrollHeight-_this.object.div.clientHeight),void 0===_params.width&&(_this.max.x=_this.object.div.scrollWidth-_this.object.div.clientWidth),Device.mobile&&_axes.forEach((axis=>_this[axis]=_scrollTarget[axis]=p[axis]*_this.max[axis]))}!function initParams(){_object&&_object.div||(_params=_object,_object=null),_params||(_params={}),_this.object=_object,_this.hitObject=_params.hitObject||_this.object,_this.max.y=_params.height||0,_this.max.x=_params.width||0,_this.scale=_params.scale||1,_this.drag=void 0!==_params.drag?_params.drag:!!Device.mobile,_this.mouseWheel=!1!==_params.mouseWheel,_this.limit="boolean"==typeof _params.limit&&_params.limit,Array.isArray(_params.axes)&&(_axes=_params.axes)}(),_this.object&&function style(){_this.object.css({overflow:"auto"})}(),function addHandlers(){if(Device.mobile||("ie"===Device.system.browser&&Device.system.browserVersion>=17&&(document.body.addEventListener("pointermove",edgeScroll,!0),document.body.addEventListener("pointerup",edgeScrollEnd,!0)),"ie"==Device.system.browser?document.body.addEventListener("wheel",scroll,!0):__window.bind("wheel",scroll)),_this.drag){_this.hitObject&&_this.hitObject.bind("touchstart",(e=>{let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));element&&checkIfProhibited(element)||e.preventDefault()}));let input=_this.hitObject?_this.initClass(Interaction,_this.hitObject):Mouse.input;_this.events.sub(input,Interaction.START,down),_this.events.sub(input,Interaction.DRAG,drag),_this.events.sub(input,Interaction.END,up)}_this.events.sub(Events.RESIZE,resize)}(),resize(),_this.startRender(loop),this.reset=function(){return _this.object&&_this.object.div&&(_this.object.div.scrollLeft=_this.x=0,_this.object.div.scrollTop=_this.y=0),_scrollTarget.x=_scrollTarget.y=0,_scrollInertia.x=_scrollInertia.y=0,stopInertia(),this},this.onDestroy=function(){__window.unbind("wheel",scroll)},this.resize=resize,this.scrollTo=function(value,axis="y"){let values={};values[axis]=value,tween(_scrollTarget,values,800,"easeInOutCubic")},this.blockUntilNewScroll=function(){return _this.reset(),_this.flag("block",!0),_this.flag("hardBlock",!0,200),this},this.stopInertia=stopInertia}),(_=>{var _scroll;Scroll.createUnlimited=Scroll.getUnlimited=function(options){return _scroll||(_scroll=new Scroll({limit:!1,drag:Device.mobile})),_scroll}}));class CubicBezierCurve2D extends Curve3D{constructor(v0,v1,v2,v3){super(),this.type="CubicBezierCurve",this.v0=v0||new Vector2,this.v1=v1||new Vector2,this.v2=v2||new Vector2,this.v3=v3||new Vector2,this.isCubicBezierCurve=!0}getPoint(t,optionalTarget){var point=optionalTarget||new Vector2,v0=this.v0,v1=this.v1,v2=this.v2,v3=this.v3;const{CubicBezier:CubicBezier}=require("Shape2DInterpolations");return point.set(CubicBezier(t,v0.x,v1.x,v2.x,v3.x),CubicBezier(t,v0.y,v1.y,v2.y,v3.y)),point}copy(source){return Curve3D.prototype.copy.call(this,source),this.v0.copy(source.v0),this.v1.copy(source.v1),this.v2.copy(source.v2),this.v3.copy(source.v3),this}let(){var data=Curve3D.prototype.let.call(this);return data.v0=this.v0.toArray(),data.v1=this.v1.toArray(),data.v2=this.v2.toArray(),data.v3=this.v3.toArray(),data}fromJSON(json){return Curve.prototype.fromJSON.call(this,json),this.v0.fromArray(json.v0),this.v1.fromArray(json.v1),this.v2.fromArray(json.v2),this.v3.fromArray(json.v3),this}}class EllipseCurve extends Base3D{constructor(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise,aRotation){super(),this.type="EllipseCurve",this.aX=aX||0,this.aY=aY||0,this.xRadius=xRadius||1,this.yRadius=yRadius||1,this.aStartAngle=aStartAngle||0,this.aEndAngle=aEndAngle||2*Math.PI,this.aClockwise=aClockwise||!1,this.aRotation=aRotation||0,this.isEllipseCurve=!0}getPoint(t,optionalTarget){let point=optionalTarget||new Vector2,twoPi=2*Math.PI,deltaAngle=this.aEndAngle-this.aStartAngle,samePoints=Math.abs(deltaAngle)<Number.EPSILON;for(;deltaAngle<0;)deltaAngle+=twoPi;for(;deltaAngle>twoPi;)deltaAngle-=twoPi;deltaAngle<Number.EPSILON&&(deltaAngle=samePoints?0:twoPi),!0!==this.aClockwise||samePoints||(deltaAngle===twoPi?deltaAngle=-twoPi:deltaAngle-=twoPi);let angle=this.aStartAngle+t*deltaAngle,x=this.aX+this.xRadius*Math.cos(angle),y=this.aY+this.yRadius*Math.sin(angle);if(0!==this.aRotation){let cos=Math.cos(this.aRotation),sin=Math.sin(this.aRotation),tx=x-this.aX,ty=y-this.aY;x=tx*cos-ty*sin+this.aX,y=tx*sin+ty*cos+this.aY}return point.set(x,y)}copy(){return Curve3D.prototype.copy.call(this,source),this.aX=source.aX,this.aY=source.aY,this.xRadius=source.xRadius,this.yRadius=source.yRadius,this.aStartAngle=source.aStartAngle,this.aEndAngle=source.aEndAngle,this.aClockwise=source.aClockwise,this.aRotation=source.aRotation,this}toJSON(){let data=Curve3D.prototype.toJSON.call(this);return data.aX=this.aX,data.aY=this.aY,data.xRadius=this.xRadius,data.yRadius=this.yRadius,data.aStartAngle=this.aStartAngle,data.aEndAngle=this.aEndAngle,data.aClockwise=this.aClockwise,data.aRotation=this.aRotation,data}fromJSON(){return Curve3D.prototype.fromJSON.call(this,json),this.aX=json.aX,this.aY=json.aY,this.xRadius=json.xRadius,this.yRadius=json.yRadius,this.aStartAngle=json.aStartAngle,this.aEndAngle=json.aEndAngle,this.aClockwise=json.aClockwise,this.aRotation=json.aRotation,this}}class LineCurve extends Curve3D{constructor(v1,v2){super(),this.type="LineCurve",this.v1=v1||new Vector3,this.v2=v2||new Vector3,this.isLineCurve=!0}getPoint(t,optionalTarget){var point=optionalTarget||new Vector3;return 1===t?point.copy(this.v2):(point.copy(this.v2).sub(this.v1),point.multiplyScalar(t).add(this.v1)),point}getPointAt(u,optionalTarget){return this.getPoint(u,optionalTarget)}getTangent(){return this.v2.clone().sub(this.v1).normalize()}copy(source){return Curve3D.prototype.copy.call(this,source),this.v1.copy(source.v1),this.v2.copy(source.v2),this}toJSON(){var data=Curve3D.prototype.toJSON.call(this);return data.v1=this.v1.toArray(),data.v2=this.v2.toArray(),data}fromJSON(json){return Curve.prototype.fromJSON.call(this,json),this.v1.fromArray(json.v1),this.v2.fromArray(json.v2),this}}class QuadraticBezierCurve extends Curve3D{constructor(v0,v1,v2){super(),this.type="QuadraticBezierCurve",this.v0=v0||new Vector2,this.v1=v1||new Vector2,this.v2=v2||new Vector2,this.isQuadraticBezierCurve=!0}getPoint(t,optionalTarget=new Vector2){let point=optionalTarget||new Vector2,v0=this.v0,v1=this.v1,v2=this.v2;const{QuadraticBezier:QuadraticBezier}=require("Shape2DInterpolations");return point.set(QuadraticBezier(t,v0.x,v1.x,v2.x),QuadraticBezier(t,v0.y,v1.y,v2.y)),point}copy(source){return Curve3D.prototype.copy.call(this,source),this.v0.copy(source.v0),this.v1.copy(source.v1),this.v2.copy(source.v2),this}toJSON(){let data=Curve3D.prototype.toJSON.call(this);return data.v0=this.v0.toArray(),data.v1=this.v1.toArray(),data.v2=this.v2.toArray(),data}fromJSON(json){return Curve3D.prototype.fromJSON.call(this,json),this.v0.fromArray(json.v0),this.v1.fromArray(json.v1),this.v2.fromArray(json.v2),this}}class SplineCurve extends Curve3D{constructor(){super(),this.type="SplineCurve",this.points=points||[],this.isSplineCurve=!0}getPoint(t,optionalTarget){let point=optionalTarget||new Vector2,points=this.points,p=(points.length-1)*t,intPoint=Math.floor(p),weight=p-intPoint,p0=points[0===intPoint?intPoint:intPoint-1],p1=points[intPoint],p2=points[intPoint>points.length-2?points.length-1:intPoint+1],p3=points[intPoint>points.length-3?points.length-1:intPoint+2];return point.set(CatmullRom(weight,p0.x,p1.x,p2.x,p3.x),CatmullRom(weight,p0.y,p1.y,p2.y,p3.y)),point}copy(source){Curve3D.prototype.copy.call(this,source),this.points=[];for(let i=0,l=source.points.length;i<l;i++){let point=source.points[i];this.points.push(point.clone())}return this}toJSON(){let data=Curve.prototype.toJSON.call(this);data.points=[];for(let i=0,l=this.points.length;i<l;i++){let point=this.points[i];data.points.push(point.toArray())}return data}fromJSON(json){Curve.prototype.fromJSON.call(this,json),this.points=[];for(let i=0,l=json.points.length;i<l;i++){let point=json.points[i];this.points.push((new Vector2).fromArray(point))}return this}}class GLUIShape extends GLUIObject{constructor(){super(1,1),GLUIShape.emptyShape||(GLUIShape.emptyShape=new Shape),GLUIShape.antialias||(GLUIShape.antialias=1);let geom=new ShapeGeometry(GLUIShape.emptyShape,24);this.geom=geom,this.msaa=1,this.useGeometry(geom),this.fillColor=new Color,this.commands=[],this.holes=new GLUIShapeHoles,this.subdivisions=24;let shader=new Shader("GLUIShape",{uColor:{value:this.fillColor}});this.useShader(shader)}beginPath(){this.commands.length=0}moveTo(x,y){this.commands.push(["moveTo",x,-y])}lineTo(x,y){this.commands.push(["lineTo",x,-y])}quadraticCurveTo(aCPx,aCPy,aX,aY){this.commands.push(["quadraticCurveTo",aCPx,-aCPy,aX,-aY])}bezierCurveTo(aCP1x,aCP1y,aCP2x,aCP2y,aX,aY){this.commands.push(["bezierCurveTo",aCP1x,-aCP1y,aCP2x,-aCP2y,aX,-aY])}arc(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){this.commands.push(["arc",aX,-aY,aRadius,aStartAngle,aEndAngle,aClockwise])}endPath(){const _this=this;return _this._promise=ShapeUtils.process(this).then((_=>{let shape,p=_this.parent;for(;p;)p instanceof GLUIShape&&(shape=p),p=p.parent;shape&&shape._notifyParentUpdate(),_this.update&&_this.update()})),_this._promise}create(){let $obj=$glShape();return this.add($obj),$obj}_notifyParentUpdate(){this._cacheAsBitmap&&this.bitmap.update()}set cacheAsBitmap(bool){this._cacheAsBitmap=bool,bool&&(this.bitmap||(this.bitmap=new GLUIShapeBitmap(this)),this.bitmap.show())}get mask(){return this._mask||(this._mask=new GLUIShapeMask(this),this.cacheAsBitmap=!0,this.bitmap.mask=this._mask),this._mask}async ready(){return this._promise}async loaded(){return this._promise}}class GLUIShapeBitmap{constructor(shape){this.shape=shape,this.rt=Utils3D.createRT(100,100,null,Texture.RGBAFormat),this.camera=new OrthographicCamera,this.scene=new Scene,this.wrapper=new Group,this.scene.add(this.wrapper),this.quad=$gl(100,100,this.rt),this.shape.add(this.quad),this.shader=new Shader("GLUIShapeBitmap",{tMask:{value:Utils3D.getTexture("assets/images/_scenelayout/mask.jpg")}}),this.quad.useShader(this.shader)}hide(){let _this=this;this.quad.hide(),this.shape.children.forEach((child=>{child!=_this.quad&&this.shape.group.add(child.group)}))}show(){let _this=this;this.quad.show(),this.shape.children.forEach((child=>{child!=_this.quad&&this.wrapper.add(child.group)}))}update(){this.scene.position.set(0,0,0),this.scene.updateMatrixWorld(!0);let scale=World.DPR*GLUIShape.antialias,bb=new Box3;bb.setFromObject(this.wrapper);let width=bb.max.x-bb.min.x,height=-(bb.min.y-bb.max.y);this.rt.setSize(width*scale,height*scale),this.quad.width=width,this.quad.height=height,this.camera.setViewport(width,height),this.camera.position.x=width/2,this.camera.position.y=-height/2,this.camera.updateMatrixWorld(!0);const _this=this;let x=9999,y=9999;this.shape.children.forEach((child=>{if(child==_this.quad)return;child.mesh.onBeforeRender&&child.mesh.onBeforeRender();let worldPos=child.mesh.getWorldPosition();x=Math.min(x,worldPos.x),y=Math.min(y,-worldPos.y)})),this.scene.position.set(-x,y,0),this.quad.x=x,this.quad.y=-y;let clearAlpha=World.RENDERER.getClearAlpha();World.RENDERER.setClearAlpha(0),World.RENDERER.render(this.scene,this.camera,this.rt),World.RENDERER.setClearAlpha(clearAlpha),this.mask&&this.mask.update()}}class GLUIShapeHoles{constructor(){this.commands=[]}beginPath(){this.commands.length=0}moveTo(x,y){this.commands.push(["moveTo",x,-y])}lineTo(x,y){this.commands.push(["lineTo",x,-y])}quadraticCurveTo(aCPx,aCPy,aX,aY){this.commands.push(["quadraticCurveTo",aCPx,-aCPy,aX,-aY])}bezierCurveTo(aCP1x,aCP1y,aCP2x,aCP2y,aX,aY){this.commands.push(["bezierCurveTo",aCP1x,-aCP1y,aCP2x,-aCP2y,aX,-aY])}arc(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){this.commands.push(["arc",aX,-aY,aRadius,aStartAngle,aEndAngle,aClockwise])}endPath(){this.commands.push(["endPath"])}}class GLUIShapeMask extends GLUIShape{constructor(shape){super(),this.shape=shape,this.rt=Utils3D.createRT(100,100,null,Texture.RGBAFormat),this.scene=new Scene,this.scene.add(this.group),this.mesh.frustumCulled=!1,this.__internalDirty=this.update}update(){let{x:x,y:y}=this.shape.bitmap.quad;this.scene.position.set(0,0,0),this.scene.updateMatrixWorld(!0),this.rt.setSize(this.shape.bitmap.rt.width,this.shape.bitmap.rt.height),this.scene.position.set(-x,0,0);let clearAlpha=World.RENDERER.getClearAlpha();World.RENDERER.setClearAlpha(0),World.RENDERER.render(this.scene,this.shape.bitmap.camera,this.rt),World.RENDERER.setClearAlpha(clearAlpha),this.shape.bitmap.shader.set("tMask",this.rt)}clear(){this.shape.bitmap.shader.set("tMask",Utils3D.getTexture("assets/images/_scenelayout/mask.jpg")),this.rt.destroy(),this.shape._mask=null}}class CurvePath extends Curve3D{constructor(){super(),this.curves=[],this.autoClose=!1}add(curve){this.curves.push(curve)}closePath(){let startPoint=this.curves[0].getPoint(0),endPoint=this.curves[this.curves.length-1].getPoint(1);startPoint.equals(endPoint)||this.curves.push(new LineCurve(endPoint,startPoint))}getPoint(t){let d=t*this.getLength(),curveLengths=this.getCurveLengths(),i=0;for(;i<curveLengths.length;){if(curveLengths[i]>=d){let diff=curveLengths[i]-d,curve=this.curves[i],segmentLength=curve.getLength(),u=0===segmentLength?0:1-diff/segmentLength;return curve.getPointAt(u)}i++}return null}getLength(){let lens=this.getCurveLengths();return lens[lens.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;let lengths=[],sums=0;for(let i=0,l=this.curves.length;i<l;i++)sums+=this.curves[i].getLength(),lengths.push(sums);return this.cacheLengths=lengths,lengths}getSpacedPoints(divisions){void 0===divisions&&(divisions=40);let points=[];for(let i=0;i<=divisions;i++)points.push(this.getPoint(i/divisions));return this.autoClose&&points.push(points[0]),points}getPoints(divisions=12){let last,points=[];for(let i=0,curves=this.curves;i<curves.length;i++){let curve=curves[i],resolution=curve&&curve.isEllipseCurve?2*divisions:curve&&(curve.isLineCurve||curve.isLineCurve3)?1:curve&&curve.isSplineCurve?divisions*curve.points.length:divisions,pts=curve.getPoints(resolution);for(let j=0;j<pts.length;j++){let point=pts[j];last&&last.equals(point)||(points.push(point),last=point)}}return this.autoClose&&points.length>1&&!points[points.length-1].equals(points[0])&&points.push(points[0]),points}copy(source){Curve3D.prototype.copy.call(this,source),this.curves=[];for(let i=0,l=source.curves.length;i<l;i++){let curve=source.curves[i];this.curves.push(curve.clone())}return this.autoClose=source.autoClose,this}toJSON(){let data=Curve3D.prototype.toJSON.call(this);data.autoClose=this.autoClose,data.curves=[];for(let i=0,l=this.curves.length;i<l;i++){let curve=this.curves[i];data.curves.push(curve.toJSON())}return data}fromJSON(json){Curve3D.prototype.fromJSON.call(this,json),this.autoClose=json.autoClose,this.curves=[];for(let i=0,l=json.curves.length;i<l;i++){let curve=json.curves[i];this.curves.push((new Curves[curve.type]).fromJSON(curve))}return this}}class Path extends CurvePath{constructor(points){super(),this.type="Path",this.currentPoint=new Vector2,points&&this.setFromPoints(points)}setFromPoints(points){this.moveTo(points[0].x,points[0].y);for(let i=1,l=points.length;i<l;i++)this.lineTo(points[i].x,points[i].y)}moveTo(x,y){this.currentPoint.set(x,y)}lineTo(x,y){let curve=new LineCurve(this.currentPoint.clone(),new Vector2(x,y));this.curves.push(curve),this.currentPoint.set(x,y)}quadraticCurveTo(aCPx,aCPy,aX,aY){let curve=new QuadraticBezierCurve(this.currentPoint.clone(),new Vector2(aCPx,aCPy),new Vector2(aX,aY));this.curves.push(curve),this.currentPoint.set(aX,aY)}bezierCurveTo(aCP1x,aCP1y,aCP2x,aCP2y,aX,aY){let curve=new CubicBezierCurve2D(this.currentPoint.clone(),new Vector2(aCP1x,aCP1y),new Vector2(aCP2x,aCP2y),new Vector2(aX,aY));this.curves.push(curve),this.currentPoint.set(aX,aY)}splineThru(pts){let npts=[this.currentPoint.clone()].concat(pts),curve=new SplineCurve(npts);this.curves.push(curve),this.currentPoint.copy(pts[pts.length-1])}arc(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){let x0=this.currentPoint.x,y0=this.currentPoint.y;this.absarc(aX+x0,aY+y0,aRadius,aStartAngle,aEndAngle,aClockwise)}absarc(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){this.absellipse(aX,aY,aRadius,aRadius,aStartAngle,aEndAngle,aClockwise)}ellipse(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise,aRotation){let x0=this.currentPoint.x,y0=this.currentPoint.y;this.absellipse(aX+x0,aY+y0,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise,aRotation)}absellipse(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise,aRotation){let curve=new EllipseCurve(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise,aRotation);if(this.curves.length>0){let firstPoint=curve.getPoint(0);firstPoint.equals(this.currentPoint)||this.lineTo(firstPoint.x,firstPoint.y)}this.curves.push(curve);let lastPoint=curve.getPoint(1);this.currentPoint.copy(lastPoint)}copy(source){return CurvePath.prototype.copy.call(this,source),this.currentPoint.copy(source.currentPoint),this}toJSON(){let data=CurvePath.prototype.toJSON.call(this);return data.currentPoint=this.currentPoint.toArray(),data}fromJSON(json){return CurvePath.prototype.fromJSON.call(this,json),this.currentPoint.fromArray(json.currentPoint),this}}class Shape extends Path{constructor(points){super(points),this.type="Shape",this.holes=[]}getPointsHoles(divisions){let holesPts=[];for(let i=0,l=this.holes.length;i<l;i++)holesPts[i]=this.holes[i].getPoints(divisions);return holesPts}extractPoints(divisions){return{shape:this.getPoints(divisions),holes:this.getPointsHoles(divisions)}}copy(source){Path.prototype.copy.call(this,source),this.holes=[];for(let i=0,l=source.holes.length;i<l;i++){let hole=source.holes[i];this.holes.push(hole.clone())}return this}toJSON(){let data=Path.prototype.toJSON.call(this);data.holes=[];for(let i=0,l=this.holes.length;i<l;i++){let hole=this.holes[i];data.holes.push(hole.toJSON())}return data}fromJSON(json){Path.prototype.fromJSON.call(this,json),this.holes=[];for(let i=0,l=json.holes.length;i<l;i++){let hole=json.holes[i];this.holes.push((new Path).fromJSON(hole))}return this}}class ShapeGeometry extends Geometry{constructor(shapes,curveSegments){super(),this.type="ShapeGeometry",this.parameters={shapes:shapes,curveSegments:curveSegments};let indices=[],vertices=[];if(!1===Array.isArray(shapes))addShape(shapes);else for(let i=0;i<shapes.length;i++)addShape(shapes[i]);function addShape(shape){let i,l,shapeHole,indexOffset=vertices.length/3,points=shape.extractPoints(curveSegments),shapeVertices=points.shape,shapeHoles=points.holes;for(!1===ShapeUtils.isClockWise(shapeVertices)&&(shapeVertices=shapeVertices.reverse()),i=0,l=shapeHoles.length;i<l;i++)shapeHole=shapeHoles[i],!0===ShapeUtils.isClockWise(shapeHole)&&(shapeHoles[i]=shapeHole.reverse());let faces=ShapeUtils.triangulateShape(shapeVertices,shapeHoles);for(i=0,l=shapeHoles.length;i<l;i++)shapeHole=shapeHoles[i],shapeVertices=shapeVertices.concat(shapeHole);for(i=0,l=shapeVertices.length;i<l;i++){let vertex=shapeVertices[i];vertices.push(vertex.x,vertex.y,0)}for(i=0,l=faces.length;i<l;i++){let face=faces[i],a=face[0]+indexOffset,b=face[1]+indexOffset,c=face[2]+indexOffset;indices.push(a,b,c)}}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3))}}Class((function Earcut(){Inherit(this,Component);function linkedList(data,start,end,dim,clockwise){var i,last;if(clockwise===function signedArea(data,start,end,dim){for(var sum=0,i=start,j=end-dim;i<end;i+=dim)sum+=(data[j]-data[i])*(data[i+1]+data[j+1]),j=i;return sum}(data,start,end,dim)>0)for(i=start;i<end;i+=dim)last=insertNode(i,data[i],data[i+1],last);else for(i=end-dim;i>=start;i-=dim)last=insertNode(i,data[i],data[i+1],last);return last&&equals(last,last.next)&&(removeNode(last),last=last.next),last}function filterPoints(start,end){if(!start)return start;end||(end=start);var again,p=start;do{if(again=!1,p.steiner||!equals(p,p.next)&&0!==area(p.prev,p,p.next))p=p.next;else{if(removeNode(p),(p=end=p.prev)===p.next)break;again=!0}}while(again||p!==end);return end}function earcutLinked(ear,triangles,dim,minX,minY,invSize,pass){if(ear){!pass&&invSize&&function indexCurve(start,minX,minY,invSize){var p=start;do{null===p.z&&(p.z=zOrder(p.x,p.y,minX,minY,invSize)),p.prevZ=p.prev,p.nextZ=p.next,p=p.next}while(p!==start);p.prevZ.nextZ=null,p.prevZ=null,function sortLinked(list){var i,p,q,e,tail,numMerges,pSize,qSize,inSize=1;do{for(p=list,list=null,tail=null,numMerges=0;p;){for(numMerges++,q=p,pSize=0,i=0;i<inSize&&(pSize++,q=q.nextZ);i++);for(qSize=inSize;pSize>0||qSize>0&&q;)0!==pSize&&(0===qSize||!q||p.z<=q.z)?(e=p,p=p.nextZ,pSize--):(e=q,q=q.nextZ,qSize--),tail?tail.nextZ=e:list=e,e.prevZ=tail,tail=e;p=q}tail.nextZ=null,inSize*=2}while(numMerges>1);return list}(p)}(ear,minX,minY,invSize);for(var prev,next,stop=ear;ear.prev!==ear.next;)if(prev=ear.prev,next=ear.next,invSize?isEarHashed(ear,minX,minY,invSize):isEar(ear))triangles.push(prev.i/dim),triangles.push(ear.i/dim),triangles.push(next.i/dim),removeNode(ear),ear=next.next,stop=next.next;else if((ear=next)===stop){pass?1===pass?earcutLinked(ear=cureLocalIntersections(ear,triangles,dim),triangles,dim,minX,minY,invSize,2):2===pass&&splitEarcut(ear,triangles,dim,minX,minY,invSize):earcutLinked(filterPoints(ear),triangles,dim,minX,minY,invSize,1);break}}}function isEar(ear){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0)return!1;for(var p=ear.next.next;p!==ear.prev;){if(pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function isEarHashed(ear,minX,minY,invSize){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0)return!1;for(var minTX=a.x<b.x?a.x<c.x?a.x:c.x:b.x<c.x?b.x:c.x,minTY=a.y<b.y?a.y<c.y?a.y:c.y:b.y<c.y?b.y:c.y,maxTX=a.x>b.x?a.x>c.x?a.x:c.x:b.x>c.x?b.x:c.x,maxTY=a.y>b.y?a.y>c.y?a.y:c.y:b.y>c.y?b.y:c.y,minZ=zOrder(minTX,minTY,minX,minY,invSize),maxZ=zOrder(maxTX,maxTY,minX,minY,invSize),p=ear.prevZ,n=ear.nextZ;p&&p.z>=minZ&&n&&n.z<=maxZ;){if(p!==ear.prev&&p!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,n!==ear.prev&&n!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,n.x,n.y)&&area(n.prev,n,n.next)>=0)return!1;n=n.nextZ}for(;p&&p.z>=minZ;){if(p!==ear.prev&&p!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;n&&n.z<=maxZ;){if(n!==ear.prev&&n!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,n.x,n.y)&&area(n.prev,n,n.next)>=0)return!1;n=n.nextZ}return!0}function cureLocalIntersections(start,triangles,dim){var p=start;do{var a=p.prev,b=p.next.next;!equals(a,b)&&intersects(a,p,p.next,b)&&locallyInside(a,b)&&locallyInside(b,a)&&(triangles.push(a.i/dim),triangles.push(p.i/dim),triangles.push(b.i/dim),removeNode(p),removeNode(p.next),p=start=b),p=p.next}while(p!==start);return p}function splitEarcut(start,triangles,dim,minX,minY,invSize){var a=start;do{for(var b=a.next.next;b!==a.prev;){if(a.i!==b.i&&isValidDiagonal(a,b)){var c=splitPolygon(a,b);return a=filterPoints(a,a.next),c=filterPoints(c,c.next),earcutLinked(a,triangles,dim,minX,minY,invSize),void earcutLinked(c,triangles,dim,minX,minY,invSize)}b=b.next}a=a.next}while(a!==start)}function compareX(a,b){return a.x-b.x}function eliminateHole(hole,outerNode){if(outerNode=function findHoleBridge(hole,outerNode){var m,p=outerNode,hx=hole.x,hy=hole.y,qx=-1/0;do{if(hy<=p.y&&hy>=p.next.y&&p.next.y!==p.y){var x=p.x+(hy-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(x<=hx&&x>qx){if(qx=x,x===hx){if(hy===p.y)return p;if(hy===p.next.y)return p.next}m=p.x<p.next.x?p:p.next}}p=p.next}while(p!==outerNode);if(!m)return null;if(hx===qx)return m.prev;var tan,stop=m,mx=m.x,my=m.y,tanMin=1/0;p=m.next;for(;p!==stop;)hx>=p.x&&p.x>=mx&&hx!==p.x&&pointInTriangle(hy<my?hx:qx,hy,mx,my,hy<my?qx:hx,hy,p.x,p.y)&&((tan=Math.abs(hy-p.y)/(hx-p.x))<tanMin||tan===tanMin&&p.x>m.x)&&locallyInside(p,hole)&&(m=p,tanMin=tan),p=p.next;return m}(hole,outerNode)){var b=splitPolygon(outerNode,hole);filterPoints(b,b.next)}}function zOrder(x,y,minX,minY,invSize){return(x=1431655765&((x=858993459&((x=252645135&((x=16711935&((x=32767*(x-minX)*invSize)|x<<8))|x<<4))|x<<2))|x<<1))|(y=1431655765&((y=858993459&((y=252645135&((y=16711935&((y=32767*(y-minY)*invSize)|y<<8))|y<<4))|y<<2))|y<<1))<<1}function getLeftmost(start){var p=start,leftmost=start;do{(p.x<leftmost.x||p.x===leftmost.x&&p.y<leftmost.y)&&(leftmost=p),p=p.next}while(p!==start);return leftmost}function pointInTriangle(ax,ay,bx,by,cx,cy,px,py){return(cx-px)*(ay-py)-(ax-px)*(cy-py)>=0&&(ax-px)*(by-py)-(bx-px)*(ay-py)>=0&&(bx-px)*(cy-py)-(cx-px)*(by-py)>=0}function isValidDiagonal(a,b){return a.next.i!==b.i&&a.prev.i!==b.i&&!function intersectsPolygon(a,b){var p=a;do{if(p.i!==a.i&&p.next.i!==a.i&&p.i!==b.i&&p.next.i!==b.i&&intersects(p,p.next,a,b))return!0;p=p.next}while(p!==a);return!1}(a,b)&&locallyInside(a,b)&&locallyInside(b,a)&&function middleInside(a,b){var p=a,inside=!1,px=(a.x+b.x)/2,py=(a.y+b.y)/2;do{p.y>py!=p.next.y>py&&p.next.y!==p.y&&px<(p.next.x-p.x)*(py-p.y)/(p.next.y-p.y)+p.x&&(inside=!inside),p=p.next}while(p!==a);return inside}(a,b)}function area(p,q,r){return(q.y-p.y)*(r.x-q.x)-(q.x-p.x)*(r.y-q.y)}function equals(p1,p2){return p1.x===p2.x&&p1.y===p2.y}function intersects(p1,q1,p2,q2){return!!(equals(p1,p2)&&equals(q1,q2)||equals(p1,q2)&&equals(p2,q1))||area(p1,q1,p2)>0!=area(p1,q1,q2)>0&&area(p2,q2,p1)>0!=area(p2,q2,q1)>0}function locallyInside(a,b){return area(a.prev,a,a.next)<0?area(a,b,a.next)>=0&&area(a,a.prev,b)>=0:area(a,b,a.prev)<0||area(a,a.next,b)<0}function splitPolygon(a,b){var a2=new Node(a.i,a.x,a.y),b2=new Node(b.i,b.x,b.y),an=a.next,bp=b.prev;return a.next=b,b.prev=a,a2.next=an,an.prev=a2,b2.next=a2,a2.prev=b2,bp.next=b2,b2.prev=bp,b2}function insertNode(i,x,y,last){var p=new Node(i,x,y);return last?(p.next=last.next,p.prev=last,last.next.prev=p,last.next=p):(p.prev=p,p.next=p),p}function removeNode(p){p.next.prev=p.prev,p.prev.next=p.next,p.prevZ&&(p.prevZ.nextZ=p.nextZ),p.nextZ&&(p.nextZ.prevZ=p.prevZ)}function Node(i,x,y){this.i=i,this.x=x,this.y=y,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}this.triangulate=function(data,holeIndices,dim){dim=dim||2;var minX,minY,maxX,maxY,x,y,invSize,hasHoles=holeIndices&&holeIndices.length,outerLen=hasHoles?holeIndices[0]*dim:data.length,outerNode=linkedList(data,0,outerLen,dim,!0),triangles=[];if(!outerNode||outerNode.next===outerNode.prev)return triangles;if(hasHoles&&(outerNode=function eliminateHoles(data,holeIndices,outerNode,dim){var i,len,list,queue=[];for(i=0,len=holeIndices.length;i<len;i++)(list=linkedList(data,holeIndices[i]*dim,i<len-1?holeIndices[i+1]*dim:data.length,dim,!1))===list.next&&(list.steiner=!0),queue.push(getLeftmost(list));for(queue.sort(compareX),i=0;i<queue.length;i++)eliminateHole(queue[i],outerNode),outerNode=filterPoints(outerNode,outerNode.next);return outerNode}(data,holeIndices,outerNode,dim)),data.length>80*dim){minX=maxX=data[0],minY=maxY=data[1];for(var i=dim;i<outerLen;i+=dim)(x=data[i])<minX&&(minX=x),(y=data[i+1])<minY&&(minY=y),x>maxX&&(maxX=x),y>maxY&&(maxY=y);invSize=0!==(invSize=Math.max(maxX-minX,maxY-minY))?1/invSize:0}return earcutLinked(outerNode,triangles,dim,minX,minY,invSize),triangles}}),"static"),Module((function Shape2DInterpolations(){this.exports={QuadraticBezier:function QuadraticBezier(t,p0,p1,p2){return function QuadraticBezierP0(t,p){let k=1-t;return k*k*p}(t,p0)+function QuadraticBezierP1(t,p){return 2*(1-t)*t*p}(t,p1)+function QuadraticBezierP2(t,p){return t*t*p}(t,p2)},CubicBezier:function CubicBezier(t,p0,p1,p2,p3){return function CubicBezierP0(t,p){let k=1-t;return k*k*k*p}(t,p0)+function CubicBezierP1(t,p){let k=1-t;return 3*k*k*t*p}(t,p1)+function CubicBezierP2(t,p){return 3*(1-t)*t*t*p}(t,p2)+function CubicBezierP3(t,p){return t*t*t*p}(t,p3)},CatmullRom:function CatmullRom(t,p0,p1,p2,p3){let v0=.5*(p2-p0),v1=.5*(p3-p1),t2=t*t;return(2*p1-2*p2+v0+v1)*(t*t2)+(-3*p1+3*p2-2*v0-v1)*t2+v0*t+p1}}})),Class((function ShapeUtils(){Inherit(this,Component);const _this=this;function getShapeGeom({commands:commands,holes:holes,subdivisions:subdivisions},id){let geom=commandsToShapeGeom(commands,holes,subdivisions),position=geom.attributes.position.array,index=geom.index,bb=geom.boundingBox;resolve({position:position,index:index,bb:bb},id,[position.buffer,index.buffer])}function commandsToShapeGeom(commands,holes,curveSegments){let shape=new Shape;commands.forEach((array=>{let cmd=array.shift();shape[cmd].apply(shape,array)}));let path=new Path;holes.forEach((array=>{let cmd=array.shift();"endPath"===cmd?(shape.holes.push(path),path=new Path):path[cmd].apply(path,array)})),path.curves.length&&shape.holes.push(path);let geom=new ShapeGeometry(shape,curveSegments);return geom.computeBoundingBox(),geom}function removeDupEndPts(points){let l=points.length;l>2&&points[l-1].equals(points[0])&&points.pop()}function addContour(vertices,contour){for(let i=0;i<contour.length;i++)vertices.push(contour[i].x),vertices.push(contour[i].y)}!async function(){window.THREAD||(await Hydra.ready(),Thread.shared(!0).array.forEach((thread=>{thread.loadFunction(commandsToShapeGeom),thread.importModule("Shape2DInterpolations"),["ShapeGeometry","Curve3D","CurvePath","EllipseCurve","Path","CubicBezierCurve2D","LineCurve","Shape","SplineCurve"].forEach((name=>{thread.importES6Class(name)})),thread.importCode(`Class(${_this.constructor.toString()}, 'static')`),thread.importCode(`Class(${Earcut.constructor.toString()}, 'static')`)})),Thread.upload(getShapeGeom))}(),this.area=function(contour){let n=contour.length,a=0;for(let p=n-1,q=0;q<n;p=q++)a+=contour[p].x*contour[q].y-contour[q].x*contour[p].y;return.5*a},this.isClockWise=function(pts){return _this.area(pts)<0},this.triangulateShape=function(contour,holes){let vertices=[],holeIndices=[],faces=[];removeDupEndPts(contour),addContour(vertices,contour);let holeIndex=contour.length;holes.forEach(removeDupEndPts);for(let i=0;i<holes.length;i++)holeIndices.push(holeIndex),holeIndex+=holes[i].length,addContour(vertices,holes[i]);let triangles=Earcut.triangulate(vertices,holeIndices);for(let i=0;i<triangles.length;i+=3)faces.push(triangles.slice(i,i+3));return faces},this.process=async function(shape){let{geom:geom,commands:commands,subdivisions:subdivisions}=shape,holes=shape.holes.commands,data=await Thread.shared().getShapeGeom({commands:commands,holes:holes,subdivisions:subdivisions});geom.attributes.position.array=data.position,geom.attributes.position.needsUpdate=!0,geom.attributes.position.needsNewBuffer=!0,geom.attributes.position.count=data.position.length/3,geom.boundingBox=data.bb,geom.index=data.index,geom.indexNeedsUpdate=!0},window.$glShape=function(){return new GLUIShape}}),"static");class Skin extends Mesh{constructor(geometry,shader,bones=geometry.bones){super(geometry,shader),this.isSkin=!0,this.createBones(bones),this.createBoneTexture(),this.animations=[],Object.assign(this.shader.uniforms,{boneTexture:{value:this.boneTexture},boneTextureSize:{value:this.boneTextureSize}})}createBones(bonesData){this.root=new Base3D,this.bones=[],bonesData.forEach((data=>{const bone=new Base3D;bone.name=data.name,bone.position.set(...data.pos),bone.quaternion.set(...data.rot),bone.scale.set(...data.scl),this.bones.push(bone)})),bonesData.forEach(((data,i)=>{if(-1===data.parent)return this.root.add(this.bones[i]);this.bones[data.parent].add(this.bones[i])})),this.root.updateMatrixWorld(!0),this.bones.forEach((bone=>{bone.bindInverse=(new Matrix4).copy(bone.matrixWorld),bone.bindInverse=bone.bindInverse.getInverse(bone.bindInverse)}))}createBoneTexture(){const size=Math.max(4,Math.pow(2,Math.ceil(Math.log(Math.sqrt(4*this.bones.length))/Math.LN2)));this.boneMatrices=new Float32Array(size*size*4),this.boneTextureSize=size,this.boneTexture=new DataTexture(this.boneMatrices,size,size)}addAnimation(data){const animation=new SkinAnimation(this,data);return this.animations.push(animation),animation}async loadAnimation(path){path.includes("assets/geometry/")||(path="assets/geometry/"+path),path.includes(".")||(path+=".json"),path=Thread.absolutePath(Assets.getPath(path));const data=await(await fetch(path)).json();return this.addAnimation(data)}update(){let total=0;this.animations.forEach((animation=>total+=animation.weight)),this.animations.forEach(((animation,i)=>{animation.update(total||1,0===i)}))}updateMatrixWorld(force){super.updateMatrixWorld(force),this.root.updateMatrixWorld(!0),this.bones.forEach(((bone,i)=>{Skin.tempMat4.multiplyMatrices(bone.matrixWorld,bone.bindInverse),this.boneMatrices.set(Skin.tempMat4.elements,16*i)})),this.boneTexture.needsUpdate=!0}}Skin.tempMat4=new Matrix4;class SkinAnimation{constructor(skin,data){this.skin=skin,this.data=data,this.elapsed=0,this.weight=1,this.duration=data.duration}update(totalWeight,isSet){const weight=isSet?1:this.weight/totalWeight,elapsed=this.elapsed%this.duration;let prevKey,nextKey;this.data.skeleton.forEach(((d,i)=>{for(let j=0;j<d.keys.length;j++){if(!(d.keys[j].time<elapsed)){nextKey=d.keys[j];break}prevKey=d.keys[j]}let key=prevKey||nextKey;if(SkinAnimation.tempPos.set(...key.pos),SkinAnimation.tempRot.set(...key.rot),SkinAnimation.tempScl.set(...key.scl),prevKey&&nextKey){let lerp=(elapsed-prevKey.time)/(nextKey.time-prevKey.time);SkinAnimation.tempPos2.set(...nextKey.pos),SkinAnimation.tempRot2.set(...nextKey.rot),SkinAnimation.tempScl2.set(...nextKey.scl),SkinAnimation.tempPos.lerp(SkinAnimation.tempPos2,lerp),SkinAnimation.tempRot.slerp(SkinAnimation.tempRot2,lerp),SkinAnimation.tempScl.lerp(SkinAnimation.tempScl2,lerp)}this.skin.bones[i].position.lerp(SkinAnimation.tempPos,weight),this.skin.bones[i].quaternion.slerp(SkinAnimation.tempRot,weight),this.skin.bones[i].scale.lerp(SkinAnimation.tempScl,weight)}))}}SkinAnimation.tempPos=new Vector3,SkinAnimation.tempRot=new Quaternion,SkinAnimation.tempScl=new Vector3,SkinAnimation.tempPos2=new Vector3,SkinAnimation.tempRot2=new Quaternion,SkinAnimation.tempScl2=new Vector3,Class((function SLCDragHelper(_capture,$obj){Inherit(this,Component);const _this=this;function dragMove(e){_this.flag("persist")||(e||_capture.unbindMove(),e&&_this.flag("handMode")&&e.hit.distance>_this.distanceThreshold&&_capture.unbindMove()),!_this.onDragMove||_this.flag("persist")&&!e||_this.onDragMove(e)}function vrButton(e){_this.flag("persist")||"trigger"==e.label&&(e.pressed?_this.flag("hover")&&_capture.bindMove():_capture.unbindMove())}function mouseDown(e){_this.flag("persist")||(_this.flag("mouse_down",!0),_this.flag("hover")&&_capture.bindMove())}function mouseUp(e){_this.flag("persist")||(_this.flag("mouse_down",!1),_capture.unbindMove())}function hover(e){_this.flag("persist")||(_this.flag("hover","over"==e.action),window.VRInput&&(VRInput.isSetupFakeHands||VRInput.isSetupHands)&&(_this.flag("handMode",!0),_capture.bindMove()))}this.distanceThreshold=.2,$obj&&$obj.interact(hover,(_=>{})),function addListeners(){_this.events.sub(Mouse.input,Interaction.START,mouseDown),_this.events.sub(Mouse.input,Interaction.END,mouseUp),window.VRInput&&VRInput.ready().then((_=>{VRInput.controllers.forEach((c=>{_this.events.sub(VRInput.BUTTON,vrButton)}))}))}(),_capture.onDragMove=dragMove,this.persistMove=function(){_capture.bindMove(),_this.flag("persist",!0)}})),Class((function StageLayout(_name,_options={}){Inherit(this,Component);const _this=this;var _dataStore,_data,$create;const GLUI=void 0===_options.glui||_options.glui;var _uil=getTopLevelUIL(),_folders={},_layers={},_exists={},_resize=[],_graph,_config;function getTopLevelUIL(){let uil=UIL.sidebar;return!_options.uil&&_this.parent&&uil&&Utils.getConstructorName(_this.parent)!=Global.PLAYGROUND&&(uil=new UILFolder(`stl_${_name}_nested`,{label:_name.capitalize()+" (Nested)",closed:!0}),UIL.sidebar&&UIL.sidebar.add(uil)),uil}function createFolder(name){let folder=new UILFolder(`stl_${_name}_${name}`,{label:name,closed:!0});return _folders[`stl_${_name}_${name}`]=folder,folder}async function initGraph(){_options.noGraph||!window.UILGraph||StageLayout.noGraph||(_graph=UILGraph.instance().getGraph(_name,_this,!!GLUI))&&(UIL.sidebar.element.show(),Global.PLAYGROUND&&(Utils.getConstructorName(_this.parent),Global.PLAYGROUND),_graph.open())}function initParams(){_options.rootPath?"/"!=_options.rootPath.charAt(_options.rootPath.length-1)&&(_options.rootPath+="/"):_options.rootPath="",_this.baseZ=_options.baseZ||0,_this.data=_options.data,_options.uil&&(_uil=_options.uil),GLUI?(_this.element=$gl(1,1),_this.element.stageLayout=_this):(_this.element=$("StageLayout_"+_name),_this.element.size("100%"))}async function initData(){if(await UILStorage.ready(),_dataStore=InputUIL.create("stagelayout_"+_name,null),void 0===(_data=JSON.parse(_dataStore.get("data")||"{}")).layers&&(_data.layers=-1),_options.perFrame)_data.layers>0&&createLayers();else{for(let i=0,c=_data.layers+1;i<c;i++)createLayer(i);_this.loaded=!0}}function initRoot(){let name=_name+"Root",group=_uil?createFolder(name):null,$obj=_this.element,input=InputUIL.create(`Config_${name}_${_name}`,group);if(input.setLabel("Parameters"),input.add("size").addTextarea("fontStyle").addTextarea("css",GLUI?"hidden":void 0).add("onResize","hidden"),input.add("compiled","hidden"),input.add("Figma Config"),_config=input,!group)return createCompiledLayer(`${name}_${_name}`,input);StageLayoutUtil.create(`${name}_${_name}`),group.hide(),group.setLabel(name);let size=input.get("size"),css=input.get("css"),resizeCode=(input.get("fontStyle"),input.get("onResize")),doCSS=change=>{if(GLUI)return;css=css||"";let obj={},objSave={};css=css.split("\n"),css.forEach((line=>{let key=(line=line.split(":"))[0],val=line[1],valSave=val;val&&(val=parseData(val.replace(/ /g,""))),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val),valSave&&(valSave=valSave.replace(/ /g,"")),objSave[key]=isNaN(Number(valSave))?valSave:Number(valSave))})),change&&StageLayoutUtil.save("css",objSave,input),$obj.css(obj)},doSize=change=>{if(size){let s=parseData(size).replace(/ /g,"").split(","),s0=s[0].includes("%")?s[0]:Number(s[0])||s[0],s1=s[1].includes("%")?s[1]:Number(s[1])||s[1];$obj.size(s0,s1),change&&StageLayoutUtil.save("size",[s0,s1],input)}else $obj.size(100,100)},doResize=change=>{if(resizeCode){let fn=new Function("$this",resizeCode);_resize.push({fn:fn,$obj:$obj}),fn($obj)}},doFont=change=>{let fontStyle=parseData(input.get("fontStyle"));fontStyle&&(fontStyle=fontStyle.split("\n"),$obj.fontStyle(fontStyle[0],Number(fontStyle[1]),fontStyle[2],fontStyle[3]),change&&StageLayoutUtil.save("fontStyle",fontStyle,input))};doCSS(),doSize(),doFont(),doResize(),input.onUpdate=key=>{switch(key){case"css":css=input.get("css"),doCSS(!0);break;case"size":size=input.get("size"),doSize(!0);break;case"onResize":resizeCode=input.get("onResize"),doResize();break;case"fontStyle":doFont(!0)}},group.params=input,_graph&&_graph.addSpecial(group.id,name,"Root"),_uil.add(group),(_=>{let folder=new UILFolder(`stl_${_name}_${name}_resize`,{label:"Resize Logic",closed:!0}),button=new UILControlButton("button",{actions:[{title:"Open Editor",callback:_=>{let editor=new UILWindow(_name,{label:"Resize Logic",height:"auto",drag:!0}),text=new UILControlTextarea(`stl_${_name}_${name}_resize`,{label:"Resize",value:input.get("onResize"),monospace:!0,rows:10,resize:"both",minWidth:400,hideLabel:!0,tab:!0});editor.add(text),text.onFinishChange((value=>input.setValue("onResize",value))),UIL.add(editor)}}],hideLabel:!0});folder.add(button),group.add(folder)})()}function createLayers(){let index=0,renderWorker=new Render.Worker((function(){createLayer(index),index++==_data.layers&&(renderWorker.stop(),_this.loaded=!0)}),_options.perFrame)}function parseData(text){if(!text||"string"!=typeof text||!text.includes("$DATA"))return text;for(;text.includes("$DATA");){let code=text.split("$DATA")[1].split(" ")[0].split("\n")[0],line="$DATA"+code;text=text.replace(line,eval(line.replace("$DATA","_options.data")))}return text}async function createCompiledLayer(key,input){let compiled=StageLayoutUtil.getCompiled(key);if(!compiled)return;let $obj,name=input.get("name"),text=input.get("text");$obj=GLUI?text?$glText(parseData(text),null,null,compiled.fontStyle):$gl(1,1,parseData(input.get("bg"))):key==`${_name}Root_${_name}`?_this.element:$(name||"Layer",parseData(input.get("type")||"div"));let nestedGroup=input.get("group");if(nestedGroup){let layer;layer=nestedGroup===_name?_this.element:await _this.getLayer(nestedGroup),layer.add($obj)}else _this.element!=$obj&&_this.element.add($obj);if(Global.PLAYGROUND&&($obj._input=input),_layers[name]=$obj,_exists[name]=!0,checkNameHook($obj,name),compiled.css&&$obj.css){for(let key in compiled.css)compiled.css[key]=parseData(compiled.css[key]);$obj.css(compiled.css)}if(compiled.transform){for(let key in compiled.transform)$obj[key]=compiled.transform[key];$obj.transform&&$obj.transform()}if(compiled.size&&$obj.size(compiled.size[0],compiled.size[1]),compiled.attributes&&$obj.attr)for(let key in compiled.attributes)$obj.attr(key,parseData(compiled.attributes[key]));if(!GLUI){let bg=input.get("bg");bg&&$obj.bg(parseData(bg)||"#ff0000")}if(!GLUI){if(text){text=parseData(text);let helper=compiled.helper;if(helper){let helperName=helper.split("(")[0],args=helper.split("(")[1];args?(args=args.replace(")","").replace(/,\ /g,",").split(","),args.forEach((function(arg,i){"$text"==arg&&(args[i]=text)})),args.indexOf(text)<0&&args.unshift(text)):args=[text];let helperFn=_options[helperName]||StageLayout.helpers[helperName];return helperFn?void $obj.html(helperFn.apply(null,args)):console.warn(`No helper function ${helperName} found.`)}text.includes(["</","/>"])?$obj.html(text):$obj.text(text)}let fs=compiled.fontStyle;fs&&$obj.fontStyle(fs[0],Number(fs[1]),fs[2],fs[3])}let zIndex=input.getNumber("zIndex");"number"==typeof zIndex&&$obj&&$obj.setZ&&!isNaN(zIndex)&&$obj.setZ(zIndex),compiled.resize&&(_resize.push({$obj:$obj,fn:compiled.resize}),compiled.resize($obj));let customClass=input.get("customClass");if(customClass){let Class=window[customClass];if(customClass.includes(".")){let split=customClass.split(".");Class=window[split[0]]&&window[split[0]][split[1]]}if(!Class)return console.warn(`No custom class ${customClass} found.`);_layers[name]=_this.initClass(Class,$obj,_options.data,input)}}function checkNameHook($obj,name){if(_this.layerHooks)for(let i=0,l=_this.layerHooks.length;i<l;i++){console.log(i);let{test:test,callback:callback,classConstructor:classConstructor}=_this.layerHooks[i];test&&test(name)&&(classConstructor&&_this.initClass(classConstructor,$obj,name),callback&&callback($obj,name))}for(let i=0,l=StageLayout.LAYER_HOOKS.length;i<l;i++){let{test:test,callback:callback,classConstructor:classConstructor}=StageLayout.LAYER_HOOKS[i];test&&test(name)&&(classConstructor&&_this.initClass(classConstructor,$obj,name),callback&&callback($obj,name))}}async function createLayer(index,groupName){let id="number"==typeof index?index:++_data.layers;if(UILStorage.get(`stl_${_name}_${id}_deleted`))return;let $obj,group=_uil?createFolder(id):null,input=InputUIL.create(`Config_${id}_${_name}`,group);if(input.setLabel("Parameters"),input.add("name").add("type",GLUI?"hidden":void 0).add("bg").add("size").add("group").add("customClass").add("wildcard").add("helper",GLUI?"hidden":void 0).add("zIndex","hidden").addTextarea("attributes",GLUI?"hidden":void 0).addTextarea("text").addTextarea("fontStyle").addTextarea("css",GLUI?"hidden":void 0).addTextarea("transform").add("onResize","hidden"),input.add("compiled","hidden"),!group)return createCompiledLayer(`${id}_${_name}`,input);StageLayoutUtil.create(`${id}_${_name}`),groupName&&input.setValue("group",groupName);let name=input.get("name")||id+"",size=input.get("size"),bg=input.get("bg"),css=input.get("css"),transform=input.get("transform"),type=input.get("type"),attributes=input.get("attributes"),text=input.get("text"),nestedGroup=(input.get("fontStyle"),input.get("group")),resizeCode=input.get("onResize"),zIndex=input.getNumber("zIndex"),customClass=input.get("customClass"),helper=input.get("helper");input.get("wildcard");group.setLabel(name),group.params=input;let getGLUIFontObject=_=>{let font=input.get("fontStyle")||"",obj={};return font=font.split("\n"),font.forEach((line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val),"false"===val&&(obj[key]=!1),"true"===val&&(obj[key]=!0))})),obj};if($obj=GLUI?text?$glText(parseData(text),null,null,getGLUIFontObject()):$gl(1,1,bg?parseData(bg):bg||name?void 0:"assets/images/_scenelayout/uv.jpg"):$(name||"Layer",parseData(type)),$obj._uil=group,nestedGroup){let layer;layer=nestedGroup===_name?_this.element:await _this.getLayer(nestedGroup),layer.add&&layer.add($obj),group&&_uil.add(group)}else _this.element.add($obj),group&&_uil.add(group);_graph&&_graph.addGroup(group.id,name||id+"",nestedGroup),(_=>{let folder=new UILFolder(`stl_${_name}_${name}_resize`,{label:"Resize Logic",closed:!0}),button=new UILControlButton("button",{actions:[{title:"Open Editor",callback:_=>{let editor=new UILWindow(_name,{label:"Resize Logic",height:"auto",drag:!0}),text=new UILControlTextarea(`stl_${_name}_${name}_resize`,{label:"Resize",value:input.get("onResize"),monospace:!0,rows:10,resize:"both",minWidth:400,hideLabel:!0,tab:!0});editor.add(text),text.onFinishChange((value=>input.setValue("onResize",value))),UIL.add(editor)}}],hideLabel:!0});folder.add(button),group.add(folder)})(),Global.PLAYGROUND&&($obj._input=input),_layers[name]=$obj,_exists[name]=!0,checkNameHook($obj,name);let doBG=change=>{GLUI?change&&$obj.bg(parseData(bg)):(bg||!bg&&!name)&&$obj.bg(parseData(bg)||"#ff0000")},doType=change=>{GLUI||change&&StageLayoutUtil.save("type",{type:type},input)},doCSS=change=>{if(GLUI)return;css=css||"";let obj={};css=css.split("\n"),css.forEach((line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=parseData(val.replace(/ /g,""))),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val))})),change&&StageLayoutUtil.save("css",obj,input),$obj.css(obj)},doTransform=change=>{transform=transform||"";let obj={};transform=transform.split("\n"),transform.forEach((line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),key.length&&(obj[key]=$obj[key]=isNaN(Number(val))?val:Number(val))})),change&&StageLayoutUtil.save("transform",obj,input),GLUI||$obj.transform()},doResize=change=>{if(resizeCode){let fn=new Function("$this",resizeCode);_resize.push({fn:fn,$obj:$obj}),fn($obj)}},doSize=change=>{if(size){let s=parseData(size).replace(/ /g,"").split(","),s0=Number(s[0])||s[0],s1=Number(s[1])||s[1];$obj.size(s0,s1),change&&StageLayoutUtil.save("size",[s0,s1],input)}else $obj.size(100,100)},doAttributes=change=>{if(GLUI)return;attributes=attributes||"";let obj={};attributes.split("\n").forEach((function(line,i){let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),obj[key]=val,val=parseData(val),$obj.attr(key,val)})),change&&StageLayoutUtil.save("attributes",obj,input)},doText=change=>{if(text=parseData(text),GLUI){if(!text)return $obj;if($obj instanceof GLUIObject)return $obj;let fontStyle=getGLUIFontObject();change&&StageLayoutUtil.save("fontStyle",fontStyle,input),$obj.setText(text,fontStyle),fontStyle.color&&$obj.setColor(fontStyle.color)}else{let fontStyle=parseData(input.get("fontStyle"));if(fontStyle?(fontStyle=fontStyle.split("\n"),$obj.fontStyle(fontStyle[0]||"",Number(fontStyle[1]),fontStyle[2],fontStyle[3]),change&&StageLayoutUtil.save("fontStyle",fontStyle,input)):change&&StageLayoutUtil.save("fontStyle","",input),!text)return;if(helper){let helperName=helper.split("(")[0],args=helper.split("(")[1];args?(args=args.replace(")","").replace(/,\ /g,",").split(","),args.forEach((function(arg,i){"$text"==arg&&(args[i]=text)})),args.indexOf(text)<0&&args.unshift(text)):args=[text];let helperFn=_options[helperName]||StageLayout.helpers[helperName];return helperFn?($obj.html(helperFn.apply(null,args)),void StageLayoutUtil.save("helper",helper,input)):console.warn(`No helper function ${helperName} found.`)}text.includes(["</","/>"])?$obj.html(text):$obj.text(text)}},doZ=_=>{"number"==typeof zIndex&&$obj.setZ(zIndex)};if(doType(),doCSS(),doBG(),doSize(),doAttributes(),doTransform(),doText(),doResize(),doZ(),input.onUpdate=key=>{switch(key){case"name":group.setLabel(input.get("name"));break;case"type":type=input.get("type"),doType(!0);break;case"css":css=input.get("css"),doCSS(!0);break;case"size":size=input.get("size"),doSize(!0);break;case"attributes":attributes=input.get("attributes"),doAttributes(!0);break;case"transform":transform=input.get("transform"),doTransform(!0);break;case"onResize":resizeCode=input.get("onResize"),doResize();break;case"text":case"fontStyle":text=input.get("text"),doText(!0);break;case"bg":bg=input.get("bg"),doBG(!0);break;case"zIndex":zIndex=input.getNumber("zIndex")||0,doZ()}},customClass){let Class=window[customClass];if(customClass.includes(".")){let split=customClass.split(".");Class=window[split[0]]&&window[split[0]][split[1]]}if(!Class)return console.warn(`No custom class ${customClass} found.`);_layers[name]=_this.initClass(Class,$obj,_options.data,input,group)}return"number"!=typeof index&&_dataStore.setValue("data",JSON.stringify(_data)),$obj}function resizeHandler(){_resize.forEach((({$obj:$obj,fn:fn})=>fn($obj)))}function sortChild(label,index=0,parent,baseZ,step){let folder=_folders[label.id||label];if(!folder||!folder.params)return;let zIndex=0;zIndex=GLUI&&baseZ!=_this.baseZ?baseZ+(index+1)*step:baseZ+index,folder.params.setValue("zIndex",zIndex),label.children&&label.children.forEach((function(child,j,all){sortChild(child,j,all,zIndex,step/(parent.length+1))}))}function copyFolderProps(from,to){let params;to.forEachFolder((child=>{switch(child.label){case"Parameters":params=child}}));let allowed=["Parameters"];from.forEachFolder((child=>{if(!(allowed.indexOf(child.label)<0))switch(child.toClipboard(),child.label){case"Parameters":params.fromClipboard()}}))}this.isStageLayout=!0,this.name=_name,this.layers=_layers,_options.layerHooks&&(_this.layerHooks=_options.layerHooks),_this.onResize(resizeHandler),initParams(),initGraph(),initData(),defer((()=>{initRoot()})),this._createLayer=function(parentId){return createLayer(null,parentId)},this._createGroup=function(parentId){return createLayer(null,parentId)},this._rename=function(id,name,value){if(name==value)return;let folder=_folders[id]||_folders[`stl_${_name}_${name}`];folder&&(folder.setLabel(value),folder.params&&folder.params.setValue("name",value),Object.values(_layers).filter((layer=>layer._uil.params.get("group")==name)).forEach((layer=>layer._uil.params.setValue("group",value))),[_exists,_layers].forEach((function(store){store[name]&&(store[value]=store[name],store[name]=null,delete store[name])})))},this._deleteLayer=function(id,name){let $obj=_layers[name];if(!$obj)return!1;if($obj.div&&$obj.div.children.length)return alert("Can't delete a group that has nested layers."),!1;if(!confirm("Are you sure you want to delete this layer?"))return;let folder=_folders[id];return _uil.remove(folder),($obj.element||$obj).remove(),UILStorage.set(id+"_deleted",!0),!0},this._changeParent=function(childId,childName,parentId,parentName){let child=_layers[childId]||_layers[childName],parent=_layers[parentId]||_layers[parentName]||_this;if(!child)return;child=child.element||child,parent==_this&&(parent=_this.element);let folder=_folders[childId]||_folders[`sl_${_name}_${childName}`];folder&&folder.params&&folder.params.setValue("group",parentName||null),("function"==typeof child.parent?child.parent():child.parent).removeChild(child,!0),parent.add(child)},this._visible=function(name,visible){let $obj=_layers[name];$obj&&$obj.css&&(visible?$obj.css({opacity:1}):$obj.css({opacity:0}))},this._focus=function(name){UIL.sidebar.toolbar.filterSingle(name)},this._blur=function(name){let folder=_folders[name];folder&&folder.forEachFolder&&(folder.forEachFolder((f=>f.close())),folder.close())},this._sort=function(order){order.forEach((function(item,i,all){sortChild(item,i,all,_this.baseZ,1)}))},this._duplicateLayer=function(id,parentId){let folder=_folders[id];if(!folder)return;createLayer(null,parentId);let copy=Object.values(_folders).last();copyFolderProps(folder,copy),parentId&&copy.params.setValue("group",parentId)},this._duplicateGroup=function(id,children,parentId){_this._duplicateLayer(id,parentId);let pid=_data.layers;children.forEach((childId=>{_this._duplicateGroup(childId,_graph.listChildren(childId),pid)}))},this._getFigmaConfig=async function(){let _figmaConfig=_config.get("Figma Config").replace(".json","");return await get(Assets.getPath(`assets/data/${_figmaConfig}.json`))},this._applyFigmaConfig=function(id,params,$obj){if("TEXT"===params.type){$obj._input.setValue("text",params.characters);let figmaConfig,lineHeight,fontStyle="",align=params.textAlignHorizontal.toLowerCase(),fontName=StageLayout.FIGMA_FONT.DEFAULT,fontScale=1,ptToPixel=.75,family=StageLayout.FIGMA_FONT[params.fontName.family];if(family){let font=family[params.fontName.style.toLowerCase()];font&&(fontName=font.name,Stage.FIGMA_FONT_CONFIG&&Stage.FIGMA_FONT_CONFIG[fontName]&&(figmaConfig=Stage.FIGMA_FONT_CONFIG[fontName]),font.scale&&(fontScale=font.scale),figmaConfig&&figmaConfig.fontScale&&figmaConfig.fontScale>.1&&(fontScale=figmaConfig.fontScale))}fontName&&(fontStyle+=`font: ${fontName}\n`),fontStyle+=`size: ${params.fontSize*ptToPixel*fontScale}\n`,fontStyle+=`align: ${align}\n`,"PERCENT"===params.letterSpacing.unit&&params.letterSpacing.value&&(fontStyle+=`letterSpacing: ${params.letterSpacing.value/100*fontScale}\n`),figmaConfig&&figmaConfig.lineHeight&&(lineHeight=figmaConfig.lineHeight),"PERCENT"===params.lineHeight.unit&&params.lineHeight.value&&(lineHeight*=params.lineHeight.value/100),lineHeight&&(fontStyle+=`lineHeight: ${lineHeight}\n`),fontStyle+=`width: ${params.width}\n`,fontStyle+=`height: ${params.height}\n`;let fill=params.fills[0];if(fill&&fill.color){let c=fill.color;fontStyle+=`color: ${new Color(c.r,c.g,c.b).getHexString()}\n`}$obj._input.setValue("fontStyle",fontStyle);let x=params.x;"center"===align?x+=params.width/2:"right"===align&&(x+=params.width);let transform=`x: ${x}\ny: ${params.y}`;params.rotation&&(transform+="\nrotation: "+params.rotation),$obj._input.setValue("transform",transform)}else if("RECTANGLE"===params.type){$obj._input.setValue("size",`${params.width}, ${params.height}`);let fill=params.fills[0];if(!fill)return;if("IMAGE"===fill.type)$obj._input.setValue("bg","assets/images/_scenelayout/uv.jpg");else if("SOLID"===fill.type){let c=fill.color,color=new Color(c.r,c.g,c.b);$obj._input.setValue("bg",color.getHexString())}let transform=`x: ${params.x}\ny: ${params.y}`;params.rotation&&(transform+="\nrotation: "+params.rotation),$obj._input.setValue("transform",transform)}},this.getLayer=async function(name){let timer;Hydra.LOCAL&&(timer=_this.delayedCall((_=>{_exists[name]||"mockup"===name||console.warn(`${name} doesn't exist in StageLayout ${_name}`)}),1e3));for(let key in _layers){let layer=_layers[key];if(layer._uil){let uil=layer._uil;if(uil.id===name||uil.label===name)return timer&&clearTimeout(timer),layer}}return await _this.wait(_layers,name),timer&&clearTimeout(timer),_layers[name]},this.getLayers=async function(){let array=[];for(let i=0;i<arguments.length;i++)array.push(_this.getLayer(arguments[i]));return Promise.all(array)},this.getAllLayers=async function(){return await this.ready(),_layers},this.ready=this.loadedAllLayers=async function(){await _this.wait(_this,"loaded"),await defer()},this.exists=function(key){return!!_exists[key]},this.get("graph",(_=>_graph)),this.get("config",(_=>_config)),this.get("layerCount",(_=>_data.layers))}),(()=>{StageLayout.FIGMA_FONT={},StageLayout.LAYER_HOOKS=[],StageLayout.helpers={},StageLayout.loadFontConfig=async(path,json)=>{if(!json){path=path||"assets/data/figma-font.json";try{json=await get("assets/data/figma-font.json")}catch(e){return}}Stage.FIGMA_FONT_CONFIG=json.config}})),Class((function StageLayoutCapture(_layout,_w,_h,_rtPool,_strict){Inherit(this,Component);const _this=this;var _rt,_camera,_hitCamera,_interaction,_ray,_needsRender,_hitEvt,_usingFingers,$glObj,_scene=new Scene,_mouse=new Vector2,_stage=new Vector2,_v3=new Vector3,_enabled=!0,_width=_w,_height=_h,_cacheHits=[];function loop(){if(!_enabled)return;if(_this.manualRender&&!_needsRender)return;let clearAlpha=World.RENDERER.getClearAlpha(),autoClear=World.RENDERER.autoClear;_this.disableClear&&(World.RENDERER.autoClear=!1);let clearColor=World.RENDERER.getClearColor().getHex();clearColor>0?World.RENDERER.setClearColor(0,0):World.RENDERER.setClearAlpha(0),World.RENDERER.render(_scene,_camera,_rt),clearColor>0?World.RENDERER.setClearColor(clearColor,clearAlpha):World.RENDERER.setClearAlpha(clearAlpha),_this.disableClear&&(World.RENDERER.autoClear=autoClear)}function noop(){}function hitUpdate(hit){let x=hit.uv.x*_width,y=(1-hit.uv.y)*_height;_usingFingers=hit.usingFinger,_this.isHitting=!0,_mouse.set(x,y),_enabled&&_interaction&&(hit.usingFinger?_interaction.testWithFinger(_mouse,hit.distance):_interaction.testWith(_mouse))}function missUpdate(){_this.isHitting=!1,_mouse.set(9999,9999),_interaction&&(_usingFingers?_interaction.testWithFinger(_mouse,9999):_interaction.testWith(_mouse))}function raycastMove(e){_ray||(_ray=_this.initClass(Raycaster,_hitCamera));let hit,input=Interaction3D.find(_hitCamera).input;if(Array.isArray(input.obj)){_cacheHits.length=0;for(let i=0;i<input.obj.length;i++){let obj=input.obj[i];_v3.set(0,0,-1).applyQuaternion(obj.quaternion);let hit=_ray.checkFromValues($glObj.mesh,obj.position,_v3)[0];hit&&_cacheHits.push(hit)}_cacheHits.sort(((a,b)=>a.distance-b.distance)),hit=_cacheHits[0]}else"2d"==input.type?hit=_ray.checkHit($glObj.mesh,input.position,input.rect||Stage)[0]:(_v3.set(0,0,-1).applyQuaternion(input.quaternion),hit=_ray.checkFromValues($glObj.mesh,input.position,_v3)[0]);_hitEvt||(_hitEvt={normal:new Vector2,tilt:new Vector2,pos:new Vector2}),hit?(_hitEvt.normal.set(hit.uv.x,1-hit.uv.y),_hitEvt.tilt.set(Math.range(_hitEvt.normal.x,0,1,-1,1),Math.range(_hitEvt.normal.y,0,1,-1,1)),_hitEvt.pos.set(_hitEvt.normal.x*_width,_hitEvt.normal.y*_height),_hitEvt.hit=hit,_this.onDragMove&&_this.onDragMove(_hitEvt)):_this.onDragMove&&_this.onDragMove(null)}function flipNeedsRender(){_needsRender=!1}this.disableClear=!1,function(){"number"==typeof _layout&&(_strict=_rtPool,_rtPool=_h,_h=_w,_w=_layout,_layout={element:$gl()}),_width=_w,_height=_h,"boolean"==typeof _rtPool&&(_strict=_rtPool,_rtPool=null);let dpr=_strict?1:RenderManager.DPR;_rtPool?_this.rt=_rtPool.nullRT:(_rt=Utils3D.createRT(_width*dpr,_height*dpr,null,Texture.RGBAFormat),_this.rt=_rt),_this.root=_layout.element,_this.root.stageLayoutCapture=_this,_scene.add(_layout.element.group),(_camera=new OrthographicCamera).setViewport(_width,_height),_camera.position.z=1,_camera.position.x=_width/2,_camera.position.y=-_height/2,_scene.disableAutoSort=!0,_stage.set(_width,_height),function findHitCamera(){let p=_this.parent;for(;p;)p instanceof FXScene&&(_hitCamera=p.camera),p=p.parent;_hitCamera=World.CAMERA}(),_interaction=_this.initClass(GLUIStageInteraction2D,_camera,_scene,_stage,!0),_this.startRender(loop,RenderManager.AFTER_LOOPS)}(),this.onVisible=function(){_rtPool&&(_rt=_this.rt=_rtPool.getRT())},this.onInvisible=function(){_rtPool&&_rtPool.putRT(_rt)},this.setSize=function(width,height){_width=width,_height=height,_camera.setViewport(_width,_height),_camera.position.z=1,_camera.position.x=_width/2,_camera.position.y=-_height/2,_stage.set(width,height)},this.render=function(){loop()},this.get("object3d",(()=>$glObj)),this.set("object3d",(gl=>{gl.mesh||(gl={mesh:gl}),($glObj=gl).mesh.onHitUpdate=hitUpdate,$glObj.mesh.onMissUpdate=missUpdate,_hitCamera&&Interaction3D.find(_hitCamera).add($glObj.mesh,noop,noop)})),this.get("camera",(()=>_camera)),this.set("hitCamera",(camera=>{camera!=_hitCamera&&($glObj&&Interaction3D.find(_hitCamera).remove($glObj.mesh),_hitCamera=camera,$glObj&&Interaction3D.find(_hitCamera).add($glObj.mesh,noop,noop))})),this.set("enabled",(v=>{_interaction._disabled=!v,_enabled=v})),this.get("enabled",(_=>_enabled)),this.set("mouseEnabled",(v=>{v?(_interaction._disabled=!1,$glObj.mesh.onHitUpdate=hitUpdate,$glObj.mesh.onMissUpdate=missUpdate,_hitCamera&&Interaction3D.find(_hitCamera).add($glObj.mesh,noop,noop)):(_interaction._disabled=!0,$glObj&&(_hitCamera&&Interaction3D.find(_hitCamera).remove($glObj.mesh),delete $glObj.mesh.onHitUpdate,delete $glObj.mesh.onMissUpdate))})),this.set("layout",(layout=>{_layout&&_scene.remove(_layout.element.group),_scene.add(layout.element.group),_layout=layout})),this.get("layout",(_=>_layout)),this.get("scene",(_=>_scene)),this.get("width",(_=>_width)),this.get("height",(_=>_height)),this.onVisible=function(){_rtPool&&(_rt=_this.rt=_rtPool.getRT())},this.onInvisible=function(){_rtPool&&_this.rt!=_rtPool.nullRT&&(_rtPool.putRT(_this.rt),_rt=_this.rt=_rtPool.nullRT)},this.onDestroy=function(){_rtPool?_this.onInvisible():_this.rt.destroy(),$glObj&&(Interaction3D.find(_hitCamera).remove($glObj.mesh),delete $glObj.mesh.onHitUpdate,delete $glObj.mesh.onMissUpdate)},this.bindMove=function(){_this.startRender(raycastMove)},this.unbindMove=function(){_this.stopRender(raycastMove)},this.set("needsRender",(value=>{_needsRender=!0,function callAfterAtLeast(callback,ms){let callAt=Date.now()+ms;callAt>(callback.__intervalExpiry||0)&&(clearTimeout(callback.__interval),callback.__interval=Timer.create(callback,ms),callback.__intervalExpiry=callAt)}(flipNeedsRender,"number"==typeof value?value:1e3)}))}),(_=>{StageLayoutCapture.createRTPool=function(width,height,strict){let pool=RTPool.instance().clone({format:Texture.RGBAFormat}),dpr=strict?1:RenderManager.DPR;return pool.setSize(width*dpr,height*dpr),pool}})),Class((function StageLayoutUtil(){Inherit(this,Component);var _data;const KEY="stagelayoututil_keys";var _compiled={};async function init(){await UILStorage.ready(),_data=JSON.parse(UILStorage.get(KEY)||"[]"),function compile(){_data.forEach((key=>{_compiled[key]=JSON.parse(UILStorage.get(`INPUT_Config_${key}_compiled`)||"{}");let resizeCode=UILStorage.get(`INPUT_Config_${key}_onResize`);resizeCode&&(_compiled[key].resize=new Function("$this",resizeCode))}))}()}!async function(){await Hydra.ready(),window.Platform&&Platform.isPlatform||init()}(),this.save=function(key,data,input){let compiled=JSON.parse(input.get("compiled")||"{}");compiled[key]=data,input.setValue("compiled",JSON.stringify(compiled))},this.create=function(key){_data.includes(key)||(_data.push(key),UILStorage.set(KEY,JSON.stringify(_data)))},this.getCompiled=function(key){return _compiled[key]},this.reload=function(){return init()}}),"static"),Class((function Track(){Inherit(this,Model);const DEBUG=Utils.query("debug");this.page=function(path,title){let data={};title&&(data.page_title=title),path&&(data.page_path=path),window.gtag&&gtag("config",Config.ANALYTICS_ID,data),DEBUG&&(window.gtag||console.log("no gtag"),Config.ANALYTICS_ID||console.log("Config.ANALYTICS_ID required"),console.log(`>>> track page: '${JSON.stringify(data)}'`))},this.event=function(category,action,label,value,params){let data={event:"event"};category&&(data.event_category=category),action&&(data.event_action=action),label&&(data.event_label=label),value&&(data.value=value),params&&(data=Object.assign(params,data)),window.gtag&&gtag("event",action,data),DEBUG&&(window.gtag||console.log("no gtag"),console.log(`>>> track event: '${action}', '${JSON.stringify(data)}'`))}}),"Static"),Class((function VelocityTracker(_vector){Inherit(this,Component);var _this=this,Vector="number"==typeof _vector.z?Vector3:Vector2,_velocity=new Vector,_last=new Vector;function loop(){_velocity.subVectors(_vector,_last),_last.copy(_vector)}this.value=_velocity,this.start=function(){_this.startRender(loop)},this.onDestroy=this.stop=function(){_this.stopRender(loop)},this.copy=function(){_last.copy(_vector)},this.update=loop})),Class((function XRDeviceManager(){Inherit(this,Component);const _this=this;var _session,_promise,_activeTime;function loop(){Render.TIME-_activeTime>15e3&&_this.events.fire(_this.HEADSET_IDLE),_activeTime=Render.TIME}function getFoveationFeatureName(){switch(_this.foveationLevel){case _this.FOVEATION_LEVEL_LOW:return"low-fixed-foveation-level";case _this.FOVEATION_LEVEL_MEDIUM:return"medium-fixed-foveation-level";case _this.FOVEATION_LEVEL_HIGH:case _this.FOVEATION_LEVEL_HIGH_TOP:return"high-fixed-foveation-level";default:return"no-fixed-foveation"}}this.SESSION_START="xr_start",this.SESSION_END="xr_end",this.CONTROLS_START="controls_start",this.HEADSET_IDLE="headset_idle",this.FOVEATION_LEVEL_NONE=0,this.FOVEATION_LEVEL_LOW=1,this.FOVEATION_LEVEL_MEDIUM=2,this.FOVEATION_LEVEL_HIGH=3,this.FOVEATION_LEVEL_HIGH_TOP=4,this.scaleFactor=1,this.preallocatedScaleFactors=[],this.features=["bounded-floor"],this.getVRSession=async function(){if(_session)return _session;let optionalFeatures=[..._this.features,getFoveationFeatureName()];return(_session=await navigator.xr.requestSession("immersive-vr",{requiredFeatures:["local-floor"],optionalFeatures:optionalFeatures})).addEventListener("end",(_=>{_session=null,_this.flag("needNewSession",!0),_this.events.fire(_this.SESSION_END)})),_this.startRender(loop,1),_session},this.getARSession=async function(){return _session||((_session=await navigator.xr.requestSession("immersive-ar")).addEventListener("end",(_=>{_session=null,_this.flag("needNewSession",!0),_this.events.fire(_this.SESSION_END)})),_session)},this.startSession=function(){return _this.flag("needNewSession")&&(_this.flag("needNewSession",!1),RenderManager.camera.reset?.(),RenderManager.renderer.reset?.(),_promise=null),_promise||(_promise=Promise.create(),_this.events.sub(_this.SESSION_START,_promise.resolve),_promise)},this.endSession=function(){return _session?.end()},this.waitForEnd=function(){let promise=Promise.create();return _this.events.sub(_this.SESSION_END,promise.resolve),promise},this.set("foveation",(value=>{window.AURA_OCULUS&&AURA_OCULUS.requestFoveation(value)}))}),"static"),Class((function ARCamera(){Inherit(this,Component);const _this=this;var _session;this.worldCamera=new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3),this.getFrameOfReference=async function(){return _session=await XRDeviceManager.getARSession(),await _session.requestReferenceSpace("local")},this.getRenderCamera=function(view,pose){if(pose)return _this.worldCamera.position.copy(view.transform.position),_this.worldCamera.quaternion.copy(view.transform.orientation),_this.worldCamera.updateMatrixWorld(!0),_this.worldCamera.projectionMatrix.fromArray(view.projectionMatrix),_this.worldCamera}})),Class((function ARRenderer(_renderer,_nuke){Inherit(this,Component);const _this=this;var _session,_arCamera,_callback,_frame,_frameOfRef,_gl,_view;async function setup(){(_session=await XRDeviceManager.getARSession()).baseLayer=new XRWebGLLayer(_session,_renderer.context,{framebufferScaleFactor:RenderManager.DPR/Device.pixelRatio,stencil:_renderer.stencil}),_session.updateRenderState({baseLayer:_session.baseLayer}),_gl=_renderer.context,_arCamera=RenderManager.camera,_frameOfRef=await _arCamera.getFrameOfReference(),ARUtils.frameOfReference=_frameOfRef,_session.requestAnimationFrame(rAF),Renderer.overrideViewport=!0,_renderer.arRenderingPath=renderAR,Render.useRAF(rAFOverride),_this.events.fire(XRDeviceManager.SESSION_START)}function renderAR(render,scene,camera){_gl.bindFramebuffer(_gl.FRAMEBUFFER,_session.baseLayer.framebuffer);let viewport=_session.baseLayer.getViewport(_view);_gl.viewport(viewport.x,viewport.y,viewport.width,viewport.height),_renderer.resolution.set(viewport.width,viewport.height),_renderer.autoClear=!1,render(scene,camera),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_renderer.autoClear=!0,_nuke.postRender&&_nuke.postRender()}function rAFOverride(callback){_callback=callback}function rAF(t,frame){_session.requestAnimationFrame(rAF);let pose=frame.getViewerPose(_frameOfRef);pose&&(ARUtils.pose=pose,_view=pose.views[0],window.AURA&&(ARUtils.setFramebuffer(_session.baseLayer,_view),_nuke.rtt=ARUtils.getFramebuffer()),_arCamera.getRenderCamera(_view,pose),_frame=frame,_callback&&_callback(t))}defer(setup),this.render=function(scene,camera){_frame&&(_nuke.passes.length&&window.AURA?_nuke.render():_renderer.render(scene,camera))},this.setSize=function(width,height){_renderer.setPixelRatio(RenderManager.DPR),_renderer.setSize(width,height)},this.getCameraTexture=function(texture){texture._gl=_session.getCameraTexture()}})),Class((function ARUtils(){Inherit(this,Component);const _this=this;var _origin,_direction,_matrix,_session,_env,_framebuffer,_originArray,_directionArray,_cameraTexture,_envShaders=[],_tracking=!1;function checkStatus(){_session.trackingStatus?_tracking||(_tracking=!0,_this.events.fire(_this.TRACKING_CHANGE,{tracking:!0})):_tracking&&(_tracking=!1,_this.events.fire(_this.TRACKING_CHANGE,{tracking:!1}))}async function handleEnvTexture({texture:texture}){let t=new Texture;t.cube=!0,t.needsReupload=t.needsUpdate=!1,t._metal=t._gl=texture;let size="ios"==Device.system.os?256:16,hdr="android"==Device.system.os,lastEnv=_env;_env=_this.initClass(DynamicEnvGenerator,t,size,30,hdr),await _env.ready(),_envShaders.forEach((shader=>{shader.set("tEnvSpecular",_env.specular.texture),shader.set("tEnvDiffuse",_env.diffuse.texture)})),lastEnv&&lastEnv.destroy()}this.lightIntensity={type:"f",value:0},this.FIRST_TRANSFORM="arutils_first_transform",this.TRACKING_CHANGE="arutils_tracking_change",this.TRACKING_STARTED="arutils_tracking_started",this.CLOUD_ANCHOR="cloud_anchor",_this.events.sub(XRDeviceManager.SESSION_START,(async _=>{RenderManager.type==RenderManager.WEBAR&&((_session=await XRDeviceManager.getARSession()).onCreated=_=>_this.events.fire(_this.TRACKING_STARTED),_this.startRender(checkStatus,10),_session.addEventListener("envTexture",handleEnvTexture))})),this.getTrackingStatus=async function(){return _session||(_session=await XRDeviceManager.getARSession()),_session.trackingStatus},this.resetOrigin=function(){},this.findSurface=async function(obj=Mouse){if(_session||(_session=await XRDeviceManager.getARSession()),!_this.frameOfReference)return;_origin||(_origin=new Vector3,_direction=new Vector3,_matrix=new Matrix4,_originArray=new Float32Array(3),_directionArray=new Float32Array(3)),_matrix.copy(World.CAMERA.matrixWorld),_origin.set(0,0,0),_origin.applyMatrix4(_matrix),_direction.set(0,0,-1),_direction.applyMatrix4(_matrix),_direction.sub(_origin).normalize(),_origin.toArray(_originArray),_direction.toArray(_directionArray);let output=[];return(await _session.requestHitTest(_originArray,_directionArray,_this.frameOfReference)).forEach((hit=>{let array=hit.hitMatrix,group=new Group;group.matrixWorld.fromArray(array),group.matrix.fromArray(array),group.matrixWorld.decompose(group.position,group.rotation,group.scale),group.hit=hit,output.push(group)})),output},this.addAnchor=async function(hit,type="normal"){return _session||(_session=await XRDeviceManager.getARSession()),hit=hit.hit||hit,window.AURA?hit.type=type:type=void 0,_session.addAnchor(hit,type)},this.removeAnchor=async function(hit){hit=hit.hit||hit,_session||(_session=await XRDeviceManager.getARSession()),_session.removeAnchor(hit,hit.type)},this.getCameraTexture=async function(){return _session||(_session=await XRDeviceManager.getARSession()),_cameraTexture||(_cameraTexture=new Texture,await RenderManager.renderer.getCameraTexture(_cameraTexture),_cameraTexture.needsUpdate=!1),_cameraTexture},this.getCameraQuad=async function(shader){let texture=await _this.getCameraTexture();shader?shader.set("tMap",texture):shader=_this.initClass(Shader,"ARCameraQuad",{tMap:{value:texture},depthWrite:!1,depthTest:!1});let mesh=new Mesh(World.QUAD,shader);return mesh.renderOrder=-999,mesh},this.applyEnvLighting=async function(shader){_env&&(await _env.ready(),shader.set("tEnvDiffuse",_env.diffuse.texture)),_envShaders.push(shader)},this.setFramebuffer=function(baseLayer,view){if(!_this.framebuffer){let viewport=baseLayer.getViewport(view);(_framebuffer=new RenderTarget(viewport.width,viewport.height))._gl=baseLayer.framebuffer}},this.getFramebuffer=function(){return _framebuffer}}),"static"),Class((function VRInput(){Inherit(this,Component);const _this=this;var _sources,_session,_frame,_reference,_controller,_matrix,_identity,_controllers=[],_handColors={},_hands={},_fakeHands={};function onXRFrame(t,frame){_session=(_frame=frame).session,_frame.getViewerPose(_reference),function updateControllers(){_sources=_session.inputSources;let index=0;for(let source of _sources)if(source.hand){if(_hands[source.handedness]||(_hands[source.handedness]=_this.initClass(window.AURA?VRInputHandAura:VRInputHand,source.handedness)),_handColors[source.handedness]&&_hands[source.handedness].setColor(_handColors[source.handedness]),_hands[source.handedness].update(_frame,source.hand,_reference),_this.isSetup&&!_this.flag("handsActive")){_this.flag("handsActive",!0),_controllers.forEach((c=>c.group.visible=!1));for(let key in _fakeHands)_fakeHands[key].group.visible=!1;for(let key in _hands)_hands[key].group.visible=!0;_this.isSetupFakeHands=!1}}else{let pose=_frame.getPose(source.targetRaySpace,_reference);if(!pose)continue;if(_matrix.fromArray(pose.transform.matrix),_matrix.equals(_identity))continue;_controllers[index]||(_controllers[index]=_this.initClass(VRInputController,_controller)),_controllers[index].inputSource=source,source.gamepad&&_controllers[index].processGamepad(source.gamepad);let controller=_controllers[index];if(pose&&pose.transform&&(controller.grip=pose.transform.matrix),_this.useControllerHands){let handedness=source.handedness;_fakeHands[handedness]||(_fakeHands[handedness]=_this.initClass(VRInputControllerHand,handedness,_controllers[index])),_handColors[source.handedness]&&_fakeHands[handedness].setColor(_handColors[source.handedness]),_fakeHands[handedness].handedness=handedness,_fakeHands[handedness].update(pose.transform.matrix),_controllers.forEach((c=>c.group.visible=!1))}if(_this.isSetupHands&&_this.flag("handsActive")){if(_this.flag("handsActive",!1),_this.useControllerHands)for(let key in _fakeHands)_fakeHands[key].group.visible=!0;else _controllers.forEach((c=>c.group.visible=!0));for(let key in _hands)_hands[key].group.visible=!1;_this.isSetupHands=!1}index++}!_this.isSetup&&_controllers[0]&&(_this.isSetup=!0);!_this.isSetupHands&&_hands.left&&_this.flag("handsActive")&&(_this.isSetupHands=!0,Promise.all([_hands.left.ready(),_hands.right.ready()]).then((_=>{Interaction3D.useInput([..._hands.left.tips,..._hands.right.tips])})),_this.events.fire(_this.CHANGE,{type:"hands"}));_this.isSetupFakeHands||!_fakeHands.left||_this.flag("handsActive")||(_this.isSetupFakeHands=!0,Promise.all([_fakeHands.left.ready(),_fakeHands.right.ready()]).then((_=>{Interaction3D.useInput([..._fakeHands.left.tips,..._fakeHands.right.tips])})),_this.events.fire(_this.CHANGE,{type:"controllers"}))}()}async function setup(){if(RenderManager.type==RenderManager.WEBVR){var session=await XRDeviceManager.getVRSession();_matrix=new Matrix4,new Matrix4,_identity=new Matrix4,_reference=await RenderManager.camera.getFrameOfReference(),session.addEventListener("selectstart",onSelectStart),session.addEventListener("selectend",onSelectEnd),session.addEventListener("native",nativeEvent),await _this.wait(100),RenderManager.renderer.onFrame=onXRFrame,await _this.wait(_this,"isSetup"),_this.events.fire(XRDeviceManager.CONTROLS_START)}}function nativeEvent(e){if(_this.enabled)for(let controller of _controllers)controller.inputSource==e.inputSource&&(e.controller=controller,controller.events.fire(_this.NATIVE,e))}function onSelectStart(e){if(_this.enabled)for(let controller of _controllers)controller.inputSource==e.inputSource&&(e.controller=controller,controller.events.fire(_this.SELECT_START,e))}function onSelectEnd(e){if(_this.enabled)for(let controller of _controllers)controller.inputSource==e.inputSource&&(e.controller=controller,controller.events.fire(_this.SELECT_END,e))}this.SELECT_START="select_start",this.SELECT_END="select_end",this.NATIVE="native",this.BUTTON="vr_button",this.JOYSTICK="vr_joystick",this.CHANGE="vr_input_change",function addHandlers(){_this.events.sub(XRDeviceManager.SESSION_START,setup)}(),_this.enabled=!0,this.get("controllers",(_=>_controllers)),this.setControllerConfig=function(config){_controller=config;for(let controller of _controllers)controller.applyControllerConfig(config)},this.ready=function(){return _this.wait("isSetup")},this.getHandType=function(){return _this.isSetupHands?"real":"fake"},this.handsReady=function(){return Promise.race([_this.wait("isSetupHands"),_this.wait("isSetupFakeHands")])},this.getHand=function(type){return _this.isSetupHands?_hands[type]:_fakeHands[type]},this.setHandColor=function(handedness,color){_handColors[handedness]=color,_this.isSetupHands?_hands[handedness].setColor(color):_fakeHands[handedness].setColor(color)},this.setBeamColor=async function(color){await _this.ready();for(let controller of _controllers)controller.setBeamColor(color)},this.setControllerObject=function(Class){_this.setControllerConfig({body:Class})}}),"static"),Class((function VRInputController(_config){Inherit(this,Object3D);const _this=this;var _body,_beam,_point,_grip=new Matrix4,_target=new Matrix4,_q=new Quaternion,_v3=new Vector3,_buttons={},_joystick={x:0,y:0};this.isVrController=!0,this.pointer=new Vector3;const PHYSICAL_SYNC=!!window.PhysicalSync;function initBody(){_body=_this.initClass(_config.body,{controller:_this})}function loop(){_grip.decompose(_this.group.position,_this.group.quaternion,_this.group.scale),_this.group.updateMatrixWorld(!0),_this.pointer.set(0,0,-1).applyQuaternion(_this.group.quaternion),PHYSICAL_SYNC&&PhysicalSync.realignObject(_this.group)}function getButtonLabel(i){let label;switch(i){case 0:label="trigger";break;case 1:label="side_trigger";break;case 2:label="touch_pad";break;case 3:label="joy_click";break;case 4:label="a";break;case 5:label="b"}return label}!function(){!function initConfig(){_config||(_config={});_config.body||(_config.body=VRInputControllerBody);_config.beam||(_config.beam=VRInputControllerBeam);_config.point||(_config.point=VRInputControllerPoint)}(),initBody(),function initBeam(){(_beam=_this.initClass(_config.beam)).group.visible=!1}();let velocity=new VelocityTracker(_this.group.position);velocity.start(),_this.velocity=velocity.value,Interaction3D.useInput(_this),RenderManager.camera.wrapper.add(_this.group),_this.startRender(loop)}(),this.get("target",(_=>_target)),this.set("target",(m=>_target.fromArray(m))),this.get("grip",(_=>_grip)),this.set("grip",(m=>_grip.fromArray(m))),this.get("color",(_=>_beam.color)),this.set("color",(c=>{_beam.color=c})),this.get("body",(_=>_body.mesh)),this.get("handedness",(_=>_this.inputSource.handedness)),this.setHitPosition=function(hit){_point&&_point.group&&(hit&&hit.point?(_point.group.visible=!0,_point.group.position.copy(hit.point),_v3.copy(hit.face.normal),hit.object.getWorldQuaternion(_q),_v3.applyQuaternion(_q),_v3.add(hit.point),_point.group.lookAt(_v3)):_point.group.visible=!1)},this.applyControllerConfig=function(config){_config=config,_body&&(_this.group.remove(_body.group),_body.destroy(),_body=null),initBody()},this.processGamepad=function(gamepad){gamepad.buttons.forEach(((b,i)=>{b.pressed?_buttons[i]||(_buttons[i]=!0,_this.events.fire(VRInput.BUTTON,{pressed:!0,label:getButtonLabel(i),controller:_this})):_buttons[i]&&(_buttons[i]=!1,_this.events.fire(VRInput.BUTTON,{pressed:!1,label:getButtonLabel(i),controller:_this}))}));let joyX=gamepad.axes[2],joyY=gamepad.axes[3];joyX==_joystick.x&&joyY==_joystick.y||(_joystick.x=joyX,_joystick.y=joyY,_joystick.controller=_this,_this.events.fire(VRInput.JOYSTICK,_joystick))},this.onDestroy=function(){RenderManager.camera.wrapper.remove(_this.group),World.SCENE.remove(_point.group)},this.setBeamColor=function(color){_beam.color=color},this.showBeam=function(){_beam.group.visible=!0},this.hideBeam=function(){_beam.group.visible=!1}})),Class((function VRInputControllerBeam(){Inherit(this,Object3D);const _this=this;var _geom,_shader,_mesh,_color;!function initGeom(){_geom=new CylinderGeometry(.005,0,2)}(),function initShader(){_color=VRInputControllerBeam.getColor(),_shader=_this.initClass(Shader,"VRInputControllerBeam",{uColor:{value:new Color(_color)},transparent:!0})}(),function initMesh(){(_mesh=new Mesh(_geom,_shader)).renderOrder=9999}(),function position(){_this.group.rotation.x=.5*Math.PI,_this.group.position.z=-1,_this.group.add(_mesh)}(),this.set("color",(function(color){VRInputControllerBeam.setColor(color),_shader.set("uColor",new Color(color)),_color=color})),this.get("color",(function(){return _color}))}),(_=>{var _color="#ffffff";VRInputControllerBeam.setColor=function(color){return _color=color},VRInputControllerBeam.getColor=function(){return _color}})),Class((function VRInputControllerBody(){Inherit(this,Object3D);const _this=this;!function(){let mesh=new Mesh(new BoxGeometry(.025,.025,.075),Utils3D.getTestShader());_this.group.add(mesh),_this.mesh=mesh}()})),Class((function VRInputControllerPoint(){Inherit(this,Object3D);const _this=this;var _geom,_shader,_mesh,_color,_borderColor;!function initGeom(){_color=VRInputControllerPoint.getColor(),_borderColor=VRInputControllerPoint.getBorderColor(),_geom=World.PLANE}(),function initShader(){_shader=_this.initClass(Shader,"VRInputControllerPoint",{uColor:{value:new Color(_color)},uBorderColor:{value:new Color(_borderColor)},uAlpha:{value:1},depthTest:!1,transparent:!0})}(),function initMesh(){(_mesh=new Mesh(_geom,_shader)).scale.setScalar(.02),_mesh.renderOrder=1e4,_this.group.add(_mesh)}(),this.set("color",(function(color){VRInputControllerPoint.setColor(color),_shader.set("uColor",new Color(color)),_color=color})),this.get("color",(function(){return _color})),this.set("borderColor",(function(color){VRInputControllerPoint.setBorderColor(color),_shader.set("uBorderColor",new Color(color)),_borderColor=color})),this.get("borderColor",(function(){return _borderColor}))}),(_=>{var _color="#ffffff",_borderColor="#000000";VRInputControllerPoint.setColor=function(color){return _color=color},VRInputControllerPoint.getColor=function(){return _color},VRInputControllerPoint.setBorderColor=function(color){return _borderColor=color},VRInputControllerPoint.getBorderColor=function(){return _borderColor}})),Class((function VRAbstractHand(){Inherit(this,Object3D);const _this=this;this.pointer=new Vector3,this.isAbstractHand=!0;var _targetColor=new Color;const PHYSICAL_SYNC=!!window.PhysicalSync;function loop(){if(PHYSICAL_SYNC&&PhysicalSync.realignObject(_this.group),_this.thumb){for(let i=_this.tips.length-1;i>-1;i--)_this.tips[i].update();_this.pointer.set(0,0,-1).applyQuaternion(_this.index.quaternion);let distance=_this.thumb.position.distanceTo(_this.index.position);_this.flag("pinching")&&distance>.025?(_this.flag("pinching",!1),_this.events.fire(VRInputHand.PINCH,{action:"end",hand:_this})):!_this.flag("pinching")&&distance<=.015&&(_this.flag("pinching",!0),_this.events.fire(VRInputHand.PINCH,{action:"start",hand:_this}))}_this.index&&_this.pointer.set(0,0,-1).applyQuaternion(_this.index.quaternion)}!function createBody(){_this.body=Utils3D.createDebug(.07),_this.body.shader.neverRender=!0;let velocity=new VelocityTracker(_this.body.position);velocity.start(),_this.velocity=velocity.value}(),function initShader(){_this.shader=VRAbstractHand.shader?VRAbstractHand.shader.clone():_this.initClass(Shader,"VRHand",{transparent:!0,uColor:{value:new Color("#ffffff")},uStatic:{value:0}}),_this.shader.uniforms.uColor={value:new Color}}(),_this.startRender(loop),_this.setColor=function(colorHex){_targetColor.set(colorHex),_this.shader.uniforms.uColor.value.lerp(_targetColor,.07)},_this.setShader=function(shader){_this.shader=shader}}),(_=>{VRAbstractHand.useShader=function(shader){VRAbstractHand.shader=shader}})),Class((function VRHandFingerTip(_bone,_prev){const _this=this;this.position=new Vector3,this.quaternion=new Quaternion;var _null=new Group,_v3=new Vector3,_velocity=new VelocityTracker(this.position);this.velocity=_velocity.value;const AURA=!!window.AURA;this.update=function(){_bone.getWorldPosition(_this.position),_prev.getWorldPosition(_null.position),AURA||(_this.position.divideScalar(100),_null.position.divideScalar(100)),_null.isCamera=!0,_null.lookAt(_this.position),_this.quaternion.copy(_null.quaternion),AURA&&_this.position.add(_v3.set(0,0,-1).applyQuaternion(_null.quaternion).multiplyScalar(.025)),_velocity.update()},this.updateStatic=function(position,quaternion){_this.position.copy(position),_this.quaternion.copy(quaternion)}})),Class((function VRInputControllerHand(_type,_controller){Inherit(this,VRAbstractHand);const _this=this;var _geom,_mesh,_tip,_grip=new Matrix4;this.tips=[],async function(){_geom=await GeomThread.loadGeometry("vrhands/pointy_hand_"+_type),_this.flag("loaded",!0),_this.shader.uniforms.uStatic.value=1,(_mesh=new Mesh(_geom,_this.shader)).scale.multiplyScalar(.01),_this.add(_mesh),_mesh.frustumCulled=!1,_mesh.rotation.set(Math.radians(-90),0,Math.radians(-90)),_mesh.position.x=.03*("left"==_type?-1:1),(_tip=Utils3D.createDebug(.02)).position.set(.014*("left"==_type?-1:1),.02,-.125),_tip.shader.neverRender=!0,_this.add(_tip),_this.tips[0]=_this.initClass(VRHandFingerTip,_tip),World.SCENE.add(_this.group),_this.group.add(_this.body)}(),this.update=function(matrix){16==matrix.length&&(_grip.fromArray(matrix),_grip.decompose(_this.group.position,_this.group.quaternion,_this.group.scale),_this.tips[0]&&_this.tips[0].updateStatic(_tip.getWorldPosition(),_this.group.quaternion),window.PhysicalSync&&PhysicalSync.realignObject(_this.group),_this.group.updateMatrixWorld(!0))},this.ready=function(){return _this.wait("loaded")},this.get("index",(_=>_this.tips[0]))})),Class((function VRInputHand(_type){Inherit(this,VRAbstractHand);const _this=this;var _geom,_mesh,_center;this.hand=this.handedness=_type,this.tips=[];var _bones=[];!async function(){await async function initMesh(){_geom=await GeomThread.loadSkinnedGeometry("vrhands/hand_"+_type),_this.flag("loaded",!0),(_mesh=new Skin(_geom,_this.shader,_geom.bones)).scale.setScalar(.01),_this.add(_mesh),_mesh.frustumCulled=!1,World.SCENE.add(_this.group)}(),function mapBones(){let findBone=name=>{for(let i=0;i<_mesh.bones.length;i++)if(_mesh.bones[i].name==name)return _mesh.bones[i]};["b_%_wrist","b_%_thumb1","b_%_thumb2","b_%_thumb3","b_%_thumb_null",null,"b_%_index1","b_%_index2","b_%_index3","b_%_index_null",null,"b_%_middle1","b_%_middle2","b_%_middle3","b_%_middle_null",null,"b_%_ring1","b_%_ring2","b_%_ring3","b_%_ring_null","b_%_pinky0","b_%_pinky1","b_%_pinky2","b_%_pinky3","b_%_pinky_null"].forEach((boneName=>{if(boneName){boneName=boneName.replace("%","right"===_type?"r":"l");const bone=findBone(boneName);boneName.includes("null")&&_this.tips.push(_this.initClass(VRHandFingerTip,bone,findBone(boneName.replace("_null","3")))),boneName.includes("middle1")&&(_center=_this.initClass(VRHandFingerTip,bone,findBone(boneName.replace("_null","3")))),_bones.push(bone)}else _bones.push(null)}))}()}(),this.update=function(frame,hand,ref){if(_mesh){for(let i=0;i<XRHand.LITTLE_PHALANX_TIP;i++)if(hand[i]){let jointPose=frame.getJointPose(hand[i],ref);_bones[i]&&jointPose&&(_bones[i].position.copy(jointPose.transform.position).multiplyScalar(100),_bones[i].quaternion.copy(jointPose.transform.orientation))}_center.update(),_this.body.position.copy(_center.position),_this.body.updateMatrixWorld(!0),_this.group.updateMatrixWorld(!0)}},this.useShader=function(shader){_mesh.shader=shader},this.ready=function(){return _this.wait("loaded")},this.get("thumb",(_=>_this.tips[0])),this.get("index",(_=>_this.tips[1])),this.get("middle",(_=>_this.tips[2])),this.get("ring",(_=>_this.tips[3])),this.get("pinky",(_=>_this.tips[4]))}),(_=>{VRInputHand.PINCH="vr_hand_pinch"})),Class((function VRInputHandAura(_type){Inherit(this,VRAbstractHand);const _this=this;var _boneMapping,_mesh,_center;const _data={rootPose:{position:[],orientation:[]}};var _quaternion=new Quaternion,_vector=new Vector3;function loop(){if("number"!=typeof _data.hand)return;_boneMapping.forEach((entry=>{let orientation=_data[entry.name],bone=_mesh.bones[entry.skinIndex];_quaternion.fromArray(orientation),bone.quaternion.slerp(_quaternion,.5)}));let position=_data.rootPose.position,orientation=_data.rootPose.orientation;_vector.fromArray(position),_quaternion.fromArray(orientation),_mesh.bones[0].position.lerp(_vector,.5),_mesh.bones[0].quaternion.slerp(_quaternion,1)}this.hand=this.handedness=_type,this.tips=[],async function(){await async function initMesh(){_geom=await GeomThread.loadSkinnedGeometry("vrhands/aura_"+_type),_this.flag("loaded",!0),_mesh=new Skin(_geom,_this.shader,_geom.bones),_this.add(_mesh),_mesh.frustumCulled=!1,World.SCENE.add(_this.group)}(),function initBoneMapping(){_boneMapping=[{name:"ovrHandBone_WristRoot",skinIndex:0,skeletonIndex:0},{name:"ovrHandBone_ForearmStub",skinIndex:23,skeletonIndex:1},{name:"ovrHandBone_Thumb0",skinIndex:1,skeletonIndex:2},{name:"ovrHandBone_Thumb1",skinIndex:2,skeletonIndex:3},{name:"ovrHandBone_Thumb2",skinIndex:3,skeletonIndex:4},{name:"ovrHandBone_Thumb3",skinIndex:4,skeletonIndex:5},{name:"ovrHandBone_Index1",skinIndex:6,skeletonIndex:6},{name:"ovrHandBone_Index2",skinIndex:7,skeletonIndex:7},{name:"ovrHandBone_Index3",skinIndex:8,skeletonIndex:8},{name:"ovrHandBone_Middle1",skinIndex:10,skeletonIndex:9},{name:"ovrHandBone_Middle2",skinIndex:11,skeletonIndex:10},{name:"ovrHandBone_Middle3",skinIndex:12,skeletonIndex:11},{name:"ovrHandBone_Ring1",skinIndex:14,skeletonIndex:12},{name:"ovrHandBone_Ring2",skinIndex:15,skeletonIndex:13},{name:"ovrHandBone_Ring3",skinIndex:16,skeletonIndex:14},{name:"ovrHandBone_Pinky0",skinIndex:18,skeletonIndex:15},{name:"ovrHandBone_Pinky1",skinIndex:19,skeletonIndex:16},{name:"ovrHandBone_Pinky2",skinIndex:20,skeletonIndex:17},{name:"ovrHandBone_Pinky3",skinIndex:21,skeletonIndex:18}]}(),function initFingerTips(){const getBone=key=>{for(let i=0;i<_boneMapping.length;i++){let entry=_boneMapping[i];if(entry.name==key)return _mesh.bones[entry.skinIndex]}};["ovrHandBone_Thumb3","ovrHandBone_Index3","ovrHandBone_Middle3","ovrHandBone_Ring3","ovrHandBone_Pinky3"].forEach((key=>{_this.tips.push(_this.initClass(VRHandFingerTip,getBone(key),getBone(key.replace("3","2"))))})),_center=_this.initClass(VRHandFingerTip,getBone("ovrHandBone_Middle1"),getBone("ovrHandBone_Middle3"))}(),_this.startRender(loop)}(),this.update=function(frame,data){_mesh&&(_data.hand=data.hand,_data.rootPose.position[0]=data.rootPose.position[0],_data.rootPose.position[1]=data.rootPose.position[1],_data.rootPose.position[2]=data.rootPose.position[2],_data.rootPose.orientation[0]=data.rootPose.orientation[0],_data.rootPose.orientation[1]=data.rootPose.orientation[1],_data.rootPose.orientation[2]=data.rootPose.orientation[2],_data.rootPose.orientation[3]=data.rootPose.orientation[3],_boneMapping.forEach((entry=>{_data[entry.name]||(_data[entry.name]=[]),_data[entry.name][0]=data[entry.name][0],_data[entry.name][1]=data[entry.name][1],_data[entry.name][2]=data[entry.name][2],_data[entry.name][3]=data[entry.name][3]})),_this.group.visible=data.confidence>3,_center.update(),_this.body.position.copy(_center.position),_this.body.updateMatrixWorld(!0))},this.ready=function(){return _this.wait("loaded")},this.get("thumb",(_=>_this.tips[0])),this.get("index",(_=>_this.tips[1])),this.get("middle",(_=>_this.tips[2])),this.get("ring",(_=>_this.tips[3])),this.get("pinky",(_=>_this.tips[4]))})),Class((function VRCamera(_gl,_nuke){Inherit(this,Component);const _this=this;var _session,_frame,_added,_map=new Map,_tempCameras=new Map,_wrapper0=new Group,_wrapper1=new Group;function applyCamera(camera){_this.worldCamera.projectionMatrix.copy(camera.projectionMatrix),_this.worldCamera.position.copy(camera.position),_this.worldCamera.quaternion.copy(camera.quaternion),_this.worldCamera.matrixWorld.copy(camera.matrixWorld),_this.worldCamera.matrix.copy(camera.matrix)}this.worldCamera=new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3),this.offset=_wrapper0.position,this.inset=_wrapper1.position,this.wrapper=_wrapper0,_wrapper0.add(_wrapper1),this.getFrameOfReference=async function(){if(_frame)return _frame;_session=await XRDeviceManager.getVRSession();try{_frame=await _session.requestReferenceSpace("bounded-floor")}catch(e){_frame=await _session.requestReferenceSpace("local-floor")}return _frame},this.newFrame=function(){_map.clear()},this.getRenderCamera=function(view,pose){if(!pose)return;if(_map.has(view.eye))return applyCamera(_map.get(view.eye)),_this.worldCamera;_tempCameras.has(view.eye)||_tempCameras.set(view.eye,new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3));let camera=_tempCameras.get(view.eye);return _added||(World.SCENE.add(_wrapper0),_added=!0),_wrapper1.position.copy(view.transform.position),_wrapper1.quaternion.copy(view.transform.orientation),_wrapper0.updateMatrixWorld(!0),camera.projectionMatrix.fromArray(view.projectionMatrix),Utils3D.decompose(_wrapper1,camera),camera.updateMatrixWorld(!0),_map.set(view.eye,camera),applyCamera(camera),_this.worldCamera},this.forceUpdate=function(){_wrapper0.updateMatrixWorld(!0),Utils3D.decompose(_wrapper1,_this.worldCamera),_this.worldCamera.updateMatrixWorld(!0)},this.reset=function(){_frame=null}})),Class((function VRRenderer(_renderer,_nuke){Inherit(this,Component);const _this=this;var _session,_gl,_callback,_frame,_scaleFactor,_nativeScaleFactor,_currentUnparsedScaleFactor,_frameOfRef,_vrCamera,_copyToScreen,_frameBound,_supportsRequestViewportScale,_baseLayers,_frustums=[],_renderEvt={},_cameras={},_nukes={};const USE_UBO=Renderer.UBO;function parseScaleFactor(value){return"number"==typeof value?value:"native"===value?_nativeScaleFactor:1}async function setup(){_session=await XRDeviceManager.getVRSession(),_nativeScaleFactor=XRWebGLLayer.getNativeFramebufferScaleFactor(_session),_currentUnparsedScaleFactor=XRDeviceManager.scaleFactor,_scaleFactor=parseScaleFactor(_currentUnparsedScaleFactor),function initBaseLayers(){let scaleFactors=[_scaleFactor,...XRDeviceManager.preallocatedScaleFactors.map(parseScaleFactor)],baseLayers={};scaleFactors.forEach((scaleFactor=>{baseLayers[scaleFactor]||(baseLayers[scaleFactor]=new XRWebGLLayer(_session,_renderer.context,{stencil:_renderer.stencil,framebufferScaleFactor:scaleFactor}))})),_session.baseLayer=baseLayers[_scaleFactor],XRDeviceManager.preallocatedScaleFactors.length&&(_baseLayers=baseLayers)}(),_session.updateRenderState({baseLayer:_session.baseLayer}),Render.useRAF(rAFOverride),_vrCamera=RenderManager.camera,_frameOfRef=await _vrCamera.getFrameOfReference(),_session.requestAnimationFrame(rAF),_renderer.vrRenderingPath=render,_gl=_renderer.context,_this.events.fire(XRDeviceManager.SESSION_START)}function getCamera(eye,camera){return _cameras[eye]||(_cameras[eye]=camera.clone()),_cameras[eye]}function initCameraUBO(camera){camera._ubo=new UBO(0,_gl),camera._ubo.push({value:camera.projectionMatrix}),camera._ubo.push({value:camera.matrixWorldInverse}),camera._ubo.push({value:camera.worldPos}),camera._ubo.push({value:camera.worldQuat}),camera._ubo.push({value:_renderer.resolution}),camera._ubo.push(_renderer.time),camera._ubo.push(Render.timeScaleUniform),camera._ubo.upload()}function rAF(t,frame){_vrCamera.newFrame(),_frame=frame,_frameBound=!1,_callback&&_callback(t),_this.onFrame&&_this.onFrame(t,frame),_session.requestAnimationFrame(rAF)}function render(scene,camera,projScreenMatrix,frustum,attachSceneUniforms,rt){if(!_frame)return;let pose,doNuke=_nuke.enabled&&_nuke.passes.length&&!rt;camera.getWorldPosition(camera.worldPos),camera.getWorldQuaternion(camera.worldQuat),USE_UBO&&(camera._ubo?camera._ubo.update():initCameraUBO(camera));try{if(pose=_frame.getViewerPose(_frameOfRef),!pose)return}catch(e){return}if(rt){let width=_session.baseLayer.framebufferWidth,height=_session.baseLayer.framebufferHeight;rt.width==width&&rt.height==height||rt.setSize(width,height),rt._gl||rt.upload()}if(void 0===_supportsRequestViewportScale&&(_supportsRequestViewportScale="function"==typeof pose.views[0].requestViewportScale),XRDeviceManager.scaleFactor!==_currentUnparsedScaleFactor)if(_currentUnparsedScaleFactor=XRDeviceManager.scaleFactor,_scaleFactor=parseScaleFactor(_currentUnparsedScaleFactor),_supportsRequestViewportScale)for(let i=0;i<pose.views.length;i++){pose.views[i].requestViewportScale(_scaleFactor)}else{let newBaseLayer;_baseLayers?(newBaseLayer=_baseLayers[_scaleFactor],newBaseLayer||console.warn("Ignoring scaleFactor not specified in XRDeviceManager.preallocatedScaleFactors")):newBaseLayer=new XRWebGLLayer(_session,_renderer.context,{stencil:_renderer.stencil,framebufferScaleFactor:_scaleFactor}),newBaseLayer&&(_session.updateRenderState({baseLayer:newBaseLayer}),_session.baseLayer=newBaseLayer)}for(let i=0;i<pose.views.length;i++){let view=pose.views[i],renderCamera=_vrCamera.getRenderCamera(view,pose);if(!renderCamera)continue;view.camera=getCamera(view.eye,renderCamera),view.camera.projectionMatrix.copy(renderCamera.projectionMatrix),view.camera.matrix.copy(renderCamera.matrix),view.camera.matrixWorld.copy(renderCamera.matrixWorld),view.camera.matrixWorldInverse.getInverse(view.camera.matrixWorld),view.camera.worldPos.copy(renderCamera.worldPos),view.camera.worldQuat.copy(renderCamera.worldQuat),view.camera.position.copy(renderCamera.position),view.camera.quaternion.copy(renderCamera.quaternion);let viewport=_session.baseLayer.getViewport(view);_renderEvt.stage=viewport,_renderEvt.camera=view.camera,_renderEvt.view=i,_renderEvt.eye=view.eye,RenderManager.fire(RenderManager.EYE_RENDER,_renderEvt),USE_UBO&&(view.camera._ubo?view.camera._ubo.update():initCameraUBO(view.camera)),_renderer.resolution.set(2*viewport.width,viewport.height),doNuke&&(view.nuke=(eye=view.eye,_nukes[eye]||(_nukes[eye]=new Nuke(_nuke.stage,{renderer:_nuke.renderer,camera:_nuke.camera,scene:_nuke.scene,dpr:_nuke.dpr}),function cloneDrawBuffers(to,from){if(from.rttBuffer.attachments)for(let i=1;i<from.rttBuffer.attachments.length;i++){let texture=from.rttBuffer.attachments[i],clone=texture.clone();clone.fxLayer=texture.fxLayer,to.attachDrawBuffer(clone)}}(_nukes[eye],_nuke)),_nukes[eye]),view.nuke.setSize(viewport.width,viewport.height),view.nuke.needsClear=!0),_frustums[i]||(_frustums[i]=new Frustum),_frustums[i].setFromCamera(view.camera)}var eye;doNuke||_frameBound||(_frameBound=!rt,_gl.bindFramebuffer(_session.oculusFramebuffer?_gl.DRAW_FRAMEBUFFER:_gl.FRAMEBUFFER,rt?rt._gl:_session.baseLayer.framebuffer),XRDeviceManager.foveationLevel&&_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT)),_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_renderer.autoClear&&_this.autoClear&&_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT);for(let l=0;l<2;l++)for(let i=0;i<scene.toRender[l].length;i++){let object=scene.toRender[l][i];if(object.onBeforeRender&&object.onBeforeRender(),!object.determineVisible()||!object.shader.visible||object.shader.neverRender)continue;let inFrustum=!1;for(let f=0;f<pose.views.length;f++)inFrustum||(inFrustum=_frustums[f].intersectsObject(object));if(!object.frustumCulled||inFrustum){object.shader.draw(object,object.geometry);for(let view of pose.views){let viewport=_session.baseLayer.getViewport(view);_renderer.resolution.set(2*viewport.width,viewport.height),object.modelViewMatrix.multiplyMatrices(view.camera.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix),doNuke?(view.nuke.rttBuffer._gl||RenderTarget.renderer.upload(view.nuke.rttBuffer),_gl.bindFramebuffer(_gl.FRAMEBUFFER,view.nuke.rttBuffer._gl),view.nuke.needsClear&&(view.nuke.needsClear=!1,_gl.viewport(0,0,view.nuke.rttBuffer.width,view.nuke.rttBuffer.height),_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))):_gl.viewport(viewport.x,viewport.y,viewport.width,viewport.height),attachSceneUniforms(object,scene,view.camera),object.geometry.draw(object,object.shader),USE_UBO&&view.camera._ubo.unbind(),doNuke&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)}}}if(Shader.renderer.resetState(),doNuke){for(let view of pose.views)runPasses(view,camera,scene,attachSceneUniforms);_gl.bindFramebuffer(_gl.FRAMEBUFFER,_session.baseLayer.framebuffer);for(let view of pose.views){let viewport=_session.baseLayer.getViewport(view);_gl.viewport(viewport.x,viewport.y,viewport.width,viewport.height);let mesh=_copyToScreen;mesh.shader.uniforms.tMap.value=view.nuke.outputTexture,drawQuad(mesh,camera,scene,attachSceneUniforms)}}Shader.renderer.resetState()}function runPasses(view,camera,scene,attachSceneUniforms){let nuke=view.nuke;if(nuke.ping._gl||RenderTarget.renderer.upload(nuke.ping),nuke.pong._gl||RenderTarget.renderer.upload(nuke.pong),nuke.rttBuffer.attachments)for(let i=1;i<nuke.rttBuffer.attachments.length;i++){let texture=nuke.rttBuffer.attachments[i];texture.fxLayer.rt.overrideTexture=texture}_renderEvt.stage=nuke.rttBuffer,_renderEvt.camera=view.camera,_this.events.fire(RenderManager.RENDER,_renderEvt);let originalShader=_copyToScreen.shader,pingPong=!0;for(let i=0;i<_nuke.passes.length;i++)pingPong=!pingPong,_copyToScreen.shader=_nuke.passes[i].pass,_copyToScreen.shader.uniforms.tDiffuse.value=0==i?nuke.rttBuffer:pingPong?nuke.pong:nuke.ping,_gl.bindFramebuffer(_gl.FRAMEBUFFER,pingPong?nuke.ping._gl:nuke.pong._gl),_gl.viewport(0,0,nuke.rttBuffer.width,nuke.rttBuffer.height),_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT),drawQuad(_copyToScreen,camera,scene,attachSceneUniforms),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);nuke.outputTexture=pingPong?nuke.ping.texture:nuke.pong.texture,_copyToScreen.shader=originalShader}function drawQuad(mesh,camera,scene,attachSceneUniforms){mesh.modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,mesh.matrixWorld),mesh.normalMatrix.getNormalMatrix(mesh.modelViewMatrix),mesh.shader.draw(mesh,mesh.geometry),attachSceneUniforms(mesh,scene,camera),mesh.geometry.draw(mesh,mesh.shader),USE_UBO&&camera._ubo.unbind()}function rAFOverride(callback){_callback=callback}this.autoClear=!0,setup(),function initCopyToScreen(){let shader=new Shader("ScreenQuad",{tMap:{value:null}});_copyToScreen=new Mesh(World.QUAD,shader)}(),this.render=function(scene,camera){_frame&&_renderer.render(scene,camera)},this.setSize=function(width,height){_renderer.setSize(width,height)},this.reset=function(){setup()},this.getBaseLayer=function(){return _session.baseLayer}})),Class((function MovableObject(_mesh,_shader,_group,_input){Inherit(this,PhysicsState,_mesh),Inherit(this,PhysicalLink);const _this=this;var _controller;function loop(){_mesh.position.copy(_controller.body.getWorldPosition()),_mesh.quaternion.copy(_controller.body.getWorldQuaternion())}function remoteEvent(e){"start"==e.action?_mesh.physics.kinematic=!0:(_mesh.physics.kinematic=!1,_mesh.applyPhysicsState(e.physics))}function start({controller:controller}){_this._invisible||_mesh.isInsideOf(controller.body)&&(_controller=controller,_this.startRender(loop),_mesh.physics.kinematic=!0,_mesh.broadcastSync=!0,_this.fireEvent(_input.prefix,{action:"start"}))}function end({controller:controller}){_this._invisible||_controller&&(_this.stopRender(loop),_controller=null,_mesh.physics.kinematic=!1,_mesh.broadcastSync=!1,_this.fireEvent(_input.prefix,{action:"end",physics:_mesh.getPhysicsState()}))}_this.startRender((_=>{})),_this.bindGlobal(_mesh,_input.prefix),_this.bindGlobalEvent(_input.prefix,remoteEvent),Platform.usingVR()&&async function initControllers(){await VRInput.ready(),VRInput.controllers.forEach(((c,i)=>{_this.events.sub(c,VRInput.SELECT_START,start),_this.events.sub(c,VRInput.SELECT_END,end)}))}()})),Class((function PhysicsState(_mesh){Inherit(this,Component),Inherit(this,PhysicalLink);_mesh.physics&&_mesh.physics.trackVelocity(),_mesh.getPhysicsState=function(){return{linear:(new Vector3).copy(_mesh.physics.linearVelocity),angular:(new Vector3).copy(_mesh.physics.angularVelocity),position:(new Vector3).copy(_mesh.position),quaternion:(new Quaternion).copy(_mesh.quaternion)}},_mesh.applyPhysicsState=function({linear:linear,angular:angular,position:position,quaternion:quaternion}){if(!quaternion.x){let quat=new Quaternion;quat.x=quaternion._x,quat.y=quaternion._y,quat.z=quaternion._z,quat.w=quaternion._w,quaternion=quat,angular=(new Vector3).copy(angular),position=(new Vector3).copy(position),linear=(new Vector3).copy(linear)}_mesh.physics.applyState(linear,angular,position,quaternion)}})),Class((function SyncedPlayable(_mesh,_shader,_group,_input){Inherit(this,PhysicsState,_mesh);const _this=this;function remoteEvent(e){switch(e.action){case"sync":_mesh.applyPhysicsState(e.physics);break;case"startMoving":_mesh.physics.kinematic=!0;break;case"stopMoving":_mesh.physics.kinematic=!1,_mesh.applyPhysicsState(e.physics)}}_this.bindGlobal(_mesh,_input.prefix),_this.bindGlobalEvent(_input.prefix,remoteEvent),_mesh.sync=function(){_this.fireEvent(_input.prefix,{action:"sync",physics:_mesh.getPhysicsState()})},_mesh.startMoving=function(){_this.fireEvent(_input.prefix,{action:"startMoving"})},_mesh.stopMoving=function(){_this.fireEvent(_input.prefix,{action:"stopMoving",physics:_mesh.getPhysicsState()})}}));
window._MODULES_ = true;